RÃµ ğŸ‘
DÆ°á»›i Ä‘Ã¢y lÃ  **UI + DB skeleton chuáº©n** Ä‘á»ƒ Game Management **test game cho QC Ä‘Ãºng SDK hub-core**, tá»± Ä‘á»™ng tá»‘i Ä‘a, khÃ´ng bá»‹a dá»¯ liá»‡u. Em viáº¿t **ngáº¯n â€“ Ä‘á»§ â€“ triá»ƒn khai Ä‘Æ°á»£c ngay**.

---

# I. DB DESIGN (MongoDB) â€” CHá»T DÃ™NG LUÃ”N

## 1) Collection: `game_versions`

DÃ¹ng Ä‘á»ƒ hiá»ƒn thá»‹ & gáº¯n QA summary.

```ts
{
  _id: ObjectId,
  gameId: string,
  versionId: string,
  entryUrl: string,
  manifest: object,

  status: "uploaded" | "qc_passed" | "qc_failed",

  qaSummary: {
    qa01: { pass: boolean },
    qa02: { pass: boolean },
    qa03: { pass: boolean },
    qa04: { pass: boolean },
    overall: "pass" | "fail"
  },

  updatedAt: Date
}
```

ğŸ‘‰ `qaSummary` Ä‘á»ƒ **list nhanh cho CTO/CEO**, khÃ´ng load report chi tiáº¿t.

---

## 2) Collection: `qc_reports` (quan trá»ng nháº¥t)

```ts
{
  _id: ObjectId,

  gameId: string,
  versionId: string,
  qcUserId: string,

  qa01: {
    initToReadyMs: number,
    quitToCompleteMs: number,
    pass: boolean
  },

  qa02: {
    pass: boolean,
    normalizedResult: object
  },

  qa03: {
    auto: {
      assetError: boolean,
      readyMs: number
    },
    manual: {
      noAutoplay: boolean,
      noWhiteScreen: boolean,
      gestureOk: boolean
    }
  },

  qa04: {
    pass: boolean
  },

  rawResult: object,          // fixture tháº­t tá»« game
  eventsTimeline: array,      // INIT/READY/RESULT/QUIT/COMPLETE

  decision: "pass" | "fail",
  note: string,

  createdAt: Date
}
```

ğŸ‘‰ **ÄÃ¢y lÃ  â€œbáº±ng chá»©ng QCâ€**, khÃ´ng Ä‘Æ°á»£c máº¥t.

---

## 3) Index cáº§n táº¡o

```ts
qc_reports: { versionId: 1 }
game_versions: { gameId: 1 }
```

---

# II. UI FLOW (ASTRO) â€” 1 MÃ€N DUY NHáº¤T CHO QC

## Route

```
/qc/review/[versionId]
```

---

## Layout (3 cá»™t, ráº¥t quan trá»ng)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Metadata   â”‚ Game Preview (iframe)â”‚ QA & Decision        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1) Cá»™t trÃ¡i â€” Metadata

Hiá»ƒn thá»‹:

* gameId / versionId
* entryUrl
* gameType / subject / grade
* NÃºt: **Run Auto QA**

```astro
<button onClick={runAutoQA}>
  â–¶ Run Auto QA
</button>
```

---

## 2) Cá»™t giá»¯a â€” Game Preview (GAME THáº¬T)

```astro
<iframe
  id="gameFrame"
  sandbox="allow-scripts allow-same-origin"
  class="w-full h-full"
/>
```

ğŸ‘‰ iframe load **entryUrl tháº­t**, khÃ´ng mock.

---

## 3) Cá»™t pháº£i â€” QA Result + Decision

### QA-01 Handshake (auto)

```
INIT â†’ READY: 2.3s  âœ…
QUIT â†’ COMPLETE: 0.8s âœ…
```

### QA-02 Converter (auto)

```
NormalizeResult: PASS
accuracy: 0.8
completion: 1.0
```

### QA-03 iOS Pack (manual)

Checkbox:

* â˜ No autoplay audio
* â˜ No white screen
* â˜ Gesture OK

### QA-04 Idempotency (auto)

```
AttemptId duplicated: âŒ
BE records: 1 âœ…
```

---

### Quyáº¿t Ä‘á»‹nh QC

```astro
<button disabled={!autoPass}>
  âœ… QC PASS
</button>

<button>
  âŒ QC FAIL
</button>

<textarea placeholder="QC note..." />
```

Rule:

* Náº¿u **QA-01 hoáº·c QA-02 fail â†’ disable QC PASS**
* QA-03 báº¯t buá»™c QC tick
* QA-04 fail â†’ QC FAIL báº¯t buá»™c

---

# III. Káº¾T Ná»I UI â†” HUB-CORE SDK (TRONG GM)

## File duy nháº¥t: `src/qc/testRunner.ts`

GM chá»‰ gá»i Ä‘Ãºng SDK, khÃ´ng tá»± Ä‘o.

```ts
import {
  createIframeBridge,
  createSessionController
} from "@iruka/game-hub-core";

export async function runAutoQA({
  iframe,
  entryUrl,
  launchContext
}) {
  const bridge = createIframeBridge({
    iframe,
    targetOrigin: new URL(entryUrl).origin
  });

  const session = createSessionController({
    bridge,
    launchContext
  });

  const events: any[] = [];
  session.onAny(e => events.push(e));

  session.start(entryUrl);
  await session.whenFinished();

  return {
    report: session.getReport(),
    events
  };
}
```

---

# IV. API ENDPOINTS (GM)

## 1) Run QA

```
POST /api/qc/run
body: { versionId }
```

Flow:

* load version
* run `runAutoQA`
* normalizeResult
* check idempotency
* save `qc_reports`
* update `game_versions.qaSummary`

---

## 2) QC Decision

```
POST /api/qc/decision
body: { versionId, decision, note }
```

* update `qc_reports.decision`
* update `game_versions.status`

---

# V. CHECKPOINT ÄÃšNG (Ä‘á»ƒ anh biáº¿t Ä‘Ã£ xong)

Sau khi lÃ m xong:

* QC báº¥m **Run Auto QA**
* Game tháº­t cháº¡y trong iframe
* INIT/READY/RESULT/QUIT/COMPLETE xuáº¥t hiá»‡n
* QA-01..04 cÃ³ PASS/FAIL tá»± Ä‘á»™ng
* Báº¥m QC PASS â†’ version chuyá»ƒn `qc_passed`
* CTO chá»‰ cáº§n má»Ÿ version list lÃ  tháº¥y tráº¡ng thÃ¡i

---

## BÆ¯á»šC TIáº¾P THEO (Náº¾U ANH MUá»N)

Em cÃ³ thá»ƒ tiáº¿p tá»¥c **viáº¿t tháº³ng code Astro page `/qc/review/[id].astro`** (UI tháº­t, khÃ´ng mock), hoáº·c **viáº¿t schema BE idempotency check**.

Anh chá»‰ cáº§n nÃ³i: **â€œviáº¿t UI astroâ€** hoáº·c **â€œviáº¿t APIâ€**.
