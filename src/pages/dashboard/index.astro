---
import Layout from "../../layouts/Layout.astro";
import type { User } from "../../models/User";
import { GameRepository, type Game } from "../../models/Game";
import {
  GameVersionRepository,
  type GameVersion,
} from "../../models/GameVersion";

// Get user from middleware (attached to locals)
const user = Astro.locals.user as User;

// Redirect if not authenticated (should be handled by middleware, but double-check)
if (!user) {
  return Astro.redirect("/login");
}

// Get games based on user role
const gameRepo = await GameRepository.getInstance();
const versionRepo = await GameVersionRepository.getInstance();
let games: Game[] = [];
let dashboardTitle = "Dashboard";
let dashboardDescription = "";

const roles = user.roles;
const userId = user._id.toString();

// Interface for game with version info
interface GameWithVersion extends Game {
  latestVersion?: GameVersion;
  versionStatus?: string;
}

// Role checks
const isAdmin = roles.includes("admin");
const isQC = roles.includes("qc");
const isCTO = roles.includes("cto") || roles.includes("ceo");

// QC KPIs
let pendingCount = 0;
let inProgressCount = 0;
let blockedCount = 0;
let doneTodayCount = 0;
const today = new Date();
today.setHours(0, 0, 0, 0);

if (isQC || isAdmin) {
  const uploadedVersions = await versionRepo.findByStatus("uploaded");
  const processingVersions = await versionRepo.findByStatus("qc_processing");
  const failedVersions = await versionRepo.findByStatus("qc_failed");
  const passedVersions = await versionRepo.findByStatus("qc_passed");

  pendingCount = uploadedVersions.length;
  inProgressCount = processingVersions.length;
  blockedCount = failedVersions.length;
  doneTodayCount = passedVersions.filter((v) => v.updatedAt >= today).length;
}

// Stats for admin/dashboard
let totalGames = 0;
let draftGames = 0;
let publishedGames = 0;

if (isAdmin) {
  const allGames = await gameRepo.findAll();
  totalGames = allGames.length;
  draftGames = allGames.filter((g) => g.status === "draft").length;
  publishedGames = allGames.filter((g) => g.status === "published").length;
}

// Jobs for Today (Inbox Preview)
let inboxItems: any[] = [];
if (isQC || isAdmin) {
  // Get versions from multiple statuses
  const uploaded = await versionRepo.findByStatus("uploaded");
  const processing = await versionRepo.findByStatus("qc_processing");
  const failed = await versionRepo.findByStatus("qc_failed");

  const allInboxVersions = [...uploaded, ...processing, ...failed]
    .sort(
      (a, b) =>
        new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime()
    )
    .slice(0, 5);

  inboxItems = await Promise.all(
    allInboxVersions.map(async (v) => {
      const game = await gameRepo.findById(v.gameId.toString());
      const owner = await (
        await import("../../models/User")
      ).UserRepository.getInstance().then((repo) =>
        repo.findById(v.submittedBy.toString())
      );
      return {
        ...v,
        gameTitle: game?.title || "Unknown Game",
        gameId: game?._id.toString() || v.gameId.toString(), // Use gameId instead of slug
        ownerName: owner?.name || owner?.email || "Unknown",
        priority: "P1", // Default priority for now
      };
    })
  );
}

if (isCTO) {
  // Get games with qc_passed versions
  const allGames = await gameRepo.findAll();
  const qcPassedVersions = await versionRepo.findByStatus("qc_passed");
  const gameIdsWithQcPassed = new Set(
    qcPassedVersions.map((v) => v.gameId.toString())
  );
  games = allGames.filter((g) => gameIdsWithQcPassed.has(g._id.toString()));
  dashboardTitle = roles.includes("cto") ? "CTO Dashboard" : "CEO Dashboard";
  dashboardDescription = "Games ƒëang ch·ªù ph√™ duy·ªát";
} else if (isQC) {
  games = []; // Pivot to version-centric below
  dashboardTitle = "QC Dashboard";
  dashboardDescription = "Khu v·ª±c l√†m vi·ªác c·ªßa Quality Assurance";
} else if (!isAdmin) {
  games = await gameRepo.findByOwnerId(userId);
  dashboardTitle = "Developer Dashboard";
  dashboardDescription = "Games c·ªßa b·∫°n";
}

// Helper to get environment label
function getEnvLabel(status: string) {
  if (status === "published") return "PROD";
  if (
    status === "uploaded" ||
    status === "qc_processing" ||
    status === "qc_passed"
  )
    return "STG";
  return "DRAFT";
}

// Helper function to get status label in Vietnamese
function getStatusLabel(status?: string): string {
  const labels: Record<string, string> = {
    draft: "Nh√°p",
    uploaded: "Ch·ªù QC",
    qc_processing: "ƒêang QC",
    qc_passed: "QC Passed",
    qc_failed: "QC Failed",
    approved: "ƒê√£ duy·ªát",
    published: "ƒê√£ xu·∫•t b·∫£n",
    archived: "ƒê√£ l∆∞u tr·ªØ",
  };
  return labels[status || ""] || status || "N/A";
}

// Format date
function formatDate(date?: Date): string {
  if (!date) return "N/A";
  return new Date(date).toLocaleDateString("vi-VN", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
}
---

<Layout title={`${dashboardTitle} - Game Hub Manager`}>
  <div class="space-y-8">
    <!-- Greeting & Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-slate-900">
          Ch√†o, {user.name || user.email.split("@")[0]}! üëã
        </h1>
        <p class="text-slate-500 mt-1">
          {
            isQC
              ? `H√¥m nay: ${pendingCount} build ch·ªù QC ¬∑ ${inProgressCount} ƒëang test ¬∑ ${blockedCount} blocker`
              : dashboardDescription
          }
        </p>
      </div>
      {
        isAdmin && (
          <a href="/upload" class="btn-primary flex items-center gap-2">
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 4v16m8-8H4"
              />
            </svg>
            T·∫°o game m·ªõi
          </a>
        )
      }
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="card p-6 border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
          <p class="text-sm font-medium text-slate-500">Ch·ªù QC</p>
          <div
            class="w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center text-blue-600"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"
              ></path></svg
            >
          </div>
        </div>
        <p class="text-3xl font-bold text-slate-900 mt-2">{pendingCount}</p>
      </div>

      <div class="card p-6 border-l-4 border-amber-500">
        <div class="flex items-center justify-between">
          <p class="text-sm font-medium text-slate-500">ƒêang test</p>
          <div
            class="w-8 h-8 rounded-lg bg-amber-50 flex items-center justify-center text-amber-600"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
              ></path></svg
            >
          </div>
        </div>
        <p class="text-3xl font-bold text-slate-900 mt-2">{inProgressCount}</p>
      </div>

      <div class="card p-6 border-l-4 border-red-500">
        <div class="flex items-center justify-between">
          <p class="text-sm font-medium text-slate-500">B·ªã ch·∫∑n / Fail</p>
          <div
            class="w-8 h-8 rounded-lg bg-red-50 flex items-center justify-center text-red-600"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path></svg
            >
          </div>
        </div>
        <p class="text-3xl font-bold text-slate-900 mt-2">{blockedCount}</p>
      </div>

      <div class="card p-6 border-l-4 border-emerald-500">
        <div class="flex items-center justify-between">
          <p class="text-sm font-medium text-slate-500">Xong h√¥m nay</p>
          <div
            class="w-8 h-8 rounded-lg bg-emerald-50 flex items-center justify-center text-emerald-600"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg
            >
          </div>
        </div>
        <p class="text-3xl font-bold text-slate-900 mt-2">{doneTodayCount}</p>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Column: QC Inbox Preview -->
      <div class="lg:col-span-2 space-y-6">
        <div class="card overflow-hidden">
          <div
            class="p-5 border-b border-slate-200 flex items-center justify-between bg-white"
          >
            <h2 class="font-bold text-slate-900 flex items-center gap-2">
              <svg
                class="w-5 h-5 text-indigo-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"
                ></path></svg
              >
              QC Inbox ‚Äî Vi·ªác c·∫ßn l√†m h√¥m nay
            </h2>
            <a
              href="/console/qc-inbox"
              class="text-xs font-bold text-indigo-600 hover:text-indigo-800 uppercase tracking-wider"
              >Xem t·∫•t c·∫£ ‚Üí</a
            >
          </div>

          <div class="overflow-x-auto">
            <table class="w-full text-left">
              <thead class="bg-slate-50 border-b border-slate-200">
                <tr>
                  <th
                    class="px-5 py-3 text-[10px] font-bold text-slate-500 uppercase tracking-widest"
                    >Game / Version</th
                  >
                  <th
                    class="px-5 py-3 text-[10px] font-bold text-slate-500 uppercase tracking-widest text-center"
                    >Env</th
                  >
                  <th
                    class="px-5 py-3 text-[10px] font-bold text-slate-500 uppercase tracking-widest"
                    >Priority</th
                  >
                  <th
                    class="px-5 py-3 text-[10px] font-bold text-slate-500 uppercase tracking-widest"
                    >Status</th
                  >
                  <th
                    class="px-5 py-3 text-[10px] font-bold text-slate-500 uppercase tracking-widest text-right"
                    >Thao t√°c</th
                  >
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100">
                {
                  inboxItems.length === 0 ? (
                    <tr>
                      <td colspan="5" class="px-5 py-12 text-center">
                        <div class="max-w-xs mx-auto">
                          <p class="text-slate-500 text-sm mb-4">
                            Kh√¥ng c√≥ build ch·ªù QC. B·∫°n c√≥ th·ªÉ:
                          </p>
                          <div class="flex flex-col gap-2">
                            <button class="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-2 rounded-lg hover:bg-indigo-100 transition-colors">
                              Ch·∫°y regression checklist
                            </button>
                            <button class="text-xs font-bold text-slate-600 bg-slate-50 px-3 py-2 rounded-lg hover:bg-slate-100 transition-colors">
                              Xem build m·ªõi nh·∫•t
                            </button>
                          </div>
                        </div>
                      </td>
                    </tr>
                  ) : (
                    inboxItems.map((item) => (
                      <tr class="hover:bg-slate-50/50 transition-colors group">
                        <td class="px-5 py-4">
                          <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-600 font-bold text-xs">
                              {item.gameTitle.charAt(0)}
                            </div>
                            <div>
                              <div class="text-sm font-bold text-slate-900 group-hover:text-indigo-600 transition-colors">
                                {item.gameTitle}
                              </div>
                              <div class="text-[10px] text-slate-400 font-mono">
                                v{item.version}
                              </div>
                            </div>
                          </div>
                        </td>
                        <td class="px-5 py-4 text-center">
                          <span
                            class={`inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-tighter ${
                              getEnvLabel(item.status) === "PROD"
                                ? "bg-emerald-100 text-emerald-700"
                                : "bg-slate-100 text-slate-600"
                            }`}
                          >
                            {getEnvLabel(item.status)}
                          </span>
                        </td>
                        <td class="px-5 py-4">
                          <span class="text-[10px] font-bold text-amber-600 bg-amber-50 px-1.5 py-0.5 rounded border border-amber-100">
                            {item.priority}
                          </span>
                        </td>
                        <td class="px-5 py-4">
                          <span
                            class={`inline-flex items-center gap-1.5 text-xs font-medium ${
                              item.status === "uploaded"
                                ? "text-blue-600"
                                : item.status === "qc_processing"
                                  ? "text-amber-600"
                                  : "text-red-600"
                            }`}
                          >
                            <span
                              class={`w-2 h-2 rounded-full animate-pulse ${
                                item.status === "uploaded"
                                  ? "bg-blue-600"
                                  : item.status === "qc_processing"
                                    ? "bg-amber-600"
                                    : "bg-red-600"
                              }`}
                            />
                            {getStatusLabel(item.status)}
                          </span>
                        </td>
                        <td class="px-5 py-4 text-right">
                          <button class="text-xs font-bold text-white bg-indigo-600 px-3 py-1.5 rounded-lg hover:bg-indigo-700 transition-colors shadow-sm shadow-indigo-200">
                            B·∫Øt ƒë·∫ßu test
                          </button>
                        </td>
                      </tr>
                    ))
                  )
                }
              </tbody>
            </table>
          </div>
        </div>

        <!-- Latest Builds (Standard View) -->
        {
          !isQC && games.length > 0 && (
            <div class="card overflow-hidden">
              <div class="p-5 border-b border-slate-200">
                <h2 class="font-bold text-slate-900">Games g·∫ßn ƒë√¢y</h2>
              </div>
              <div class="p-6">
                <p class="text-sm text-slate-500">
                  Xem t·∫•t c·∫£ games trong{" "}
                  <a
                    href="/console/library"
                    class="text-indigo-600 hover:text-indigo-800 font-medium"
                  >
                    Game Library
                  </a>
                </p>
              </div>
            </div>
          )
        }
      </div>

      <!-- Right Column: Quick Actions & Health -->
      <div class="space-y-6">
        <!-- Quick Actions -->
        <div class="card p-5">
          <h2
            class="font-bold text-slate-900 mb-4 text-sm uppercase tracking-wider"
          >
            Thao t√°c nhanh
          </h2>
          <div class="grid grid-cols-1 gap-3">
            <button
              class="flex items-center gap-3 p-3 rounded-xl border border-slate-100 hover:border-indigo-200 hover:bg-indigo-50/50 transition-all text-left group"
            >
              <div
                class="w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center text-indigo-600 group-hover:scale-110 transition-transform"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
                  ></path></svg
                >
              </div>
              <div>
                <div class="text-sm font-bold text-slate-900">
                  Test build m·ªõi nh·∫•t
                </div>
                <div class="text-[10px] text-slate-500">
                  M·ªü runner cho uploaded build
                </div>
              </div>
            </button>

            <button
              class="flex items-center gap-3 p-3 rounded-xl border border-slate-100 hover:border-indigo-200 hover:bg-indigo-50/50 transition-all text-left group"
            >
              <div
                class="w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center text-emerald-600 group-hover:scale-110 transition-transform"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path></svg
                >
              </div>
              <div>
                <div class="text-sm font-bold text-slate-900">
                  Regression Checklist
                </div>
                <div class="text-[10px] text-slate-500">
                  iOS / Android / Web
                </div>
              </div>
            </button>

            <button
              class="flex items-center gap-3 p-3 rounded-xl border border-slate-100 hover:border-red-200 hover:bg-red-50/50 transition-all text-left group"
            >
              <div
                class="w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center text-red-600 group-hover:scale-110 transition-transform"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path></svg
                >
              </div>
              <div>
                <div class="text-sm font-bold text-slate-900">
                  T·∫°o b√°o c√°o l·ªói
                </div>
                <div class="text-[10px] text-slate-500">
                  Link tr·ª±c ti·∫øp Jira/Slack
                </div>
              </div>
            </button>
          </div>
        </div>

        <!-- System Health -->
        <div class="card p-5">
          <h2
            class="font-bold text-slate-900 mb-4 text-sm uppercase tracking-wider"
          >
            S·ª©c kh·ªèe h·ªá th·ªëng
          </h2>
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                <span class="text-xs font-medium text-slate-600"
                  >Upload Service</span
                >
              </div>
              <span
                class="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded"
                >ONLINE</span
              >
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                <span class="text-xs font-medium text-slate-600"
                  >Game Registry</span
                >
              </div>
              <span
                class="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded"
                >ONLINE</span
              >
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                <span class="text-xs font-medium text-slate-600"
                  >Runner CDN</span
                >
              </div>
              <span
                class="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded"
                >ONLINE</span
              >
            </div>
            <div class="pt-2 border-t border-slate-100">
              <a
                href="/console/logs"
                class="text-[10px] font-bold text-indigo-600 hover:text-indigo-800 flex items-center justify-between"
              >
                Review System Logs
                <svg
                  class="w-3 h-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"></path></svg
                >
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>
