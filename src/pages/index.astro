---
// @ts-nocheck
import Layout from "../layouts/Layout.astro";
import GameCard from "../components/GameCard.astro";
import { GameRepository } from "../models/Game";
import { GameVersionRepository } from "../models/GameVersion";
import { getUserFromRequest } from "../lib/session";
import type { User } from "../models/User";
import { UserRepository } from "../models/User";

// Check authentication
const user = (await getUserFromRequest(Astro.request)) as User | null;

// Fetch games from database (public view)
let games: any[] = [];
let errorMessage = "";
let serverError = false;

try {
  const gameRepo = await GameRepository.getInstance();
  const versionRepo = await GameVersionRepository.getInstance();
  const userRepo = await UserRepository.getInstance();

  const [allGames, allUsers] = await Promise.all([
    gameRepo.findAll(),
    userRepo.findAll(),
  ]);

  const userMap = new Map(allUsers.map((u) => [u._id.toString(), u]));

  games = await Promise.all(
    allGames.map(async (game) => {
      let latestVersion = null;
      let status = "draft";
      let activeVer = null;

      // Logic to resolve active version & status
      if (game.latestVersionId) {
        latestVersion = await versionRepo.findById(
          game.latestVersionId.toString()
        );
      } else {
        const versions = await versionRepo.findByGameId(game._id.toString());
        if (versions.length > 0) {
          latestVersion = versions[0];
          await gameRepo.updateLatestVersion(
            game._id.toString(),
            latestVersion._id
          );
        }
      }

      if (latestVersion) {
        status = latestVersion.status;
        activeVer = latestVersion.version;
      }

      const owner = userMap.get(game.ownerId);

      return {
        id: game.gameId,
        title: game.title || game.gameId,
        owner: game.ownerId,
        ownerName: owner?.name || owner?.email.split("@")[0],
        ownerAvatar: owner?.avatar,
        updatedAt:
          latestVersion?.updatedAt?.toISOString() ||
          game.updatedAt.toISOString(),
        activeVersion: activeVer || "1.0.0",
        versions: latestVersion
          ? [
              {
                version: activeVer,
                size: latestVersion.buildSize,
              },
            ]
          : [],
        manifest: {
          title: game.title,
          runtime: "iframe-html", // Placeholder, ideally from DB
          capabilities: game.tags || [],
        },
        capabilities: game.tags || [],
        status: status,

        // Search fields
        gameId: game.gameId,
        tags: game.tags || [],
      };
    })
  );
} catch (error: any) {
  console.error("Error loading games:", error);
  errorMessage = "Không thể kết nối đến máy chủ cơ sở dữ liệu.";
  serverError = true;
}

// Permissions
const hasRole = (role: string) => user?.roles?.includes(role as any) ?? false;
const canUpload = hasRole("dev") || hasRole("admin");

// Stats calculation
const totalGames = games.length;
const totalVersions = games.reduce(
  (sum, g) => sum + (g.versions?.length || 1),
  0
); // Approximation
const errorCount = games.filter(
  (g) => g.status === "qc_failed" || g.status === "archived"
).length;
const stableSystem = errorCount === 0 && !serverError;

function formatDate(date?: Date): string {
  if (!date) return "N/A";
  return new Date(date).toLocaleDateString("vi-VN", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
}
---

<Layout title="Dashboard Quản lý - Iruka Game Hub">
  <!-- Hero Section & Stats -->
  <div class="mb-8 animate-fade-in">
    <div
      class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-6"
    >
      <div>
        <h1
          class="text-2xl font-black text-slate-900 tracking-tight leading-none mb-2"
        >
          Tổng quan hệ thống
        </h1>
        <p class="text-sm font-bold text-slate-500">
          Chào mừng trở lại, <span class="text-indigo-600"
            >{user?.name || "Administrator"}</span
          >
        </p>
      </div>
      {
        canUpload && (
          <a
            href="/upload"
            class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl bg-indigo-600 text-white font-bold text-sm hover:bg-indigo-700 hover:shadow-lg hover:shadow-indigo-500/20 active:scale-95 transition-all"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 4v16m8-8H4"
              />
            </svg>
            Tải Game Mới
          </a>
        )
      }
    </div>

    <!-- 3 KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Card 1 -->
      <div
        class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm flex items-center gap-4"
      >
        <div
          class="w-12 h-12 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
            ></path></svg
          >
        </div>
        <div>
          <p class="text-2xl font-black text-slate-900 leading-none">
            {totalGames}
          </p>
          <p
            class="text-xs font-bold text-slate-400 uppercase tracking-wider mt-1"
          >
            Tổng Game
          </p>
        </div>
      </div>

      <!-- Card 2 -->
      <div
        class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm flex items-center gap-4"
      >
        <div
          class="w-12 h-12 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"
            ></path></svg
          >
        </div>
        <div>
          <p class="text-2xl font-black text-slate-900 leading-none">
            {totalVersions}
          </p>
          <p
            class="text-xs font-bold text-slate-400 uppercase tracking-wider mt-1"
          >
            Phiên bản
          </p>
        </div>
      </div>

      <!-- Card 3 -->
      <div
        class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm flex items-center gap-4"
      >
        <div
          class={`w-12 h-12 rounded-xl flex items-center justify-center ${stableSystem ? "bg-emerald-50 text-emerald-600" : "bg-red-50 text-red-600"}`}
        >
          {
            stableSystem ? (
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
            ) : (
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
            )
          }
        </div>
        <div>
          <p
            class={`text-2xl font-black leading-none ${stableSystem ? "text-emerald-600" : "text-red-600"}`}
          >
            {stableSystem ? "100% Ổn định" : "Có cảnh báo"}
          </p>
          <p
            class="text-xs font-bold text-slate-400 uppercase tracking-wider mt-1"
          >
            {
              stableSystem
                ? "Hệ thống vận hành tốt"
                : `${errorCount} lỗi cần xử lý`
            }
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Search & Toolbar -->
  <div class="mb-8 sticky top-4 z-30">
    <div
      class="bg-white/80 backdrop-blur-md rounded-2xl border border-slate-200 shadow-lg shadow-slate-200/50 p-4"
    >
      <div class="flex flex-col md:flex-row gap-4">
        <!-- Main Search -->
        <div class="flex-1 relative">
          <svg
            class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg
          >
          <input
            type="text"
            id="searchInput"
            placeholder="Tìm kiếm game, ID hoặc người phụ trách..."
            class="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all font-medium text-sm text-slate-900 placeholder:text-slate-400"
          />
        </div>

        <!-- View Toggle -->
        <div
          class="flex bg-slate-100 p-1 rounded-xl shrink-0 self-start md:self-auto"
        >
          <button
            id="gridViewBtn"
            class="p-2.5 rounded-lg bg-white shadow-sm text-indigo-600 transition-all"
            ><svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
              ></path></svg
            ></button
          >
          <button
            id="tableViewBtn"
            class="p-2.5 rounded-lg text-slate-400 hover:text-slate-600 transition-all"
            ><svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"></path></svg
            ></button
          >
        </div>
      </div>

      <!-- Quick Filters Chips (P1) -->
      <div
        class="flex items-center gap-2 mt-4 overflow-x-auto pb-1 scrollbar-hide"
      >
        <button
          class="filter-chip active px-3 py-1.5 rounded-lg text-xs font-bold bg-slate-900 text-white transition-all whitespace-nowrap"
          data-filter="">Tất cả</button
        >
        <button
          class="filter-chip px-3 py-1.5 rounded-lg text-xs font-bold bg-slate-100 text-slate-500 hover:bg-emerald-50 hover:text-emerald-700 transition-all whitespace-nowrap"
          data-filter="production">Production</button
        >
        <button
          class="filter-chip px-3 py-1.5 rounded-lg text-xs font-bold bg-slate-100 text-slate-500 hover:bg-slate-200 hover:text-slate-700 transition-all whitespace-nowrap"
          data-filter="draft">Draft / Review</button
        >
        <button
          class="filter-chip px-3 py-1.5 rounded-lg text-xs font-bold bg-slate-100 text-slate-500 hover:bg-red-50 hover:text-red-700 transition-all whitespace-nowrap"
          data-filter="error">Có lỗi (QC)</button
        >
      </div>
    </div>
  </div>

  <!-- Error State (P0) -->
  {
    errorMessage && (
      <div class="mb-8 p-6 rounded-2xl bg-red-50 text-red-700 border border-red-100 flex items-center gap-4 animate-fade-in">
        <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center shrink-0">
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"
            />
          </svg>
        </div>
        <div>
          <h3 class="font-bold text-lg">
            Hệ thống đang bảo trì hoặc gặp sự cố
          </h3>
          <p class="text-sm opacity-80">{errorMessage}</p>
        </div>
        <button
          onclick="window.location.reload()"
          class="ml-auto px-4 py-2 bg-white rounded-lg text-sm font-bold text-red-600 shadow-sm hover:shadow"
        >
          Thử lại
        </button>
      </div>
    )
  }

  <!-- Loading State (managed by Client JS or simple initial hidden) -->
  <div id="loadingState" class="hidden py-20 text-center">
    <div
      class="inline-block animate-spin w-8 h-8 border-4 border-indigo-200 border-t-indigo-600 rounded-full mb-4"
    >
    </div>
    <p class="text-slate-400 font-bold text-sm">Đang tải dữ liệu...</p>
  </div>

  <!-- Content Grid -->
  <div
    id="gamesGrid"
    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6 animate-fade-in-up"
  >
    {
      games.map((game, idx) => {
        let status = "draft";
        if (game.status === "published") status = "production";
        else if (game.status === "qc_failed" || game.status === "archived")
          status = "error";

        return (
          <div
            class="game-item transition-all duration-500"
            style={`animation-delay: ${idx * 0.05}s`}
            data-game-name={game.title?.toLowerCase()}
            data-game-id={game.id.toLowerCase()}
            data-game-owner={(game.ownerName || "admin").toLowerCase()}
            data-status={status}
          >
            <GameCard game={game} />
          </div>
        );
      })
    }
  </div>

  <!-- Empty State (No Results) -->
  <div
    id="emptyState"
    class="hidden py-24 text-center rounded-3xl bg-slate-50 border border-dashed border-slate-200"
  >
    <div
      class="w-16 h-16 bg-white rounded-2xl shadow-sm flex items-center justify-center mx-auto mb-4 text-slate-300"
    >
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"
        ><path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg
      >
    </div>
    <h3 class="text-lg font-bold text-slate-900 mb-1">
      Không tìm thấy kết quả
    </h3>
    <p class="text-slate-500 text-sm mb-6">
      Thử thay đổi từ khóa hoặc bộ lọc của bạn
    </p>
    <button
      onclick="clearSearch()"
      class="px-6 py-2 bg-white border border-slate-200 rounded-xl text-slate-600 font-bold text-sm hover:border-slate-300 shadow-sm"
      >Xóa bộ lọc</button
    >
  </div>

  <style>
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    .animate-fade-in-up {
      animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>

  <script is:inline>
    // Client-side Filtering Logic
    const searchInput = document.getElementById("searchInput");
    const chips = document.querySelectorAll(".filter-chip");
    const items = document.querySelectorAll(".game-item");
    const emptyState = document.getElementById("emptyState");
    const gridEl = document.getElementById("gamesGrid");

    let currentFilter = "";

    function filterGames() {
      const term = searchInput.value.toLowerCase();
      let visibleCount = 0;

      items.forEach((item) => {
        const name = item.dataset.gameName;
        const id = item.dataset.gameId;
        const owner = item.dataset.gameOwner;
        const status = item.dataset.status;

        const matchSearch =
          name.includes(term) || id.includes(term) || owner.includes(term);
        const matchFilter = currentFilter === "" || status === currentFilter;

        if (matchSearch && matchFilter) {
          item.style.display = "";
          visibleCount++;
        } else {
          item.style.display = "none";
        }
      });

      if (visibleCount === 0) {
        emptyState.classList.remove("hidden");
        gridEl.classList.add("hidden");
      } else {
        emptyState.classList.add("hidden");
        gridEl.classList.remove("hidden");
      }
    }

    searchInput.addEventListener("input", filterGames);

    chips.forEach((chip) => {
      chip.addEventListener("click", () => {
        // Toggle active class
        chips.forEach((c) => {
          c.classList.remove("bg-slate-900", "text-white");
          c.classList.add("bg-slate-100", "text-slate-500");
        });
        chip.classList.remove("bg-slate-100", "text-slate-500");
        chip.classList.add("bg-slate-900", "text-white");

        currentFilter = chip.dataset.filter;
        filterGames();
      });
    });

    window.clearSearch = () => {
      searchInput.value = "";
      chips[0].click(); // Reset to 'All'
    };
  </script>
</Layout>
