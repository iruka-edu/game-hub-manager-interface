---
// @ts-nocheck
import Layout from "../layouts/Layout.astro";
import GameCard from "../components/GameCard.astro";
import { GameRepository } from "../models/Game";
import { GameVersionRepository } from "../models/GameVersion";
import { getUserFromRequest } from "../lib/session";
import type { User } from "../models/User";
import { UserRepository } from "../models/User";

// Check authentication
let user: any = null;
let games: any[] = [];
let errorMessage = "";
let serverError = false;

try {
  user = await getUserFromRequest(Astro.request);

  const gameRepo = await GameRepository.getInstance();
  const versionRepo = await GameVersionRepository.getInstance();
  const userRepo = await UserRepository.getInstance();

  const [allGames, allUsers] = await Promise.all([
    gameRepo.findAll(),
    userRepo.findAll(),
  ]);

  const userMap = new Map(
    allUsers.filter((u) => u && u._id).map((u) => [u._id.toString(), u])
  );

  games = await Promise.all(
    allGames.map(async (game) => {
      let latestVersion = null;
      let status = "draft";
      let activeVer = null;

      // Logic to resolve active version & status
      if (game.latestVersionId) {
        latestVersion = await versionRepo.findById(
          game.latestVersionId.toString()
        );
      } else {
        const versions = await versionRepo.findByGameId(game._id.toString());
        if (versions.length > 0) {
          latestVersion = versions[0];
          await gameRepo.updateLatestVersion(
            game._id.toString(),
            latestVersion._id
          );
        }
      }

      if (latestVersion) {
        status = latestVersion.status;
        activeVer = latestVersion.version;
      }

      const owner = userMap.get(game.ownerId);

      return {
        id: game.gameId,
        title: game.title || game.gameId,
        owner: game.ownerId,
        ownerName: owner?.name || owner?.email.split("@")[0],
        ownerAvatar: owner?.avatar,
        updatedAt:
          latestVersion?.updatedAt?.toISOString() ||
          game.updatedAt?.toISOString() ||
          new Date().toISOString(),
        activeVersion: activeVer || "1.0.0",
        versions: latestVersion
          ? [
              {
                version: activeVer,
                size: latestVersion.buildSize,
              },
            ]
          : [],
        manifest: {
          title: game.title,
          runtime: "iframe-html", // Placeholder, ideally from DB
          capabilities: game.tags || [],
        },
        capabilities: game.tags || [],
        status: status,

        // Search fields
        gameId: game.gameId,
        tags: game.tags || [],
      };
    })
  );
} catch (error: any) {
  const err = error || new Error("Unknown error during initialization");
  console.error("Error loading dashboard:", err);
  errorMessage = "Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß c∆° s·ªü d·ªØ li·ªáu.";
  serverError = true;
}

// Permissions
const hasRole = (role: string) => user?.roles?.includes(role as any) ?? false;
const canUpload = hasRole("dev") || hasRole("admin");

// Stats calculation
const totalGames = games.length;
const totalVersions = games.reduce(
  (sum, g) => sum + (g.versions?.length || 1),
  0
); // Approximation
const errorCount = games.filter(
  (g) => g.status === "qc_failed" || g.status === "archived"
).length;
const stableSystem = errorCount === 0 && !serverError;

function formatDate(date?: any): string {
  if (!date) return "N/A";
  try {
    const d = typeof date === "string" ? new Date(date) : date;
    return d.toLocaleDateString("vi-VN", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    });
  } catch (e) {
    return "N/A";
  }
}
---

<Layout title="Dashboard Qu·∫£n l√Ω - Iruka Game Hub">
  <!-- Compact Header & Status Bar -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-5 animate-fade-in">
    <!-- Header -->
    <div class="flex items-center gap-4">
      <h1 class="text-xl font-bold text-slate-900 tracking-tight">Game Hub Manager</h1>
      <div class="h-4 w-px bg-slate-200"></div>
      <span class="text-sm font-medium text-slate-500">Dashboard ‚Äî {user?.name || "Administrator"}</span>
    </div>
  </div>

  <!-- Compact KPI Status Bar -->
  <div class="mb-6 bg-white rounded-xl border border-slate-200 shadow-sm px-5 py-3 flex flex-wrap items-center gap-x-8 gap-y-2 text-sm animate-fade-in">
    <div class="flex items-center gap-2 text-slate-600">
      <span class="text-lg">üß©</span>
      <span class="font-bold text-slate-900">{totalGames}</span> Game
    </div>
    <div class="w-px h-4 bg-slate-200"></div>
    <div class="flex items-center gap-2 text-slate-600">
      <span class="text-lg">üì¶</span>
      <span class="font-bold text-slate-900">{totalVersions}</span> Phi√™n b·∫£n
    </div>
    <div class="w-px h-4 bg-slate-200"></div>
    <div class="flex items-center gap-2">
      {
        stableSystem ? (
          <>
            <span class="text-lg">‚úÖ</span>
            <span class="font-bold text-emerald-600">H·ªá th·ªëng ·ªïn ƒë·ªãnh 100%</span>
          </>
        ) : (
          <>
            <span class="text-lg">‚ö†Ô∏è</span>
            <span class="font-bold text-red-600">{errorCount} l·ªói c·∫ßn x·ª≠ l√Ω</span>
          </>
        )
      }
    </div>
  </div>

  {totalGames > 0 ? (
    <>
      <!-- Search & Unified Toolbar -->
      <div class="mb-6 sticky top-4 z-30">
        <div class="bg-white/90 backdrop-blur-md rounded-xl border border-slate-200 shadow-sm p-2 flex flex-col md:flex-row items-center gap-2">
          <!-- Main Search -->
          <div class="flex-1 relative w-full md:w-auto">
            <svg
              class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input
              type="text"
              id="searchInput"
              placeholder="T√¨m ki·∫øm game, ID..."
              class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all font-medium text-sm text-slate-900 placeholder:text-slate-400"
            />
          </div>

          <!-- Divider -->
          <div class="hidden md:block w-px h-6 bg-slate-200 mx-1"></div>

          <!-- Quick Filters Chips -->
          <div class="flex items-center gap-1.5 w-full md:w-auto overflow-x-auto pb-1 md:pb-0 scrollbar-hide">
            <button
              class="filter-chip active px-3 py-1.5 rounded-lg text-xs font-bold bg-slate-900 text-white transition-all whitespace-nowrap"
              data-filter="">T·∫•t c·∫£</button
            >
            <button
              class="filter-chip px-3 py-1.5 rounded-lg text-xs font-bold bg-slate-100 text-slate-500 hover:bg-emerald-50 hover:text-emerald-700 transition-all whitespace-nowrap"
              data-filter="production">Live</button
            >
            <button
              class="filter-chip px-3 py-1.5 rounded-lg text-xs font-bold bg-slate-100 text-slate-500 hover:bg-slate-200 hover:text-slate-700 transition-all whitespace-nowrap"
              data-filter="draft">Draft</button
            >
            <button
              class="filter-chip px-3 py-1.5 rounded-lg text-xs font-bold bg-slate-100 text-slate-500 hover:bg-red-50 hover:text-red-700 transition-all whitespace-nowrap"
              data-filter="error">QC L·ªói</button
            >
          </div>

          <!-- Divider -->
          <div class="hidden md:block w-px h-6 bg-slate-200 mx-1"></div>

          <!-- View Toggle -->
          <div class="flex bg-slate-100 p-1 rounded-lg shrink-0 w-full md:w-auto justify-center md:justify-start">
            <button
              id="gridViewBtn"
              class="p-1.5 rounded-md bg-white shadow-sm text-indigo-600 transition-all"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
              </svg>
            </button>
            <button
              id="tableViewBtn"
              class="p-1.5 rounded-md text-slate-400 hover:text-slate-600 transition-all"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </>
  ) : (
    /* Zero Data State */
    <div class="mt-8 mb-12 animate-fade-in">
       <div class="max-w-md mx-auto text-center bg-white rounded-2xl border border-dashed border-slate-300 p-10">
          <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
             <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
             </svg>
          </div>
          <h3 class="text-lg font-bold text-slate-900 mb-2">Ch∆∞a c√≥ game n√†o trong h·ªá th·ªëng</h3>
          <p class="text-slate-500 text-sm mb-6">B·∫Øt ƒë·∫ßu b·∫±ng c√°ch t·∫£i l√™n game ƒë·∫ßu ti√™n c·ªßa b·∫°n ƒë·ªÉ qu·∫£n l√Ω v√† v·∫≠n h√†nh.</p>
          <div class="flex flex-col sm:flex-row gap-3 justify-center">
             <a href="/upload" class="px-5 py-2.5 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700 shadow-sm hover:shadow-md transition-all">
               + T·∫°o Game ƒê·∫ßu Ti√™n
             </a>
             <a href="/docs/guide" class="px-5 py-2.5 bg-white text-slate-700 border border-slate-200 rounded-xl font-bold text-sm hover:bg-slate-50 transition-all">
               Xem h∆∞·ªõng d·∫´n
             </a>
          </div>
       </div>
    </div>
  )}

  <!-- Error State (P0) -->
  {
    errorMessage && (
      <div class="mb-8 p-6 rounded-2xl bg-red-50 text-red-700 border border-red-100 flex items-center gap-4 animate-fade-in">
        <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center shrink-0">
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"
            />
          </svg>
        </div>
        <div>
          <h3 class="font-bold text-lg">
            H·ªá th·ªëng ƒëang b·∫£o tr√¨ ho·∫∑c g·∫∑p s·ª± c·ªë
          </h3>
          <p class="text-sm opacity-80">{errorMessage}</p>
        </div>
        <button
          onclick="window.location.reload()"
          class="ml-auto px-4 py-2 bg-white rounded-lg text-sm font-bold text-red-600 shadow-sm hover:shadow"
        >
          Th·ª≠ l·∫°i
        </button>
      </div>
    )
  }

  <!-- Loading State (managed by Client JS or simple initial hidden) -->
  <div id="loadingState" class="hidden py-20 text-center">
    <div
      class="inline-block animate-spin w-8 h-8 border-4 border-indigo-200 border-t-indigo-600 rounded-full mb-4"
    >
    </div>
    <p class="text-slate-400 font-bold text-sm">ƒêang t·∫£i d·ªØ li·ªáu...</p>
  </div>

  <!-- Content Grid -->
  <div
    id="gamesGrid"
    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6 animate-fade-in-up"
  >
    {
      games.map((game, idx) => {
        let status = "draft";
        if (game.status === "published") status = "production";
        else if (game.status === "qc_failed" || game.status === "archived")
          status = "error";

        return (
          <div
            class="game-item transition-all duration-500"
            style={`animation-delay: ${idx * 0.05}s`}
            data-game-name={game.title?.toLowerCase()}
            data-game-id={game.id.toLowerCase()}
            data-game-owner={(game.ownerName || "admin").toLowerCase()}
            data-status={status}
          >
            <GameCard game={game} />
          </div>
        );
      })
    }
  </div>

  <!-- Empty State (No Results) -->
  <div
    id="emptyState"
    class="hidden py-24 text-center rounded-3xl bg-slate-50 border border-dashed border-slate-200"
  >
    <div
      class="w-16 h-16 bg-white rounded-2xl shadow-sm flex items-center justify-center mx-auto mb-4 text-slate-300"
    >
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"
        ><path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg
      >
    </div>
    <h3 class="text-lg font-bold text-slate-900 mb-1">
      Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£
    </h3>
    <p class="text-slate-500 text-sm mb-6">
      Th·ª≠ thay ƒë·ªïi t·ª´ kh√≥a ho·∫∑c b·ªô l·ªçc c·ªßa b·∫°n
    </p>
    <button
      onclick="clearSearch()"
      class="px-6 py-2 bg-white border border-slate-200 rounded-xl text-slate-600 font-bold text-sm hover:border-slate-300 shadow-sm"
      >X√≥a b·ªô l·ªçc</button
    >
  </div>

  <style>
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    .animate-fade-in-up {
      animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>

  <script is:inline>
    // Client-side Filtering Logic
    const searchInput = document.getElementById("searchInput");
    const chips = document.querySelectorAll(".filter-chip");
    const items = document.querySelectorAll(".game-item");
    const emptyState = document.getElementById("emptyState");
    const gridEl = document.getElementById("gamesGrid");

    const gridBtn = document.getElementById("gridViewBtn");
    const listBtn = document.getElementById("tableViewBtn");

    // --- View Toggle Logic ---
    function setGameView(mode) {
      if (!gridEl) return;
      
      if (mode === "list") {
        gridEl.classList.add("list-view");
        gridEl.classList.remove(
          "md:grid-cols-2",
          "lg:grid-cols-3",
          "xl:grid-cols-3"
        );
        gridEl.classList.add("grid-cols-1");

        // UI Feedback
        if (listBtn && gridBtn) {
            listBtn.classList.add("bg-white", "shadow-sm", "text-indigo-600");
            listBtn.classList.remove("text-slate-400");
            gridBtn.classList.remove("bg-white", "shadow-sm", "text-indigo-600");
            gridBtn.classList.add("text-slate-400");
        }
      } else {
        gridEl.classList.remove("list-view");
        gridEl.classList.add(
          "md:grid-cols-2",
          "lg:grid-cols-3",
          "xl:grid-cols-3"
        );
        gridEl.classList.remove("grid-cols-1");

        // UI Feedback
        if (listBtn && gridBtn) {
            gridBtn.classList.add("bg-white", "shadow-sm", "text-indigo-600");
            gridBtn.classList.remove("text-slate-400");
            listBtn.classList.remove("bg-white", "shadow-sm", "text-indigo-600");
            listBtn.classList.add("text-slate-400");
        }
      }
      localStorage.setItem("gameViewMode", mode);
    }

    if (gridBtn) gridBtn.addEventListener("click", () => setGameView("grid"));
    if (listBtn) listBtn.addEventListener("click", () => setGameView("list"));

    // Initialize View
    const savedView = localStorage.getItem("gameViewMode") || "grid";
    if (gridEl) setGameView(savedView);

    // --- Filtering Logic ---
    let currentFilter = "";

    function filterGames() {
      if (!searchInput) return;
      const term = searchInput.value.toLowerCase();
      let visibleCount = 0;

      items.forEach((item) => {
        const name = item.dataset.gameName;
        const id = item.dataset.gameId;
        const owner = item.dataset.gameOwner;
        const status = item.dataset.status;

        const matchSearch =
          name.includes(term) || id.includes(term) || owner.includes(term);
        const matchFilter = currentFilter === "" || status === currentFilter;

        if (matchSearch && matchFilter) {
          item.style.display = "";
          visibleCount++;
        } else {
          item.style.display = "none";
        }
      });

      if (emptyState && gridEl) {
        if (visibleCount === 0) {
            emptyState.classList.remove("hidden");
            gridEl.classList.add("hidden");
        } else {
            emptyState.classList.add("hidden");
            gridEl.classList.remove("hidden");
        }
      }
    }

    if (searchInput) searchInput.addEventListener("input", filterGames);

    chips.forEach((chip) => {
      chip.addEventListener("click", () => {
        // Toggle active class
        chips.forEach((c) => {
          c.classList.remove("bg-slate-900", "text-white");
          c.classList.add("bg-slate-100", "text-slate-500");
        });
        chip.classList.remove("bg-slate-100", "text-slate-500");
        chip.classList.add("bg-slate-900", "text-white");

        currentFilter = chip.dataset.filter;
        filterGames();
      });
    });

    window.clearSearch = () => {
      if (searchInput) searchInput.value = "";
      if (chips.length > 0) chips[0].click(); // Reset to 'All'
    };
  </script>
</Layout>
