---
import Layout from "../layouts/Layout.astro";
import GameCard from "../components/GameCard.astro";
import { GameRepository } from "../models/Game";
import { GameVersionRepository } from "../models/GameVersion";
import { getUserFromRequest } from "../lib/session";
import type { User } from "../models/User";

// Check authentication
const user = (await getUserFromRequest(Astro.request)) as User | null;

// Fetch games from database (public view)
let games: any[] = [];
let errorMessage = "";

try {
  const gameRepo = await GameRepository.getInstance();
  const versionRepo = await GameVersionRepository.getInstance();
  const userRepo = await UserRepository.getInstance(); // Added

  // Get all games and users
  const [allGames, allUsers] = await Promise.all([
    // Modified
    gameRepo.findAll(),
    userRepo.findAll(),
  ]);

  // Create user map for easy lookup
  const userMap = new Map(allUsers.map((u) => [u._id.toString(), u])); // Added

  games = await Promise.all(
    allGames.map(async (game) => {
      let latestVersion = null;
      let status = "draft";

      // Get latest version
      if (game.latestVersionId) {
        latestVersion = await versionRepo.findById(
          game.latestVersionId.toString()
        );
      } else {
        // Fallback: find most recent version
        const versions = await versionRepo.findByGameId(game._id.toString());
        if (versions.length > 0) {
          latestVersion = versions[0];
          // Update game's latestVersionId for future calls
          await gameRepo.updateLatestVersion(
            game._id.toString(),
            latestVersion._id
          );
        }
      }

      if (latestVersion) {
        status = latestVersion.status;
      }

      // Get owner info
      const owner = userMap.get(game.ownerId); // Added

      // Convert to format compatible with GameCard component
      return {
        id: game.gameId,
        title: game.title || game.gameId,
        owner: game.ownerId, // Will be resolved in GameCard if needed
        ownerName: owner?.name || owner?.email.split("@")[0], // Added
        ownerAvatar: owner?.avatar, // Added
        updatedAt:
          latestVersion?.updatedAt?.toISOString() ||
          game.updatedAt.toISOString(),
        activeVersion: latestVersion?.version || "1.0.0",
        versions: latestVersion
          ? [
              {
                version: latestVersion.version,
                uploadedAt: latestVersion.createdAt.toISOString(),
                size: latestVersion.buildSize,
              },
            ]
          : [],
        entryUrl: latestVersion
          ? `https://storage.googleapis.com/${process.env.GCLOUD_BUCKET_NAME || "iruka-edu-mini-game"}/games/${game.gameId}/${latestVersion.version}/index.html`
          : "",
        manifest: {
          title: game.title || game.gameId,
          runtime: "iframe-html",
          capabilities: game.tags || [],
          disabled: game.disabled || false,
        },
        capabilities: game.tags || [],
        // Status for filtering
        status: status,
        // Additional fields for search/filter
        gameId: game.gameId,
        tags: game.tags || [],
        subject: game.subject,
        grade: game.grade,
        priority: game.priority,
      };
    })
  );
} catch (error: any) {
  console.error("Error loading games:", error);
  errorMessage = error.message || "Không thể tải danh sách game";
}

// Helper to check if user has specific role
const hasRole = (role: string) => user?.roles?.includes(role as any) ?? false;
const isAdmin = hasRole("admin");
const isDev = hasRole("dev");
const canUpload = isDev || isAdmin;

// Role labels for display
const roleLabels: Record<string, string> = {
  dev: "Developer",
  qc: "QC Tester",
  cto: "CTO",
  ceo: "CEO",
  admin: "Administrator",
};
const userRoleDisplay =
  user?.roles?.map((r) => roleLabels[r] || r).join(", ") || "";
---

<Layout title="Game Hub Manager - Bảng điều khiển">
  <!-- Hero Section -->
  <div class="mb-8">
    <div
      class="flex flex-col md:flex-row md:items-center md:justify-between gap-6"
    >
      <div>
        <h1 class="text-3xl font-bold text-slate-900 mb-2">Quản lý Game Hub</h1>
        <p class="text-slate-500">
          Tải lên, quản lý và triển khai mini-games lên Google Cloud Storage.
        </p>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Total Games -->
    <div class="card p-6">
      <div class="flex items-center gap-4">
        <div
          class="w-12 h-12 rounded-lg bg-indigo-100 flex items-center justify-center"
        >
          <svg
            class="w-6 h-6 text-indigo-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
            ></path>
          </svg>
        </div>
        <div>
          <p class="text-2xl font-bold text-slate-900">{games.length}</p>
          <p class="text-slate-500 text-sm">Tổng số game</p>
        </div>
      </div>
    </div>

    <!-- Total Versions -->
    <div class="card p-6">
      <div class="flex items-center gap-4">
        <div
          class="w-12 h-12 rounded-lg bg-emerald-100 flex items-center justify-center"
        >
          <svg
            class="w-6 h-6 text-emerald-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 12l2 2 4-4"
            ></path>
          </svg>
        </div>
        <div>
          <p class="text-2xl font-bold text-slate-900">
            {games.reduce((sum, g) => sum + (g.versions?.length || 0), 0)}
          </p>
          <p class="text-slate-500 text-sm">Tổng số phiên bản</p>
        </div>
      </div>
    </div>

    <!-- System Status -->
    <div class="card p-6">
      <div class="flex items-center gap-4">
        <div
          class="w-12 h-12 rounded-lg bg-green-100 flex items-center justify-center"
        >
          <svg
            class="w-6 h-6 text-green-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <div>
          <p class="text-2xl font-bold text-green-600">Ổn định</p>
          <p class="text-slate-500 text-sm">Không có lỗi trong 24h</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Filter -->
  <div class="card p-6 mb-8">
    <div class="flex flex-col md:flex-row gap-6">
      <!-- Search -->
      <div class="flex-1">
        <div class="relative">
          <svg
            class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <input
            type="text"
            id="searchInput"
            placeholder="Tìm kiếm game theo tên, ID hoặc người phụ trách..."
            class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm"
          />
        </div>
      </div>

      <!-- Filter and Toggle -->
      <div class="flex flex-wrap items-center gap-3">
        <select
          id="statusFilter"
          class="px-4 py-2.5 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm bg-white"
        >
          <option value="">Tất cả trạng thái</option>
          <option value="production">Đang chạy (Production)</option>
          <option value="draft">Bản nháp / Chưa chạy</option>
          <option value="error">Có lỗi</option>
        </select>

        <select
          id="sortBy"
          class="px-4 py-2.5 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm bg-white"
        >
          <option value="updated">Mới cập nhật</option>
          <option value="name">Tên A-Z</option>
          <option value="created">Mới tạo</option>
        </select>

        <div class="h-8 w-px bg-slate-200 mx-1"></div>

        <!-- View Toggle -->
        <div class="flex bg-slate-100 p-1 rounded-xl">
          <button
            id="gridViewBtn"
            class="p-1.5 rounded-lg bg-white shadow-sm text-indigo-600 transition-all"
            title="Dạng lưới"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
              ></path>
            </svg>
          </button>
          <button
            id="tableViewBtn"
            class="p-1.5 rounded-lg text-slate-500 hover:text-indigo-600 transition-all"
            title="Dạng bảng"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  {
    errorMessage && (
      <div class="mb-8 p-4 rounded-lg bg-red-50 text-red-700 border border-red-200">
        <p class="flex items-center gap-2 text-sm font-medium">
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          {errorMessage}
        </p>
      </div>
    )
  }

  <!-- Games Grid -->
  {
    games.length > 0 ? (
      <div id="gridView" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {games.map((game, index) => {
          // Map version status to filter status
          let filterStatus = "draft";
          if (game.status === "published") {
            filterStatus = "production";
          } else if (
            game.status === "qc_failed" ||
            game.status === "archived"
          ) {
            filterStatus = "error";
          } else {
            filterStatus = "draft";
          }

          return (
            <div
              class="game-card-wrapper"
              style={`animation-delay: ${index * 0.1}s`}
              data-game-name={game.title?.toLowerCase()}
              data-game-id={game.id.toLowerCase()}
              data-game-runtime={game.manifest?.runtime || ""}
              data-game-owner={(game.ownerName || game.owner || 'admin').toLowerCase()}
              data-game-status={filterStatus}
              data-updated-at={game.updatedAt}
            >
              <GameCard game={game} />
            </div>
          );
        })}
      </div>

      <!-- Table View -->
      <div id="tableView" class="hidden card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr>
                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-widest">Game</th>
                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-widest">ID</th>
                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-widest">Env</th>
                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-widest">Version</th>
                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-widest">Cập nhật</th>
                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-widest">Owner</th>
                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-widest text-right">Thao tác</th>
              </tr>
            </thead>
            <tbody id="tableBody" class="divide-y divide-slate-100">
              {games.map((game) => {
                let filterStatus = 'draft';
                if (game.status === 'published') filterStatus = 'production';
                else if (game.status === 'qc_failed' || game.status === 'archived') filterStatus = 'error';

                return (
                  <tr
                    class="game-row hover:bg-slate-50 transition-colors group"
                    data-game-name={game.title?.toLowerCase()}
                    data-game-id={game.id.toLowerCase()}
                    data-game-runtime={game.manifest?.runtime || ''}
                    data-game-owner={(game.ownerName || game.owner || 'admin').toLowerCase()}
                    data-game-status={filterStatus}
                    data-updated-at={game.updatedAt}
                  >
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-600 font-bold text-xs uppercase">
                          {game.title?.charAt(0)}
                        </div>
                        <span class="font-bold text-slate-900">{game.title}</span>
                      </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-slate-400">
                      {game.id}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class={`inline-flex items-center px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider ${
                        filterStatus === 'production'
                          ? 'bg-emerald-50 text-emerald-700'
                          : filterStatus === 'error'
                          ? 'bg-red-50 text-red-700'
                          : 'bg-amber-50 text-amber-700'
                      }`}>
                        {filterStatus === 'production' ? 'PROD' : filterStatus === 'error' ? 'ERR' : 'DRAFT'}
                      </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                      v{game.activeVersion}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
                      {formatDate(new Date(game.updatedAt))}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="flex items-center gap-2">
                        {game.ownerAvatar ? (
                          <img src={game.ownerAvatar} class="w-6 h-6 rounded-full" />
                        ) : (
                          <div class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-[10px] font-bold text-slate-500">
                            {(game.ownerName || game.owner || 'A').charAt(0).toUpperCase()}
                          </div>
                        )}
                        <span class="text-sm text-slate-600">{game.ownerName || game.owner || 'Admin'}</span>
                      </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                      <div class="flex items-center justify-end gap-2">
                        <a href={`/play/${game.id}`} class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors" title="Play">
                          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        </a>
                        <a href={`/games/${game.id}`} class="p-2 text-slate-400 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors" title="Details">
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </a>
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>
    ) : (
      !errorMessage && (
        <div class="card p-16 text-center">
          <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-slate-200 flex items-center justify-center">
            <svg
              class="w-10 h-10 text-slate-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
              />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-slate-900 mb-2">
            Chưa có game nào
          </h3>
          <p class="text-slate-500 mb-6">
            Tải game đầu tiên của bạn để bắt đầu
          </p>
          {canUpload ? (
            <a
              href="/upload"
              class="inline-flex items-center gap-2 px-6 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition-colors text-sm"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4v16m8-8H4"
                />
              </svg>
              Tải Game Đầu Tiên
            </a>
          ) : (
            <a
              href="/login"
              class="inline-flex items-center gap-2 px-6 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition-colors text-sm"
            >
              Đăng nhập để tải game
            </a>
          )}
        </div>
      )
    )
  }

  <!-- No Results Message -->
  <div id="noResults" class="hidden card p-16 text-center">
    <div
      class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-slate-200 flex items-center justify-center"
    >
      <svg
        class="w-10 h-10 text-slate-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="1.5"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
    </div>
    <h3 class="text-xl font-bold text-slate-900 mb-2">Không tìm thấy game</h3>
    <p class="text-slate-500 mb-6">Thử thay đổi từ khóa tìm kiếm hoặc bộ lọc</p>
    <button
      id="clearFilters"
      class="inline-flex items-center gap-2 px-6 py-3 rounded-lg bg-slate-600 hover:bg-slate-700 text-white font-semibold transition-colors text-sm"
    >
      <svg
        class="w-5 h-5"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
        ></path>
      </svg>
      Xóa bộ lọc
    </button>
  </div>

  <script>
    // View Toggling
  const gridViewBtn = document.getElementById('gridViewBtn');
  const tableViewBtn = document.getElementById('tableViewBtn');
  const gridView = document.getElementById('gridView');
  const tableView = document.getElementById('tableView');

  let currentView = localStorage.getItem('gameViewMode') || 'grid';

  function updateViewMode(mode: string) {
    currentView = mode;
    localStorage.setItem('gameViewMode', mode);
    
    if (mode === 'grid') {
      gridView?.classList.remove('hidden');
      tableView?.classList.add('hidden');
      gridViewBtn?.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
      gridViewBtn?.classList.remove('text-slate-500');
      tableViewBtn?.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
      tableViewBtn?.classList.add('text-slate-500');
    } else {
      gridView?.classList.add('hidden');
      tableView?.classList.remove('hidden');
      tableViewBtn?.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
      tableViewBtn?.classList.remove('text-slate-500');
      gridViewBtn?.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
      gridViewBtn?.classList.add('text-slate-500');
    }
    filterAndSort(); // Re-apply filters and visibility after view change
  }

  gridViewBtn?.addEventListener('click', () => updateViewMode('grid'));
  tableViewBtn?.addEventListener('click', () => updateViewMode('table'));
  updateViewMode(currentView);

  // Search and Filter functionality
  const searchInput = document.getElementById('searchInput') as HTMLInputElement;
  const statusFilter = document.getElementById('statusFilter') as HTMLSelectElement;
  const sortBy = document.getElementById('sortBy') as HTMLSelectElement;
  const noResults = document.getElementById('noResults') as HTMLElement;
  const clearFilters = document.getElementById('clearFilters') as HTMLButtonElement;

  function filterAndSort() {
    const searchTerm = searchInput?.value.toLowerCase() || '';
    const statusValue = statusFilter?.value || '';
    const sortValue = sortBy?.value || 'updated';

    const gridCards = Array.from(document.querySelectorAll('.game-card-wrapper')) as HTMLElement[];
    const tableRows = Array.from(document.querySelectorAll('.game-row')) as HTMLElement[];

    function processItems(items: HTMLElement[]) {
      const filtered = items.filter(item => {
        const gameName = item.dataset.gameName || '';
        const gameId = item.dataset.gameId || '';
        const gameRuntime = item.dataset.gameRuntime || '';
        const gameOwner = item.dataset.gameOwner || '';
        const gameStatus = item.dataset.gameStatus || '';
        
        const matchesSearch = !searchTerm || 
          gameName.includes(searchTerm) || 
          gameId.includes(searchTerm) ||
          gameRuntime.includes(searchTerm) ||
          gameOwner.includes(searchTerm);

        const matchesStatus = !statusValue || gameStatus === statusValue;

        return matchesSearch && matchesStatus;
      });

      filtered.sort((a, b) => {
        const aName = a.dataset.gameName || '';
        const bName = b.dataset.gameName || '';
        const aUpdated = a.dataset.updatedAt || '';
        const bUpdated = b.dataset.updatedAt || '';
        
        switch (sortValue) {
          case 'name': return aName.localeCompare(bName);
          case 'created':
          case 'updated': return new Date(bUpdated).getTime() - new Date(aUpdated).getTime();
          default: return 0;
        }
      });

      // Update visibility and order
      items.forEach(item => item.classList.add('hidden'));
      filtered.forEach((item, index) => {
        item.classList.remove('hidden');
        if (item.classList.contains('game-card-wrapper')) {
          item.style.animationDelay = `${index * 0.05}s`;
          (item.parentElement as HTMLElement).appendChild(item); // Reorder in DOM
        } else {
          (item.parentElement as HTMLElement).appendChild(item); // Reorder rows
        }
      });

      return filtered.length;
    }

    const gridMatches = processItems(gridCards);
    const tableMatches = processItems(tableRows);
    
    const hasMatches = gridMatches > 0;

    if (noResults) noResults.classList.toggle('hidden', hasMatches);
    if (gridView) gridView.classList.toggle('hidden', currentView !== 'grid' || !hasMatches);
    if (tableView) tableView.classList.toggle('hidden', currentView !== 'table' || !hasMatches);
  }

  function clearAllFilters() {
    if (searchInput) searchInput.value = '';
    if (statusFilter) statusFilter.value = '';
    if (sortBy) sortBy.value = 'updated';
    filterAndSort();
  }

  searchInput?.addEventListener('input', filterAndSort);
  statusFilter?.addEventListener('change', filterAndSort);
  sortBy?.addEventListener('change', filterAndSort);
  clearFilters?.addEventListener('click', clearAllFilters);

  filterAndSort();
  </script>
</Layout>
