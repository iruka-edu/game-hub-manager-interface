---
import Layout from "../layouts/Layout.astro";
import GameCard from "../components/GameCard.astro";
import { RegistryManager } from "../lib/registry";

// Fetch games from registry
let games: any[] = [];
let errorMessage = "";

try {
  const registry = await RegistryManager.get();
  games = registry.games;
} catch (error: any) {
  errorMessage = error.message || "Không thể tải danh sách game";
}
---

<Layout title="Game Hub Manager - Bảng điều khiển">
  <!-- Hero Section -->
  <div class="mb-10">
    <div
      class="flex flex-col md:flex-row md:items-center md:justify-between gap-6"
    >
      <div>
        <h1 class="text-3xl font-bold text-slate-900 mb-2">Quản lý Game Hub</h1>
        <p class="text-slate-500">
          Tải lên, quản lý và triển khai mini-games lên Google Cloud Storage.
        </p>
      </div>

      <a
        href="/upload"
        class="btn-primary px-6 py-3 rounded-lg font-semibold text-white flex items-center gap-2 shadow-sm whitespace-nowrap text-sm"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 4v16m8-8H4"></path>
        </svg>
        Tải Game Mới
      </a>
    </div>
  </div>

  <!-- Stats Bar -->
  <div class="card p-6 mb-10">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="text-center md:text-left">
        <p class="text-3xl font-bold text-indigo-600">{games.length}</p>
        <p class="text-slate-500 text-sm mt-1">Tổng số game</p>
      </div>
      <div class="text-center md:text-left">
        <p class="text-3xl font-bold text-emerald-600">
          {games.reduce((sum, g) => sum + (g.versions?.length || 0), 0)}
        </p>
        <p class="text-slate-500 text-sm mt-1">Tổng số phiên bản</p>
      </div>
      <div class="text-center md:text-left">
        <p class="text-3xl font-bold text-slate-900">Hoạt động</p>
        <p class="text-slate-500 text-sm mt-1">Trạng thái Registry</p>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  {
    errorMessage && (
      <div class="mb-8 p-4 rounded-lg bg-red-50 text-red-700 border border-red-200">
        <p class="flex items-center gap-2 text-sm font-medium">
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          {errorMessage}
        </p>
      </div>
    )
  }

  <!-- Games Grid -->
  {
    games.length > 0 ? (
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {games.map((game, index) => (
          <div style={`animation-delay: ${index * 0.1}s`}>
            <GameCard game={game} />
          </div>
        ))}
      </div>
    ) : (
      !errorMessage && (
        <div class="card p-16 text-center">
          <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-slate-100 flex items-center justify-center">
            <svg
              class="w-10 h-10 text-slate-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
              />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-slate-900 mb-2">
            Chưa có game nào
          </h3>
          <p class="text-slate-500 mb-6">
            Tải game đầu tiên của bạn để bắt đầu
          </p>
          <a
            href="/upload"
            class="inline-flex items-center gap-2 px-6 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition-colors text-sm"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 4v16m8-8H4"
              />
            </svg>
            Tải Game Đầu Tiên
          </a>
        </div>
      )
    )
  }
</Layout>
