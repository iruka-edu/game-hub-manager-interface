---
import Layout from '../layouts/Layout.astro';

// Check if already logged in
import { getUserFromRequest } from '../lib/session';
const user = await getUserFromRequest(Astro.request);

// Get redirect parameter
const redirectParam = Astro.url.searchParams.get('redirect');

// Validate redirect URL (must be internal path)
function isValidRedirect(url: string | null): boolean {
  if (!url) return false;
  // Must start with / and not be //
  return url.startsWith('/') && !url.startsWith('//');
}

const redirectUrl = isValidRedirect(redirectParam) ? redirectParam : '/console';

if (user) {
  return Astro.redirect(redirectUrl);
}
---

<Layout title="Đăng nhập - Game Hub Manager">
  <div class="min-h-[60vh] flex items-center justify-center">
    <div class="w-full max-w-md">
      <div class="card p-8">
        <div class="text-center mb-8">
          <div class="w-16 h-16 rounded-xl bg-indigo-600 flex items-center justify-center mx-auto mb-4 shadow-lg">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-slate-900">Đăng nhập</h1>
          <p class="text-slate-500 mt-2">Nhập email và mật khẩu để tiếp tục</p>
        </div>

        <form id="loginForm" class="space-y-6">
          <input type="hidden" id="redirectUrl" value={redirectUrl} />
          
          <div>
            <label for="email" class="block text-sm font-medium text-slate-700 mb-2">
              Email
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              placeholder="dev@iruka.com"
              class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-colors"
            />
          </div>

          <div>
            <label for="password" class="block text-sm font-medium text-slate-700 mb-2">
              Mật khẩu
            </label>
            <input
              type="password"
              id="password"
              name="password"
              required
              placeholder="••••••••"
              class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-colors"
            />
          </div>

          <div id="errorMessage" class="hidden p-3 rounded-lg bg-red-50 text-red-700 text-sm">
          </div>

          <button
            type="submit"
            class="w-full btn-primary text-white py-3 rounded-lg font-medium"
          >
            Đăng nhập
          </button>
        </form>

        <div class="mt-6 pt-6 border-t border-slate-200">
          <p class="text-sm text-slate-500 text-center mb-3">Test accounts (password: role123):</p>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <button type="button" class="quick-login px-3 py-2 rounded bg-slate-100 hover:bg-slate-200 text-slate-700" data-email="dev@iruka.com" data-password="dev123">dev@iruka.com</button>
            <button type="button" class="quick-login px-3 py-2 rounded bg-slate-100 hover:bg-slate-200 text-slate-700" data-email="qc@iruka.com" data-password="qc123">qc@iruka.com</button>
            <button type="button" class="quick-login px-3 py-2 rounded bg-slate-100 hover:bg-slate-200 text-slate-700" data-email="cto@iruka.com" data-password="cto123">cto@iruka.com</button>
            <button type="button" class="quick-login px-3 py-2 rounded bg-slate-100 hover:bg-slate-200 text-slate-700" data-email="admin@iruka.com" data-password="admin123">admin@iruka.com</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>


<script>
  const form = document.getElementById('loginForm') as HTMLFormElement;
  const emailInput = document.getElementById('email') as HTMLInputElement;
  const passwordInput = document.getElementById('password') as HTMLInputElement;
  const errorMessage = document.getElementById('errorMessage') as HTMLDivElement;
  const quickLoginButtons = document.querySelectorAll('.quick-login');
  const redirectUrlInput = document.getElementById('redirectUrl') as HTMLInputElement;

  // Get redirect URL from hidden input (set by server)
  const redirectUrl = redirectUrlInput?.value || '/console';

  async function login(email: string, password: string) {
    errorMessage.classList.add('hidden');
    
    try {
      const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password }),
      });

      const data = await response.json();

      if (response.ok) {
        // Redirect to the original destination or default to /console
        window.location.href = redirectUrl;
      } else {
        errorMessage.textContent = data.error || 'Đăng nhập thất bại';
        errorMessage.classList.remove('hidden');
      }
    } catch (error) {
      errorMessage.textContent = 'Lỗi kết nối. Vui lòng thử lại.';
      errorMessage.classList.remove('hidden');
    }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    await login(emailInput.value, passwordInput.value);
  });

  quickLoginButtons.forEach(button => {
    button.addEventListener('click', async () => {
      const email = (button as HTMLButtonElement).dataset.email;
      const password = (button as HTMLButtonElement).dataset.password;
      if (email && password) {
        emailInput.value = email;
        passwordInput.value = password;
        await login(email, password);
      }
    });
  });
</script>
