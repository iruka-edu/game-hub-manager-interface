---
import Layout from '../../../layouts/Layout.astro';
import { RegistryManager } from '../../../lib/registry';

const { id } = Astro.params;

// Find game in registry
let game = null;
let error = null;

try {
  const registry = await RegistryManager.get();
  game = registry.games.find(g => g.id === id);
  
  if (!game) {
    error = `Game "${id}" không tồn tại trong registry`;
  }
} catch (err) {
  console.error('Failed to load game:', err);
  error = 'Không thể tải thông tin game';
}
---

<Layout title={game ? `${game.title} - Quản lý phiên bản` : 'Game không tìm thấy'}>
  <div class="min-h-screen bg-slate-50 py-8">
    <div class="max-w-4xl mx-auto px-4">
      <!-- Header -->
      <div class="mb-8">
        <div class="flex items-center gap-4 mb-4">
          <a 
            href="/" 
            class="text-slate-500 hover:text-slate-900 transition-colors flex items-center gap-2 text-sm font-medium"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Quay lại Dashboard
          </a>
        </div>
        
        {game ? (
          <div>
            <h1 class="text-3xl font-bold text-slate-900 mb-2">{game.title}</h1>
            <p class="text-slate-500 font-mono text-sm">{game.id}</p>
            <div class="flex items-center gap-4 mt-4">
              <span class="px-3 py-1 rounded-full text-sm font-medium bg-green-50 text-green-700 border border-green-200">
                Đang chạy: v{game.activeVersion}
              </span>
              <span class="text-slate-500 text-sm">
                {game.versions.length} phiên bản
              </span>
            </div>
          </div>
        ) : (
          <div>
            <h1 class="text-3xl font-bold text-slate-900 mb-2">Game không tìm thấy</h1>
            <p class="text-slate-500">{error}</p>
          </div>
        )}
      </div>

      {game ? (
        <div class="space-y-6">
          <!-- Version Management -->
          <div class="card p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-semibold text-slate-900 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Quản lý phiên bản
              </h2>
              <a
                href={`/games/${game.id}/new-version`}
                class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white font-semibold transition-colors text-sm"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Phiên bản mới
              </a>
            </div>
            
            <div class="space-y-3">
              {game.versions.slice().reverse().map((versionInfo) => {
                const isActive = versionInfo.version === game.activeVersion;
                const CDN_BASE = `https://storage.googleapis.com/${import.meta.env.GCLOUD_BUCKET_NAME || 'iruka-edu-mini-game'}`;
                
                return (
                  <div class="flex items-center justify-between py-4 px-4 rounded-lg bg-slate-50 hover:bg-slate-100 transition-colors">
                    <!-- Version Info -->
                    <div class="flex items-center gap-4 flex-1 min-w-0">
                      <div class={`w-3 h-3 rounded-full shrink-0 ${isActive ? "bg-green-500" : "bg-slate-300"}`}></div>
                      <div class="min-w-0 flex-1">
                        <div class="flex items-center gap-3">
                          <span class="font-mono text-lg text-slate-900 font-semibold">
                            v{versionInfo.version}
                          </span>
                          {isActive && (
                            <span class="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700 border border-green-200">
                              Đang chạy
                            </span>
                          )}
                        </div>
                        <div class="flex items-center gap-3 text-sm text-slate-500 mt-1">
                          <span>Tải lên: {new Date(versionInfo.uploadedAt).toLocaleDateString('vi-VN')}</span>
                          {versionInfo.size && (
                            <>
                              <span>•</span>
                              <span>{Math.round(versionInfo.size / 1024)} KB</span>
                            </>
                          )}
                          {versionInfo.changelog && (
                            <>
                              <span>•</span>
                              <span class="truncate max-w-48" title={versionInfo.changelog}>
                                {versionInfo.changelog}
                              </span>
                            </>
                          )}
                        </div>
                      </div>
                    </div>

                    <!-- Version Actions -->
                    <div class="flex items-center gap-2 shrink-0">
                      <a
                        href={`/play/${game.id}?v=${versionInfo.version}`}
                        class="px-3 py-2 text-sm font-medium text-indigo-600 hover:text-indigo-700 border border-indigo-200 rounded-md hover:bg-indigo-50 transition-colors"
                        title="Chơi phiên bản này"
                      >
                        Chơi
                      </a>
                      
                      <a
                        href={`${CDN_BASE}/games/${game.id}/${versionInfo.version}/index.html`}
                        target="_blank"
                        class="px-3 py-2 text-sm font-medium text-slate-600 hover:text-slate-700 rounded-md hover:bg-slate-200 transition-colors"
                        title="Xem trực tiếp"
                      >
                        Xem
                      </a>
                      
                      {!isActive && (
                        <button
                          class="set-active-btn px-3 py-2 text-sm font-medium text-emerald-600 hover:text-emerald-700 border border-emerald-200 rounded-md hover:bg-emerald-50 transition-colors"
                          data-game-id={game.id}
                          data-version={versionInfo.version}
                        >
                          Kích hoạt
                        </button>
                      )}
                      
                      {isActive ? (
                        <button
                          class="px-3 py-2 text-sm font-medium text-slate-400 rounded-md cursor-not-allowed"
                          disabled
                          title="Không thể xóa phiên bản đang chạy"
                        >
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                          </svg>
                        </button>
                      ) : (
                        <button
                          class="delete-version-btn px-3 py-2 text-sm font-medium text-red-600 hover:text-red-700 rounded-md hover:bg-red-50 transition-colors"
                          data-game-id={game.id}
                          data-version={versionInfo.version}
                          title="Xóa phiên bản"
                        >
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                          </svg>
                        </button>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          <!-- Game Info -->
          <div class="card p-6">
            <h2 class="text-xl font-semibold text-slate-900 mb-4">Thông tin Game</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div>
                <span class="font-medium text-slate-700">Game ID:</span>
                <span class="ml-2 font-mono text-slate-900">{game.id}</span>
              </div>
              <div>
                <span class="font-medium text-slate-700">Runtime:</span>
                <span class="ml-2 text-slate-900">{game.manifest?.runtime || 'iframe-html'}</span>
              </div>
              <div>
                <span class="font-medium text-slate-700">Cập nhật lần cuối:</span>
                <span class="ml-2 text-slate-900">{new Date(game.updatedAt).toLocaleDateString('vi-VN')}</span>
              </div>
              <div>
                <span class="font-medium text-slate-700">Người phụ trách:</span>
                <span class="ml-2 text-slate-900">{game.owner || 'Admin'}</span>
              </div>
            </div>
            
            {game.capabilities && game.capabilities.length > 0 && (
              <div class="mt-4">
                <span class="font-medium text-slate-700 block mb-2">Capabilities:</span>
                <div class="flex flex-wrap gap-2">
                  {game.capabilities.map((cap) => (
                    <span class="px-2.5 py-1 rounded-md text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200">
                      {cap}
                    </span>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      ) : (
        <div class="card p-8 text-center">
          <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-slate-200 flex items-center justify-center">
            <svg class="w-10 h-10 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h2 class="text-xl font-bold text-slate-900 mb-2">Game không tồn tại</h2>
          <p class="text-slate-500 mb-6">{error}</p>
          <a 
            href="/" 
            class="inline-flex items-center gap-2 px-6 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition-colors text-sm"
          >
            Quay lại Dashboard
          </a>
        </div>
      )}
    </div>
  </div>
</Layout>

<script>
  // Set Active Version
  document.querySelectorAll(".set-active-btn").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      const gameId = target.dataset.gameId;
      const version = target.dataset.version;

      if (
        !confirm(
          `Bạn có chắc muốn kích hoạt phiên bản v${version}?\n\nGame Hub sẽ chuyển sang sử dụng phiên bản này.`
        )
      ) {
        return;
      }

      target.textContent = "Đang xử lý...";
      target.disabled = true;

      try {
        const res = await fetch("/api/games/set-active", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ gameId, version }),
        });

        const data = await res.json();

        if (res.ok) {
          window.location.reload();
        } else {
          alert("Lỗi: " + (data.error || "Không thể kích hoạt phiên bản"));
          target.textContent = "Kích hoạt";
          target.disabled = false;
        }
      } catch (err) {
        alert("Lỗi kết nối mạng");
        target.textContent = "Kích hoạt";
        target.disabled = false;
      }
    });
  });

  // Delete Version
  document.querySelectorAll(".delete-version-btn").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      const gameId = target.dataset.gameId;
      const version = target.dataset.version;

      if (
        !confirm(
          `Bạn có chắc muốn xóa phiên bản v${version}?\n\nHành động này sẽ xóa vĩnh viễn tất cả file của phiên bản này và không thể hoàn tác.`
        )
      ) {
        return;
      }

      const originalHTML = target.innerHTML;
      target.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>';
      target.disabled = true;

      try {
        const res = await fetch(
          `/api/games/delete?id=${gameId}&version=${version}`,
          {
            method: "DELETE",
          }
        );

        const data = await res.json();

        if (res.ok) {
          window.location.reload();
        } else {
          alert("Xóa thất bại: " + (data.error || "Lỗi không xác định"));
          target.innerHTML = originalHTML;
          target.disabled = false;
        }
      } catch (err) {
        alert("Xóa thất bại: Lỗi kết nối mạng");
        target.innerHTML = originalHTML;
        target.disabled = false;
      }
    });
  });
</script>