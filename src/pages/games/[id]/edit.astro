---
import Layout from '../../../layouts/Layout.astro';
import { RegistryManager } from '../../../lib/registry';

const { id } = Astro.params;

// Find game in registry
let game = null;
let error = null;

try {
  const registry = await RegistryManager.get();
  game = registry.games.find(g => g.id === id);
  
  if (!game) {
    error = `Game "${id}" kh√¥ng t·ªìn t·∫°i trong registry`;
  }
} catch (err) {
  console.error('Failed to load game:', err);
  error = 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin game';
}

// Available capabilities
const AVAILABLE_CAPABILITIES = [
  { id: 'score', label: 'Score', icon: 'üéØ' },
  { id: 'save-progress', label: 'Save Progress', icon: 'üíæ' },
  { id: 'levels', label: 'Levels', icon: 'üéÆ' },
  { id: 'hints', label: 'Hints', icon: 'üí°' },
  { id: 'audio', label: 'Audio', icon: 'üîä' },
  { id: 'telemetry', label: 'Telemetry', icon: 'üìä' },
  { id: 'leaderboard', label: 'Leaderboard', icon: 'üèÜ' }
];
---

<Layout title={game ? `S·ª≠a ${game.title}` : 'Game kh√¥ng t√¨m th·∫•y'}>
  <div class="min-h-screen bg-slate-50 py-8">
    <div class="max-w-4xl mx-auto px-4">
      <!-- Header -->
      <div class="mb-8">
        <div class="flex items-center gap-4 mb-4">
          <a 
            href={game ? `/games/${game.id}` : '/'} 
            class="text-slate-500 hover:text-slate-900 transition-colors flex items-center gap-2 text-sm font-medium"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            {game ? 'Quay l·∫°i th√¥ng tin game' : 'Quay l·∫°i Dashboard'}
          </a>
        </div>
        
        {game ? (
          <div>
            <h1 class="text-3xl font-bold text-slate-900 mb-2">S·ª≠a th√¥ng tin Game</h1>
            <p class="text-slate-500 font-mono text-sm">{game.id}</p>
          </div>
        ) : (
          <div>
            <h1 class="text-3xl font-bold text-slate-900 mb-2">Game kh√¥ng t√¨m th·∫•y</h1>
            <p class="text-slate-500">{error}</p>
          </div>
        )}
      </div>

      {game ? (
        <form id="editGameForm" class="space-y-6">
          <!-- Basic Information -->
          <div class="card p-6">
            <h2 class="text-xl font-semibold text-slate-900 mb-4">Th√¥ng tin c∆° b·∫£n</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-600 mb-2">Game ID *</label>
                <input
                  type="text"
                  id="gameId"
                  value={game.id}
                  disabled
                  class="w-full bg-slate-100 border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-500 cursor-not-allowed"
                />
                <p class="text-xs text-slate-500 mt-1">Game ID kh√¥ng th·ªÉ thay ƒë·ªïi</p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-600 mb-2">T√™n hi·ªÉn th·ªã *</label>
                <input
                  type="text"
                  id="gameTitle"
                  value={game.title}
                  class="w-full bg-white border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  placeholder="T√™n game hi·ªÉn th·ªã"
                />
                <p class="text-xs text-slate-500 mt-1">3-40 k√Ω t·ª±, Title Case, kh√¥ng emoji</p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-600 mb-2">Runtime *</label>
                <select
                  id="gameRuntime"
                  class="w-full bg-white border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                >
                  <option value="iframe-html" selected={game.manifest?.runtime === 'iframe-html' || !game.manifest?.runtime}>iframe-html - Game web th√¥ng th∆∞·ªùng</option>
                  <option value="esm-module" selected={game.manifest?.runtime === 'esm-module'}>esm-module - Module JavaScript</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-600 mb-2">Ng∆∞·ªùi ph·ª• tr√°ch</label>
                <input
                  type="text"
                  id="gameOwner"
                  value={game.owner || ''}
                  class="w-full bg-white border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  placeholder="T√™n ng∆∞·ªùi ph·ª• tr√°ch"
                />
              </div>
            </div>
          </div>

          <!-- Capabilities -->
          <div class="card p-6">
            <h2 class="text-xl font-semibold text-slate-900 mb-4">T√≠nh nƒÉng Game</h2>
            <div class="mb-4">
              <label class="block text-sm font-medium text-slate-600 mb-2">Capabilities</label>
              <div id="capabilitiesSelector" class="flex flex-wrap gap-2">
                <!-- Capability tags will be rendered here -->
              </div>
              <p class="text-xs text-slate-500 mt-2">Ch·ªçn c√°c kh·∫£ nƒÉng game s·ª≠ d·ª•ng (c√≥ th·ªÉ ch·ªçn nhi·ªÅu)</p>
              
              <!-- Hidden elements to store initial capabilities -->
              {game.capabilities && game.capabilities.map((cap) => (
                <span data-initial-capability={cap} class="hidden"></span>
              ))}
            </div>
          </div>

          <!-- URLs -->
          <div class="card p-6">
            <h2 class="text-xl font-semibold text-slate-900 mb-4">Li√™n k·∫øt</h2>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-600 mb-2">Entry URL</label>
                <input
                  type="url"
                  id="entryUrl"
                  value={game.entryUrl}
                  disabled
                  class="w-full bg-slate-100 border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-500 cursor-not-allowed font-mono"
                />
                <p class="text-xs text-slate-500 mt-1">Entry URL ƒë∆∞·ª£c t·ª± ƒë·ªông t·∫°o d·ª±a tr√™n Game ID v√† phi√™n b·∫£n</p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-600 mb-2">Icon URL</label>
                <input
                  type="url"
                  id="iconUrl"
                  value={game?.manifest?.iconUrl ?? ''}
                  class="w-full bg-white border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-mono"
                  placeholder="https://example.com/icon.png"
                />
                <p class="text-xs text-slate-500 mt-1">URL ƒë·∫øn icon game (PNG, JPG, WebP, SVG)</p>
              </div>
            </div>
          </div>

          <!-- Advanced Settings -->
          <div class="card p-6">
            <h2 class="text-xl font-semibold text-slate-900 mb-4">C√†i ƒë·∫∑t n√¢ng cao</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-600 mb-2">Min Hub Version</label>
                <input
                  type="text"
                  id="minHubVersion"
                  value={game.manifest?.minHubVersion || '1.0.0'}
                  class="w-full bg-white border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-mono"
                  placeholder="1.0.0"
                />
                <p class="text-xs text-slate-500 mt-1">Phi√™n b·∫£n Hub t·ªëi thi·ªÉu c·∫ßn thi·∫øt</p>
              </div>
              
              <div class="flex items-center">
                <label class="flex items-center">
                  <input
                    type="checkbox"
                    id="gameDisabled"
                    checked={game.manifest?.disabled === true}
                    class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                  />
                  <span class="ml-2 text-sm text-slate-700">T·∫°m th·ªùi v√¥ hi·ªáu h√≥a game</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <a
                href={`/games/${game.id}`}
                class="px-4 py-2 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50 font-medium transition-colors text-sm"
              >
                H·ªßy
              </a>
            </div>
            
            <div class="flex items-center gap-2">
              <button
                type="button"
                id="previewBtn"
                class="px-4 py-2 rounded-lg border border-indigo-200 text-indigo-600 hover:bg-indigo-50 font-medium transition-colors text-sm"
              >
                Xem tr∆∞·ªõc
              </button>
              <button
                type="submit"
                id="saveBtn"
                class="px-6 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium transition-colors text-sm"
              >
                L∆∞u thay ƒë·ªïi
              </button>
            </div>
          </div>
        </form>
      ) : (
        <div class="card p-8 text-center">
          <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-slate-200 flex items-center justify-center">
            <svg class="w-10 h-10 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h2 class="text-xl font-bold text-slate-900 mb-2">Game kh√¥ng t·ªìn t·∫°i</h2>
          <p class="text-slate-500 mb-6">{error}</p>
          <a 
            href="/" 
            class="inline-flex items-center gap-2 px-6 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition-colors text-sm"
          >
            Quay l·∫°i Dashboard
          </a>
        </div>
      )}
    </div>
  </div>
</Layout>

<script>
  // Get initial capabilities from hidden elements
  const capabilityElements = document.querySelectorAll('[data-initial-capability]');
  let selectedCapabilities: string[] = [];
  capabilityElements.forEach(el => {
    const htmlEl = el as HTMLElement;
    if (htmlEl.dataset.initialCapability) {
      selectedCapabilities.push(htmlEl.dataset.initialCapability);
    }
  });

  const AVAILABLE_CAPABILITIES = [
    { id: 'score', label: 'Score', icon: 'üéØ' },
    { id: 'save-progress', label: 'Save Progress', icon: 'üíæ' },
    { id: 'levels', label: 'Levels', icon: 'üéÆ' },
    { id: 'hints', label: 'Hints', icon: 'üí°' },
    { id: 'audio', label: 'Audio', icon: 'üîä' },
    { id: 'telemetry', label: 'Telemetry', icon: 'üìä' },
    { id: 'leaderboard', label: 'Leaderboard', icon: 'üèÜ' }
  ];

  function renderCapabilitiesSelector() {
    const container = document.getElementById('capabilitiesSelector');
    if (!container) return;

    container.innerHTML = AVAILABLE_CAPABILITIES.map(cap => {
      const isSelected = selectedCapabilities.includes(cap.id);
      return `
        <button
          type="button"
          class="capability-tag px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
            isSelected
              ? 'bg-indigo-100 text-indigo-700 border-2 border-indigo-300'
              : 'bg-white text-slate-600 border border-slate-300 hover:border-indigo-300 hover:bg-slate-50'
          }"
          data-capability="${cap.id}"
        >
          <span class="mr-1">${cap.icon}</span>
          ${cap.label}
        </button>
      `;
    }).join('');

    // Attach click handlers
    container.querySelectorAll('.capability-tag').forEach(btn => {
      btn.addEventListener('click', () => {
        const htmlBtn = btn as HTMLElement;
        const capId = htmlBtn.dataset.capability;
        if (capId) {
          toggleCapability(capId);
        }
      });
    });
  }

  function toggleCapability(capId: string) {
    const index = selectedCapabilities.indexOf(capId);
    if (index > -1) {
      selectedCapabilities.splice(index, 1);
    } else {
      selectedCapabilities.push(capId);
    }
    renderCapabilitiesSelector();
  }

  // Initialize capabilities selector
  renderCapabilitiesSelector();

  // Preview button
  const previewBtn = document.getElementById('previewBtn');
  if (previewBtn) {
    previewBtn.addEventListener('click', () => {
      const gameIdEl = document.getElementById('gameId') as HTMLInputElement;
      if (gameIdEl && gameIdEl.value) {
        window.open(`/play/${gameIdEl.value}`, '_blank');
      }
    });
  }

  // Form submission
  const editForm = document.getElementById('editGameForm');
  if (editForm) {
    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const saveBtn = document.getElementById('saveBtn') as HTMLButtonElement;
      if (!saveBtn) return;
      
      const originalText = saveBtn.textContent;
      saveBtn.textContent = 'ƒêang l∆∞u...';
      saveBtn.disabled = true;

      try {
        const gameIdEl = document.getElementById('gameId') as HTMLInputElement;
        const gameTitleEl = document.getElementById('gameTitle') as HTMLInputElement;
        const gameRuntimeEl = document.getElementById('gameRuntime') as HTMLSelectElement;
        const gameOwnerEl = document.getElementById('gameOwner') as HTMLInputElement;
        const iconUrlEl = document.getElementById('iconUrl') as HTMLInputElement;
        const minHubVersionEl = document.getElementById('minHubVersion') as HTMLInputElement;
        const gameDisabledEl = document.getElementById('gameDisabled') as HTMLInputElement;

        if (!gameIdEl || !gameTitleEl || !gameRuntimeEl) {
          alert('Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc');
          return;
        }

        const formData = {
          id: gameIdEl.value,
          title: gameTitleEl.value.trim(),
          runtime: gameRuntimeEl.value,
          owner: gameOwnerEl ? gameOwnerEl.value.trim() : '',
          capabilities: selectedCapabilities,
          iconUrl: iconUrlEl ? iconUrlEl.value.trim() : '',
          minHubVersion: minHubVersionEl ? minHubVersionEl.value.trim() : '1.0.0',
          disabled: gameDisabledEl ? gameDisabledEl.checked : false
        };

        // Basic validation
        if (!formData.title || formData.title.length < 3 || formData.title.length > 40) {
          alert('T√™n game ph·∫£i c√≥ ƒë·ªô d√†i 3-40 k√Ω t·ª±');
          return;
        }

        const response = await fetch('/api/games/update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData),
        });

        const result = await response.json();

        if (response.ok) {
          alert('C·∫≠p nh·∫≠t th√¥ng tin game th√†nh c√¥ng!');
          window.location.href = `/games/${formData.id}`;
        } else {
          alert('L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t game'));
        }
      } catch (error) {
        console.error('Error updating game:', error);
        alert('L·ªói k·∫øt n·ªëi m·∫°ng. Vui l√≤ng th·ª≠ l·∫°i.');
      } finally {
        if (saveBtn) {
          saveBtn.textContent = originalText;
          saveBtn.disabled = false;
        }
      }
    });
  }
</script>