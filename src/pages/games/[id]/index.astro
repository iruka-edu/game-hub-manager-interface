---
import Layout from '../../../layouts/Layout.astro';
import { GameRepository } from '../../../models/Game';
import { GameVersionRepository } from '../../../models/GameVersion';
import { UserRepository } from '../../../models/User';

const { id } = Astro.params;

// Find game in database
let game = null;
let latestVersion = null;
let allVersions = [];
let owner = null;
let error = null;

const CDN_BASE = `https://storage.googleapis.com/${import.meta.env.GCLOUD_BUCKET_NAME || 'iruka-edu-mini-game'}`;

try {
  const gameRepo = await GameRepository.getInstance();
  const versionRepo = await GameVersionRepository.getInstance();
  const userRepo = await UserRepository.getInstance();
  
  // 1. Try lookup by ID (ObjectId)
  game = await gameRepo.findById(id || '');
  
  // 2. If not found, try lookup by GameId (slug)
  if (!game) {
    game = await gameRepo.findByGameId(id || '');
  }
  
  if (!game) {
    error = `Game "${id}" kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng`;
  } else {
    // Load versions
    allVersions = await versionRepo.findByGameId(game._id.toString());
    
    // Load latest version
    if (game.latestVersionId) {
      latestVersion = await versionRepo.findById(game.latestVersionId.toString());
    } else if (allVersions.length > 0) {
      latestVersion = allVersions[0];
    }

    // Load owner info
    owner = await userRepo.findById(game.ownerId);
  }
} catch (err) {
  console.error('Failed to load game:', err);
  error = 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin game';
}

// Helper functions
function formatDate(date: Date): string {
  if (!date) return "N/A";
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 60) return `${diffMins} ph√∫t tr∆∞·ªõc`;
  if (diffHours < 24) return `${diffHours} gi·ªù tr∆∞·ªõc`;
  if (diffDays < 7) return `${diffDays} ng√†y tr∆∞·ªõc`;
  return date.toLocaleDateString("vi-VN", { day: "2-digit", month: "2-digit", year: "numeric" });
}

function formatSize(bytes?: number): string {
  if (!bytes) return "0 KB";
  const mb = bytes / (1024 * 1024);
  return mb < 1 ? `${(bytes / 1024).toFixed(0)} KB` : `${mb.toFixed(1)} MB`;
}

// Status helpers
const getStatusInfo = (status: string) => {
  switch (status) {
    case 'published':
      return { color: 'emerald', label: 'ƒê√£ xu·∫•t b·∫£n', icon: '‚úÖ' };
    case 'approved':
      return { color: 'blue', label: 'ƒê√£ duy·ªát', icon: 'üëç' };
    case 'qc_passed':
      return { color: 'purple', label: 'QC ƒë·∫°t', icon: 'üîç' };
    case 'uploaded':
      return { color: 'amber', label: 'Ch·ªù QC', icon: '‚è≥' };
    case 'qc_failed':
      return { color: 'red', label: 'QC kh√¥ng ƒë·∫°t', icon: '‚ùå' };
    case 'draft':
      return { color: 'slate', label: 'Nh√°p', icon: 'üìù' };
    default:
      return { color: 'slate', label: 'Kh√¥ng x√°c ƒë·ªãnh', icon: '‚ùì' };
  }
};

const currentStatus = latestVersion?.status || 'draft';
const statusInfo = getStatusInfo(currentStatus);
const ownerName = owner?.name || owner?.email?.split('@')[0] || 'Unknown';
---

<Layout title={game ? `${game.title} - Th√¥ng tin Game` : 'Game kh√¥ng t√¨m th·∫•y'}>
  <div class="min-h-screen bg-slate-50 py-8">
    <div class="max-w-6xl mx-auto px-4">
      <!-- Header -->
      <div class="mb-8">
        <div class="flex items-center gap-4 mb-6">
          <a 
            href="/" 
            class="text-slate-500 hover:text-slate-900 transition-colors flex items-center gap-2 text-sm font-medium"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Quay l·∫°i Dashboard
          </a>
        </div>
        
        {game ? (
          <!-- Game Header Card -->
          <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 mb-8">
            <div class="flex items-start justify-between">
              <div class="flex items-start gap-4">
                <!-- Game Icon -->
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-50 to-blue-50 flex items-center justify-center shrink-0 border border-slate-100 shadow-sm">
                  <span class="text-2xl font-black text-indigo-600 uppercase">
                    {game.title?.charAt(0) || game.gameId?.charAt(0)}
                  </span>
                </div>
                
                <div>
                  <div class="flex items-center gap-3 mb-2">
                    <h1 class="text-3xl font-bold text-slate-900">{game.title || game.gameId}</h1>
                    <span class={`inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-${statusInfo.color}-100 text-${statusInfo.color}-700 border border-${statusInfo.color}-200`}>
                      {statusInfo.icon} {statusInfo.label}
                    </span>
                  </div>
                  
                  <p class="text-slate-500 font-mono text-sm mb-3">{game.gameId}</p>
                  
                  <!-- Meta Info -->
                  <div class="flex items-center gap-6 text-sm text-slate-600">
                    <div class="flex items-center gap-2">
                      <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                      </svg>
                      <span class="font-medium">{ownerName}</span>
                    </div>
                    
                    <div class="flex items-center gap-2">
                      <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      <span>{formatDate(game.updatedAt)}</span>
                    </div>
                    
                    <div class="flex items-center gap-2">
                      <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                      </svg>
                      <span>{allVersions.length} phi√™n b·∫£n</span>
                    </div>
                    
                    {latestVersion && (
                      <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span class="font-mono">v{latestVersion.version}</span>
                      </div>
                    )}
                  </div>
                </div>
              </div>
              
              <!-- Play Button -->
              <div class="flex items-center gap-3">
                <a
                  href={`/play/${game._id}`}
                  target="_blank"
                  class="px-6 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold transition-colors text-sm flex items-center gap-2 shadow-sm hover:shadow-md"
                >
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                  Ch∆°i Game
                </a>
              </div>
            </div>
          </div>
        ) : (
          <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
            <h1 class="text-3xl font-bold text-slate-900 mb-2">Game kh√¥ng t√¨m th·∫•y</h1>
            <p class="text-slate-500">{error}</p>
          </div>
        )}
      </div>

      {game ? (
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Main Content -->
          <div class="lg:col-span-2 space-y-6">
            <!-- Game Details -->
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
              <h2 class="text-xl font-bold text-slate-900 mb-6">Th√¥ng tin chi ti·∫øt</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-slate-600 mb-2">Game ID</label>
                    <div class="font-mono text-slate-900 bg-slate-50 px-4 py-3 rounded-lg border border-slate-200">
                      {game.gameId}
                    </div>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-slate-600 mb-2">T√™n hi·ªÉn th·ªã</label>
                    <div class="text-slate-900 bg-slate-50 px-4 py-3 rounded-lg border border-slate-200">
                      {game.title || '-'}
                    </div>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-slate-600 mb-2">M√¥n h·ªçc</label>
                    <div class="text-slate-900 bg-slate-50 px-4 py-3 rounded-lg border border-slate-200">
                      {game.subject || '-'}
                    </div>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-slate-600 mb-2">L·ªõp</label>
                    <div class="text-slate-900 bg-slate-50 px-4 py-3 rounded-lg border border-slate-200">
                      {game.grade || '-'}
                    </div>
                  </div>
                </div>
                
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-slate-600 mb-2">Phi√™n b·∫£n hi·ªán t·∫°i</label>
                    <div class="font-mono text-slate-900 bg-slate-50 px-4 py-3 rounded-lg border border-slate-200">
                      {latestVersion ? `v${latestVersion.version}` : 'N/A'}
                    </div>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-slate-600 mb-2">Unit</label>
                    <div class="text-slate-900 bg-slate-50 px-4 py-3 rounded-lg border border-slate-200">
                      {game.unit || '-'}
                    </div>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-slate-600 mb-2">Lo·∫°i game</label>
                    <div class="text-slate-900 bg-slate-50 px-4 py-3 rounded-lg border border-slate-200">
                      {game.gameType || '-'}
                    </div>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-slate-600 mb-2">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi</label>
                    <div class="text-slate-900 bg-slate-50 px-4 py-3 rounded-lg border border-slate-200">
                      {formatDate(game.updatedAt)}
                    </div>
                  </div>
                </div>
              </div>
              
              {game.description && (
                <div class="mt-6">
                  <label class="block text-sm font-medium text-slate-600 mb-2">M√¥ t·∫£</label>
                  <div class="text-slate-900 bg-slate-50 px-4 py-3 rounded-lg border border-slate-200">
                    {game.description}
                  </div>
                </div>
              )}
            </div>

            <!-- Tags/Capabilities -->
            {game.tags && game.tags.length > 0 && (
              <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                <h2 class="text-xl font-bold text-slate-900 mb-4">T√≠nh nƒÉng Game</h2>
                <div class="flex flex-wrap gap-2">
                  {game.tags.map((tag: string) => (
                    <span class="px-3 py-2 rounded-lg text-sm font-medium bg-blue-50 text-blue-700 border border-blue-200">
                      {tag}
                    </span>
                  ))}
                </div>
              </div>
            )}

            <!-- Game URLs -->
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
              <h2 class="text-xl font-bold text-slate-900 mb-4">Li√™n k·∫øt Game</h2>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-slate-600 mb-2">Entry URL</label>
                  <div class="flex items-center gap-3">
                    <div class="flex-1 font-mono text-sm text-slate-900 bg-slate-50 px-4 py-3 rounded-lg border border-slate-200 break-all">
                      {latestVersion ? `${CDN_BASE}/games/${game.gameId}/${latestVersion.version}/index.html` : 'Ch∆∞a c√≥ b·∫£n build'}
                    </div>
                    {latestVersion && (
                      <a
                        href={`${CDN_BASE}/games/${game.gameId}/${latestVersion.version}/index.html`}
                        target="_blank"
                        class="px-4 py-3 text-sm font-medium text-indigo-600 hover:text-indigo-700 border border-indigo-200 rounded-lg hover:bg-indigo-50 transition-colors shrink-0"
                      >
                        M·ªü
                      </a>
                    )}
                  </div>
                </div>
                
                {latestVersion && latestVersion.entryFile && (
                  <div>
                    <label class="block text-sm font-medium text-slate-600 mb-2">Entry File</label>
                    <div class="font-mono text-sm text-slate-900 bg-slate-50 px-4 py-3 rounded-lg border border-slate-200 break-all">
                      {latestVersion.entryFile}
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>

          <!-- Sidebar -->
          <div class="space-y-6">
            <!-- Quick Actions -->
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
              <h3 class="text-lg font-bold text-slate-900 mb-4">H√†nh ƒë·ªông nhanh</h3>
              <div class="space-y-3">
                <a
                  href={`/play/${game._id}`}
                  target="_blank"
                  class="w-full px-4 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium transition-colors text-sm flex items-center justify-center gap-2"
                >
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                  Ch∆°i Game
                </a>
              </div>
            </div>

            <!-- Version Summary -->
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
              <h3 class="text-lg font-bold text-slate-900 mb-4">Th√¥ng tin phi√™n b·∫£n</h3>
              <div class="space-y-4">
                <div class="flex justify-between items-center">
                  <span class="text-sm text-slate-600">T·ªïng s·ªë phi√™n b·∫£n:</span>
                  <span class="font-bold text-slate-900">{allVersions.length}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-slate-600">Phi√™n b·∫£n m·ªõi nh·∫•t:</span>
                  <span class="font-mono text-sm font-bold text-slate-900">
                    {latestVersion ? `v${latestVersion.version}` : 'N/A'}
                  </span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-slate-600">Tr·∫°ng th√°i:</span>
                  <span class={`text-sm font-bold text-${statusInfo.color}-700`}>
                    {statusInfo.label}
                  </span>
                </div>
                {latestVersion && latestVersion.buildSize && (
                  <div class="flex justify-between items-center">
                    <span class="text-sm text-slate-600">K√≠ch th∆∞·ªõc:</span>
                    <span class="font-mono text-sm font-bold text-slate-900">
                      {formatSize(latestVersion.buildSize)}
                    </span>
                  </div>
                )}
              </div>
            </div>

            <!-- Game Manifest -->
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
              <h3 class="text-lg font-bold text-slate-900 mb-4">Game Manifest</h3>
              <div class="relative">
                <pre class="bg-slate-900 text-slate-100 p-4 rounded-lg text-xs overflow-x-auto max-h-64 overflow-y-auto"><code>{JSON.stringify({
                  id: game.gameId,
                  title: game.title,
                  subject: game.subject,
                  grade: game.grade,
                  unit: game.unit,
                  gameType: game.gameType,
                  priority: game.priority,
                  status: currentStatus,
                  version: latestVersion?.version || '1.0.0'
                }, null, 2)}</code></pre>
                <button
                  id="copyManifest"
                  class="absolute top-2 right-2 px-2 py-1 text-xs bg-slate-700 hover:bg-slate-600 text-slate-200 rounded transition-colors"
                  title="Copy to clipboard"
                >
                  Copy
                </button>
              </div>
            </div>
          </div>
        </div>
      ) : (
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-8 text-center">
          <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-slate-200 flex items-center justify-center">
            <svg class="w-10 h-10 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h2 class="text-xl font-bold text-slate-900 mb-2">Game kh√¥ng t·ªìn t·∫°i</h2>
          <p class="text-slate-500 mb-6">{error}</p>
          <a 
            href="/" 
            class="inline-flex items-center gap-2 px-6 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition-colors text-sm"
          >
            Quay l·∫°i Dashboard
          </a>
        </div>
      )}
    </div>
  </div>
</Layout>

<script>
  // Copy manifest to clipboard
  document.getElementById('copyManifest')?.addEventListener('click', async () => {
    const manifestElement = document.querySelector('pre code');
    if (manifestElement) {
      try {
        await navigator.clipboard.writeText(manifestElement.textContent || '');
        const button = document.getElementById('copyManifest');
        if (button) {
          const originalText = button.textContent;
          button.textContent = 'Copied!';
          setTimeout(() => {
            button.textContent = originalText;
          }, 2000);
        }
      } catch (err) {
        console.error('Failed to copy manifest:', err);
      }
    }
  });
</script>

<style>
  /* Smooth transitions for interactive elements */
  .transition-colors {
    transition-property: color, background-color, border-color;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 150ms;
  }

  /* Custom scrollbar for code blocks */
  pre::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }

  pre::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
  }

  pre::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
  }

  pre::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
  }

  /* Responsive text sizing */
  @media (max-width: 768px) {
    .text-3xl {
      font-size: 1.875rem;
      line-height: 2.25rem;
    }
  }
</style>