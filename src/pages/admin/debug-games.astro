---
import Layout from '../../layouts/Layout.astro';
import type { User } from '../../models/User';

// Get user from middleware
const user = Astro.locals.user as User;

// Check admin permission
if (!user || !user.roles.includes('admin')) {
  return Astro.redirect('/dashboard');
}
---

<Layout title="Debug Games - Admin">
  <div class="max-w-4xl mx-auto space-y-8">
    <!-- Header -->
    <div>
      <h1 class="text-2xl font-bold text-slate-900">Debug Games</h1>
      <p class="text-slate-500 mt-1">Kiểm tra và fix games bị lỗi</p>
    </div>

    <!-- Check Game -->
    <div class="card p-6">
      <h2 class="text-lg font-semibold text-slate-900 mb-4">Kiểm tra Game</h2>
      <div class="flex gap-4 mb-4">
        <input 
          type="text" 
          id="gameIdInput" 
          placeholder="Game ID (MongoDB _id)" 
          class="flex-1 px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500"
        >
        <button id="checkBtn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
          Kiểm tra
        </button>
      </div>
    </div>

    <!-- Results -->
    <div id="results" class="hidden">
      <div class="card">
        <div class="p-4 border-b border-slate-200">
          <h2 class="text-lg font-semibold text-slate-900">Kết quả kiểm tra</h2>
        </div>
        <div class="p-6">
          <div id="gameInfo" class="mb-6"></div>
          <div id="versionsInfo" class="mb-6"></div>
          <div id="analysisInfo" class="mb-6"></div>
          <div id="actionsSection" class="hidden">
            <h3 class="font-medium text-slate-900 mb-3">Hành động khắc phục:</h3>
            <div class="flex flex-wrap gap-3">
              <button id="syncFromGcsBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                Sync từ GCS Registry
              </button>
              <button id="updateLatestBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                Update Latest Version
              </button>
              <button id="deleteGameBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">
                Xóa Game
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="hidden">
      <div class="card p-8 text-center">
        <div class="animate-spin w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full mx-auto"></div>
        <p class="mt-4 text-slate-500">Đang xử lý...</p>
      </div>
    </div>

    <!-- Error -->
    <div id="error" class="hidden">
      <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-red-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <div>
            <h3 class="font-medium text-red-800">Lỗi</h3>
            <p id="errorMessage" class="mt-1 text-sm text-red-700"></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  const gameIdInput = document.getElementById('gameIdInput') as HTMLInputElement;
  const checkBtn = document.getElementById('checkBtn') as HTMLButtonElement;
  const resultsDiv = document.getElementById('results') as HTMLDivElement;
  const loadingDiv = document.getElementById('loading') as HTMLDivElement;
  const errorDiv = document.getElementById('error') as HTMLDivElement;
  const errorMessage = document.getElementById('errorMessage') as HTMLParagraphElement;
  const gameInfo = document.getElementById('gameInfo') as HTMLDivElement;
  const versionsInfo = document.getElementById('versionsInfo') as HTMLDivElement;
  const analysisInfo = document.getElementById('analysisInfo') as HTMLDivElement;
  const actionsSection = document.getElementById('actionsSection') as HTMLDivElement;

  let currentGameId = '';

  function showLoading() {
    resultsDiv.classList.add('hidden');
    errorDiv.classList.add('hidden');
    loadingDiv.classList.remove('hidden');
  }

  function hideLoading() {
    loadingDiv.classList.add('hidden');
  }

  function showError(message: string) {
    hideLoading();
    errorMessage.textContent = message;
    errorDiv.classList.remove('hidden');
  }

  function showResults(data: any) {
    hideLoading();
    
    // Game Info
    gameInfo.innerHTML = `
      <h3 class="font-medium text-slate-900 mb-2">Game Information</h3>
      <div class="bg-slate-50 rounded-lg p-4 text-sm">
        <p><strong>ID:</strong> ${data.game._id}</p>
        <p><strong>Game ID:</strong> ${data.game.gameId}</p>
        <p><strong>Title:</strong> ${data.game.title}</p>
        <p><strong>Owner ID:</strong> ${data.game.ownerId}</p>
        <p><strong>Latest Version ID:</strong> ${data.game.latestVersionId || 'null'}</p>
        <p><strong>Live Version ID:</strong> ${data.game.liveVersionId || 'null'}</p>
        <p><strong>Created:</strong> ${new Date(data.game.createdAt).toLocaleString('vi-VN')}</p>
      </div>
    `;

    // Versions Info
    versionsInfo.innerHTML = `
      <h3 class="font-medium text-slate-900 mb-2">Versions (${data.versions.active.length} active, ${data.versions.includeDeleted.length} total)</h3>
      <div class="bg-slate-50 rounded-lg p-4">
        ${data.versions.includeDeleted.length === 0 ? 
          '<p class="text-slate-500 text-sm">No versions found</p>' :
          `<div class="space-y-2">
            ${data.versions.includeDeleted.map((v: any) => `
              <div class="flex items-center justify-between text-sm ${v.isDeleted ? 'text-slate-400' : ''}">
                <span>${v.version} (${v.status})</span>
                <span>${v.isDeleted ? '[DELETED]' : ''} ${new Date(v.createdAt).toLocaleDateString('vi-VN')}</span>
              </div>
            `).join('')}
          </div>`
        }
      </div>
    `;

    // Analysis
    const statusClass = data.analysis.hasActiveVersions ? 'text-green-700 bg-green-50' : 'text-red-700 bg-red-50';
    analysisInfo.innerHTML = `
      <h3 class="font-medium text-slate-900 mb-2">Analysis</h3>
      <div class="space-y-2">
        <div class="p-3 rounded-lg ${statusClass}">
          <p class="font-medium">${data.analysis.hasActiveVersions ? '✅ Game has active versions' : '❌ Game has NO active versions'}</p>
        </div>
        <div class="bg-slate-50 rounded-lg p-3 text-sm space-y-1">
          <p><strong>Latest Version ID exists:</strong> ${data.analysis.latestVersionIdExists ? '✅' : '❌'}</p>
          <p><strong>Live Version ID exists:</strong> ${data.analysis.liveVersionIdExists ? '✅' : '❌'}</p>
        </div>
        <div class="bg-blue-50 rounded-lg p-3">
          <p class="font-medium text-blue-800 mb-1">Recommendations:</p>
          <ul class="text-sm text-blue-700 list-disc list-inside space-y-1">
            ${data.recommendations.map((rec: string) => `<li>${rec}</li>`).join('')}
          </ul>
        </div>
      </div>
    `;

    // Show actions if needed
    if (!data.analysis.hasActiveVersions || !data.analysis.latestVersionIdExists) {
      actionsSection.classList.remove('hidden');
    } else {
      actionsSection.classList.add('hidden');
    }

    resultsDiv.classList.remove('hidden');
  }

  async function checkGame() {
    const gameId = gameIdInput.value.trim();
    if (!gameId) {
      alert('Vui lòng nhập Game ID');
      return;
    }

    currentGameId = gameId;
    showLoading();

    try {
      const response = await fetch(`/api/debug/check-game?gameId=${encodeURIComponent(gameId)}`);
      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Check failed');
      }

      showResults(data);
    } catch (error: any) {
      showError(error.message);
    }
  }

  async function fixGame(action: string) {
    if (!currentGameId) return;

    const confirmMessage = {
      'sync-from-gcs': 'Sync game từ GCS Registry? Sẽ tạo versions từ registry/index.json',
      'update-latest-version': 'Update Latest Version ID? Sẽ set latestVersionId = version mới nhất',
      'delete-game': 'XÓA game này? Hành động không thể hoàn tác!'
    }[action];

    if (!confirm(confirmMessage)) return;

    showLoading();

    try {
      const response = await fetch('/api/debug/fix-game', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ gameId: currentGameId, action })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Fix failed');
      }

      alert(data.message);
      
      // Re-check the game
      if (action !== 'delete-game') {
        await checkGame();
      } else {
        resultsDiv.classList.add('hidden');
        hideLoading();
      }
    } catch (error: any) {
      showError(error.message);
    }
  }

  // Event listeners
  checkBtn.addEventListener('click', checkGame);
  gameIdInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') checkGame();
  });

  document.getElementById('syncFromGcsBtn')?.addEventListener('click', () => fixGame('sync-from-gcs'));
  document.getElementById('updateLatestBtn')?.addEventListener('click', () => fixGame('update-latest-version'));
  document.getElementById('deleteGameBtn')?.addEventListener('click', () => fixGame('delete-game'));
</script>