---
import Layout from '../../layouts/Layout.astro';
import type { User } from '../../models/User';

// Get user from middleware
const user = Astro.locals.user as User;

// Check admin permission
if (!user || !user.roles.includes('admin')) {
  return Astro.redirect('/dashboard');
}
---

<Layout title="Trash Management - Admin">
  <div class="max-w-6xl mx-auto space-y-8">
    <!-- Header -->
    <div>
      <h1 class="text-2xl font-bold text-slate-900">Trash Management</h1>
      <p class="text-slate-500 mt-1">Manage soft-deleted games and hard deletion requests</p>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="card p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-slate-500">Soft Deleted</p>
            <p id="softDeletedCount" class="text-2xl font-bold text-slate-900">-</p>
          </div>
          <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
          </div>
        </div>
      </div>

      <div class="card p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-slate-500">Hard Delete Requests</p>
            <p id="hardDeleteRequestsCount" class="text-2xl font-bold text-slate-900">-</p>
          </div>
          <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
          </div>
        </div>
      </div>

      <div class="card p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-slate-500">Retention Days</p>
            <p class="text-2xl font-bold text-slate-900">30</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="card p-6">
      <h2 class="text-lg font-semibold text-slate-900 mb-4">Bulk Actions</h2>
      <div class="flex gap-4">
        <button id="refreshBtn" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-colors font-medium">
          üîÑ Refresh
        </button>
        <button id="runHardDeleteJobBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
          ‚ö†Ô∏è Run Hard Delete Job
        </button>
      </div>
    </div>

    <!-- Soft Deleted Games -->
    <div class="card">
      <div class="p-4 border-b border-slate-200 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-slate-900">Soft Deleted Games</h2>
        <div class="text-sm text-slate-500">Can be restored</div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-slate-50">
            <tr>
              <th class="text-left px-4 py-3 text-xs font-semibold text-slate-500 uppercase">Game</th>
              <th class="text-left px-4 py-3 text-xs font-semibold text-slate-500 uppercase">Deleted</th>
              <th class="text-left px-4 py-3 text-xs font-semibold text-slate-500 uppercase">Reason</th>
              <th class="text-left px-4 py-3 text-xs font-semibold text-slate-500 uppercase">Actions</th>
            </tr>
          </thead>
          <tbody id="softDeletedGames" class="divide-y divide-slate-200">
            <tr>
              <td colspan="4" class="px-4 py-8 text-center text-slate-500">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Hard Delete Requests -->
    <div class="card">
      <div class="p-4 border-b border-slate-200 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-slate-900">Hard Delete Requests</h2>
        <div class="text-sm text-slate-500">Scheduled for permanent deletion</div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-slate-50">
            <tr>
              <th class="text-left px-4 py-3 text-xs font-semibold text-slate-500 uppercase">Game</th>
              <th class="text-left px-4 py-3 text-xs font-semibold text-slate-500 uppercase">Requested</th>
              <th class="text-left px-4 py-3 text-xs font-semibold text-slate-500 uppercase">Reason</th>
              <th class="text-left px-4 py-3 text-xs font-semibold text-slate-500 uppercase">Status</th>
            </tr>
          </thead>
          <tbody id="hardDeleteRequests" class="divide-y divide-slate-200">
            <tr>
              <td colspan="4" class="px-4 py-8 text-center text-slate-500">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="hidden">
      <div class="card p-8 text-center">
        <div class="animate-spin w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full mx-auto"></div>
        <p class="mt-4 text-slate-500">Processing...</p>
      </div>
    </div>

    <!-- Error -->
    <div id="error" class="hidden">
      <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-red-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <div>
            <h3 class="font-medium text-red-800">Error</h3>
            <p id="errorMessage" class="mt-1 text-sm text-red-700"></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  const refreshBtn = document.getElementById('refreshBtn') as HTMLButtonElement;
  const runHardDeleteJobBtn = document.getElementById('runHardDeleteJobBtn') as HTMLButtonElement;
  const softDeletedGames = document.getElementById('softDeletedGames') as HTMLTableSectionElement;
  const hardDeleteRequests = document.getElementById('hardDeleteRequests') as HTMLTableSectionElement;
  const softDeletedCount = document.getElementById('softDeletedCount') as HTMLElement;
  const hardDeleteRequestsCount = document.getElementById('hardDeleteRequestsCount') as HTMLElement;
  const loadingDiv = document.getElementById('loading') as HTMLDivElement;
  const errorDiv = document.getElementById('error') as HTMLDivElement;
  const errorMessage = document.getElementById('errorMessage') as HTMLParagraphElement;

  async function loadTrashData() {
    try {
      errorDiv.classList.add('hidden');
      
      const response = await fetch('/api/admin/trash-data');
      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to load trash data');
      }

      // Update stats
      softDeletedCount.textContent = data.softDeleted.length.toString();
      hardDeleteRequestsCount.textContent = data.hardDeleteRequests.length.toString();

      // Populate soft deleted games
      softDeletedGames.innerHTML = '';
      if (data.softDeleted.length === 0) {
        softDeletedGames.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-slate-500">No soft-deleted games</td></tr>';
      } else {
        data.softDeleted.forEach((game: any) => {
          const row = document.createElement('tr');
          row.className = 'hover:bg-slate-50';
          
          const deletedDate = new Date(game.deletedAt).toLocaleDateString();
          const canHardDelete = game.deleteReason?.startsWith('hard_delete_requested:') ? false : true;
          
          row.innerHTML = `
            <td class="px-4 py-3">
              <div class="text-sm font-medium text-slate-900">${game.title}</div>
              <div class="text-xs text-slate-500 font-mono">${game.gameId}</div>
            </td>
            <td class="px-4 py-3 text-sm text-slate-500">
              <div>${deletedDate}</div>
              <div class="text-xs">by ${game.deletedBy || 'unknown'}</div>
            </td>
            <td class="px-4 py-3 text-sm text-slate-500">${game.deleteReason || 'No reason'}</td>
            <td class="px-4 py-3">
              <div class="flex gap-2">
                <button onclick="restoreGame('${game._id}')" class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium hover:bg-green-200">
                  Restore
                </button>
                ${canHardDelete ? `
                <button onclick="requestHardDelete('${game._id}', '${game.title}')" class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-medium hover:bg-red-200">
                  Hard Delete
                </button>
                ` : ''}
              </div>
            </td>
          `;
          softDeletedGames.appendChild(row);
        });
      }

      // Populate hard delete requests
      hardDeleteRequests.innerHTML = '';
      if (data.hardDeleteRequests.length === 0) {
        hardDeleteRequests.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-slate-500">No hard delete requests</td></tr>';
      } else {
        data.hardDeleteRequests.forEach((game: any) => {
          const row = document.createElement('tr');
          row.className = 'hover:bg-slate-50';
          
          const requestedDate = new Date(game.deletedAt).toLocaleDateString();
          const reason = game.deleteReason?.replace('hard_delete_requested: ', '') || 'No reason';
          const daysSinceRequest = Math.floor((Date.now() - new Date(game.deletedAt).getTime()) / (1000 * 60 * 60 * 24));
          const isEligible = daysSinceRequest >= 30;
          
          row.innerHTML = `
            <td class="px-4 py-3">
              <div class="text-sm font-medium text-slate-900">${game.title}</div>
              <div class="text-xs text-slate-500 font-mono">${game.gameId}</div>
            </td>
            <td class="px-4 py-3 text-sm text-slate-500">
              <div>${requestedDate}</div>
              <div class="text-xs">${daysSinceRequest} days ago</div>
            </td>
            <td class="px-4 py-3 text-sm text-slate-500">${reason}</td>
            <td class="px-4 py-3">
              <span class="px-2 py-1 rounded text-xs font-medium ${isEligible ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">
                ${isEligible ? 'Eligible for deletion' : `Wait ${30 - daysSinceRequest} more days`}
              </span>
            </td>
          `;
          hardDeleteRequests.appendChild(row);
        });
      }

    } catch (error: any) {
      errorDiv.classList.remove('hidden');
      errorMessage.textContent = error.message;
    }
  }

  async function restoreGame(gameId: string) {
    if (!confirm('Are you sure you want to restore this game?')) return;

    try {
      loadingDiv.classList.remove('hidden');
      
      const response = await fetch(`/api/games/${gameId}/restore`, {
        method: 'POST'
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to restore game');
      }

      alert('Game restored successfully!');
      await loadTrashData();

    } catch (error: any) {
      alert(`Error: ${error.message}`);
    } finally {
      loadingDiv.classList.add('hidden');
    }
  }

  async function requestHardDelete(gameId: string, gameTitle: string) {
    const reason = prompt(`Enter reason for hard deleting "${gameTitle}":`);
    if (!reason) return;

    if (!confirm(`This will PERMANENTLY delete "${gameTitle}" and all its files. This cannot be undone. Continue?`)) return;

    try {
      loadingDiv.classList.remove('hidden');
      
      const response = await fetch(`/api/games/${gameId}/hard-delete-request`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to request hard delete');
      }

      alert('Hard delete request created. Game will be permanently deleted by background job after 30 days.');
      await loadTrashData();

    } catch (error: any) {
      alert(`Error: ${error.message}`);
    } finally {
      loadingDiv.classList.add('hidden');
    }
  }

  async function runHardDeleteJob() {
    if (!confirm('This will run the hard delete job to permanently delete eligible games. Continue?')) return;

    try {
      loadingDiv.classList.remove('hidden');
      
      const response = await fetch('/api/admin/run-hard-delete-job', {
        method: 'POST'
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to run hard delete job');
      }

      alert(`Hard delete job completed. ${data.processed} games processed, ${data.deleted} games deleted.`);
      await loadTrashData();

    } catch (error: any) {
      alert(`Error: ${error.message}`);
    } finally {
      loadingDiv.classList.add('hidden');
    }
  }

  // Make functions global for onclick handlers
  (window as any).restoreGame = restoreGame;
  (window as any).requestHardDelete = requestHardDelete;

  // Event listeners
  refreshBtn.addEventListener('click', loadTrashData);
  runHardDeleteJobBtn.addEventListener('click', runHardDeleteJob);

  // Load initial data
  loadTrashData();
</script>