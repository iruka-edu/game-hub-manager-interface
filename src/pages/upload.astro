---
/**
 * Upload Page - Full width horizontal layout
 */
import Layout from "../layouts/Layout.astro";
import GameUploadForm from "../components/upload/GameUploadForm.astro";
import { getUserFromRequest } from "../lib/session";
import type { User } from "../models/User";
import UploadMetaForm from "../components/UploadMetaForm.astro";

// Auth check
const user = (await getUserFromRequest(Astro.request)) as User | null;
const hasRole = (role: string) => user?.roles?.includes(role as any) ?? false;
const canUpload = hasRole("dev") || hasRole("admin");

if (!user) return Astro.redirect("/login?redirect=/upload");
if (!canUpload) return Astro.redirect("/dashboard?error=unauthorized");

const sp = Astro.url.searchParams;

const meta = {
  lop: sp.get("lop") ?? "",
  mon: sp.get("mon") ?? "",

  quyenSach: sp.get("quyenSach") ?? "",
  lesson: sp.get("lesson") ?? "",

  game: sp.get("game") ?? "",
  level: sp.get("level") ?? "",
  skills: sp.getAll("skill").filter(Boolean),
  themes: sp.getAll("theme").filter(Boolean),
  github: sp.get("github") ?? "",
};

// Chỉ các key bạn muốn bắt buộc cho bước upload
const metaReady = Boolean(meta.lop && meta.mon && meta.quyenSach && meta.lesson && meta.game && meta.level && meta.github)
  && meta.skills.length > 0
  && meta.themes.length > 0;

// Đây là phần “tổng hợp data cần thiết” để GameUploadForm dùng build payload
const gameMeta = {
  // Những cái API create game cần trực tiếp
  grade: meta.lop,
  subject: meta.mon,
  lesson: meta.lesson ? [meta.lesson] : [],
  gameType: meta.game,
  level: meta.level,
  skills: meta.skills,
  themes: meta.themes,
  linkGithub: meta.github,
};

---

<Layout title="Tải Game Mới - Iruka Console">
  <div class="w-full px-6 py-6">
    <!-- Minimal Header -->
    <header class="flex items-center gap-3 mb-6">
      <a
        href="/"
        class="w-8 h-8 rounded-lg bg-white border border-slate-200 flex items-center justify-center text-slate-400 hover:text-iruka-blue hover:border-blue-300 transition-all"
        title="Quay lại"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </a>
      <h1 class="text-lg font-black text-slate-900">Tải Game Mới</h1>
    </header>

    {metaReady ? (
      <>
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4">
          <div class="flex items-center justify-between gap-4">
            <div class="text-xs font-bold text-slate-600">
              <span class="font-black text-slate-900">Metadata:</span>
              {" "}
              {meta.lop} • {meta.mon} • {meta.quyenSach} • {meta.lesson} • {meta.game} • {meta.level} • {meta.skills} • {meta.themes}
              {" "}
              • <span class="text-iruka-blue">{meta.github}</span>
            </div>
            <a href="/upload" class="text-xs font-black text-slate-600 hover:underline">
              Sửa
            </a>
          </div>
        </div>

        <GameUploadForm meta={gameMeta} />
      </>
    ) : (
      <UploadMetaForm
        values={meta}
        options={{
          lops: [],
          mons: [],
          quyensachs: [],
          lessons: [],
          games: [],
          levels: [],
          skills: [],
          themes: [],
        }}
      />
    )}

    <!-- Collapsible Help (optional) -->
    <details class="mt-6 group">
      <summary class="text-xs font-bold text-slate-400 cursor-pointer hover:text-slate-600 flex items-center gap-1">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Hướng dẫn
        <svg class="w-3 h-3 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </summary>
      <div class="mt-3 p-3 bg-slate-50 rounded-lg text-xs text-slate-600 space-y-2">
        <p>Kiểm tra build trước khi upload:</p>
        <code class="block bg-slate-800 text-emerald-400 p-2 rounded text-[11px]">pnpm iruka-game:validate ./dist</code>
      </div>
    </details>
  </div>
</Layout>

<style is:inline>
  :root { --iruka-blue: #2b9bf6; }
</style>
