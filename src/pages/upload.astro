---
/**
 * Upload Page - Full width horizontal layout
 */
import Layout from "../layouts/Layout.astro";
import { getUserFromRequest } from "../lib/session";
import type { User } from "../models/User";
import UploadMetaForm from "../components/UploadMetaForm.astro";

// Auth check
const user = (await getUserFromRequest(Astro.request)) as User | null;
const hasRole = (role: string) => user?.roles?.includes(role as any) ?? false;
const canUpload = hasRole("dev") || hasRole("admin");

if (!user) return Astro.redirect("/login?redirect=/upload");
if (!canUpload) return Astro.redirect("/dashboard?error=unauthorized");

const sp = Astro.url.searchParams;

const meta = {
  lop: sp.get("lop") ?? "",
  mon: sp.get("mon") ?? "",

  quyenSach: sp.get("quyenSach") ?? "",
  lesson: sp.get("lesson") ?? "",

  game: sp.get("game") ?? "",
  level: sp.get("level") ?? "",
  skills: sp.getAll("skill").filter(Boolean),
  themes: sp.getAll("theme").filter(Boolean),
  github: sp.get("github") ?? "",
};

// Chỉ các key bạn muốn bắt buộc cho bước upload
const metaReady = Boolean(meta.lop && meta.mon && meta.quyenSach && meta.lesson && meta.game && meta.level && meta.github)
  && meta.skills.length > 0
  && meta.themes.length > 0;

// Đây là phần “tổng hợp data cần thiết” để GameUploadForm dùng build payload
const gameMeta = {
  // Những cái API create game cần trực tiếp
  grade: meta.lop,
  subject: meta.mon,
  lesson: meta.lesson ? [meta.lesson] : [],
  backendGameId: meta.game,
  level: meta.level,
  skills: meta.skills,
  themes: meta.themes,
  linkGithub: meta.github,
};

---

<Layout title="Tải Game Mới - Iruka Console">
  <div class="w-full px-6 py-4">
    <!-- Compact Header with Breadcrumb -->
    <header class="flex items-center gap-2 mb-4">
      <nav class="text-sm text-slate-500">
        <a href="/dashboard" class="hover:text-slate-700">Game Hub</a>
        <span class="mx-2">/</span>
        <span class="text-slate-900 font-medium">Upload</span>
      </nav>
      <button
        onclick="window.location.href='/dashboard'"
        class="ml-auto w-6 h-6 rounded flex items-center justify-center text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-all"
        title="Đóng"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </header>

    {metaReady ? (
      <>
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4">
          <div class="flex items-center justify-between gap-4">
            <div class="text-xs font-bold text-slate-600">
              <span class="font-black text-slate-900">Metadata:</span>
              {" "}
              {meta.lop} • {meta.mon} • {meta.quyenSach} • {meta.lesson} • {meta.game} • {meta.level} • {meta.skills} • {meta.themes}
              {" "}
              • <span class="text-iruka-blue">{meta.github}</span>
            </div>
            <a href="/upload" class="text-xs font-black text-slate-600 hover:underline">
              Sửa
            </a>
          </div>
        </div>

        <GameUploadForm meta={gameMeta} />
      </>
    ) : (
      <UploadMetaForm
        values={meta}
        options={{
          lops: [],
          mons: [],
          quyensachs: [],
          lessons: [],
          games: [],
          levels: [],
          skills: [],
          themes: [],
        }}
      />
    )}

    <!-- Collapsible Help (optional) -->
    <details class="mt-6 group">
      <summary class="text-xs font-bold text-slate-400 cursor-pointer hover:text-slate-600 flex items-center gap-1">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Hướng dẫn
        <svg class="w-3 h-3 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </summary>
      <div class="mt-3 p-3 bg-slate-50 rounded-lg text-xs text-slate-600 space-y-2">
        <p>Kiểm tra build trước khi upload:</p>
        <code class="block bg-slate-800 text-emerald-400 p-2 rounded text-[11px]">pnpm iruka-game:validate ./dist</code>
      </div>
    </div>
  </div>
</Layout>

<script>
  // Game upload state
  let uploadedFile = null;
  let manifestData = {
    gameId: 'my-awesome-game',
    version: '1.0.0',
    runtime: 'HTML5',
    entryPoint: 'index.html'
  };

  // Utility functions
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
  }

  function updateFileInfo(file) {
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const previewSize = document.getElementById('previewSize');
    
    if (fileName) fileName.textContent = file.name;
    if (fileSize) fileSize.textContent = formatFileSize(file.size);
    if (previewSize) previewSize.textContent = formatFileSize(file.size);
  }

  function updatePreview() {
    const previewGameId = document.getElementById('previewGameId');
    const previewVersion = document.getElementById('previewVersion');
    const previewRuntime = document.getElementById('previewRuntime');
    const previewEntry = document.getElementById('previewEntry');

    if (previewGameId) previewGameId.textContent = manifestData.gameId;
    if (previewVersion) previewVersion.textContent = manifestData.version;
    if (previewRuntime) previewRuntime.textContent = manifestData.runtime;
    if (previewEntry) previewEntry.textContent = manifestData.entryPoint;
  }

  function showUploadStatus() {
    const uploadStatus = document.getElementById('uploadStatus');
    const manifestSection = document.getElementById('manifestSection');
    const previewSection = document.getElementById('previewSection');
    const publishBtn = document.getElementById('publishBtn');
    
    if (uploadStatus) uploadStatus.style.display = 'block';
    if (manifestSection) manifestSection.style.display = 'block';
    if (previewSection) previewSection.style.display = 'block';
    if (publishBtn) publishBtn.disabled = false;
  }

  function simulateUpload(file) {
    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const uploadZone = document.getElementById('uploadZone');
    
    if (progressDiv) progressDiv.classList.remove('hidden');
    if (uploadZone) uploadZone.style.display = 'none';
    
    let progress = 0;
    const interval = setInterval(() => {
      progress += Math.random() * 15;
      if (progress > 100) progress = 100;
      
      if (progressBar) progressBar.style.width = progress + '%';
      if (progressText) progressText.textContent = `Đang tải lên... ${Math.round(progress)}%`;
      
      if (progress >= 100) {
        clearInterval(interval);
        if (progressText) progressText.textContent = 'Hoàn thành!';
        
        setTimeout(() => {
          updateFileInfo(file);
          showUploadStatus();
          updatePreview();
          if (progressDiv) progressDiv.classList.add('hidden');
          if (uploadZone) uploadZone.style.display = 'block';
        }, 500);
      }
    }, 100);
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', () => {
    // File upload handler
    const gameFileInput = document.getElementById('gameFile');
    if (gameFileInput) {
      gameFileInput.addEventListener('change', function(e) {
        if (e.target && e.target.files && e.target.files.length > 0) {
          uploadedFile = e.target.files[0];
          simulateUpload(uploadedFile);
        }
      });
    }

    // Drag and drop functionality
    const uploadZone = document.getElementById('uploadZone');
    if (uploadZone) {
      uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('border-blue-500', 'bg-blue-50');
      });

      uploadZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('border-blue-500', 'bg-blue-50');
      });

      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('border-blue-500', 'bg-blue-50');
        
        const files = e.dataTransfer?.files;
        if (files && files.length > 0) {
          const file = files[0];
          if (file.name.endsWith('.zip')) {
            uploadedFile = file;
            simulateUpload(file);
          } else {
            alert('Vui lòng chọn file ZIP');
          }
        }
      });
    }

    // Form input handlers
    const gameIdInput = document.getElementById('gameIdInput');
    const versionInput = document.getElementById('versionInput');
    const runtimeSelect = document.getElementById('runtimeSelect');
    const entryInput = document.getElementById('entryInput');

    if (gameIdInput) {
      gameIdInput.addEventListener('input', (e) => {
        manifestData.gameId = e.target.value;
        updatePreview();
      });
    }

    if (versionInput) {
      versionInput.addEventListener('input', (e) => {
        manifestData.version = e.target.value;
        updatePreview();
      });
    }

    if (runtimeSelect) {
      runtimeSelect.addEventListener('change', (e) => {
        manifestData.runtime = e.target.value;
        updatePreview();
      });
    }

    if (entryInput) {
      entryInput.addEventListener('input', (e) => {
        manifestData.entryPoint = e.target.value;
        updatePreview();
      });
    }

    // Publish button handler
    const publishBtn = document.getElementById('publishBtn');
    if (publishBtn) {
      publishBtn.addEventListener('click', () => {
        if (uploadedFile && manifestData.gameId) {
          console.log('Publishing game:', manifestData);
          alert('Game đã được đăng thành công!');
        }
      });
    }

    // Edit manifest button
    const editManifestBtn = document.getElementById('editManifestBtn');
    if (editManifestBtn) {
      editManifestBtn.addEventListener('click', () => {
        console.log('Toggle manifest edit mode');
      });
    }
  });
</script>

<style>
  :root {
    --iruka-blue: #2b9bf6;
  }
</style>