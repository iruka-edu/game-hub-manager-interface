---
import ConsoleLayout from '../../layouts/ConsoleLayout.astro';
import StatusChip from '../../components/StatusChip.astro';
import type { User } from '../../models/User';
import { GameRepository, type Game, type GameStatus } from '../../models/Game';
import { getUserFromRequest } from '../../lib/session';

// Auth check
const user = await getUserFromRequest(Astro.request) as User | null;
if (!user) {
  return Astro.redirect('/login?redirect=/console/my-games');
}

// Role check - only dev and admin
const hasRole = (role: string) => user?.roles?.includes(role as any) ?? false;
if (!hasRole('dev') && !hasRole('admin')) {
  return Astro.redirect('/console?error=unauthorized');
}

// Get filter from URL
const url = new URL(Astro.request.url);
const statusFilter = url.searchParams.get('status') || '';

// Get user's games
const gameRepo = await GameRepository.getInstance();
const userId = user._id.toString();
let games = await gameRepo.findByOwnerId(userId);

// Apply status filter
if (statusFilter) {
  games = games.filter(g => g.status === statusFilter);
}

// Group games by status for display
const groupedGames: Record<string, Game[]> = {
  draft: games.filter(g => g.status === 'draft'),
  qc_failed: games.filter(g => g.status === 'qc_failed'),
  uploaded: games.filter(g => g.status === 'uploaded'),
  qc_passed: games.filter(g => g.status === 'qc_passed'),
  approved: games.filter(g => g.status === 'approved'),
  published: games.filter(g => g.status === 'published'),
};

const statusLabels: Record<string, string> = {
  draft: 'Nháp',
  qc_failed: 'QC cần sửa',
  uploaded: 'Đang chờ QC',
  qc_passed: 'QC đạt - Chờ duyệt',
  approved: 'Đã duyệt - Chờ xuất bản',
  published: 'Đã xuất bản',
};
---

<ConsoleLayout title="Game của tôi" user={user} activeMenu="my-games">
  <div class="p-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-2xl font-bold text-slate-900">Game của tôi</h1>
        <p class="text-slate-500 mt-1">Quản lý các game bạn đang phát triển</p>
      </div>
      <a href="/upload" class="btn-primary flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Tạo game mới
      </a>
    </div>

    <!-- Filter Tabs -->
    <div class="flex items-center gap-2 mb-6 overflow-x-auto pb-2">
      <a 
        href="/console/my-games" 
        class={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors ${
          !statusFilter ? 'bg-indigo-600 text-white' : 'bg-white text-slate-600 hover:bg-slate-100 border border-slate-200'
        }`}
      >
        Tất cả ({games.length})
      </a>
      {Object.entries(groupedGames).map(([status, statusGames]) => (
        statusGames.length > 0 && (
          <a 
            href={`/console/my-games?status=${status}`}
            class={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors ${
              statusFilter === status ? 'bg-indigo-600 text-white' : 'bg-white text-slate-600 hover:bg-slate-100 border border-slate-200'
            }`}
          >
            {statusLabels[status]} ({statusGames.length})
          </a>
        )
      ))}
    </div>

    <!-- Games List -->
    {games.length > 0 ? (
      <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
        <table class="w-full">
          <thead class="bg-slate-50 border-b border-slate-200">
            <tr>
              <th class="text-left px-6 py-4 text-sm font-semibold text-slate-700">Game</th>
              <th class="text-left px-6 py-4 text-sm font-semibold text-slate-700">Trạng thái</th>
              <th class="text-left px-6 py-4 text-sm font-semibold text-slate-700">Cập nhật</th>
              <th class="text-right px-6 py-4 text-sm font-semibold text-slate-700">Thao tác</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            {games.map(game => (
              <tr class="hover:bg-slate-50 transition-colors">
                <td class="px-6 py-4">
                  <a href={`/console/games/${game._id}`} class="block">
                    <p class="font-medium text-slate-900 hover:text-indigo-600">{game.title || game.gameId}</p>
                    <p class="text-sm text-slate-500">{game.gameId}</p>
                  </a>
                </td>
                <td class="px-6 py-4">
                  <StatusChip status={game.status} size="sm" />
                </td>
                <td class="px-6 py-4 text-sm text-slate-500">
                  {game.updatedAt.toLocaleDateString('vi-VN')}
                </td>
                <td class="px-6 py-4">
                  <div class="flex items-center justify-end gap-2">
                    {/* Edit button - only for draft, qc_failed */}
                    {['draft', 'qc_failed'].includes(game.status) && (
                      <a 
                        href={`/console/games/${game._id}/edit`}
                        class="px-3 py-1.5 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors"
                      >
                        Sửa
                      </a>
                    )}
                    
                    {/* Submit to QC - only for draft, qc_failed */}
                    {['draft', 'qc_failed'].includes(game.status) && (
                      <button 
                        class="submit-qc-btn px-3 py-1.5 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors"
                        data-game-id={game._id.toString()}
                        data-game-title={game.title || game.gameId}
                      >
                        Gửi QC
                      </button>
                    )}
                    
                    {/* View only for other statuses */}
                    {!['draft', 'qc_failed'].includes(game.status) && (
                      <a 
                        href={`/console/games/${game._id}`}
                        class="px-3 py-1.5 text-sm font-medium text-indigo-600 hover:text-indigo-800 hover:bg-indigo-50 rounded-lg transition-colors"
                      >
                        Xem chi tiết
                      </a>
                    )}
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    ) : (
      <div class="bg-white rounded-xl border border-slate-200 p-16 text-center">
        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-slate-100 flex items-center justify-center">
          <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-slate-900 mb-2">
          {statusFilter ? `Không có game nào ở trạng thái "${statusLabels[statusFilter]}"` : 'Bạn chưa có game nào'}
        </h3>
        <p class="text-slate-500 mb-6">
          {statusFilter ? 'Thử chọn bộ lọc khác' : 'Bắt đầu bằng cách tạo game mới'}
        </p>
        {!statusFilter && (
          <a href="/upload" class="btn-primary inline-flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Tạo game đầu tiên
          </a>
        )}
      </div>
    )}
  </div>

  <!-- Submit QC Modal -->
  <div id="submitQcModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-xl max-w-md w-full mx-4 p-6">
      <h3 class="text-lg font-semibold text-slate-900 mb-4">Gửi game để QC kiểm tra</h3>
      <p class="text-slate-600 mb-4">Bạn đang gửi game "<span id="modalGameTitle" class="font-medium"></span>" để QC kiểm tra.</p>
      
      <div class="mb-6">
        <p class="text-sm font-medium text-slate-700 mb-3">Checklist trước khi gửi:</p>
        <div class="space-y-2">
          <label class="flex items-center gap-2 text-sm text-slate-600">
            <input type="checkbox" class="qc-checklist rounded border-slate-300" />
            Đã test âm thanh trên các thiết bị
          </label>
          <label class="flex items-center gap-2 text-sm text-slate-600">
            <input type="checkbox" class="qc-checklist rounded border-slate-300" />
            Đã test responsive (mobile, tablet)
          </label>
          <label class="flex items-center gap-2 text-sm text-slate-600">
            <input type="checkbox" class="qc-checklist rounded border-slate-300" />
            Logic game hoạt động đúng
          </label>
          <label class="flex items-center gap-2 text-sm text-slate-600">
            <input type="checkbox" class="qc-checklist rounded border-slate-300" />
            Nội dung phù hợp với yêu cầu
          </label>
        </div>
      </div>
      
      <div class="flex items-center justify-end gap-3">
        <button id="cancelSubmitQc" class="btn-secondary">Hủy</button>
        <button id="confirmSubmitQc" class="btn-primary" disabled>Xác nhận gửi QC</button>
      </div>
    </div>
  </div>
</ConsoleLayout>

<script>
  const modal = document.getElementById('submitQcModal');
  const modalTitle = document.getElementById('modalGameTitle');
  const cancelBtn = document.getElementById('cancelSubmitQc');
  const confirmBtn = document.getElementById('confirmSubmitQc') as HTMLButtonElement;
  const checkboxes = document.querySelectorAll('.qc-checklist');
  let currentGameId = '';

  // Open modal
  document.querySelectorAll('.submit-qc-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      currentGameId = (btn as HTMLElement).dataset.gameId || '';
      const title = (btn as HTMLElement).dataset.gameTitle || '';
      if (modalTitle) modalTitle.textContent = title;
      modal?.classList.remove('hidden');
      modal?.classList.add('flex');
      
      // Reset checkboxes
      checkboxes.forEach(cb => (cb as HTMLInputElement).checked = false);
      if (confirmBtn) confirmBtn.disabled = true;
    });
  });

  // Close modal
  cancelBtn?.addEventListener('click', () => {
    modal?.classList.add('hidden');
    modal?.classList.remove('flex');
  });

  // Check all checkboxes
  checkboxes.forEach(cb => {
    cb.addEventListener('change', () => {
      const allChecked = Array.from(checkboxes).every(c => (c as HTMLInputElement).checked);
      if (confirmBtn) confirmBtn.disabled = !allChecked;
    });
  });

  // Submit to QC
  confirmBtn?.addEventListener('click', async () => {
    if (!currentGameId) return;
    
    try {
      const response = await fetch(`/api/games/submit-qc`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ gameId: currentGameId })
      });
      
      if (response.ok) {
        window.location.reload();
      } else {
        alert('Có lỗi xảy ra. Vui lòng thử lại.');
      }
    } catch (error) {
      alert('Có lỗi xảy ra. Vui lòng thử lại.');
    }
  });
</script>
