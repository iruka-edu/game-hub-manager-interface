---
import ConsoleLayout from '../../layouts/ConsoleLayout.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import EmptyState from '../../components/EmptyState.astro';
import DeleteGameModal from '../../components/DeleteGameModal.astro';
import GameTable from '../../components/GameTable.astro';
import GameFilters from '../../components/GameFilters.astro';
import BulkActions from '../../components/BulkActions.astro';
import GCSManagement from '../../components/GCSManagement.astro';
import SubmitQCModal from '../../components/modals/SubmitQCModal.astro';
import UpdateCodeModal from '../../components/modals/UpdateCodeModal.astro';
import type { User } from '../../models/User';
import { GameRepository, type Game } from '../../models/Game';
import { GameVersionRepository, type GameVersion, type VersionStatus } from '../../models/GameVersion';
import { getUserFromRequest } from '../../lib/session';

// Auth check
const user = await getUserFromRequest(Astro.request) as User | null;
if (!user) {
  return Astro.redirect('/login?redirect=/console/my-games');
}

// Role check - only dev and admin
const hasRole = (role: string) => user?.roles?.includes(role as any) ?? false;
if (!hasRole('dev') && !hasRole('admin')) {
  return Astro.redirect('/console?error=unauthorized');
}

// Get filter from URL
const url = new URL(Astro.request.url);
const statusFilter = url.searchParams.get('status') || '';

// Get user's games with their latest version info
const gameRepo = await GameRepository.getInstance();
const versionRepo = await GameVersionRepository.getInstance();
const userId = user._id.toString();
const rawGames = await gameRepo.findByOwnerId(userId);

// Fetch latest version for each game
interface GameWithVersion {
  game: Game;
  latestVersion: GameVersion | null;
  liveVersion: GameVersion | null;
}

const gamesWithVersions: GameWithVersion[] = await Promise.all(
  rawGames.map(async (game) => {
    const latestVersion = game.latestVersionId 
      ? await versionRepo.findById(game.latestVersionId.toString())
      : await versionRepo.getLatestVersion(game._id.toString());
    const liveVersion = game.liveVersionId
      ? await versionRepo.findById(game.liveVersionId.toString())
      : null;
    return { game, latestVersion, liveVersion };
  })
);

// Apply status filter based on latest version status
let filteredGames = gamesWithVersions;
if (statusFilter) {
  filteredGames = gamesWithVersions.filter(g => g.latestVersion?.status === statusFilter);
}

// Group games by latest version status for display
const groupedGames: Record<string, GameWithVersion[]> = {
  draft: gamesWithVersions.filter(g => g.latestVersion?.status === 'draft'),
  qc_failed: gamesWithVersions.filter(g => g.latestVersion?.status === 'qc_failed'),
  uploaded: gamesWithVersions.filter(g => g.latestVersion?.status === 'uploaded'),
  qc_processing: gamesWithVersions.filter(g => g.latestVersion?.status === 'qc_processing'),
  qc_passed: gamesWithVersions.filter(g => g.latestVersion?.status === 'qc_passed'),
  approved: gamesWithVersions.filter(g => g.latestVersion?.status === 'approved'),
  published: gamesWithVersions.filter(g => g.latestVersion?.status === 'published'),
};

const statusLabels: Record<string, string> = {
  draft: 'Nháp',
  qc_failed: 'QC cần sửa',
  uploaded: 'Đang chờ QC',
  qc_processing: 'Đang QC',
  qc_passed: 'QC đạt - Chờ duyệt',
  approved: 'Đã duyệt - Chờ xuất bản',
  published: 'Đã xuất bản',
};

const breadcrumbItems = [
  { label: 'Console', href: '/console' },
  { label: 'Game của tôi' }
];

// Check if bulk actions should be enabled (only for dev/admin)
const enableBulkActions = hasRole('dev') || hasRole('admin');

// Get current tab from URL
const currentTab = url.searchParams.get('tab') || 'games';
---

<ConsoleLayout title="Game của tôi" user={user} activeMenu="my-games">
  <div class="p-8">
    <!-- Breadcrumb Navigation -->
    <Breadcrumb items={breadcrumbItems} />

    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-2xl font-bold text-slate-900">Game của tôi</h1>
        <p class="text-slate-500 mt-1">Quản lý các game bạn đang phát triển</p>
      </div>
      <a href="/upload" class="btn-primary flex items-center gap-2 min-h-[40px] px-6 py-3">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Tạo game mới
      </a>
    </div>

    <!-- Tab Navigation -->
    <div class="flex items-center gap-1 mb-6 border-b border-slate-200">
      <a 
        href="/console/my-games?tab=games" 
        class={`px-4 py-3 text-sm font-medium border-b-2 transition-colors ${
          currentTab === 'games' 
            ? 'border-indigo-600 text-indigo-600' 
            : 'border-transparent text-slate-600 hover:text-slate-900 hover:border-slate-300'
        }`}
      >
        <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
        </svg>
        Danh sách game
      </a>
      {hasRole('admin') && (
        <a 
          href="/console/my-games?tab=gcs" 
          class={`px-4 py-3 text-sm font-medium border-b-2 transition-colors ${
            currentTab === 'gcs' 
              ? 'border-indigo-600 text-indigo-600' 
              : 'border-transparent text-slate-600 hover:text-slate-900 hover:border-slate-300'
          }`}
        >
          <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path>
          </svg>
          Quản lý GCS
        </a>
      )}
    </div>

    <!-- Games Tab Content -->
    {currentTab === 'games' && (
      <>
        <!-- Filter Tabs -->
        <GameFilters 
          statusFilter={statusFilter}
          groupedGames={groupedGames}
          filteredGames={filteredGames}
        />

        <!-- Games List -->
        {filteredGames.length > 0 ? (
          <GameTable 
            games={filteredGames}
            showBulkActions={enableBulkActions}
          />
        ) : (
          <EmptyState 
            title={statusFilter ? `Không có game nào ở trạng thái "${statusLabels[statusFilter]}"` : 'Bạn chưa có game nào'}
            description={statusFilter ? 'Thử chọn bộ lọc khác hoặc tạo game mới' : 'Bắt đầu bằng cách tạo game đầu tiên của bạn'}
            icon="games"
            actionText={statusFilter ? undefined : "Tạo game đầu tiên"}
            actionHref={statusFilter ? undefined : "/upload"}
            secondaryActionText={statusFilter ? "Xóa bộ lọc" : undefined}
            secondaryActionHref={statusFilter ? "/console/my-games" : undefined}
          />
        )}

        <!-- Bulk Actions -->
        {enableBulkActions && <BulkActions />}
      </>
    )}

    <!-- GCS Management Tab Content -->
    {currentTab === 'gcs' && (
      <GCSManagement userRoles={user.roles || []} />
    )}
  </div>

  <!-- Modals -->
  <SubmitQCModal />
  <UpdateCodeModal />

  <!-- Delete Game Modals -->
  {filteredGames.map(({ game }) => (
    <DeleteGameModal 
      gameId={game._id.toString()} 
      gameTitle={game.title || game.gameId} 
      userRoles={user.roles || []}
    />
  ))}
</ConsoleLayout>

<style>
  /* Custom styles for game table */
  .game-checkbox:checked {
    background-color: rgb(79 70 229);
    border-color: rgb(79 70 229);
  }

  .version-history-row {
    transition: all 0.2s ease-in-out;
  }

  #bulkActions {
    transition: all 0.2s ease-in-out;
  }

  /* Mobile responsive improvements */
  @media (max-width: 768px) {
    #bulkActions {
      left: 1rem;
      right: 1rem;
      transform: none;
      translate: 0;
    }
  }
</style>

<script>
  import { GameTableHandlers } from '../../scripts/gameTableHandlers';
  import { ModalHandlers } from '../../scripts/modalHandlers';
  import { GCSManagement } from '../../scripts/gcsManagement';

  // Initialize handlers when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    new GameTableHandlers();
    new ModalHandlers();
    
    // Initialize GCS management if on GCS tab
    const urlParams = new URLSearchParams(window.location.search);
    const currentTab = urlParams.get('tab') || 'games';
    
    if (currentTab === 'gcs') {
      new GCSManagement();
    }
  });
</script>
