---
import ConsoleLayout from '../../../../layouts/ConsoleLayout.astro';
import StatusChip from '../../../../components/StatusChip.astro';
import WorkflowTimeline from '../../../../components/WorkflowTimeline.astro';
import QCPerformanceCheck from '../../../../components/QCPerformanceCheck.astro';
import PerformanceMonitor from '../../../../components/PerformanceMonitor.astro';
import DeviceInfo from '../../../../components/DeviceInfo.astro';
import type { User } from '../../../../models/User';
import { GameRepository } from '../../../../models/Game';
import { GameVersionRepository } from '../../../../models/GameVersion';
import { UserRepository } from '../../../../models/User';
import { QCReportRepository } from '../../../../models/QcReport';
import { getUserFromRequest } from '../../../../lib/session';

// Auth check
const user = await getUserFromRequest(Astro.request) as User | null;
if (!user) {
  return Astro.redirect('/login');
}

// Role check - only QC and admin
const hasRole = (role: string) => user?.roles?.includes(role as any) ?? false;
if (!hasRole('qc') && !hasRole('admin')) {
  return Astro.redirect('/console?error=unauthorized');
}

// Get game and version
const { id } = Astro.params;
const gameRepo = await GameRepository.getInstance();
const versionRepo = await GameVersionRepository.getInstance();
const userRepo = await UserRepository.getInstance();
const qcRepo = await QCReportRepository.getInstance();
const game = await gameRepo.findById(id || '');

if (!game) {
  return Astro.redirect('/console/qc-inbox?error=not-found');
}

// Get latest version or find uploaded version
let version = null;
if (game.latestVersionId) {
  version = await versionRepo.findById(game.latestVersionId.toString());
} else {
  // Fallback: find uploaded version
  const versions = await versionRepo.findByGameId(id || '');
  const uploadedVersion = versions.find(v => v.status === 'uploaded');
  if (uploadedVersion) {
    version = uploadedVersion;
    // Update game's latestVersionId
    await gameRepo.updateLatestVersion(id || '', uploadedVersion._id);
  }
}

if (!version) {
  return Astro.redirect('/console/qc-inbox?error=no-version');
}

// Check if version is in correct status for QC
if (!['uploaded', 'qc_processing'].includes(version.status)) {
  return Astro.redirect(`/console/games/${id}?error=invalid-status`);
}

// Get owner info
const owner = await userRepo.findById(game.ownerId);
const ownerName = owner?.name || owner?.email || 'Unknown';

// Get QC attempt count and previous reports
const attemptCount = await qcRepo.countByGameId(id || '');
const previousReports = await qcRepo.findByGameId(id || '');
const lastReport = previousReports[0];

// Simple QC checklist categories for the old review interface
const QC_CHECKLIST_CATEGORIES = [
  { id: 'gameplay', label: 'Gameplay' },
  { id: 'ui', label: 'User Interface' },
  { id: 'audio', label: 'Audio' },
  { id: 'performance', label: 'Performance' },
  { id: 'content', label: 'Content' }
];
---

<ConsoleLayout title={`Review: ${game.title || game.gameId}`} user={user} activeMenu="qc-inbox">
  <div class="p-8">
    <!-- Breadcrumb -->
    <div class="mb-6">
      <a href="/console/qc-inbox" class="text-slate-500 hover:text-slate-900 text-sm flex items-center gap-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Quay lại QC Inbox
      </a>
    </div>

    <!-- Header -->
    <div class="flex items-start justify-between mb-8">
      <div>
        <div class="flex items-center gap-3 mb-2">
          <h1 class="text-2xl font-bold text-slate-900">{game.title || game.gameId}</h1>
          <StatusChip status={version.status} />
        </div>
        <p class="text-slate-500">{game.gameId} v{version.version}</p>
        <p class="text-sm text-slate-400 mt-1">Dev: {ownerName}</p>
      </div>
    </div>

    <!-- Workflow Timeline -->
    <div class="bg-white rounded-xl border border-slate-200 p-6 mb-8">
      <h3 class="text-sm font-semibold text-slate-700 mb-4">Tiến trình</h3>
      <WorkflowTimeline currentStatus={version.status} />
    </div>

    <!-- Game Metadata -->
    <div class="bg-white rounded-xl border border-slate-200 p-6 mb-8">
      <h3 class="text-sm font-semibold text-slate-700 mb-4">Thông tin game</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
        <div>
          <span class="text-slate-500">Môn học:</span>
          <span class="ml-2 font-medium">{game.subject || '-'}</span>
        </div>
        <div>
          <span class="text-slate-500">Lớp:</span>
          <span class="ml-2 font-medium">{game.grade || '-'}</span>
        </div>
        <div>
          <span class="text-slate-500">Unit:</span>
          <span class="ml-2 font-medium">{game.unit || '-'}</span>
        </div>
        <div>
          <span class="text-slate-500">Loại:</span>
          <span class="ml-2 font-medium">{game.gameType || '-'}</span>
        </div>
        <div>
          <span class="text-slate-500">Độ ưu tiên:</span>
          <span class={`ml-2 font-medium ${game.priority === 'high' ? 'text-red-600' : game.priority === 'medium' ? 'text-yellow-600' : 'text-slate-600'}`}>
            {game.priority === 'high' ? 'Cao' : game.priority === 'medium' ? 'Trung bình' : 'Thấp'}
          </span>
        </div>
        <div>
          <span class="text-slate-500">Lần QC:</span>
          <span class={`ml-2 font-medium ${attemptCount > 0 ? 'text-orange-600' : ''}`}>
            #{attemptCount + 1}
          </span>
        </div>
        {lastReport && (
          <div>
            <span class="text-slate-500">Lỗi trước:</span>
            <span class={`ml-2 font-medium ${lastReport.severity === 'critical' ? 'text-red-600' : lastReport.severity === 'major' ? 'text-orange-600' : 'text-yellow-600'}`}>
              {lastReport.severity === 'critical' ? 'Nghiêm trọng' : lastReport.severity === 'major' ? 'Lớn' : 'Nhỏ'}
            </span>
          </div>
        )}
        {version.lastCodeUpdateAt && (
          <div class="col-span-2">
            <span class="text-slate-500">Cập nhật code lần cuối:</span>
            <span class="ml-2 font-medium text-blue-600">
              {new Date(version.lastCodeUpdateAt).toLocaleString('vi-VN', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
              })}
            </span>
          </div>
        )}
      </div>
    </div>

    <!-- Dev's Self-QA Checklist -->
    {version.selfQAChecklist && (
      <div class="bg-amber-50 rounded-xl border border-amber-200 p-6 mb-8">
        <h3 class="text-sm font-semibold text-amber-800 mb-4 flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
          </svg>
          Self-QA của Dev
        </h3>
        <div class="space-y-2">
          <div class="flex items-center gap-2 text-sm">
            {version.selfQAChecklist.testedDevices ? (
              <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            ) : (
              <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            )}
            <span class={version.selfQAChecklist.testedDevices ? 'text-amber-800' : 'text-slate-500'}>Đã test trên các thiết bị</span>
          </div>
          <div class="flex items-center gap-2 text-sm">
            {version.selfQAChecklist.testedAudio ? (
              <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            ) : (
              <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            )}
            <span class={version.selfQAChecklist.testedAudio ? 'text-amber-800' : 'text-slate-500'}>Đã test âm thanh</span>
          </div>
          <div class="flex items-center gap-2 text-sm">
            {version.selfQAChecklist.gameplayComplete ? (
              <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            ) : (
              <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            )}
            <span class={version.selfQAChecklist.gameplayComplete ? 'text-amber-800' : 'text-slate-500'}>Đã chơi hết tất cả màn</span>
          </div>
          <div class="flex items-center gap-2 text-sm">
            {version.selfQAChecklist.contentVerified ? (
              <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            ) : (
              <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            )}
            <span class={version.selfQAChecklist.contentVerified ? 'text-amber-800' : 'text-slate-500'}>Đã đối chiếu nội dung</span>
          </div>
        </div>
        {version.selfQAChecklist.note && (
          <div class="mt-4 pt-4 border-t border-amber-200">
            <p class="text-sm text-amber-700"><strong>Ghi chú:</strong> {version.selfQAChecklist.note}</p>
          </div>
        )}
      </div>
    )}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Game Preview -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
          <div class="p-4 border-b border-slate-200 flex items-center justify-between">
            <h3 class="font-semibold text-slate-900">Preview Game</h3>
            <div class="flex items-center gap-3">
              <button 
                id="load-game-btn" 
                class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-lg transition-colors"
                data-game-url={`/play/${game._id}`}
              >
                Tải Game để Test
              </button>
              <div class="flex items-center gap-2">
                <button class="device-btn px-3 py-1.5 text-sm rounded-lg bg-slate-100 text-slate-600" data-device="mobile">Mobile</button>
                <button class="device-btn px-3 py-1.5 text-sm rounded-lg bg-indigo-100 text-indigo-700" data-device="tablet">Tablet</button>
                <button class="device-btn px-3 py-1.5 text-sm rounded-lg bg-slate-100 text-slate-600" data-device="desktop">Desktop</button>
              </div>
            </div>
          </div>
          <div class="p-4 bg-slate-100 flex items-center justify-center min-h-[500px]">
            <div id="preview-container" class="bg-white shadow-lg rounded-lg overflow-hidden transition-all" style="width: 768px; height: 500px;">
              <div id="game-placeholder" class="w-full h-full flex items-center justify-center">
                <div class="text-center">
                  <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-slate-200 flex items-center justify-center">
                    <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  <p class="text-slate-500 text-sm">Nhấn "Tải Game để Test" để xem trước game</p>
                </div>
              </div>
              <iframe 
                id="game-iframe"
                class="w-full h-full border-0 hidden"
                title="Game Preview"
                sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-presentation"
              ></iframe>
            </div>
          </div>
        </div>
      </div>

      <!-- QC Panel -->
      <div class="space-y-6">
        <!-- Performance Check -->
        <QCPerformanceCheck gameId={game._id.toString()} />

        <!-- QC Checklist -->
        <div class="bg-white rounded-xl border border-slate-200 p-6">
          <h3 class="font-semibold text-slate-900 mb-4">Checklist kiểm tra</h3>
          <div class="space-y-4">
            {QC_CHECKLIST_CATEGORIES.map(cat => (
              <div class="qc-item border border-slate-200 rounded-lg p-3" data-category={cat.id}>
                <div class="flex items-center justify-between mb-2">
                  <span class="font-medium text-slate-700">{cat.label}</span>
                  <div class="flex gap-1">
                    <button type="button" class="status-btn px-2 py-1 text-xs rounded bg-green-100 text-green-700 hover:bg-green-200" data-status="ok">OK</button>
                    <button type="button" class="status-btn px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-700 hover:bg-yellow-200" data-status="warning">Cảnh báo</button>
                    <button type="button" class="status-btn px-2 py-1 text-xs rounded bg-red-100 text-red-700 hover:bg-red-200" data-status="fail">Lỗi</button>
                  </div>
                </div>
                <input 
                  type="text" 
                  class="item-note w-full px-2 py-1 text-sm border border-slate-200 rounded focus:ring-1 focus:ring-indigo-500"
                  placeholder="Ghi chú (nếu có)..."
                />
              </div>
            ))}
          </div>
        </div>

        <!-- Severity (for fail) -->
        <div class="bg-white rounded-xl border border-slate-200 p-6" id="severity-section">
          <h3 class="font-semibold text-slate-900 mb-4">Mức độ nghiêm trọng</h3>
          <div class="space-y-2">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="severity" value="minor" class="text-indigo-600" />
              <span class="text-sm"><strong class="text-yellow-600">Nhỏ</strong> - Lỗi nhỏ, không ảnh hưởng gameplay</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="severity" value="major" class="text-indigo-600" />
              <span class="text-sm"><strong class="text-orange-600">Lớn</strong> - Ảnh hưởng trải nghiệm người dùng</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="severity" value="critical" class="text-indigo-600" />
              <span class="text-sm"><strong class="text-red-600">Nghiêm trọng</strong> - Game không thể chơi được</span>
            </label>
          </div>
        </div>

        <!-- Note -->
        <div class="bg-white rounded-xl border border-slate-200 p-6">
          <h3 class="font-semibold text-slate-900 mb-4">Ghi chú cho Dev</h3>
          <textarea 
            id="qc-note"
            rows="4"
            class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            placeholder="Nhập ghi chú nếu có vấn đề cần sửa..."
          ></textarea>
        </div>

        <!-- Actions -->
        <div class="bg-white rounded-xl border border-slate-200 p-6">
          <h3 class="font-semibold text-slate-900 mb-4">Kết quả QC</h3>
          <div class="space-y-3">
            <button 
              id="qc-pass-btn"
              class="w-full btn-success flex items-center justify-center gap-2"
              data-version-id={version._id.toString()}
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              QC Đạt
            </button>
            <button 
              id="qc-fail-btn"
              class="w-full btn-danger flex items-center justify-center gap-2"
              data-version-id={version._id.toString()}
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
              QC Cần sửa
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</ConsoleLayout>

<script>
  // Load Game Preview
  document.getElementById('load-game-btn')?.addEventListener('click', (e) => {
    const button = e.target as HTMLButtonElement;
    const gameUrl = button.dataset.gameUrl;
    const placeholder = document.getElementById('game-placeholder');
    const iframe = document.getElementById('game-iframe') as HTMLIFrameElement;
    
    if (gameUrl && placeholder && iframe) {
      // Show loading state
      button.textContent = 'Đang tải...';
      button.disabled = true;
      
      // Set iframe src and show it
      iframe.src = gameUrl;
      iframe.onload = () => {
        placeholder.classList.add('hidden');
        iframe.classList.remove('hidden');
        button.textContent = 'Tải lại Game';
        button.disabled = false;
      };
      
      iframe.onerror = () => {
        button.textContent = 'Lỗi - Thử lại';
        button.disabled = false;
      };
    }
  });

  const container = document.getElementById('preview-container') as HTMLElement;
  const deviceBtns = document.querySelectorAll('.device-btn');
  
  const sizes = {
    mobile: { width: '375px', height: '667px' },
    tablet: { width: '768px', height: '500px' },
    desktop: { width: '100%', height: '500px' }
  };
  
  deviceBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const device = (btn as HTMLElement).dataset.device as keyof typeof sizes;
      const size = sizes[device];
      
      container.style.width = size.width;
      container.style.height = size.height;
      
      deviceBtns.forEach(b => {
        b.classList.remove('bg-indigo-100', 'text-indigo-700');
        b.classList.add('bg-slate-100', 'text-slate-600');
      });
      btn.classList.remove('bg-slate-100', 'text-slate-600');
      btn.classList.add('bg-indigo-100', 'text-indigo-700');
    });
  });

  // QC Checklist status buttons
  const qcItems = document.querySelectorAll('.qc-item');
  const checklistState: Record<string, { status: string; note: string }> = {};

  qcItems.forEach(item => {
    const category = (item as HTMLElement).dataset.category!;
    const statusBtns = item.querySelectorAll('.status-btn');
    const noteInput = item.querySelector('.item-note') as HTMLInputElement;

    checklistState[category] = { status: '', note: '' };

    statusBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const status = (btn as HTMLElement).dataset.status!;
        checklistState[category].status = status;

        // Update button styles
        statusBtns.forEach(b => {
          b.classList.remove('ring-2', 'ring-offset-1');
        });
        btn.classList.add('ring-2', 'ring-offset-1');
      });
    });

    noteInput?.addEventListener('input', () => {
      checklistState[category].note = noteInput.value;
    });
  });
  
  // QC Actions
  const passBtn = document.getElementById('qc-pass-btn');
  const failBtn = document.getElementById('qc-fail-btn');
  const noteInput = document.getElementById('qc-note') as HTMLTextAreaElement;

  function getChecklist() {
    return Object.entries(checklistState).map(([category, data]) => ({
      category,
      status: data.status || 'ok',
      note: data.note || undefined,
    }));
  }

  function getSeverity(): string | null {
    const checked = document.querySelector('input[name="severity"]:checked') as HTMLInputElement;
    return checked?.value || null;
  }
  
  async function submitQCResult(result: 'pass' | 'fail') {
    const versionId = passBtn?.dataset.versionId;
    const note = noteInput?.value || '';
    const checklist = getChecklist();
    const severity = getSeverity();
    
    if (result === 'fail' && !note.trim()) {
      alert('Vui lòng nhập ghi chú khi QC không đạt');
      return;
    }

    if (result === 'fail' && !severity) {
      alert('Vui lòng chọn mức độ nghiêm trọng');
      return;
    }
    
    try {
      const response = await fetch('/api/games/qc-result', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ versionId, result, checklist, note, severity })
      });
      
      const data = await response.json();
      
      if (response.ok) {
        window.location.href = '/console/qc-inbox';
      } else {
        alert(data.error || 'Có lỗi xảy ra');
      }
    } catch {
      alert('Có lỗi xảy ra');
    }
  }
  
  passBtn?.addEventListener('click', () => submitQCResult('pass'));
  failBtn?.addEventListener('click', () => submitQCResult('fail'));
</script>

<!-- Performance Monitor (Development only) -->
<PerformanceMonitor />

<!-- Device Info (Development only) -->
<DeviceInfo />
