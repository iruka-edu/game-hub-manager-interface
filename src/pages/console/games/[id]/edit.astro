---
import ConsoleLayout from '../../../../layouts/ConsoleLayout.astro';
import type { User } from '../../../../models/User';
import { GameRepository } from '../../../../models/Game';
import { getUserFromRequest } from '../../../../lib/session';
import { hasPermissionString } from '../../../../auth/auth-rbac';

// Auth check
const user = await getUserFromRequest(Astro.request) as User | null;
if (!user) {
  return Astro.redirect('/login?redirect=' + Astro.url.pathname);
}

// Get game
const { id } = Astro.params;
const gameRepo = await GameRepository.getInstance();
const game = await gameRepo.findById(id!);

if (!game) {
  return Astro.redirect('/404');
}

// Check ownership
const isOwner = game.ownerId === user._id.toString();
const isAdmin = user.roles.includes('admin');
if (!isOwner && !isAdmin) {
  return Astro.redirect('/403');
}

// Check status
const canEdit = ['draft', 'qc_failed'].includes(game.status);
if (!canEdit) {
  return Astro.redirect(`/console/games/${id}?error=cannot_edit`);
}
---

<ConsoleLayout title={`Sửa: ${game.title}`} user={user} activeMenu="my-games">
  <div class="p-8 max-w-2xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
      <a href={`/console/games/${id}`} class="text-indigo-600 hover:text-indigo-800 text-sm font-medium mb-2 inline-block">
        ← Quay lại chi tiết game
      </a>
      <h1 class="text-2xl font-bold text-slate-900">Sửa thông tin game</h1>
      <p class="text-slate-500 mt-1">Game ID: {game.gameId}</p>
    </div>

    <!-- Form -->
    <form id="editGameForm" class="bg-white rounded-xl border border-slate-200 p-6 space-y-6">
      <input type="hidden" name="gameId" value={id} />

      <!-- Title -->
      <div>
        <label for="title" class="block text-sm font-medium text-slate-700 mb-1">
          Tên game <span class="text-red-500">*</span>
        </label>
        <input
          type="text"
          id="title"
          name="title"
          required
          value={game.title}
          class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
        />
      </div>

      <!-- Description -->
      <div>
        <label for="description" class="block text-sm font-medium text-slate-700 mb-1">Mô tả</label>
        <textarea
          id="description"
          name="description"
          rows="3"
          class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
        >{game.description || ''}</textarea>
      </div>

      <!-- Subject & Grade -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label for="subject" class="block text-sm font-medium text-slate-700 mb-1">Môn học</label>
          <select
            id="subject"
            name="subject"
            class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500"
          >
            <option value="">Chọn môn học</option>
            <option value="math" selected={game.subject === 'math'}>Toán</option>
            <option value="vietnamese" selected={game.subject === 'vietnamese'}>Tiếng Việt</option>
            <option value="english" selected={game.subject === 'english'}>Tiếng Anh</option>
            <option value="science" selected={game.subject === 'science'}>Khoa học</option>
            <option value="other" selected={game.subject === 'other'}>Khác</option>
          </select>
        </div>
        <div>
          <label for="grade" class="block text-sm font-medium text-slate-700 mb-1">Lớp</label>
          <select
            id="grade"
            name="grade"
            class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500"
          >
            <option value="">Chọn lớp</option>
            <option value="1" selected={game.grade === '1'}>Lớp 1</option>
            <option value="2" selected={game.grade === '2'}>Lớp 2</option>
            <option value="3" selected={game.grade === '3'}>Lớp 3</option>
            <option value="4" selected={game.grade === '4'}>Lớp 4</option>
            <option value="5" selected={game.grade === '5'}>Lớp 5</option>
          </select>
        </div>
      </div>

      <!-- Unit & Game Type -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label for="unit" class="block text-sm font-medium text-slate-700 mb-1">Unit SGK</label>
          <input
            type="text"
            id="unit"
            name="unit"
            value={game.unit || ''}
            class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
          />
        </div>
        <div>
          <label for="gameType" class="block text-sm font-medium text-slate-700 mb-1">Loại game</label>
          <select
            id="gameType"
            name="gameType"
            class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500"
          >
            <option value="">Chọn loại</option>
            <option value="quiz" selected={game.gameType === 'quiz'}>Quiz</option>
            <option value="matching" selected={game.gameType === 'matching'}>Matching</option>
            <option value="puzzle" selected={game.gameType === 'puzzle'}>Puzzle</option>
            <option value="adventure" selected={game.gameType === 'adventure'}>Adventure</option>
            <option value="other" selected={game.gameType === 'other'}>Khác</option>
          </select>
        </div>
      </div>

      <!-- Priority -->
      <div>
        <label for="priority" class="block text-sm font-medium text-slate-700 mb-1">Độ ưu tiên</label>
        <select
          id="priority"
          name="priority"
          class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500"
        >
          <option value="low" selected={game.priority === 'low'}>Thấp</option>
          <option value="medium" selected={game.priority === 'medium' || !game.priority}>Trung bình</option>
          <option value="high" selected={game.priority === 'high'}>Cao</option>
        </select>
      </div>

      <!-- Error message -->
      <div id="errorMessage" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"></div>

      <!-- Actions -->
      <div class="flex items-center justify-end gap-3 pt-4 border-t border-slate-200">
        <a href={`/console/games/${id}`} class="btn-secondary">Hủy</a>
        <button type="submit" class="btn-primary" id="submitBtn">Lưu thay đổi</button>
      </div>
    </form>
  </div>
</ConsoleLayout>

<script>
  const form = document.getElementById('editGameForm') as HTMLFormElement;
  const errorDiv = document.getElementById('errorMessage') as HTMLDivElement;
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorDiv.classList.add('hidden');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Đang lưu...';

    const formData = new FormData(form);
    const data = {
      gameId: formData.get('gameId'),
      title: formData.get('title'),
      description: formData.get('description'),
      subject: formData.get('subject'),
      grade: formData.get('grade'),
      unit: formData.get('unit'),
      gameType: formData.get('gameType'),
      priority: formData.get('priority'),
    };

    try {
      const response = await fetch('/api/games/update-metadata', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (response.ok) {
        window.location.href = `/console/games/${data.gameId}`;
      } else {
        errorDiv.textContent = result.error || 'Có lỗi xảy ra';
        errorDiv.classList.remove('hidden');
      }
    } catch (error) {
      errorDiv.textContent = 'Có lỗi xảy ra. Vui lòng thử lại.';
      errorDiv.classList.remove('hidden');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Lưu thay đổi';
    }
  });
</script>
