---
import ConsoleLayout from '../../layouts/ConsoleLayout.astro';
import StatusChip from '../../components/StatusChip.astro';
import DeleteGameModal from '../../components/DeleteGameModal.astro';
import type { User } from '../../models/User';
import { GameRepository, VALID_GAME_STATUSES } from '../../models/Game';
import { UserRepository } from '../../models/User';
import { getUserFromRequest } from '../../lib/session';

// Auth check
const user = await getUserFromRequest(Astro.request) as User | null;
if (!user) {
  return Astro.redirect('/login?redirect=/console/library');
}

// Get filters from URL
const url = new URL(Astro.request.url);
const statusFilter = url.searchParams.get('status') || '';
const searchQuery = url.searchParams.get('q') || '';

// Get all games
const gameRepo = await GameRepository.getInstance();
const userRepo = await UserRepository.getInstance();
let games = await gameRepo.findAll();

// Apply filters
if (statusFilter && statusFilter.length > 0) {
  games = games.filter(g => (g.status || 'draft') === statusFilter);
}
if (searchQuery) {
  const q = searchQuery.toLowerCase();
  games = games.filter(g => 
    g.title?.toLowerCase().includes(q) || 
    g.gameId.toLowerCase().includes(q)
  );
}

// Get owner info
const gamesWithOwner = await Promise.all(games.map(async (game) => {
  const owner = await userRepo.findById(game.ownerId);
  return { ...game, ownerName: owner?.name || owner?.email || 'Unknown' };
}));

// Role checks for actions
const hasRole = (role: string) => user?.roles?.includes(role as any) ?? false;
const isDev = hasRole('dev');
const isQC = hasRole('qc');
const isCTO = hasRole('cto');
const isCEO = hasRole('ceo');
const isAdmin = hasRole('admin');

const statusLabels: Record<string, string> = {
  draft: 'Nháp',
  uploaded: 'Chờ QC',
  qc_passed: 'QC đạt',
  qc_failed: 'QC cần sửa',
  approved: 'Đã duyệt',
  published: 'Đã xuất bản',
  archived: 'Đã lưu trữ',
};
---

<ConsoleLayout title="Thư viện Game" user={user} activeMenu="library">
  <div class="p-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-2xl font-bold text-slate-900">Thư viện Game</h1>
        <p class="text-slate-500 mt-1">Tất cả game trong hệ thống</p>
      </div>
      {(isDev || isAdmin) && (
        <a href="/upload" class="btn-primary flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Tạo game mới
        </a>
      )}
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl border border-slate-200 p-4 mb-6">
      <form method="get" class="flex flex-col md:flex-row gap-4">
        <!-- Search -->
        <div class="flex-1">
          <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input 
              type="text" 
              name="q" 
              value={searchQuery}
              placeholder="Tìm theo tên game, ID..."
              class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            />
          </div>
        </div>
        
        <!-- Status Filter -->
        <select name="status" class="px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500">
          <option value="">Tất cả trạng thái</option>
          {VALID_GAME_STATUSES.map(status => (
            <option value={status} selected={statusFilter === status}>{statusLabels[status]}</option>
          ))}
        </select>
        
        <button type="submit" class="btn-primary">Lọc</button>
        {(statusFilter || searchQuery) && (
          <a href="/console/library" class="btn-secondary">Xóa bộ lọc</a>
        )}
      </form>
    </div>

    <!-- Games Table -->
    {gamesWithOwner.length > 0 ? (
      <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
        <table class="w-full">
          <thead class="bg-slate-50 border-b border-slate-200">
            <tr>
              <th class="text-left px-6 py-4 text-sm font-semibold text-slate-700">Game</th>
              <th class="text-left px-6 py-4 text-sm font-semibold text-slate-700">Trạng thái</th>
              <th class="text-left px-6 py-4 text-sm font-semibold text-slate-700">Người phụ trách</th>
              <th class="text-left px-6 py-4 text-sm font-semibold text-slate-700">Cập nhật</th>
              <th class="text-right px-6 py-4 text-sm font-semibold text-slate-700">Thao tác</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            {gamesWithOwner.map(game => {
              const isOwner = game.ownerId === user._id.toString();
              const gameStatus = game.status || 'draft';
              const canEdit = isOwner && ['draft', 'qc_failed'].includes(gameStatus);
              const canSubmitQC = isOwner && ['draft', 'qc_failed'].includes(gameStatus);
              const canReview = (isQC || isAdmin) && gameStatus === 'uploaded';
              const canApprove = (isCTO || isCEO || isAdmin) && gameStatus === 'qc_passed';
              const canPublish = isAdmin && gameStatus === 'approved';
              
              return (
                <tr class="hover:bg-slate-50 transition-colors">
                  <td class="px-6 py-4">
                    <a href={`/console/games/${game._id}`} class="block">
                      <p class="font-medium text-slate-900 hover:text-indigo-600">{game.title || game.gameId}</p>
                      <p class="text-sm text-slate-500">{game.gameId}</p>
                    </a>
                  </td>
                  <td class="px-6 py-4">
                    <StatusChip status={gameStatus} size="sm" />
                  </td>
                  <td class="px-6 py-4 text-sm text-slate-600">
                    {game.ownerName}
                    {isOwner && <span class="ml-1 text-indigo-600">(bạn)</span>}
                  </td>
                  <td class="px-6 py-4 text-sm text-slate-500">
                    {game.updatedAt.toLocaleDateString('vi-VN')}
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex items-center justify-end gap-2">
                      {canEdit && (
                        <a href={`/console/games/${game._id}/edit`} class="px-3 py-1.5 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg">
                          Sửa
                        </a>
                      )}
                      {canSubmitQC && (
                        <a href={`/console/my-games`} class="px-3 py-1.5 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded-lg">
                          Gửi QC
                        </a>
                      )}
                      {canReview && (
                        <a href={`/console/games/${game._id}/review`} class="px-3 py-1.5 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded-lg">
                          Review
                        </a>
                      )}
                      {canApprove && (
                        <a href="/console/approval" class="px-3 py-1.5 text-sm font-medium text-purple-600 hover:bg-purple-50 rounded-lg">
                          Duyệt
                        </a>
                      )}
                      {canPublish && (
                        <a href="/console/publish" class="px-3 py-1.5 text-sm font-medium text-green-600 hover:bg-green-50 rounded-lg">
                          Xuất bản
                        </a>
                      )}
                      <a href={`/console/games/${game._id}`} class="px-3 py-1.5 text-sm font-medium text-indigo-600 hover:bg-indigo-50 rounded-lg">
                        Chi tiết
                      </a>
                      
                      {/* Delete button - for Admin/CTO/CEO (can delete any game) */}
                      {(isAdmin || isCTO || isCEO) && (
                        <button 
                          type="button"
                          onclick={`openDeleteModal('${game._id.toString()}')`}
                          class="px-3 py-1.5 text-sm font-medium text-red-600 hover:text-red-800 hover:bg-red-50 rounded-lg transition-colors"
                          title="Xóa game"
                        >
                          Xóa
                        </button>
                      )}
                    </div>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    ) : (
      <div class="bg-white rounded-xl border border-slate-200 p-16 text-center">
        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-slate-100 flex items-center justify-center">
          <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-slate-900 mb-2">Không tìm thấy game</h3>
        <p class="text-slate-500 mb-4">Thử thay đổi bộ lọc hoặc từ khóa tìm kiếm</p>
        {(statusFilter || searchQuery) && (
          <a href="/console/library" class="btn-secondary inline-block">Xóa bộ lọc</a>
        )}
      </div>
    )}
  </div>

  <!-- Delete Game Modals -->
  {gamesWithOwner.map(game => (
    <DeleteGameModal 
      gameId={game._id.toString()} 
      gameTitle={game.title || game.gameId} 
      userRoles={user.roles || []}
    />
  ))}
</ConsoleLayout>
