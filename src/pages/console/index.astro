---
import ConsoleLayout from '../../layouts/ConsoleLayout.astro';
import StatusChip from '../../components/StatusChip.astro';
import LoadingSkeleton from '../../components/LoadingSkeleton.astro';
import type { User } from '../../models/User';
import { GameRepository, type Game } from '../../models/Game';
import { GameVersionRepository } from '../../models/GameVersion';
import { getUserFromRequest } from '../../lib/session';

// Auth check
const user = await getUserFromRequest(Astro.request) as User | null;
if (!user) {
  return Astro.redirect('/login?redirect=/console');
}

// Role checks
const hasRole = (role: string) => user?.roles?.includes(role as any) ?? false;
const isAdmin = hasRole('admin');
const isDev = hasRole('dev');
const isQC = hasRole('qc');
const isCTO = hasRole('cto');
const isCEO = hasRole('ceo');

// Initialize with loading state - we'll fetch data client-side for better UX
let stats = {
  myGames: 0,
  draftGames: 0,
  qcFailedGames: 0,
  uploadedGames: 0,
  qcPassedGames: 0,
  approvedGames: 0,
  publishedGames: 0,
  recentGames: [] as any[]
};

let isLoading = true;

// Try to get initial data quickly, but don't block rendering
try {
  const gameRepo = await GameRepository.getInstance();
  const versionRepo = await GameVersionRepository.getInstance();
  const userId = user._id.toString();

  // Get basic counts quickly
  const allGames = await gameRepo.findAll();
  const myGames = allGames.filter(g => g.ownerId === userId);
  
  // Quick stats calculation
  stats.myGames = myGames.length;
  
  // Count games by latest version status
  for (const game of allGames) {
    if (!game.latestVersionId) continue;
    
    const latestVersion = await versionRepo.findById(game.latestVersionId.toString());
    if (!latestVersion) continue;

    switch (latestVersion.status) {
      case 'draft':
        if (game.ownerId === userId) stats.draftGames++;
        break;
      case 'qc_failed':
        if (game.ownerId === userId) stats.qcFailedGames++;
        break;
      case 'uploaded':
        stats.uploadedGames++;
        break;
      case 'qc_passed':
        stats.qcPassedGames++;
        break;
      case 'approved':
        stats.approvedGames++;
        break;
      case 'published':
        stats.publishedGames++;
        break;
    }
  }

  // Recent games
  stats.recentGames = allGames
    .sort((a, b) => new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime())
    .slice(0, 5)
    .map(game => ({
      _id: game._id.toString(),
      title: game.title,
      gameId: game.gameId,
      status: game.status || 'draft',
      updatedAt: game.updatedAt
    }));

  isLoading = false;
} catch (error) {
  console.error('Error loading dashboard data:', error);
  // Keep loading state true to show skeleton
}
---

<ConsoleLayout title="Dashboard" user={user} activeMenu="dashboard">
  <div class="p-8">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-2xl font-bold text-slate-900">
        Xin ch√†o, {user.name || user.email.split('@')[0]}! üëã
      </h1>
      {isDev && !isAdmin && (
        <p class="text-slate-500 mt-1">
          <span class="font-medium text-indigo-600">Developer Dashboard</span> - Qu·∫£n l√Ω games c·ªßa b·∫°n, theo d√µi ti·∫øn ƒë·ªô QC v√† c·∫≠p nh·∫≠t phi√™n b·∫£n
        </p>
      )}
      {isQC && !isAdmin && (
        <p class="text-slate-500 mt-1">
          <span class="font-medium text-blue-600">QC Dashboard</span> - Review v√† test c√°c game builds, ƒë·∫£m b·∫£o ch·∫•t l∆∞·ª£ng tr∆∞·ªõc khi ph√™ duy·ªát
        </p>
      )}
      {(isCTO || isCEO) && !isAdmin && (
        <p class="text-slate-500 mt-1">
          <span class="font-medium text-purple-600">{isCTO ? 'CTO' : 'CEO'} Dashboard</span> - Ph√™ duy·ªát games ƒë√£ qua QC, qu·∫£n l√Ω quy tr√¨nh xu·∫•t b·∫£n
        </p>
      )}
      {isAdmin && (
        <p class="text-slate-500 mt-1">
          <span class="font-medium text-emerald-600">Admin Dashboard</span> - To√†n quy·ªÅn qu·∫£n l√Ω h·ªá th·ªëng, games, users v√† quy tr√¨nh workflow
        </p>
      )}
    </div>

    <!-- Stats Cards based on role -->
    {isLoading ? (
      <LoadingSkeleton type="stats" />
    ) : (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="stats-container">
        {/* Dev Stats */}
        {(isDev || isAdmin) && (
          <>
            <a href="/console/my-games?status=draft" class="bg-white rounded-xl p-6 border border-slate-200 hover:border-indigo-300 hover:shadow-md transition-all">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-slate-500">Game nh√°p</p>
                  <p class="text-3xl font-bold text-slate-900 mt-1" data-stat="draftGames">{stats.draftGames}</p>
                </div>
                <div class="w-12 h-12 rounded-lg bg-slate-100 flex items-center justify-center">
                  <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                </div>
              </div>
            </a>
            
            <a href="/console/my-games?status=qc_failed" class="bg-white rounded-xl p-6 border border-slate-200 hover:border-red-300 hover:shadow-md transition-all">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-slate-500">C·∫ßn s·ª≠a (QC)</p>
                  <p class="text-3xl font-bold text-red-600 mt-1" data-stat="qcFailedGames">{stats.qcFailedGames}</p>
                </div>
                <div class="w-12 h-12 rounded-lg bg-red-100 flex items-center justify-center">
                  <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                  </svg>
                </div>
              </div>
            </a>
          </>
        )}

        {/* QC Stats */}
        {(isQC || isAdmin) && (
          <a href="/console/qc-inbox" class="bg-white rounded-xl p-6 border border-slate-200 hover:border-blue-300 hover:shadow-md transition-all">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-slate-500">Ch·ªù QC</p>
                <p class="text-3xl font-bold text-blue-600 mt-1" data-stat="uploadedGames">{stats.uploadedGames}</p>
              </div>
              <div class="w-12 h-12 rounded-lg bg-blue-100 flex items-center justify-center">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                </svg>
              </div>
            </div>
          </a>
        )}

        {/* CTO/CEO Stats */}
        {(isCTO || isCEO || isAdmin) && (
          <a href="/console/approval" class="bg-white rounded-xl p-6 border border-slate-200 hover:border-purple-300 hover:shadow-md transition-all">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-slate-500">Ch·ªù duy·ªát</p>
                <p class="text-3xl font-bold text-purple-600 mt-1" data-stat="qcPassedGames">{stats.qcPassedGames}</p>
              </div>
              <div class="w-12 h-12 rounded-lg bg-purple-100 flex items-center justify-center">
                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
            </div>
          </a>
        )}

        {/* Admin Stats */}
        {isAdmin && (
          <>
            <a href="/console/publish?status=approved" class="bg-white rounded-xl p-6 border border-slate-200 hover:border-emerald-300 hover:shadow-md transition-all">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-slate-500">Ch·ªù xu·∫•t b·∫£n</p>
                  <p class="text-3xl font-bold text-emerald-600 mt-1" data-stat="approvedGames">{stats.approvedGames}</p>
                </div>
                <div class="w-12 h-12 rounded-lg bg-emerald-100 flex items-center justify-center">
                  <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                  </svg>
                </div>
              </div>
            </a>
            
            <a href="/console/publish?status=published" class="bg-white rounded-xl p-6 border border-slate-200 hover:border-green-300 hover:shadow-md transition-all">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-slate-500">ƒê√£ xu·∫•t b·∫£n</p>
                  <p class="text-3xl font-bold text-green-600 mt-1" data-stat="publishedGames">{stats.publishedGames}</p>
                </div>
                <div class="w-12 h-12 rounded-lg bg-green-100 flex items-center justify-center">
                  <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                </div>
              </div>
            </a>
          </>
        )}
      </div>
    )}

    <!-- Quick Actions -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Recent Games -->
      {isLoading ? (
        <LoadingSkeleton type="list" count={5} />
      ) : (
        <div class="bg-white rounded-xl border border-slate-200" id="recent-games">
          <div class="p-5 border-b border-slate-200 flex items-center justify-between">
            <h2 class="font-semibold text-slate-900">Game g·∫ßn ƒë√¢y</h2>
            <a href="/console/library" class="text-sm text-indigo-600 hover:text-indigo-800">Xem t·∫•t c·∫£ ‚Üí</a>
          </div>
          {stats.recentGames.length > 0 ? (
            <div class="divide-y divide-slate-100">
              {stats.recentGames.map(game => (
                <a href={`/console/games/${game._id}`} class="flex items-center justify-between p-4 hover:bg-slate-50 transition-colors">
                  <div>
                    <p class="font-medium text-slate-900">{game.title || game.gameId}</p>
                    <p class="text-sm text-slate-500">{game.gameId}</p>
                  </div>
                  <StatusChip status={game.status} size="sm" />
                </a>
              ))}
            </div>
          ) : (
            <div class="p-8 text-center text-slate-500">
              <p>Ch∆∞a c√≥ game n√†o</p>
            </div>
          )}
        </div>
      )}

      <!-- Quick Actions Panel -->
      <div class="bg-white rounded-xl border border-slate-200">
        <div class="p-5 border-b border-slate-200">
          <h2 class="font-semibold text-slate-900">Thao t√°c nhanh</h2>
        </div>
        <div class="p-5 space-y-3">
          {(isDev || isAdmin) && (
            <a href="/upload" class="flex items-center gap-3 p-4 rounded-lg border border-slate-200 hover:border-indigo-300 hover:bg-indigo-50 transition-all">
              <div class="w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center">
                <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
              </div>
              <div>
                <p class="font-medium text-slate-900">T·∫°o game m·ªõi</p>
                <p class="text-sm text-slate-500">Upload game build m·ªõi</p>
              </div>
            </a>
          )}
          
          {(isQC || isAdmin) && stats.uploadedGames > 0 && (
            <a href="/console/qc-inbox" class="flex items-center gap-3 p-4 rounded-lg border border-slate-200 hover:border-blue-300 hover:bg-blue-50 transition-all">
              <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                </svg>
              </div>
              <div>
                <p class="font-medium text-slate-900">Review game</p>
                <p class="text-sm text-slate-500">{stats.uploadedGames} game ƒëang ch·ªù QC</p>
              </div>
            </a>
          )}
          
          {(isCTO || isCEO || isAdmin) && stats.qcPassedGames > 0 && (
            <a href="/console/approval" class="flex items-center gap-3 p-4 rounded-lg border border-slate-200 hover:border-purple-300 hover:bg-purple-50 transition-all">
              <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center">
                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <div>
                <p class="font-medium text-slate-900">Duy·ªát game</p>
                <p class="text-sm text-slate-500">{stats.qcPassedGames} game ch·ªù ph√™ duy·ªát</p>
              </div>
            </a>
          )}
          
          {(isAdmin) && stats.approvedGames > 0 && (
            <a href="/console/publish" class="flex items-center gap-3 p-4 rounded-lg border border-slate-200 hover:border-emerald-300 hover:bg-emerald-50 transition-all">
              <div class="w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center">
                <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                </svg>
              </div>
              <div>
                <p class="font-medium text-slate-900">Xu·∫•t b·∫£n game</p>
                <p class="text-sm text-slate-500">{stats.approvedGames} game s·∫µn s√†ng publish</p>
              </div>
            </a>
          )}
        </div>
      </div>
    </div>

    <!-- Workflow Guide -->
    <div class="mt-8 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl border border-indigo-100 p-6">
      <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        Quy tr√¨nh l√†m vi·ªác c·ªßa b·∫°n
      </h3>
      
      {isDev && !isAdmin && (
        <div class="space-y-3">
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold text-sm flex-shrink-0">1</div>
            <div>
              <p class="font-medium text-slate-900">T·∫°o & Upload Game</p>
              <p class="text-sm text-slate-600">Upload game build m·ªõi ho·∫∑c c·∫≠p nh·∫≠t phi√™n b·∫£n hi·ªán t·∫°i</p>
            </div>
          </div>
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold text-sm flex-shrink-0">2</div>
            <div>
              <p class="font-medium text-slate-900">Ho√†n th√†nh Self-QA</p>
              <p class="text-sm text-slate-600">Ki·ªÉm tra game tr√™n nhi·ªÅu thi·∫øt b·ªã, √¢m thanh, gameplay</p>
            </div>
          </div>
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold text-sm flex-shrink-0">3</div>
            <div>
              <p class="font-medium text-slate-900">Submit cho QC</p>
              <p class="text-sm text-slate-600">G·ª≠i game ƒë·ªÉ QC team review v√† test</p>
            </div>
          </div>
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold text-sm flex-shrink-0">4</div>
            <div>
              <p class="font-medium text-slate-900">Theo d√µi & S·ª≠a l·ªói</p>
              <p class="text-sm text-slate-600">N·∫øu QC fail, s·ª≠a l·ªói v√† submit l·∫°i</p>
            </div>
          </div>
        </div>
      )}

      {isQC && !isAdmin && (
        <div class="space-y-3">
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-sm flex-shrink-0">1</div>
            <div>
              <p class="font-medium text-slate-900">Nh·∫≠n game t·ª´ QC Inbox</p>
              <p class="text-sm text-slate-600">Xem danh s√°ch games ƒëang ch·ªù review</p>
            </div>
          </div>
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-sm flex-shrink-0">2</div>
            <div>
              <p class="font-medium text-slate-900">Test & Review</p>
              <p class="text-sm text-slate-600">Ki·ªÉm tra gameplay, performance, bugs tr√™n nhi·ªÅu thi·∫øt b·ªã</p>
            </div>
          </div>
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-sm flex-shrink-0">3</div>
            <div>
              <p class="font-medium text-slate-900">Pass ho·∫∑c Fail</p>
              <p class="text-sm text-slate-600">Pass: chuy·ªÉn cho CTO duy·ªát | Fail: tr·∫£ v·ªÅ Dev v·ªõi ghi ch√∫</p>
            </div>
          </div>
        </div>
      )}

      {(isCTO || isCEO) && !isAdmin && (
        <div class="space-y-3">
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-purple-600 text-white flex items-center justify-center font-bold text-sm flex-shrink-0">1</div>
            <div>
              <p class="font-medium text-slate-900">Review games ƒë√£ qua QC</p>
              <p class="text-sm text-slate-600">Xem danh s√°ch games c√≥ status "QC Passed"</p>
            </div>
          </div>
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-purple-600 text-white flex items-center justify-center font-bold text-sm flex-shrink-0">2</div>
            <div>
              <p class="font-medium text-slate-900">Ph√™ duy·ªát ho·∫∑c Y√™u c·∫ßu s·ª≠a</p>
              <p class="text-sm text-slate-600">Approve: chuy·ªÉn sang tr·∫°ng th√°i s·∫µn s√†ng publish | Reject: tr·∫£ v·ªÅ Dev</p>
            </div>
          </div>
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-purple-600 text-white flex items-center justify-center font-bold text-sm flex-shrink-0">3</div>
            <div>
              <p class="font-medium text-slate-900">Theo d√µi xu·∫•t b·∫£n</p>
              <p class="text-sm text-slate-600">Admin s·∫Ω publish games ƒë√£ ƒë∆∞·ª£c approve</p>
            </div>
          </div>
        </div>
      )}

      {isAdmin && (
        <div class="space-y-3">
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-emerald-600 text-white flex items-center justify-center font-bold text-sm flex-shrink-0">‚òÖ</div>
            <div>
              <p class="font-medium text-slate-900">To√†n quy·ªÅn qu·∫£n l√Ω</p>
              <p class="text-sm text-slate-600">B·∫°n c√≥ th·ªÉ th·ª±c hi·ªán t·∫•t c·∫£ c√°c thao t√°c: Upload, QC, Approve, Publish v√† qu·∫£n l√Ω users</p>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
            <a href="/console/library" class="flex items-center gap-2 p-3 bg-white rounded-lg border border-slate-200 hover:border-indigo-300 transition-colors text-sm">
              <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
              </svg>
              <span class="font-medium text-slate-700">Th∆∞ vi·ªán Game</span>
            </a>
            <a href="/console/qc-inbox" class="flex items-center gap-2 p-3 bg-white rounded-lg border border-slate-200 hover:border-blue-300 transition-colors text-sm">
              <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
              </svg>
              <span class="font-medium text-slate-700">QC Inbox</span>
            </a>
            <a href="/console/approval" class="flex items-center gap-2 p-3 bg-white rounded-lg border border-slate-200 hover:border-purple-300 transition-colors text-sm">
              <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span class="font-medium text-slate-700">Ch·ªù duy·ªát</span>
            </a>
            <a href="/console/publish" class="flex items-center gap-2 p-3 bg-white rounded-lg border border-slate-200 hover:border-emerald-300 transition-colors text-sm">
              <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
              </svg>
              <span class="font-medium text-slate-700">Xu·∫•t b·∫£n</span>
            </a>
          </div>
        </div>
      )}
    </div>
  </div>

  <!-- Client-side data refresh -->
  <script>
    // Refresh data every 30 seconds
    let refreshInterval;
    
    async function refreshDashboardData() {
      try {
        const response = await fetch('/api/dashboard/stats');
        if (!response.ok) return;
        
        const data = await response.json();
        
        // Update stats
        document.querySelectorAll('[data-stat]').forEach(el => {
          const stat = el.getAttribute('data-stat');
          if (stat && data[stat] !== undefined) {
            el.textContent = data[stat];
          }
        });
        
        // Update recent games if needed
        // This would require more complex DOM manipulation
        
      } catch (error) {
        console.error('Failed to refresh dashboard data:', error);
      }
    }
    
    // Start refresh interval
    refreshInterval = setInterval(refreshDashboardData, 30000);
    
    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    });
  </script>
</ConsoleLayout>