---
/**
 * Upload Zone Component - Handles file selection and drag & drop
 */
export interface Props {
  id?: string;
  accept?: string;
  maxSize?: number;
  disabled?: boolean;
  className?: string;
}

const { 
  id = 'uploadZone',
  accept = '.zip',
  maxSize = 50,
  disabled = false,
  className = ''
} = Astro.props;
---

<div 
  id={id}
  class={`upload-zone ${className} ${disabled ? 'disabled' : ''}`}
  data-accept={accept}
  data-max-size={maxSize}
>
  <div class="upload-zone__content">
    <div class="upload-zone__icon">
      <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
      </svg>
    </div>
    
    <div class="upload-zone__text">
      <p class="text-slate-600 font-medium">Kéo thả file vào đây hoặc</p>
      <label for={`${id}Input`} class="upload-zone__button">
        Chọn file
      </label>
      <input 
        type="file" 
        id={`${id}Input`}
        accept={accept}
        class="hidden"
        disabled={disabled}
      >
    </div>
    
    <p class="upload-zone__help">
      Chỉ hỗ trợ file {accept.toUpperCase()} (tối đa {maxSize}MB)
    </p>
  </div>

  <!-- Loading State -->
  <div class="upload-zone__loading hidden">
    <div class="upload-zone__spinner">
      <svg class="animate-spin w-8 h-8 text-blue-600" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    </div>
    <p class="text-slate-600">Đang xử lý file...</p>
  </div>
</div>

<style>
  .upload-zone {
    @apply border-2 border-dashed border-slate-300 rounded-xl p-8 text-center transition-all cursor-pointer;
  }

  .upload-zone:hover:not(.disabled) {
    @apply border-slate-400 bg-slate-50;
  }

  .upload-zone.dragover {
    @apply border-blue-500 bg-blue-50;
  }

  .upload-zone.disabled {
    @apply opacity-50 cursor-not-allowed;
  }

  .upload-zone__content {
    @apply space-y-4;
  }

  .upload-zone__icon {
    @apply w-16 h-16 mx-auto bg-slate-100 rounded-full flex items-center justify-center;
  }

  .upload-zone__button {
    @apply inline-block mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 transition-colors;
  }

  .upload-zone__help {
    @apply text-xs text-slate-400;
  }

  .upload-zone__loading {
    @apply space-y-4;
  }

  .upload-zone__spinner {
    @apply w-16 h-16 mx-auto flex items-center justify-center;
  }
</style>

<script>
  class UploadZone {
    private element: HTMLElement;
    private input: HTMLInputElement;
    private content: HTMLElement;
    private loading: HTMLElement;
    private onFileSelect?: (file: File) => void;

    constructor(element: HTMLElement) {
      this.element = element;
      this.input = element.querySelector('input[type="file"]')!;
      this.content = element.querySelector('.upload-zone__content')!;
      this.loading = element.querySelector('.upload-zone__loading')!;
      
      this.setupEventListeners();
    }

    private setupEventListeners(): void {
      // File input change
      this.input.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        if (target.files && target.files.length > 0) {
          this.handleFile(target.files[0]);
        }
      });

      // Drag and drop
      this.element.addEventListener('dragover', (e) => {
        e.preventDefault();
        this.element.classList.add('dragover');
      });

      this.element.addEventListener('dragleave', (e) => {
        e.preventDefault();
        this.element.classList.remove('dragover');
      });

      this.element.addEventListener('drop', (e) => {
        e.preventDefault();
        this.element.classList.remove('dragover');
        
        const files = e.dataTransfer?.files;
        if (files && files.length > 0) {
          this.handleFile(files[0]);
        }
      });

      // Click to select
      this.element.addEventListener('click', (e) => {
        if (e.target === this.element || this.content.contains(e.target as Node)) {
          this.input.click();
        }
      });
    }

    private handleFile(file: File): void {
      // Validate file type
      const accept = this.element.dataset.accept || '';
      const allowedTypes = accept.split(',').map(t => t.trim());
      const fileExtension = '.' + file.name.split('.').pop()?.toLowerCase();
      
      if (allowedTypes.length > 0 && !allowedTypes.includes(fileExtension)) {
        this.showError(`Chỉ hỗ trợ file: ${allowedTypes.join(', ')}`);
        return;
      }

      // Validate file size
      const maxSize = parseInt(this.element.dataset.maxSize || '50') * 1024 * 1024;
      if (file.size > maxSize) {
        this.showError(`File quá lớn. Tối đa ${maxSize / 1024 / 1024}MB`);
        return;
      }

      // Trigger callback
      if (this.onFileSelect) {
        this.onFileSelect(file);
      }

      // Dispatch custom event
      this.element.dispatchEvent(new CustomEvent('fileselected', {
        detail: { file },
        bubbles: true
      }));
    }

    private showError(message: string): void {
      // Create temporary error message
      const errorDiv = document.createElement('div');
      errorDiv.className = 'upload-zone__error';
      errorDiv.innerHTML = `
        <div class="bg-red-50 border border-red-200 rounded-lg p-3 mt-4">
          <p class="text-red-600 text-sm">${message}</p>
        </div>
      `;
      
      this.element.appendChild(errorDiv);
      
      // Remove after 5 seconds
      setTimeout(() => {
        errorDiv.remove();
      }, 5000);
    }

    public setLoading(loading: boolean): void {
      if (loading) {
        this.content.classList.add('hidden');
        this.loading.classList.remove('hidden');
      } else {
        this.content.classList.remove('hidden');
        this.loading.classList.add('hidden');
      }
    }

    public setDisabled(disabled: boolean): void {
      this.input.disabled = disabled;
      if (disabled) {
        this.element.classList.add('disabled');
      } else {
        this.element.classList.remove('disabled');
      }
    }

    public onFile(callback: (file: File) => void): void {
      this.onFileSelect = callback;
    }
  }

  // Initialize upload zones
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.upload-zone').forEach(element => {
      new UploadZone(element as HTMLElement);
    });
  });

  // Export for external use
  (window as any).UploadZone = UploadZone;
</script>