---
/**
 * Game Upload Form - Horizontal Layout with Manifest Editor
 */
import { TABS } from '../../types/upload-types';

const { meta } = Astro.props as { meta?: any };
const metaJson = JSON.stringify(meta ?? {});

---

<div class="game-upload-form" id="uploadForm">
  <script id="__upload_meta__" type="application/json" set:html={metaJson}></script>
  <!-- Horizontal Layout: 3 columns -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <!-- Column 1: Upload Zone -->
    <div class="space-y-4">
      <div class="text-xs font-bold text-slate-400 flex items-center gap-2">
        <span class="w-5 h-5 rounded-full bg-iruka-blue text-white flex items-center justify-center text-[10px] font-black">1</span>
        <span class="text-slate-700">Upload gói build</span>
      </div>

      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
        <!-- Tabs -->
        <div class="flex items-center gap-1 p-3 border-b border-slate-100">
          {TABS.map((tab, i) => (
            <button type="button" data-mode={tab.id} class:list={[
              'upload-tab px-3 py-1.5 rounded-lg text-xs font-bold transition-all',
              i === 0 ? 'bg-slate-100 text-slate-800' : 'text-slate-500 hover:bg-slate-50'
            ]}>{tab.label}</button>
          ))}
        </div>

        <!-- Dropzone -->
        <div id="dropZone" class="p-6 cursor-pointer group" tabindex="0" role="button">
          <div id="dropzoneIdle" class="border-2 border-dashed border-slate-200 rounded-xl p-8 text-center hover:border-iruka-blue hover:bg-blue-50/30 transition-all">
            <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-slate-100 flex items-center justify-center group-hover:bg-blue-100 transition-colors">
              <svg class="w-6 h-6 text-slate-400 group-hover:text-iruka-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
              </svg>
            </div>
            <p class="text-sm font-bold text-slate-700">Kéo thả file vào đây</p>
            <p class="text-xs text-slate-400 mt-1">hoặc click để chọn</p>
          </div>
        </div>

        <!-- File Preview -->
        <div id="filePreview" class="hidden px-6 pb-4">
          <div class="flex items-center gap-3 p-3 bg-emerald-50 rounded-lg border border-emerald-100">
            <div class="w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center">
              <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
            </div>
            <div class="flex-1 min-w-0">
              <p id="previewFileName" class="text-sm font-bold text-slate-800 truncate">file.zip</p>
              <p id="previewFileSize" class="text-xs text-slate-500">0 MB</p>
            </div>
            <button type="button" id="clearFileBtn" class="text-slate-400 hover:text-red-500 p-1" title="Xóa">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Live Checklist -->
        <div id="liveChecklist" class="hidden px-6 pb-4">
          <div class="space-y-2" id="checklistItems"></div>
        </div>
      </div>

      <!-- Thumbnails -->
      <div id="thumbnailSection" class="hidden bg-white rounded-2xl border border-slate-200 shadow-sm p-4">
        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-wider mb-3">Thumbnails</h4>
        <div class="grid grid-cols-2 gap-3">
          <div class="thumb-upload" data-type="desktop" data-w="308" data-h="211">
            <div class="thumb-preview aspect-[308/211] rounded-lg bg-slate-100 border-2 border-dashed border-slate-200 flex items-center justify-center cursor-pointer hover:border-iruka-blue hover:bg-blue-50/30 transition-all overflow-hidden">
              <div class="thumb-placeholder text-center">
                <svg class="w-4 h-4 mx-auto text-slate-300 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span class="text-[10px] text-slate-400 font-bold">308×211</span>
              </div>
              <img class="thumb-img hidden w-full h-full object-cover" alt="Desktop thumbnail"/>
            </div>
            <p class="text-[10px] font-bold text-slate-500 mt-1 text-center">Desktop</p>
            <input type="file" class="thumb-input hidden" accept="image/png,image/jpeg,image/webp"/>
          </div>
          <div class="thumb-upload" data-type="mobile" data-w="343" data-h="170">
            <div class="thumb-preview aspect-[343/170] rounded-lg bg-slate-100 border-2 border-dashed border-slate-200 flex items-center justify-center cursor-pointer hover:border-iruka-blue hover:bg-blue-50/30 transition-all overflow-hidden">
              <div class="thumb-placeholder text-center">
                <svg class="w-4 h-4 mx-auto text-slate-300 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span class="text-[10px] text-slate-400 font-bold">343×170</span>
              </div>
              <img class="thumb-img hidden w-full h-full object-cover" alt="Mobile thumbnail"/>
            </div>
            <p class="text-[10px] font-bold text-slate-500 mt-1 text-center">Mobile</p>
            <input type="file" class="thumb-input hidden" accept="image/png,image/jpeg,image/webp"/>
          </div>
        </div>
      </div>
    </div>

    <!-- Column 2: Manifest Editor -->
    <div class="space-y-4">
      <div class="text-xs font-bold text-slate-400 flex items-center gap-2">
        <span class="w-5 h-5 rounded-full bg-slate-300 text-white flex items-center justify-center text-[10px] font-black" id="step2Badge">2</span>
        <span class="text-slate-700">Cập nhật Manifest</span>
      </div>

      <div id="manifestEditor" class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5">
        <div class="space-y-4">
          <!-- Game ID -->
          <div>
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-wider block mb-1">Game ID</label>
            <input type="text" id="manifestId" class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-iruka-blue/20 focus:border-iruka-blue font-mono" placeholder="com.example.game"/>
          </div>
          <!-- Version -->
          <div>
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-wider block mb-1">Version</label>
            <input type="text" id="manifestVersion" class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-iruka-blue/20 focus:border-iruka-blue font-mono" placeholder="1.0.0"/>
          </div>
          <!-- Title -->
          <div>
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-wider block mb-1">Tên Game</label>
            <input type="text" id="manifestTitle" class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-iruka-blue/20 focus:border-iruka-blue" placeholder="My Awesome Game"/>
          </div>
          <!-- Runtime -->
          <div>
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-wider block mb-1">Runtime</label>
            <select id="manifestRuntime" class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-iruka-blue/20 focus:border-iruka-blue bg-white">
              <option value="">Chọn runtime</option>
              <option value="iframe-html">iframe-html</option>
              <option value="esm-module">esm-module</option>
            </select>
          </div>
          <!-- Entry URL -->
          <div>
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-wider block mb-1">Entry URL</label>
            <input type="text" id="manifestEntry" class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-iruka-blue/20 focus:border-iruka-blue font-mono" placeholder="index.html"/>
          </div>
          <!-- Description -->
          <div>
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-wider block mb-1">Mô tả</label>
            <textarea id="manifestDesc" rows="2" class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-iruka-blue/20 focus:border-iruka-blue resize-none" placeholder="Mô tả ngắn về game..."></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Column 3: Preview & Submit -->
    <div class="space-y-4">
      <div class="text-xs font-bold text-slate-400 flex items-center gap-2">
        <span class="w-5 h-5 rounded-full bg-slate-300 text-white flex items-center justify-center text-[10px] font-black" id="step3Badge">3</span>
        <span class="text-slate-700">Xác nhận & Đăng</span>
      </div>

      <!-- Game Info Preview -->
      <div id="gameInfoPreview" class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5">
        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-wider mb-3">Preview</h4>
        <div class="space-y-3 text-xs">
          <div class="flex justify-between"><span class="text-slate-400">Game ID</span><span id="infoGameId" class="font-mono font-bold text-slate-800 truncate max-w-[150px]">-</span></div>
          <div class="flex justify-between"><span class="text-slate-400">Version</span><span id="infoVersion" class="font-mono font-bold text-slate-800">-</span></div>
          <div class="flex justify-between"><span class="text-slate-400">Tên</span><span id="infoTitle" class="font-bold text-slate-800 truncate max-w-[150px]">-</span></div>
          <div class="flex justify-between"><span class="text-slate-400">Runtime</span><span id="infoRuntime" class="font-bold text-slate-800">-</span></div>
          <div class="flex justify-between"><span class="text-slate-400">Entry</span><span id="infoEntry" class="font-mono font-bold text-slate-800 truncate max-w-[150px]">-</span></div>
        </div>
      </div>

      <!-- Validation Message -->
      <div id="validationMsg" class="hidden rounded-xl p-3 flex items-start gap-2">
        <span id="msgIcon" class="shrink-0 mt-0.5"></span>
        <div>
          <p id="msgText" class="text-sm font-bold"></p>
          <p id="msgAction" class="text-xs mt-0.5 opacity-80"></p>
        </div>
      </div>

      <!-- Submit Button - Always blue, shows confirm if incomplete -->
      <button type="button" id="submitBtn" class="w-full py-3.5 rounded-xl text-white font-bold text-sm shadow-lg hover:opacity-90 transition-all flex items-center justify-center gap-2" style="background-color: var(--iruka-blue); box-shadow: 0 10px 15px -3px rgb(43 155 246 / 0.2);">
        <span>Đăng bản Build</span>
        <svg id="submitSpinner" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Hidden Inputs -->
  <input type="file" id="zipInput" accept=".zip" class="hidden"/>
  <input type="file" id="folderInput" multiple class="hidden"/>
  <input type="file" id="fileInput" multiple class="hidden"/>
</div>

<!-- Confirm Dialog -->
<div id="confirmDialog" class="fixed inset-0 z-50 bg-slate-900/70 backdrop-blur-sm items-center justify-center" style="display:none;">
  <div class="bg-white rounded-2xl p-6 w-96 shadow-2xl mx-4">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center">
        <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
      </div>
      <div>
        <h3 class="font-bold text-slate-800">Chưa đủ yêu cầu</h3>
        <p class="text-xs text-slate-500">Một số thông tin còn thiếu</p>
      </div>
    </div>
    <div id="confirmIssues" class="mb-4 p-3 bg-slate-50 rounded-lg text-xs space-y-1.5 max-h-40 overflow-y-auto"></div>
    <p class="text-sm text-slate-600 mb-4">Bạn vẫn muốn tiếp tục upload?</p>
    <div class="flex gap-3">
      <button type="button" id="confirmCancel" class="flex-1 py-2.5 rounded-lg border border-slate-200 text-slate-600 font-bold text-sm hover:bg-slate-50 transition-all">Hủy</button>
      <button type="button" id="confirmProceed" class="flex-1 py-2.5 rounded-lg text-white font-bold text-sm hover:opacity-90 transition-all" style="background-color: var(--iruka-blue);">Tiếp tục</button>
    </div>
  </div>
</div>

  <!-- Hidden Inputs -->
  <input type="file" id="zipInput" accept=".zip" class="hidden"/>
  <input type="file" id="folderInput" multiple class="hidden"/>
  <input type="file" id="fileInput" multiple class="hidden"/>
</div>

<!-- Progress Overlay -->
<div id="progressOverlay" class="fixed inset-0 z-50 bg-slate-900/70 backdrop-blur-sm items-center justify-center" style="display:none;">
  <div class="bg-white rounded-2xl p-6 w-72 text-center shadow-2xl">
    <div class="w-16 h-16 mx-auto mb-4 relative">
      <svg class="w-full h-full -rotate-90"><circle cx="32" cy="32" r="28" stroke="#e2e8f0" stroke-width="5" fill="none"/><circle id="progCircle" cx="32" cy="32" r="28" stroke="#2b9bf6" stroke-width="5" fill="none" stroke-dasharray="176" stroke-dashoffset="176" class="transition-all duration-200"/></svg>
      <span id="progPercent" class="absolute inset-0 flex items-center justify-center font-black text-lg text-slate-800">0%</span>
    </div>
    <p id="progLabel" class="text-xs font-bold text-slate-500 uppercase tracking-wide">Đang tải...</p>
  </div>
</div>

<style>
  @reference "tailwindcss";
  .check-success { @apply text-emerald-600; }
  .check-warning { @apply text-amber-600; }
  .check-error { @apply text-red-500; }
  .check-pending { @apply text-slate-400; }
  .msg-success { @apply bg-emerald-50 border border-emerald-100 text-emerald-700; }
  .msg-warning { @apply bg-amber-50 border border-amber-100 text-amber-700; }
  .msg-error { @apply bg-red-50 border border-red-100 text-red-600; }
</style>

<script>
  import type { UploadMode, FileItem, ManifestData, LiveCheckItem } from '../../types/upload-types';
  import { UPLOAD_CONFIG } from '../../types/upload-types';
  import { formatFileSize, calculateTotalSize, findManifestFile, parseManifestFile, generateLiveChecks, generateValidationMessage, canSubmitUpload, buildUploadFormData, getUploadEndpoint } from '../../lib/upload-utils';

  function init() {
    const form = document.getElementById('uploadForm');
    const dropZone = document.getElementById('dropZone');
    const dropzoneIdle = document.getElementById('dropzoneIdle');
    const filePreview = document.getElementById('filePreview');
    const previewFileName = document.getElementById('previewFileName');
    const previewFileSize = document.getElementById('previewFileSize');
    const clearFileBtn = document.getElementById('clearFileBtn');
    const liveChecklist = document.getElementById('liveChecklist');
    const checklistItems = document.getElementById('checklistItems');
    const thumbnailSection = document.getElementById('thumbnailSection');
    const validationMsg = document.getElementById('validationMsg');
    const msgIcon = document.getElementById('msgIcon');
    const msgText = document.getElementById('msgText');
    const msgAction = document.getElementById('msgAction');
    const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
    const submitSpinner = document.getElementById('submitSpinner');
    const zipInput = document.getElementById('zipInput') as HTMLInputElement;
    const folderInput = document.getElementById('folderInput') as HTMLInputElement;
    const fileInput = document.getElementById('fileInput') as HTMLInputElement;
    const progressOverlay = document.getElementById('progressOverlay');
    const progCircle = document.getElementById('progCircle');
    const progPercent = document.getElementById('progPercent');
    const progLabel = document.getElementById('progLabel');
    
    // Manifest editor elements
    const manifestId = document.getElementById('manifestId') as HTMLInputElement;
    const manifestVersion = document.getElementById('manifestVersion') as HTMLInputElement;
    const manifestTitle = document.getElementById('manifestTitle') as HTMLInputElement;
    const manifestRuntime = document.getElementById('manifestRuntime') as HTMLSelectElement;
    const manifestEntry = document.getElementById('manifestEntry') as HTMLInputElement;
    const manifestDesc = document.getElementById('manifestDesc') as HTMLTextAreaElement;
    const step2Badge = document.getElementById('step2Badge');
    const step3Badge = document.getElementById('step3Badge');
    const confirmDialog = document.getElementById('confirmDialog');
    const confirmIssues = document.getElementById('confirmIssues');
    const confirmCancel = document.getElementById('confirmCancel');
    const confirmProceed = document.getElementById('confirmProceed');

    if (!form) return;

    let mode: UploadMode = 'zip';
    let files: FileItem[] = [];
    let manifest: ManifestData | null = null;
    let thumbDesktop: File | null = null;
    let thumbMobile: File | null = null;
    let isUploading = false;
    let currentChecks: LiveCheckItem[] = [];

    if (folderInput) (folderInput as any).webkitdirectory = true;

    // Tab switching
    document.querySelectorAll('.upload-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        mode = (tab as HTMLElement).dataset.mode as UploadMode;
        document.querySelectorAll('.upload-tab').forEach(t => {
          t.className = t === tab 
            ? 'upload-tab px-3 py-1.5 rounded-lg text-xs font-bold bg-slate-100 text-slate-800 transition-all'
            : 'upload-tab px-3 py-1.5 rounded-lg text-xs font-bold text-slate-500 hover:bg-slate-50 transition-all';
        });
        resetState();
      });
    });

    dropZone?.addEventListener('click', () => {
      const input = mode === 'zip' ? zipInput : mode === 'folder' ? folderInput : fileInput;
      input?.click();
    });

    dropZone?.addEventListener('dragover', e => { e.preventDefault(); dropzoneIdle?.classList.add('border-iruka-blue', 'bg-blue-50/50'); });
    dropZone?.addEventListener('dragleave', e => { e.preventDefault(); dropzoneIdle?.classList.remove('border-iruka-blue', 'bg-blue-50/50'); });
    dropZone?.addEventListener('drop', e => {
      e.preventDefault();
      dropzoneIdle?.classList.remove('border-iruka-blue', 'bg-blue-50/50');
      if (e.dataTransfer?.files) handleFiles(Array.from(e.dataTransfer.files));
    });

    [zipInput, folderInput, fileInput].forEach(input => {
      input?.addEventListener('change', () => { if (input.files) handleFiles(Array.from(input.files)); });
    });

    clearFileBtn?.addEventListener('click', (e) => { e.stopPropagation(); resetState(); });

    // Manifest editor change handlers
    [manifestId, manifestVersion, manifestTitle, manifestRuntime, manifestEntry, manifestDesc].forEach(el => {
      el?.addEventListener('input', () => {
        manifest = {
          id: manifestId?.value || '',
          version: manifestVersion?.value || '',
          title: manifestTitle?.value || '',
          runtime: manifestRuntime?.value || '',
          entryUrl: manifestEntry?.value || ''
        };
        updatePreview();
        updateValidation();
      });
    });

    // Thumbnail uploads
    document.querySelectorAll('.thumb-upload').forEach(el => {
      const preview = el.querySelector('.thumb-preview') as HTMLElement;
      const input = el.querySelector('.thumb-input') as HTMLInputElement;
      const img = el.querySelector('.thumb-img') as HTMLImageElement;
      const placeholder = el.querySelector('.thumb-placeholder') as HTMLElement;
      const type = (el as HTMLElement).dataset.type;

      preview?.addEventListener('click', () => input?.click());
      input?.addEventListener('change', () => {
        const file = input.files?.[0];
        if (!file) return;
        if (file.size > UPLOAD_CONFIG.MAX_THUMBNAIL_SIZE) { alert('Ảnh quá lớn (max 2MB)'); return; }
        
        const url = URL.createObjectURL(file);
        const testImg = new Image();
        testImg.onload = () => {
          if (img) { img.src = url; img.classList.remove('hidden'); }
          if (placeholder) placeholder.classList.add('hidden');
          preview.classList.remove('border-dashed');
          preview.classList.add('border-solid', 'border-emerald-300');
          if (type === 'desktop') thumbDesktop = file;
          else thumbMobile = file;
          updateValidation();
        };
        testImg.src = url;
      });
    });

    submitBtn?.addEventListener('click', async () => {
      if (isUploading) return;
      
      // Check if all requirements are met
      const canSubmit = canSubmitUpload(currentChecks) && files.length > 0;
      
      if (canSubmit) {
        await performUpload();
      } else {
        // Show confirm dialog with issues
        showConfirmDialog();
      }
    });

    // Confirm dialog handlers
    confirmCancel?.addEventListener('click', () => {
      if (confirmDialog) confirmDialog.style.display = 'none';
    });

    confirmProceed?.addEventListener('click', async () => {
      if (confirmDialog) confirmDialog.style.display = 'none';
      await performUpload();
    });

    function showConfirmDialog() {
      if (!confirmDialog || !confirmIssues) return;
      
      // Build issues list
      const issues = currentChecks
        .filter(c => c.status === 'error' || c.status === 'warning')
        .map(c => {
          const icon = c.status === 'error' ? '✗' : '⚠';
          const colorClass = c.status === 'error' ? 'text-red-500' : 'text-amber-600';
          return `<div class="flex items-center gap-2 ${colorClass}">
            <span class="font-bold">${icon}</span>
            <span>${c.label}${c.message ? ` · ${c.message}` : ''}</span>
          </div>`;
        });
      
      if (files.length === 0) {
        issues.unshift(`<div class="flex items-center gap-2 text-red-500">
          <span class="font-bold">✗</span>
          <span>Chưa chọn file để upload</span>
        </div>`);
      }
      
      confirmIssues.innerHTML = issues.join('');
      confirmDialog.style.display = 'flex';
    }

    async function handleFiles(rawFiles: File[]) {
      if (!rawFiles.length) return;
      
      if (mode === 'zip' && (rawFiles.length > 1 || !rawFiles[0].name.endsWith('.zip'))) {
        alert('Vui lòng chọn 1 file ZIP');
        return;
      }

      files = rawFiles.map(f => ({ file: f, path: (f as any).webkitRelativePath || f.name, size: f.size }));
      const totalSize = calculateTotalSize(files);
      const fileName = mode === 'zip' ? files[0].file.name : `${files.length} files`;

      if (dropzoneIdle) dropzoneIdle.classList.add('hidden');
      if (filePreview) filePreview.classList.remove('hidden');
      if (previewFileName) previewFileName.textContent = fileName;
      if (previewFileSize) previewFileSize.textContent = formatFileSize(totalSize);

      // Parse manifest for non-zip or create empty one
      if (mode !== 'zip') {
        const manifestFile = findManifestFile(files);
        if (manifestFile) {
          manifest = await parseManifestFile(manifestFile.file);
          populateManifestEditor();
        }
      }
      
      // If no manifest, create empty one for user to fill
      if (!manifest) {
        manifest = {
          id: '',
          version: '1.0.0',
          title: '',
          runtime: '',
          entryUrl: 'index.html'
        };
        populateManifestEditor();
      }

      if (liveChecklist) liveChecklist.classList.remove('hidden');
      if (thumbnailSection) thumbnailSection.classList.remove('hidden');
      if (step2Badge) step2Badge.classList.replace('bg-slate-300', 'bg-iruka-blue');
      if (step3Badge) step3Badge.classList.replace('bg-slate-300', 'bg-iruka-blue');
      
      updatePreview();
      updateValidation();
    }

    function populateManifestEditor() {
      if (!manifest) return;
      if (manifestId) manifestId.value = manifest.id || '';
      if (manifestVersion) manifestVersion.value = manifest.version || '';
      if (manifestTitle) manifestTitle.value = manifest.title || '';
      if (manifestRuntime) manifestRuntime.value = (manifest.runtime as string) || '';
      if (manifestEntry) manifestEntry.value = (manifest.entryUrl as string) || '';
      if (manifestDesc) manifestDesc.value = ''; // Remove description field
    }

    function updatePreview() {
      const idEl = document.getElementById('infoGameId');
      const verEl = document.getElementById('infoVersion');
      const titleEl = document.getElementById('infoTitle');
      const runtimeEl = document.getElementById('infoRuntime');
      const entryEl = document.getElementById('infoEntry');
      if (idEl) idEl.textContent = manifest?.id || '-';
      if (verEl) verEl.textContent = manifest?.version || '-';
      if (titleEl) titleEl.textContent = manifest?.title || '-';
      if (runtimeEl) runtimeEl.textContent = manifest?.runtime || '-';
      if (entryEl) entryEl.textContent = (manifest?.entryUrl as string) || '-';
    }

    function updateValidation() {
      currentChecks = generateLiveChecks(files, manifest, !!thumbDesktop, !!thumbMobile, mode === 'zip');
      renderChecklist(currentChecks);
      const msg = generateValidationMessage(currentChecks);
      renderMessage(msg);
    }

    function renderChecklist(checks: LiveCheckItem[]) {
      if (!checklistItems) return;
      checklistItems.innerHTML = checks.map(c => {
        const iconMap = { success: '✓', warning: '⚠', error: '✗', pending: '○' };
        const classMap = { success: 'check-success', warning: 'check-warning', error: 'check-error', pending: 'check-pending' };
        return `<div class="flex items-center gap-2 text-xs ${classMap[c.status]}">
          <span class="font-bold">${iconMap[c.status]}</span>
          <span class="font-medium">${c.label}</span>
          ${c.message ? `<span class="text-slate-400">· ${c.message}</span>` : ''}
        </div>`;
      }).join('');
    }

    function renderMessage(msg: { type: string; message: string; action?: string } | null) {
      if (!validationMsg || !msgIcon || !msgText || !msgAction) return;
      if (!msg) { validationMsg.classList.add('hidden'); return; }
      validationMsg.classList.remove('hidden', 'msg-success', 'msg-warning', 'msg-error');
      validationMsg.classList.add(`msg-${msg.type}`);
      const icons = { success: '✓', warning: '⚠', error: '✗' };
      msgIcon.textContent = icons[msg.type as keyof typeof icons] || '';
      msgText.textContent = msg.message;
      msgAction.textContent = msg.action || '';
      msgAction.classList.toggle('hidden', !msg.action);
    }

    async function performUpload() {
      isUploading = true;
      if (progressOverlay) progressOverlay.style.display = 'flex';
      if (submitSpinner) submitSpinner.classList.remove('hidden');

      let progress = 0;
      const interval = setInterval(() => {
        progress = Math.min(progress + 5, 90);
        updateProgress(progress, progress > 50 ? 'Xác thực...' : 'Đang tải...');
      }, 100);

      try {
        const metaEl = document.getElementById('__upload_meta__');
        const metaFromUpload = metaEl ? JSON.parse(metaEl.textContent || '{}') : {};

        const formData = buildUploadFormData(files, manifest, thumbDesktop, thumbMobile, mode === 'zip', metaFromUpload);

        const res = await fetch(getUploadEndpoint(mode === 'zip'), { method: 'POST', body: formData });
        clearInterval(interval);
        
        if (res.ok) {
          updateProgress(100, 'Thành công!');
          setTimeout(() => { window.location.href = '/'; }, 600);
        } else {
          throw new Error((await res.json().catch(() => ({}))).error || 'Upload failed');
        }
      } catch (e) {
        clearInterval(interval);
        alert(`Lỗi: ${e instanceof Error ? e.message : 'Có lỗi xảy ra'}`);
        if (progressOverlay) progressOverlay.style.display = 'none';
        if (submitSpinner) submitSpinner.classList.add('hidden');
        isUploading = false;
      }
    }

    function updateProgress(percent: number, label: string) {
      if (progCircle) progCircle.style.strokeDashoffset = String(176 - (176 * percent / 100));
      if (progPercent) progPercent.textContent = `${percent}%`;
      if (progLabel) progLabel.textContent = label;
    }

    function resetState() {
      files = []; manifest = null; thumbDesktop = null; thumbMobile = null;
      if (dropzoneIdle) dropzoneIdle.classList.remove('hidden');
      if (filePreview) filePreview.classList.add('hidden');
      if (liveChecklist) liveChecklist.classList.add('hidden');
      if (thumbnailSection) thumbnailSection.classList.add('hidden');
      if (validationMsg) validationMsg.classList.add('hidden');
      if (step2Badge) step2Badge.classList.replace('bg-iruka-blue', 'bg-slate-300');
      if (step3Badge) step3Badge.classList.replace('bg-iruka-blue', 'bg-slate-300');
      currentChecks = [];
      [zipInput, folderInput, fileInput].forEach(i => { if (i) i.value = ''; });
      // Clear manifest editor
      if (manifestId) manifestId.value = '';
      if (manifestVersion) manifestVersion.value = '';
      if (manifestTitle) manifestTitle.value = '';
      if (manifestRuntime) manifestRuntime.value = '';
      if (manifestEntry) manifestEntry.value = '';
      if (manifestDesc) manifestDesc.value = '';
      updatePreview();
      // Reset thumbnails
      document.querySelectorAll('.thumb-upload').forEach(el => {
        const img = el.querySelector('.thumb-img') as HTMLImageElement;
        const placeholder = el.querySelector('.thumb-placeholder') as HTMLElement;
        const preview = el.querySelector('.thumb-preview') as HTMLElement;
        if (img) { img.src = ''; img.classList.add('hidden'); }
        if (placeholder) placeholder.classList.remove('hidden');
        if (preview) { preview.classList.add('border-dashed'); preview.classList.remove('border-solid', 'border-emerald-300'); }
      });
    }
  }

  document.addEventListener('DOMContentLoaded', init);
  document.addEventListener('astro:page-load', init);
</script>
