---
import type { GameEntry, VersionInfo } from "../lib/registry";
import VersionHistory from "./VersionHistory.astro";

interface Props {
  game: GameEntry & {
    status?: string; // Added for status display
    ownerName?: string; // Added for owner name
    ownerAvatar?: string; // Added for owner avatar
  };
}

const { game } = Astro.props;

// Helper to format date
function formatDate(dateString: string): string {
  if (!dateString) return "N/A";
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return "Vừa xong";
  if (diffMins < 60) return `${diffMins} phút trước`;
  if (diffHours < 24) return `${diffHours} giờ trước`;
  if (diffDays < 7) return `${diffDays} ngày trước`;

  return date.toLocaleDateString("vi-VN");
}

// Get versions as array
function getVersions(): VersionInfo[] {
  if (!game.versions || game.versions.length === 0) return [];

  // Check if it's old format (string[]) or new format (VersionInfo[])
  if (typeof game.versions[0] === "string") {
    return (game.versions as unknown as string[]).map((v) => ({
      version: v,
      uploadedAt: game.updatedAt || new Date().toISOString(),
    }));
  }

  return game.versions as VersionInfo[];
}

const versions = getVersions();

// Standardize runtime string
const runtimeDisplay =
  game.manifest?.runtime === "iframe-html"
    ? "Iframe HTML"
    : game.manifest?.runtime || "Unknown";

// Standardize Environment status
const isProduction = game.status === "published";
const isError = game.status === "qc_failed" || game.status === "archived";
---

<div
  class="card overflow-hidden animate-fade-in border-slate-200 hover:border-indigo-200 transition-all duration-300"
  data-game-id={game.id}
>
  <!-- Card Header -->
  <div class="p-6">
    <div class="flex items-start justify-between gap-4">
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-4 mb-4">
          <div
            class="w-14 h-14 rounded-2xl bg-indigo-50 flex items-center justify-center shrink-0 shadow-inner group-hover:bg-indigo-100 transition-colors"
          >
            <svg
              class="w-8 h-8 text-indigo-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"
              ></path>
            </svg>
          </div>
          <div class="min-w-0 flex-1">
            <h3
              class="text-lg font-bold text-slate-900 truncate tracking-tight"
            >
              {game.title}
            </h3>
            <div class="flex items-center gap-2 mt-0.5">
              <span
                class="text-xs font-mono text-slate-400 bg-slate-50 px-1.5 py-0.5 rounded uppercase tracking-wider"
                >{game.id}</span
              >
              <span
                class={`inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider ${
                  isProduction
                    ? "bg-emerald-50 text-emerald-700 border border-emerald-100"
                    : isError
                      ? "bg-red-50 text-red-700 border border-red-100"
                      : "bg-amber-50 text-amber-700 border border-amber-100"
                }`}
              >
                {
                  isProduction
                    ? "Production"
                    : isError
                      ? "Có lỗi"
                      : game.status === "archived"
                        ? "Đã lưu trữ"
                        : "Bản nháp"
                }
              </span>
            </div>
          </div>
        </div>

        <!-- Metadata Grid -->
        <div
          class="grid grid-cols-2 gap-y-2 gap-x-4 mt-4 text-[13px] text-slate-600"
        >
          <div class="flex items-center gap-2">
            <svg
              class="w-4 h-4 text-slate-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span class="truncate">Cập nhật: {formatDate(game.updatedAt)}</span>
          </div>
          <div class="flex items-center gap-2">
            <svg
              class="w-4 h-4 text-slate-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"
              ></path>
            </svg>
            <span
              >Live: <span class="font-semibold text-slate-900"
                >v{game.activeVersion}</span
              ></span
            >
          </div>
          <div class="flex items-center gap-2">
            <svg
              class="w-4 h-4 text-slate-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              ></path>
            </svg>
            <div class="flex items-center gap-1.5 min-w-0">
              {
                game.ownerAvatar && (
                  <img
                    src={game.ownerAvatar}
                    class="w-4 h-4 rounded-full"
                    alt=""
                  />
                )
              }
              <span class="truncate" title={game.owner || "Admin"}
                >Owner: {game.ownerName || game.owner || "Admin"}</span
              >
            </div>
          </div>
          <div class="flex items-center gap-2">
            <svg
              class="w-4 h-4 text-slate-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            <span>{runtimeDisplay}</span>
          </div>
        </div>
      </div>

      <div class="flex flex-col items-end gap-2 shrink-0">
        <!-- Game Actions Menu -->
        <div class="relative">
          <button
            class="game-menu-btn p-2 text-slate-400 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-all"
            data-game-id={game.id}
            title="Thêm tùy chọn"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
              ></path>
            </svg>
          </button>

          <!-- Dropdown Menu -->
          <div
            class="game-menu hidden absolute right-0 mt-1 w-52 bg-white rounded-xl shadow-xl border border-slate-200 py-2 z-20 overflow-hidden"
          >
            <a
              href={`/games/${game.id}`}
              class="flex items-center gap-3 px-4 py-2.5 text-sm text-slate-700 hover:bg-slate-50 transition-colors"
            >
              <svg
                class="w-4 h-4 text-slate-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
              Xem thông tin
            </a>
            <a
              href={`/games/${game.id}/edit`}
              class="flex items-center gap-3 px-4 py-2.5 text-sm text-slate-700 hover:bg-slate-50 transition-colors"
            >
              <svg
                class="w-4 h-4 text-slate-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                ></path>
              </svg>
              Sửa thông tin
            </a>
            <div class="h-px bg-slate-100 my-1"></div>
            <button
              class="delete-game-btn w-full flex items-center gap-3 px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 transition-colors"
              data-game-id={game.id}
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                ></path>
              </svg>
              Xóa game
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Play Button Section -->
    <div class="mt-6 flex gap-3">
      <a
        href={`/play/${game.id}`}
        class="flex-1 btn-primary py-3 rounded-xl font-bold text-white flex items-center justify-center gap-2.5 shadow-md shadow-indigo-100 ring-1 ring-indigo-500 hover:ring-indigo-600 active:scale-[0.98] transition-all"
      >
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
          <path d="M8 5v14l11-7z"></path>
        </svg>
        <span>Chơi Bản Hiện Hành</span>
      </a>

      <div class="flex gap-2">
        <a
          href={`/games/${game.id}/versions`}
          class="w-12 h-12 rounded-xl border border-slate-200 text-slate-500 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 flex items-center justify-center transition-all bg-white"
          title="Quản lý phiên bản"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"
            ></path>
          </svg>
        </a>
        <a
          href={`/games/${game.id}/logs`}
          class="w-12 h-12 rounded-xl border border-slate-200 text-slate-500 hover:text-emerald-600 hover:border-emerald-200 hover:bg-emerald-50 flex items-center justify-center transition-all bg-white"
          title="Xem logs"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
            ></path>
          </svg>
        </a>
      </div>
    </div>
  </div>

  <!-- Version History -->
  <div class="px-6 pb-6 mt-2">
    <VersionHistory game={game} versions={versions} />
  </div>

  <!-- Capabilities (Micro-bar) -->
  {
    game.capabilities && game.capabilities.length > 0 && (
      <div class="px-6 pb-6">
        <div class="flex flex-wrap gap-1.5">
          {game.capabilities?.map((cap) => (
            <span class="px-2 py-0.5 rounded-md text-[10px] font-bold bg-slate-100 text-slate-500 uppercase tracking-tight">
              {cap}
            </span>
          ))}
        </div>
      </div>
    )
  }
</div>

<script>
  // Set Active Version
  document.querySelectorAll(".set-active-btn").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      const gameId = target.dataset.gameId;
      const version = target.dataset.version;

      if (
        !confirm(
          `Bạn có chắc muốn kích hoạt phiên bản v${version}?\n\nGame Hub sẽ chuyển sang sử dụng phiên bản này.`
        )
      ) {
        return;
      }

      target.textContent = "Đang xử lý...";
      target.disabled = true;

      try {
        const res = await fetch("/api/games/set-active", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ gameId, version }),
        });

        const data = await res.json();

        if (res.ok) {
          window.location.reload();
        } else {
          alert("Lỗi: " + (data.error || "Không thể kích hoạt phiên bản"));
          target.textContent = "Kích hoạt";
          target.disabled = false;
        }
      } catch (err) {
        alert("Lỗi kết nối mạng");
        target.textContent = "Kích hoạt";
        target.disabled = false;
      }
    });
  });

  // Delete Version
  document.querySelectorAll(".delete-version-btn").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      const gameId = target.dataset.gameId;
      const version = target.dataset.version;

      const confirmText = prompt(
        `Bạn có chắc muốn xóa phiên bản v${version}?\nHành động này không thể hoàn tác.\n\nVui lòng nhập "${version}" để xác nhận:`
      );

      if (confirmText !== version) {
        if (confirmText !== null) alert("Mã xác nhận không khớp!");
        return;
      }

      const originalHTML = target.innerHTML;
      target.innerHTML =
        '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>';
      target.disabled = true;

      try {
        const res = await fetch(
          `/api/games/delete?id=${gameId}&version=${version}`,
          {
            method: "DELETE",
          }
        );

        const data = await res.json();

        if (res.ok) {
          window.location.reload();
        } else {
          alert("Xóa thất bại: " + (data.error || "Lỗi không xác định"));
          target.innerHTML = originalHTML;
          target.disabled = false;
        }
      } catch (err) {
        alert("Xóa thất bại: Lỗi kết nối mạng");
        target.innerHTML = originalHTML;
        target.disabled = false;
      }
    });
  });

  // Game Menu Toggle
  document.querySelectorAll(".game-menu-btn").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      const menu = btn.nextElementSibling as HTMLElement;
      const allMenus = document.querySelectorAll(".game-menu");

      // Close all other menus
      allMenus.forEach((m) => {
        if (m !== menu) m.classList.add("hidden");
      });

      // Toggle current menu
      menu.classList.toggle("hidden");
    });
  });

  // Close menus when clicking outside
  document.addEventListener("click", () => {
    document.querySelectorAll(".game-menu").forEach((menu) => {
      menu.classList.add("hidden");
    });
  });

  // Delete Game
  document.querySelectorAll(".delete-game-btn").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      const gameId = target.dataset.gameId;

      const confirmText = prompt(
        `CẢNH BÁO: Bạn đang xóa toàn bộ game "${gameId}".\nTất cả dữ liệu và file sẽ bị xóa vĩnh viễn.\n\nVui lòng nhập "${gameId}" để xác nhận:`
      );

      if (confirmText !== gameId) {
        if (confirmText !== null) alert("Mã xác nhận không khớp!");
        return;
      }

      const originalHTML = target.innerHTML;
      target.innerHTML =
        '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>';
      target.disabled = true;

      try {
        const res = await fetch(`/api/games/delete?id=${gameId}`, {
          method: "DELETE",
        });

        const data = await res.json();

        if (res.ok) {
          // Find the game card wrapper and remove it smoothly
          const card = target.closest(".game-card-wrapper") as HTMLElement;
          if (card) {
            // Animate out
            card.style.transition = "all 0.4s cubic-bezier(0.4, 0, 0.2, 1)";
            card.style.opacity = "0";
            card.style.transform = "scale(0.9) translateY(-20px)";

            // Remove from DOM after animation
            setTimeout(() => {
              card.remove();

              // Check if no games left and show empty state
              const gamesGrid = document.getElementById("gamesGrid");
              const noResults = document.getElementById("noResults");
              if (gamesGrid && gamesGrid.children.length === 0) {
                gamesGrid.style.display = "none";
                if (noResults) {
                  noResults.style.display = "block";
                  noResults.querySelector("h3")!.textContent =
                    "Không còn game nào";
                  noResults.querySelector("p")!.textContent =
                    "Tất cả game đã được xóa";
                }
              }
            }, 400);
          }

          // Show focus on success message if exists elsewhere or use toast
          console.log(`Successfully deleted ${gameId}`);
        } else {
          alert("Xóa game thất bại: " + (data.error || "Lỗi không xác định"));
          target.innerHTML = originalHTML;
          target.disabled = false;
        }
      } catch (err) {
        alert("Xóa game thất bại: Lỗi kết nối mạng");
        target.innerHTML = originalHTML;
        target.disabled = false;
      }
    });
  });
</script>
