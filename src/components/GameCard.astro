---
import type { GameEntry, VersionInfo } from "../lib/registry";
import VersionHistory from "./VersionHistory.astro";

interface Props {
  game: GameEntry;
}

const { game } = Astro.props;
const CDN_BASE = `https://storage.googleapis.com/${import.meta.env.GCLOUD_BUCKET_NAME || "iruka-edu-mini-game"}`;

// Helper to format date
function formatDate(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return "Vừa xong";
  if (diffMins < 60) return `${diffMins} phút trước`;
  if (diffHours < 24) return `${diffHours} giờ trước`;
  if (diffDays < 7) return `${diffDays} ngày trước`;

  return date.toLocaleDateString("vi-VN");
}

// Get versions as array (handle both old and new format)
function getVersions(): VersionInfo[] {
  if (!game.versions || game.versions.length === 0) return [];

  // Check if it's old format (string[]) or new format (VersionInfo[])
  if (typeof game.versions[0] === "string") {
    return (game.versions as unknown as string[]).map((v) => ({
      version: v,
      uploadedAt: game.updatedAt || new Date().toISOString(),
    }));
  }

  return game.versions as VersionInfo[];
}

const versions = getVersions();
---

<div class="card overflow-hidden animate-fade-in" data-game-id={game.id}>
  <!-- Card Header -->
  <div class="p-6 border-b border-slate-200">
    <div class="flex items-start justify-between gap-4">
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-3 mb-3">
          <div
            class="w-12 h-12 rounded-lg bg-indigo-100 flex items-center justify-center shrink-0"
          >
            <svg
              class="w-6 h-6 text-indigo-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"
              ></path>
            </svg>
          </div>
          <div class="min-w-0 flex-1">
            <h3 class="text-base font-bold text-slate-900 truncate">
              {game.title}
            </h3>
            <p class="text-slate-500 text-sm font-mono">{game.id}</p>
            
            <!-- Game Meta Info -->
            <div class="flex items-center gap-2 mt-1 text-xs text-slate-500">
              <span class="flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Cập nhật: {formatDate(game.updatedAt || new Date().toISOString())}
              </span>
              <span>•</span>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-50 text-green-700 border border-green-200">
                ● Production
              </span>
              {game.manifest?.runtime && (
                <>
                  <span>•</span>
                  <span class="capitalize">{game.manifest.runtime}</span>
                </>
              )}
            </div>
            
            <!-- Owner Info -->
            <div class="flex items-center gap-1 mt-1 text-xs text-slate-500">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
              <span>Người phụ trách: {game.owner || 'Admin'}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="flex flex-col items-end gap-2 shrink-0">
        <span
          class="px-2.5 py-1 rounded-full text-xs font-medium bg-green-50 text-green-700 border border-green-200"
        >
          Đang chạy: v{game.activeVersion}
        </span>
        
        <!-- Game Actions Menu -->
        <div class="relative">
          <button
            class="game-menu-btn p-1.5 text-slate-400 hover:text-slate-600 hover:bg-slate-200 rounded transition-colors"
            data-game-id={game.id}
            title="Thêm tùy chọn"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
            </svg>
          </button>
          
          <!-- Dropdown Menu -->
          <div class="game-menu hidden absolute right-0 top-8 w-48 bg-white rounded-lg shadow-lg border border-slate-200 py-1 z-10">
            <a href={`/games/${game.id}`} class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">
              <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Xem thông tin
            </a>
            <a href={`/games/${game.id}/edit`} class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">
              <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
              Sửa thông tin
            </a>
            <hr class="my-1">
            <button
              class="delete-game-btn w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50"
              data-game-id={game.id}
            >
              <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
              Xóa game
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Play Button -->
    <div class="mt-4 flex gap-2">
      <a
        href={`/play/${game.id}`}
        class="flex-1 btn-primary py-3 rounded-lg font-semibold text-white flex items-center justify-center gap-2 text-sm"
      >
        <svg
          class="w-5 h-5"
          fill="currentColor"
          viewBox="0 0 24 24"
        >
          <path d="M8 5v14l11-7z"/>
        </svg>
        Chơi phiên bản hiện hành
      </a>
      
      <a
        href={`/games/${game.id}/versions`}
        class="px-4 py-3 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50 flex items-center justify-center transition-colors text-sm font-medium"
        title="Quản lý phiên bản"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
        </svg>
      </a>
    </div>
  </div>

  <!-- Version History -->
  <div class="p-6">
    <VersionHistory game={game} versions={versions} />
  </div>

  <!-- Meta Info -->
  {
    game.manifest?.runtime && (
      <div class="px-6 pb-6">
        <div class="flex flex-wrap gap-2">
          <span class="px-2.5 py-1 rounded-md text-xs font-medium bg-slate-200 text-slate-600">
            Runtime: {game.manifest.runtime}
          </span>
          {game.capabilities?.map((cap) => (
            <span class="px-2.5 py-1 rounded-md text-xs font-medium bg-blue-50 text-blue-700">
              {cap}
            </span>
          ))}
        </div>
      </div>
    )
  }
</div>

<script>
  // Set Active Version
  document.querySelectorAll(".set-active-btn").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      const gameId = target.dataset.gameId;
      const version = target.dataset.version;

      if (
        !confirm(
          `Bạn có chắc muốn kích hoạt phiên bản v${version}?\n\nGame Hub sẽ chuyển sang sử dụng phiên bản này.`
        )
      ) {
        return;
      }

      target.textContent = "Đang xử lý...";
      target.disabled = true;

      try {
        const res = await fetch("/api/games/set-active", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ gameId, version }),
        });

        const data = await res.json();

        if (res.ok) {
          window.location.reload();
        } else {
          alert("Lỗi: " + (data.error || "Không thể kích hoạt phiên bản"));
          target.textContent = "Kích hoạt";
          target.disabled = false;
        }
      } catch (err) {
        alert("Lỗi kết nối mạng");
        target.textContent = "Kích hoạt";
        target.disabled = false;
      }
    });
  });

  // Delete Version
  document.querySelectorAll(".delete-version-btn").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      const gameId = target.dataset.gameId;
      const version = target.dataset.version;

      if (
        !confirm(
          `Bạn có chắc muốn xóa phiên bản v${version}?\n\nHành động này sẽ xóa vĩnh viễn tất cả file của phiên bản này và không thể hoàn tác.`
        )
      ) {
        return;
      }

      const originalHTML = target.innerHTML;
      target.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>';
      target.disabled = true;

      try {
        const res = await fetch(
          `/api/games/delete?id=${gameId}&version=${version}`,
          {
            method: "DELETE",
          }
        );

        const data = await res.json();

        if (res.ok) {
          window.location.reload();
        } else {
          alert("Xóa thất bại: " + (data.error || "Lỗi không xác định"));
          target.innerHTML = originalHTML;
          target.disabled = false;
        }
      } catch (err) {
        alert("Xóa thất bại: Lỗi kết nối mạng");
        target.innerHTML = originalHTML;
        target.disabled = false;
      }
    });
  });

  // Game Menu Toggle
  document.querySelectorAll(".game-menu-btn").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      const menu = btn.nextElementSibling as HTMLElement;
      const allMenus = document.querySelectorAll(".game-menu");
      
      // Close all other menus
      allMenus.forEach(m => {
        if (m !== menu) m.classList.add("hidden");
      });
      
      // Toggle current menu
      menu.classList.toggle("hidden");
    });
  });

  // Close menus when clicking outside
  document.addEventListener("click", () => {
    document.querySelectorAll(".game-menu").forEach(menu => {
      menu.classList.add("hidden");
    });
  });

  // Delete Game
  document.querySelectorAll(".delete-game-btn").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      const gameId = target.dataset.gameId;

      if (
        !confirm(
          `Bạn có chắc muốn xóa toàn bộ game "${gameId}"?\n\nHành động này sẽ xóa vĩnh viễn:\n- Tất cả phiên bản của game\n- Tất cả file trên cloud storage\n- Thông tin trong registry\n\nKhông thể hoàn tác!`
        )
      ) {
        return;
      }

      const originalHTML = target.innerHTML;
      target.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>';
      target.disabled = true;

      try {
        const res = await fetch(`/api/games/delete?id=${gameId}`, {
          method: "DELETE",
        });

        const data = await res.json();

        if (res.ok) {
          // Fade out the card before reload
          const card = target.closest('.card') as HTMLElement;
          if (card) {
            card.style.opacity = '0.5';
            card.style.transform = 'scale(0.95)';
          }
          
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } else {
          alert("Xóa game thất bại: " + (data.error || "Lỗi không xác định"));
          target.innerHTML = originalHTML;
          target.disabled = false;
        }
      } catch (err) {
        alert("Xóa game thất bại: Lỗi kết nối mạng");
        target.innerHTML = originalHTML;
        target.disabled = false;
      }
    });
  });
</script>
