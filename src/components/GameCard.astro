---
import type { GameEntry } from "../lib/registry";

interface Props {
  game: GameEntry & {
    status?: string;
    ownerName?: string;
    ownerAvatar?: string;
  };
  compact?: boolean;
}

const { game, compact = false } = Astro.props;

// --- Helper Functions ---
function formatDate(dateString: string): string {
  if (!dateString) return "N/A";
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);

  if (diffMins < 60) return `${diffMins} phút trước`;
  if (diffHours < 24) return `${diffHours} giờ trước`;
  return date.toLocaleDateString("vi-VN", { day: "2-digit", month: "2-digit" });
}

function formatSize(bytes?: number): string {
  if (!bytes) return "0 KB";
  const mb = bytes / (1024 * 1024);
  return mb < 1 ? `${(bytes / 1024).toFixed(0)} KB` : `${mb.toFixed(1)} MB`;
}

// --- Data Preparation ---
const activeVersion = game.versions?.find(
  (v: any) => v.version === game.activeVersion
);
const versionSize = activeVersion ? formatSize(activeVersion.size) : "Updated";

const isProduction = game.status === "published";
const isDraft = !game.status || game.status === "draft";
const isError = game.status === "qc_failed" || game.status === "archived";

const statusColor = isProduction
  ? "emerald"
  : isError
    ? "red"
    : isDraft
      ? "slate"
      : "amber";
const runtimeDisplay =
  game.manifest?.runtime === "iframe-html" ? "Iframe" : "ESM";
const ownerDisplay = game.ownerName || game.owner || "Admin";

// Limit capabilities tags
const displayedCaps = game.capabilities?.slice(0, 3) || [];
const remainingCaps = (game.capabilities?.length || 0) - 3;
---

<div
  class="game-card-root group relative bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-md hover:border-indigo-300 transition-all duration-300 flex flex-col h-full overflow-hidden cursor-pointer"
  data-game-id={game.id}
  data-game-title={game.title}
  onclick={`window.openGameDrawer('${game.id}')`}
>
  <!-- Card Content Padding - Reduced from p-5 to p-4 -->
  <div class="card-content p-4 flex flex-col h-full transition-all">
    <!-- 1. Header Row - Reduced margin -->
    <div
      class="card-header flex items-start justify-between gap-3 mb-2 transition-all"
    >
      <div class="flex items-center gap-3 min-w-0 pointer-events-none">
        <!-- Icon -->
        <div
          class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-50 to-blue-50 flex items-center justify-center shrink-0 border border-slate-100 shadow-sm group-hover:from-indigo-100 group-hover:to-blue-100 transition-colors"
        >
          <span class="text-lg font-black text-indigo-600 uppercase"
            >{game.title?.charAt(0)}</span
          >
        </div>

        <!-- Title & Badges -->
        <div class="min-w-0">
          <div class="flex items-center gap-2">
            <h3
              class="text-base font-bold text-slate-900 truncate tracking-tight"
            >
              {game.title}
            </h3>
            {
              isProduction && (
                <span class="hidden sm:inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-black bg-emerald-100 text-emerald-700 uppercase tracking-wider">
                  PROD
                </span>
              )
            }
          </div>

          <!-- Sub-line: Version & Status -->
          <div class="flex items-center gap-2 mt-0.5 text-xs">
            <span
              class={`flex items-center gap-1.5 font-bold text-${statusColor}-600`}
            >
              <span
                class={`w-1.5 h-1.5 rounded-full bg-${statusColor}-500 ${isProduction ? "animate-pulse" : ""}`}
              ></span>
              Live v{game.activeVersion}
            </span>
            <span class="text-slate-300">|</span>
            <span class="text-slate-500 font-medium truncate"
              >ID: {game.id}</span
            >
          </div>
        </div>
      </div>
    </div>

    <!-- 2. Meta Info Row -->
    <div
      class="card-meta flex items-center gap-x-4 gap-y-2 flex-wrap text-[11px] font-medium text-slate-500 mb-4 bg-slate-50/50 p-2 rounded-lg border border-slate-100/50 pointer-events-none transition-all"
    >
      <span class="flex items-center gap-1.5 min-w-[100px]">
        <svg
          class="w-3.5 h-3.5 text-slate-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg
        >
        {formatDate(game.updatedAt)}
      </span>
      <span class="flex items-center gap-1.5">
        <svg
          class="w-3.5 h-3.5 text-slate-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
          ></path></svg
        >
        {ownerDisplay}
      </span>
      <span class="flex items-center gap-1.5">
        <svg
          class="w-3.5 h-3.5 text-slate-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg
        >
        {runtimeDisplay}
      </span>
    </div>

    <!-- 3. Tags -->
    {
      displayedCaps.length > 0 && (
        <div class="card-tags flex flex-wrap gap-1.5 mb-4 pointer-events-none transition-all">
          {displayedCaps.map((cap) => (
            <span class="px-2 py-0.5 rounded border border-slate-100 bg-white text-[10px] font-bold text-slate-500 uppercase tracking-tight">
              {cap}
            </span>
          ))}
          {remainingCaps > 0 && (
            <span class="px-2 py-0.5 rounded border border-slate-100 bg-slate-50 text-[10px] font-bold text-slate-400">
              +{remainingCaps}
            </span>
          )}
        </div>
      )
    }

    <!-- 4. Action Row -->
    <div
      class="card-actions mt-auto pt-3 border-t border-slate-100 flex items-center justify-between gap-2 transition-all"
      onclick="event.stopPropagation()"
    >
      <!-- Versions -->
      <a
        href={`/games/${game.id}/versions`}
        class="flex-1 py-2 text-xs font-bold text-slate-600 bg-slate-50 hover:bg-white hover:text-indigo-600 hover:shadow-sm border border-slate-200 rounded-lg transition-all flex items-center justify-center gap-2 group/btn"
      >
        <svg
          class="w-4 h-4 text-slate-400 group-hover/btn:text-indigo-500"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg
        >
        Phiên bản
      </a>

      <a
        href={`/play/${game.id}`}
        target="_blank"
        class="flex-1 py-2 text-xs font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 hover:text-indigo-700 border border-indigo-100 rounded-lg transition-all flex items-center justify-center gap-1.5"
        title="Chơi Live (Tab mới)"
      >
        <svg class="w-3.5 h-3.5 fill-current" viewBox="0 0 24 24"
          ><path d="M8 5v14l11-7z"></path></svg
        >
        Chơi ngay
      </a>
    </div>
  </div>
</div>

<script>
  // Game Card Interactive

  // Define types for global window augmentation if needed (though implicit in .astro scripts usually)
  declare global {
    interface Window {
      openGameDrawer: (gameId: string) => void;
    }
  }

  // Open Drawer Logic
  window.openGameDrawer = (gameId: string) => {
    window.location.href = `/games/${gameId}`;
  };
</script>

<style>
  .animate-fade-in-up {
    animation: fadeInUp 0.2s cubic-bezier(0.16, 1, 0.3, 1);
  }
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(5px);
      scale: 0.95;
    }
    to {
      opacity: 1;
      transform: translateY(0);
      scale: 1;
    }
  }

  /* LIST VIEW STYLES */
  :global(#gamesGrid.list-view) .game-card-root {
    flex-direction: row;
    height: auto;
    min-height: 80px;
    align-items: center;
  }

  :global(#gamesGrid.list-view) .card-content {
    flex-direction: row;
    align-items: center;
    width: 100%;
    padding: 0.75rem 1rem;
    gap: 1.5rem;
  }

  :global(#gamesGrid.list-view) .card-header {
    margin-bottom: 0;
    flex: 2;
    min-width: 0; /* Text truncation fix */
  }

  :global(#gamesGrid.list-view) .card-meta {
    margin-bottom: 0;
    background: none;
    border: none;
    padding: 0;
    flex: 2;
    display: flex; /* Ensure it's shown */
  }

  :global(#gamesGrid.list-view) .card-tags {
    margin-bottom: 0;
    display: none; /* Hide tags in list view to reduce clutter */
  }

  :global(#gamesGrid.list-view) .card-actions {
    margin-top: 0;
    padding-top: 0;
    border-top: none;
    flex: 2;
    justify-content: flex-end;
  }

  /* Adjust Action Buttons for List View */
  :global(#gamesGrid.list-view) .card-actions a {
    padding: 0.5rem 0.75rem;
    white-space: nowrap;
    flex: 0 0 auto;
  }
</style>
