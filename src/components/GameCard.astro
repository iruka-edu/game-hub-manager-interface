---
import type { GameEntry } from "../lib/registry";

interface Props {
  game: GameEntry & {
    status?: string;
    ownerName?: string;
    ownerAvatar?: string;
  };
  compact?: boolean;
}

const { game, compact = false } = Astro.props;

// --- Helper Functions ---
function formatDate(dateString: string): string {
  if (!dateString) return "N/A";
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);

  if (diffMins < 60) return `${diffMins} phút trước`;
  if (diffHours < 24) return `${diffHours} giờ trước`;
  return date.toLocaleDateString("vi-VN", { day: "2-digit", month: "2-digit" });
}

function formatSize(bytes?: number): string {
  if (!bytes) return "0 KB";
  const mb = bytes / (1024 * 1024);
  return mb < 1 ? `${(bytes / 1024).toFixed(0)} KB` : `${mb.toFixed(1)} MB`;
}

// --- Data Preparation ---
const activeVersion = game.versions?.find(
  (v: any) => v.version === game.activeVersion
);
const versionSize = activeVersion ? formatSize(activeVersion.size) : "Updated";

const isProduction = game.status === "published";
const isDraft = !game.status || game.status === "draft";
const isError = game.status === "qc_failed" || game.status === "archived";

const statusColor = isProduction
  ? "emerald"
  : isError
    ? "red"
    : isDraft
      ? "slate"
      : "amber";
const runtimeDisplay =
  game.manifest?.runtime === "iframe-html" ? "Iframe" : "ESM";
const ownerDisplay = game.ownerName || game.owner || "Admin";

// Limit capabilities tags
const displayedCaps = game.capabilities?.slice(0, 3) || [];
const remainingCaps = (game.capabilities?.length || 0) - 3;
---

<div
  class="game-card-root group relative bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-md hover:border-indigo-300 transition-all duration-300 flex flex-col h-full overflow-hidden cursor-pointer"
  data-game-id={game.id}
  data-game-title={game.title}
  onclick={`window.openGameDrawer('${game.id}')`}
>
  <!-- Card Content Padding - Reduced from p-5 to p-4 -->
  <div class="card-content p-4 flex flex-col h-full transition-all">
    <!-- 1. Header Row - Reduced margin -->
    <div
      class="card-header flex items-start justify-between gap-3 mb-2 transition-all"
    >
      <div class="flex items-center gap-3 min-w-0 pointer-events-none">
        <!-- Icon -->
        <div
          class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-50 to-blue-50 flex items-center justify-center shrink-0 border border-slate-100 shadow-sm group-hover:from-indigo-100 group-hover:to-blue-100 transition-colors"
        >
          <span class="text-lg font-black text-indigo-600 uppercase"
            >{game.title?.charAt(0)}</span
          >
        </div>

        <!-- Title & Badges -->
        <div class="min-w-0">
          <div class="flex items-center gap-2">
            <h3
              class="text-base font-bold text-slate-900 truncate tracking-tight"
            >
              {game.title}
            </h3>
            {
              isProduction && (
                <span class="hidden sm:inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-black bg-emerald-100 text-emerald-700 uppercase tracking-wider">
                  PROD
                </span>
              )
            }
          </div>

          <!-- Sub-line: Version & Status -->
          <div class="flex items-center gap-2 mt-0.5 text-xs">
            <span
              class={`flex items-center gap-1.5 font-bold text-${statusColor}-600`}
            >
              <span
                class={`w-1.5 h-1.5 rounded-full bg-${statusColor}-500 ${isProduction ? "animate-pulse" : ""}`}
              ></span>
              Live v{game.activeVersion}
            </span>
            <span class="text-slate-300">|</span>
            <span class="text-slate-500 font-medium truncate"
              >ID: {game.id}</span
            >
          </div>
        </div>
      </div>

      <!-- Right: More Menu -->
      <div
        class="flex items-center gap-1 relative ml-auto"
        onclick="event.stopPropagation()"
      >
        <button
          class="game-menu-btn p-1.5 text-slate-400 hover:text-slate-700 hover:bg-slate-100 rounded-lg transition-colors"
          data-menu-trigger
        >
          <svg
            class="w-5 h-5 pointer-events-none"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
            ></path></svg
          >
        </button>

        <!-- Dropdown (Reorganized) -->
        <div
          class="game-menu-dropdown hidden absolute right-0 top-9 w-52 bg-white rounded-xl shadow-xl border border-slate-200 py-1.5 z-30 animate-fade-in-up origin-top-right"
        >
          <!-- Group 1: Actions -->
          <div class="px-2 py-1">
            <span
              class="px-2 text-[10px] font-black text-slate-400 uppercase tracking-wider"
              >Tác vụ</span
            >
            <button
              onclick={`window.openGameDrawer('${game.id}')`}
              class="w-full text-left px-2 py-1.5 text-xs font-bold text-slate-700 hover:bg-slate-50 hover:text-indigo-600 rounded-lg flex items-center gap-2"
            >
              <svg
                class="w-4 h-4 text-slate-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                ></path></svg
              >
              Mở chi tiết
            </button>
            <button
              onclick={`navigator.clipboard.writeText('${game.id}'); alert('Đã copy ID')`}
              class="w-full text-left px-2 py-1.5 text-xs font-bold text-slate-700 hover:bg-slate-50 hover:text-indigo-600 rounded-lg flex items-center gap-2"
            >
              <svg
                class="w-4 h-4 text-slate-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                ></path></svg
              >
              Copy Game ID
            </button>
          </div>

          <div class="h-px bg-slate-100 my-1"></div>

          <!-- Group 2: Management -->
          <div class="px-2 py-1">
            <span
              class="px-2 text-[10px] font-black text-slate-400 uppercase tracking-wider"
              >Quản lý</span
            >
            <a
              href={`/upload?gameId=${game.id}`}
              class="block px-2 py-1.5 text-xs font-bold text-slate-700 hover:bg-slate-50 hover:text-indigo-600 rounded-lg flex items-center gap-2"
            >
              <svg
                class="w-4 h-4 text-slate-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                ></path></svg
              >
              Tải bản build mới
            </a>
            <a
              href={`/games/${game.id}/versions`}
              class="block px-2 py-1.5 text-xs font-bold text-slate-700 hover:bg-slate-50 hover:text-indigo-600 rounded-lg flex items-center gap-2"
            >
              <svg
                class="w-4 h-4 text-slate-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg
              >
              Quản lý Versions
            </a>
          </div>

          <div class="h-px bg-slate-100 my-1"></div>

          <!-- Group 3: Danger -->
          <div class="px-2 py-1">
            <button
              class="delete-game-btn w-full text-left px-2 py-1.5 text-xs font-bold text-red-600 hover:bg-red-50 rounded-lg flex items-center gap-2"
              data-game-id={game.id}
              data-game-title={game.title}
            >
              <svg
                class="w-4 h-4 text-red-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                ></path></svg
              >
              Xóa Game
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. Meta Info Row -->
    <div
      class="card-meta flex items-center gap-x-4 gap-y-2 flex-wrap text-[11px] font-medium text-slate-500 mb-4 bg-slate-50/50 p-2 rounded-lg border border-slate-100/50 pointer-events-none transition-all"
    >
      <span class="flex items-center gap-1.5 min-w-[100px]">
        <svg
          class="w-3.5 h-3.5 text-slate-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg
        >
        {formatDate(game.updatedAt)}
      </span>
      <span class="flex items-center gap-1.5">
        <svg
          class="w-3.5 h-3.5 text-slate-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
          ></path></svg
        >
        {ownerDisplay}
      </span>
      <span class="flex items-center gap-1.5">
        <svg
          class="w-3.5 h-3.5 text-slate-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg
        >
        {runtimeDisplay}
      </span>
    </div>

    <!-- 3. Tags -->
    {
      displayedCaps.length > 0 && (
        <div class="card-tags flex flex-wrap gap-1.5 mb-4 pointer-events-none transition-all">
          {displayedCaps.map((cap) => (
            <span class="px-2 py-0.5 rounded border border-slate-100 bg-white text-[10px] font-bold text-slate-500 uppercase tracking-tight">
              {cap}
            </span>
          ))}
          {remainingCaps > 0 && (
            <span class="px-2 py-0.5 rounded border border-slate-100 bg-slate-50 text-[10px] font-bold text-slate-400">
              +{remainingCaps}
            </span>
          )}
        </div>
      )
    }

    <!-- 4. Action Row -->
    <div
      class="card-actions mt-auto pt-3 border-t border-slate-100 flex items-center justify-between gap-2 transition-all"
      onclick="event.stopPropagation()"
    >
      <!-- Versions -->
      <a
        href={`/games/${game.id}/versions`}
        class="flex-1 py-2 text-xs font-bold text-slate-600 bg-slate-50 hover:bg-white hover:text-indigo-600 hover:shadow-sm border border-slate-200 rounded-lg transition-all flex items-center justify-center gap-2 group/btn"
      >
        <svg
          class="w-4 h-4 text-slate-400 group-hover/btn:text-indigo-500"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg
        >
        Phiên bản
      </a>

      <a
        href={`/play/${game.id}`}
        target="_blank"
        class="flex-1 py-2 text-xs font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 hover:text-indigo-700 border border-indigo-100 rounded-lg transition-all flex items-center justify-center gap-1.5"
        title="Chơi Live (Tab mới)"
      >
        <svg class="w-3.5 h-3.5 fill-current" viewBox="0 0 24 24"
          ><path d="M8 5v14l11-7z"></path></svg
        >
        Chơi ngay
      </a>
    </div>
  </div>
</div>

<script>
  // Game Card Interactive

  // Define types for global window augmentation if needed (though implicit in .astro scripts usually)
  declare global {
    interface Window {
      openGameDrawer: (gameId: string) => void;
    }
  }

  // Open Drawer Logic
  window.openGameDrawer = (gameId: string) => {
    window.location.href = `/games/${gameId}`;
  };

  // Delegated Event Listeners for better performance
  document.addEventListener("click", (e) => {
    const target = e.target as HTMLElement;

    // Toggle Menu
    const menuBtn = target.closest(".game-menu-btn");
    if (menuBtn) {
      e.preventDefault();
      e.stopPropagation();
      const container = menuBtn.nextElementSibling;
      document.querySelectorAll(".game-menu-dropdown").forEach((el) => {
        if (el !== container) el.classList.add("hidden");
      });
      container?.classList.toggle("hidden");
      return;
    }

    // Outside Click
    if (!target.closest(".game-menu-dropdown")) {
      document
        .querySelectorAll(".game-menu-dropdown")
        .forEach((el) => el.classList.add("hidden"));
    }

    // Delete Game
    const deleteBtn = target.closest(
      ".delete-game-btn"
    ) as HTMLButtonElement | null;
    if (deleteBtn) {
      e.preventDefault();
      e.stopPropagation();
      const gameId = deleteBtn.dataset.gameId;
      const gameTitle = deleteBtn.dataset.gameTitle;

      if (
        gameId &&
        confirm(
          `⚠️ CẢNH BÁO Production:\n\nBạn đang xóa game "${gameTitle}"?\nID: ${gameId}\n\nHành động này sẽ xóa toàn bộ phiên bản và dữ liệu. Không thể hoàn tác.`
        )
      ) {
        handleDeleteGame(gameId, deleteBtn);
      }
    }
  });

  async function handleDeleteGame(gameId: string, btn: HTMLButtonElement) {
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="animate-pulse">Đang xóa...</span>';
    btn.disabled = true;

    try {
      const res = await fetch(`/api/games/delete?id=${gameId}`, {
        method: "DELETE",
      });
      if (res.ok) {
        const card = btn.closest("[data-game-id]") as HTMLElement;
        if (card) {
          card.style.opacity = "0";
          card.style.transform = "scale(0.9)";
          setTimeout(() => card.remove(), 300);
        }
      } else {
        alert("Lỗi: Không thể xóa game (API Error)");
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    } catch (e) {
      alert("Lỗi kết nối mạng.");
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  }
</script>

<style>
  .animate-fade-in-up {
    animation: fadeInUp 0.2s cubic-bezier(0.16, 1, 0.3, 1);
  }
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(5px);
      scale: 0.95;
    }
    to {
      opacity: 1;
      transform: translateY(0);
      scale: 1;
    }
  }

  /* LIST VIEW STYLES */
  :global(#gamesGrid.list-view) .game-card-root {
    flex-direction: row;
    height: auto;
    min-height: 80px;
    align-items: center;
  }

  :global(#gamesGrid.list-view) .card-content {
    flex-direction: row;
    align-items: center;
    width: 100%;
    padding: 0.75rem 1rem;
    gap: 1.5rem;
  }

  :global(#gamesGrid.list-view) .card-header {
    margin-bottom: 0;
    flex: 2;
    min-width: 0; /* Text truncation fix */
  }

  :global(#gamesGrid.list-view) .card-meta {
    margin-bottom: 0;
    background: none;
    border: none;
    padding: 0;
    flex: 2;
    display: flex; /* Ensure it's shown */
  }

  :global(#gamesGrid.list-view) .card-tags {
    margin-bottom: 0;
    display: none; /* Hide tags in list view to reduce clutter */
  }

  :global(#gamesGrid.list-view) .card-actions {
    margin-top: 0;
    padding-top: 0;
    border-top: none;
    flex: 2;
    justify-content: flex-end;
  }

  /* Adjust Action Buttons for List View */
  :global(#gamesGrid.list-view) .card-actions a {
    padding: 0.5rem 0.75rem;
    white-space: nowrap;
    flex: 0 0 auto;
  }
</style>
