---
import type { GameEntry, VersionInfo } from "../lib/registry";

interface Props {
  game: GameEntry;
}

const { game } = Astro.props;
const CDN_BASE = `https://storage.googleapis.com/${import.meta.env.GCLOUD_BUCKET_NAME || "iruka-edu-mini-game"}`;

// Helper to format date
function formatDate(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return "Vừa xong";
  if (diffMins < 60) return `${diffMins} phút trước`;
  if (diffHours < 24) return `${diffHours} giờ trước`;
  if (diffDays < 7) return `${diffDays} ngày trước`;

  return date.toLocaleDateString("vi-VN");
}

// Get versions as array (handle both old and new format)
function getVersions(): VersionInfo[] {
  if (!game.versions || game.versions.length === 0) return [];

  // Check if it's old format (string[]) or new format (VersionInfo[])
  if (typeof game.versions[0] === "string") {
    return (game.versions as unknown as string[]).map((v) => ({
      version: v,
      uploadedAt: game.updatedAt || new Date().toISOString(),
    }));
  }

  return game.versions as VersionInfo[];
}

const versions = getVersions();
---

<div class="card overflow-hidden animate-fade-in" data-game-id={game.id}>
  <!-- Card Header -->
  <div class="p-6 border-b border-slate-100">
    <div class="flex items-start justify-between gap-4">
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-3 mb-2">
          <div
            class="w-12 h-12 rounded-lg bg-indigo-100 flex items-center justify-center shrink-0"
          >
            <svg
              class="w-6 h-6 text-indigo-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"
              ></path>
            </svg>
          </div>
          <div class="min-w-0">
            <h3 class="text-base font-bold text-slate-900 truncate">
              {game.title}
            </h3>
            <p class="text-slate-500 text-sm font-mono">{game.id}</p>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-2 shrink-0">
        <span
          class="px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-200"
        >
          Live: v{game.activeVersion}
        </span>
      </div>
    </div>

    <!-- Play Button -->
    <a
      href={`/play/${game.id}`}
      class="mt-4 btn-primary w-full py-3 rounded-lg font-semibold text-white flex items-center justify-center gap-2 text-sm"
    >
      <svg
        class="w-5 h-5"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
        ></path>
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      Chơi phiên bản hiện hành
    </a>
  </div>

  <!-- Version History Table -->
  <div class="p-6">
    <h4
      class="text-sm font-semibold text-slate-700 mb-4 flex items-center gap-2"
    >
      <svg
        class="w-4 h-4"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      Lịch sử phiên bản ({versions.length})
    </h4>

    <div class="space-y-2 max-h-64 overflow-y-auto">
      {
        versions
          .slice()
          .reverse()
          .map((versionInfo) => {
            const isActive = versionInfo.version === game.activeVersion;
            return (
              <div
                class="flex items-center justify-between py-3 px-4 rounded-lg bg-slate-50 hover:bg-slate-100 transition-colors group"
                data-version={versionInfo.version}
              >
                <div class="flex items-center gap-3 flex-1 min-w-0">
                  <span
                    class={`w-2 h-2 rounded-full shrink-0 ${isActive ? "bg-emerald-500" : "bg-slate-300"}`}
                  />
                  <div class="min-w-0">
                    <div class="flex items-center gap-2">
                      <span class="font-mono text-sm text-slate-900 font-medium">
                        v{versionInfo.version}
                      </span>
                      {isActive && (
                        <span class="px-2 py-0.5 rounded text-xs font-medium bg-emerald-100 text-emerald-700">
                          Active
                        </span>
                      )}
                    </div>
                    <p class="text-xs text-slate-500">
                      {formatDate(versionInfo.uploadedAt)}
                    </p>
                  </div>
                </div>

                <div class="flex items-center gap-2 shrink-0">
                  {!isActive && (
                    <button
                      class="set-active-btn px-3 py-1.5 text-xs font-medium text-indigo-600 hover:text-indigo-700 rounded-md hover:bg-indigo-50 transition-colors"
                      data-game-id={game.id}
                      data-version={versionInfo.version}
                    >
                      Kích hoạt
                    </button>
                  )}
                  <a
                    href={`${CDN_BASE}/games/${game.id}/${versionInfo.version}/index.html`}
                    target="_blank"
                    class="px-3 py-1.5 text-xs font-medium text-slate-600 hover:text-slate-700 rounded-md hover:bg-slate-200 transition-colors"
                  >
                    Xem
                  </a>
                  {isActive ? (
                    <button
                      class="px-3 py-1.5 text-xs font-medium text-slate-400 rounded-md cursor-not-allowed"
                      disabled
                      title="Không thể xóa phiên bản đang hoạt động"
                    >
                      Xóa
                    </button>
                  ) : (
                    <button
                      class="delete-version-btn px-3 py-1.5 text-xs font-medium text-red-600 hover:text-red-700 rounded-md hover:bg-red-50 transition-colors"
                      data-game-id={game.id}
                      data-version={versionInfo.version}
                    >
                      Xóa
                    </button>
                  )}
                </div>
              </div>
            );
          })
      }
    </div>
  </div>

  <!-- Meta Info -->
  {
    game.manifest?.runtime && (
      <div class="px-6 pb-6">
        <div class="flex flex-wrap gap-2">
          <span class="px-2.5 py-1 rounded-md text-xs font-medium bg-slate-100 text-slate-600">
            Runtime: {game.manifest.runtime}
          </span>
          {game.capabilities?.map((cap) => (
            <span class="px-2.5 py-1 rounded-md text-xs font-medium bg-blue-50 text-blue-700">
              {cap}
            </span>
          ))}
        </div>
      </div>
    )
  }
</div>

<script>
  // Set Active Version
  document.querySelectorAll(".set-active-btn").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      const gameId = target.dataset.gameId;
      const version = target.dataset.version;

      if (
        !confirm(
          `Kích hoạt phiên bản ${version}? Game Hub sẽ chuyển sang sử dụng phiên bản này.`
        )
      ) {
        return;
      }

      target.textContent = "Đang xử lý...";
      target.disabled = true;

      try {
        const res = await fetch("/api/games/set-active", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ gameId, version }),
        });

        const data = await res.json();

        if (res.ok) {
          window.location.reload();
        } else {
          alert("Lỗi: " + (data.error || "Không thể kích hoạt phiên bản"));
          target.textContent = "Kích hoạt";
          target.disabled = false;
        }
      } catch (err) {
        alert("Lỗi kết nối mạng");
        target.textContent = "Kích hoạt";
        target.disabled = false;
      }
    });
  });

  // Delete Version
  document.querySelectorAll(".delete-version-btn").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      const gameId = target.dataset.gameId;
      const version = target.dataset.version;

      if (
        !confirm(
          `Xóa phiên bản ${version}? Hành động này sẽ xóa tất cả file của phiên bản này.`
        )
      ) {
        return;
      }

      target.textContent = "Đang xóa...";
      target.disabled = true;

      try {
        const res = await fetch(
          `/api/games/delete?id=${gameId}&version=${version}`,
          {
            method: "DELETE",
          }
        );

        const data = await res.json();

        if (res.ok) {
          window.location.reload();
        } else {
          alert("Xóa thất bại: " + (data.error || "Lỗi không xác định"));
          target.textContent = "Xóa";
          target.disabled = false;
        }
      } catch (err) {
        alert("Xóa thất bại: Lỗi kết nối mạng");
        target.textContent = "Xóa";
        target.disabled = false;
      }
    });
  });
</script>
