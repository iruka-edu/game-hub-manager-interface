---
// Server-side component - all logic happens on client
---

<div class="flex flex-col h-full animate-fade-in gap-6">
  <!-- Section 1: Upload Card (Tabs + Dropzone) -->
  <div
    class="bg-white rounded-[24px] border border-slate-200 shadow-sm overflow-hidden shrink-0"
  >
    <!-- Compact Tabs -->
    <div class="flex items-center justify-center pt-6 pb-2">
      <div class="bg-slate-100 p-1 rounded-lg inline-flex">
        <button
          id="tabZip"
          class="px-4 py-1.5 rounded-md text-xs font-bold text-slate-700 hover:text-slate-900 transition-all shadow-sm bg-white"
        >
          ZIP (Khuyên dùng)
        </button>
        <button
          id="tabFolder"
          class="px-4 py-1.5 rounded-md text-xs font-bold text-slate-500 hover:text-slate-700 transition-all"
        >
          Thư mục
        </button>
        <button
          id="tabFile"
          class="px-4 py-1.5 rounded-md text-xs font-bold text-slate-500 hover:text-slate-700 transition-all"
        >
          File lẻ
        </button>
      </div>
    </div>

    <!-- Dropzone Area -->
    <div class="p-8">
      <div
        id="dropZone"
        class="relative border-2 border-dashed border-slate-200 rounded-xl bg-slate-50/50 hover:bg-white hover:border-iruka-blue transition-all duration-300 group cursor-pointer flex flex-col items-center justify-center text-center p-8 gap-6"
      >
        <div class="space-y-3">
          <div
            class="mx-auto w-12 h-12 rounded-full bg-white shadow-sm ring-1 ring-slate-100 flex items-center justify-center group-hover:scale-110 transition-transform"
          >
            <!-- Illustration Icon changes based on Tab -->
            <svg
              id="dropIcon"
              class="w-6 h-6 text-iruka-blue"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
              ></path></svg
            >
          </div>

          <div>
            <h3 id="dropTitle" class="text-sm font-black text-slate-900">
              Kéo thả file ZIP vào đây
            </h3>
            <p id="dropHint" class="text-[11px] font-bold text-slate-400 mt-1">
              hoặc click để chọn từ máy tính
            </p>
          </div>
        </div>

        <button
          type="button"
          id="triggerInputBtn"
          class="hidden px-6 py-2 rounded-lg bg-white border border-slate-200 text-slate-700 font-bold text-xs hover:border-blue-400 hover:text-blue-600 shadow-sm transition-all active:scale-95"
        >
          Chọn file
        </button>

        <!-- Live Checklist -->
        <div
          class="w-full max-w-sm mt-2 bg-white rounded-lg border border-slate-100 p-3 grid grid-cols-2 gap-3 text-left shadow-sm"
        >
          <div
            id="liveCheckIndex"
            class="flex items-center gap-2 text-[11px] font-bold text-slate-400 transition-colors"
          >
            <svg
              class="w-4 h-4 shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg
            >
            <span>index.html</span>
          </div>
          <div
            id="liveCheckManifest"
            class="flex items-center gap-2 text-[11px] font-bold text-slate-400 transition-colors"
          >
            <svg
              class="w-4 h-4 shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg
            >
            <span>manifest.json</span>
          </div>
          <div
            id="liveCheckId"
            class="flex items-center gap-2 text-[11px] font-bold text-slate-400 transition-colors"
          >
            <svg
              class="w-4 h-4 shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg
            >
            <span>Game ID chuẩn</span>
          </div>
          <div
            id="liveCheckSize"
            class="flex items-center gap-2 text-[11px] font-bold text-slate-400 transition-colors"
          >
            <svg
              class="w-4 h-4 shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg
            >
            <span>Size &lt; 10MB</span>
          </div>
        </div>

        <!-- Hidden Inputs -->
        <input type="file" id="zipInput" accept=".zip" class="hidden" />
        <input type="file" id="folderInput" multiple class="hidden" />
        <input type="file" id="fileInput" multiple class="hidden" />
      </div>
    </div>
  </div>

  <!-- Section 2: Game Meta & Thumbnails -->
  <div
    id="validationCard"
    class="bg-white rounded-[24px] border border-slate-200 shadow-sm overflow-hidden shrink-0 hidden"
  >
    <div class="p-6">
      <h3
        class="text-sm font-black text-slate-900 uppercase mb-4 flex items-center justify-between"
      >
        Thông tin Game
        <button
          id="toggleEdit"
          class="text-[10px] font-bold text-slate-400 hover:text-indigo-600 transition-colors flex items-center gap-1"
        >
          <svg
            class="w-3 h-3"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
            ></path></svg
          >
          Chỉnh sửa Manifest
        </button>
      </h3>

      <!-- Content -->
      <div class="grid gap-6">
        <!-- Info Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-100">
            <label
              class="block text-[9px] font-black text-slate-400 uppercase mb-1"
              >Game ID</label
            >
            <div
              id="metaId"
              class="text-xs font-bold text-slate-800 font-mono break-all"
            >
              Checking...
            </div>
          </div>
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-100">
            <label
              class="block text-[9px] font-black text-slate-400 uppercase mb-1"
              >Version</label
            >
            <div
              id="metaVersion"
              class="text-xs font-bold text-slate-800 font-mono"
            >
              Checking...
            </div>
          </div>
          <div
            class="p-3 rounded-xl bg-slate-50 border border-slate-100 sm:col-span-2"
          >
            <label
              class="block text-[9px] font-black text-slate-400 uppercase mb-1"
              >Tên hiển thị</label
            >
            <div id="metaTitle" class="text-sm font-bold text-slate-800">
              Checking...
            </div>
          </div>
        </div>

        <!-- Hidden JSON Editor -->
        <div
          id="manualEditor"
          class="hidden p-4 bg-slate-50 rounded-xl border border-slate-200"
        >
          <label class="block text-xs font-bold text-slate-500 mb-2"
            >Manifest JSON</label
          >
          <textarea
            id="jsonEditor"
            class="w-full h-32 text-xs font-mono bg-slate-800 text-green-400 p-3 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500"
            spellcheck="false"></textarea>
          <div class="flex justify-end gap-2 mt-3">
            <button
              id="saveJson"
              class="text-xs font-bold bg-indigo-600 text-white px-3 py-1.5 rounded-lg hover:bg-indigo-700 shadow-sm"
              >Áp dụng</button
            >
          </div>
        </div>

        <!-- Thumbnails -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <!-- Desktop -->
          <div
            class="p-4 rounded-xl border border-slate-100 flex items-start gap-4 hover:border-slate-200 transition-colors"
          >
            <div
              id="thumbDesktopPreview"
              class="w-20 h-14 rounded-lg bg-slate-100 border border-slate-200 flex items-center justify-center bg-cover bg-center shrink-0 cursor-pointer hover:opacity-80 transition-opacity relative group"
            >
              <span class="text-[9px] font-bold text-slate-400">308x211</span>
              <div
                class="absolute inset-0 bg-black/10 hidden group-hover:flex items-center justify-center rounded-lg"
              >
                <svg
                  class="w-4 h-4 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                  ></path></svg
                >
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between mb-1">
                <span class="text-xs font-black text-slate-700"
                  >Desktop Thumbnail</span
                >
                <span id="checkDesktop" class="hidden text-emerald-500"
                  ><svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    ><path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"></path></svg
                  ></span
                >
              </div>
              <button
                id="btnSelectThumbDesktop"
                class="text-[10px] font-bold text-indigo-600 hover:text-indigo-700 hover:underline"
                >Upload ảnh...</button
              >
              <p
                id="errTimeDesktop"
                class="text-[10px] text-red-500 font-bold mt-1 hidden"
              >
              </p>
              <input
                type="file"
                id="thumbInputDesktop"
                accept="image/png, image/jpeg, image/webp"
                class="hidden"
              />
            </div>
          </div>

          <!-- Mobile -->
          <div
            class="p-4 rounded-xl border border-slate-100 flex items-start gap-4 hover:border-slate-200 transition-colors"
          >
            <div
              id="thumbMobilePreview"
              class="w-20 h-10 rounded-lg bg-slate-100 border border-slate-200 flex items-center justify-center bg-cover bg-center shrink-0 cursor-pointer hover:opacity-80 transition-opacity relative group"
            >
              <span class="text-[9px] font-bold text-slate-400">343x170</span>
              <div
                class="absolute inset-0 bg-black/10 hidden group-hover:flex items-center justify-center rounded-lg"
              >
                <svg
                  class="w-4 h-4 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                  ></path></svg
                >
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between mb-1">
                <span class="text-xs font-black text-slate-700"
                  >Mobile Thumbnail</span
                >
                <span id="checkMobile" class="hidden text-emerald-500"
                  ><svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    ><path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"></path></svg
                  ></span
                >
              </div>
              <button
                id="btnSelectThumbMobile"
                class="text-[10px] font-bold text-indigo-600 hover:text-indigo-700 hover:underline"
                >Upload ảnh...</button
              >
              <p
                id="errThumbMobile"
                class="text-[10px] text-red-500 font-bold mt-1 hidden"
              >
              </p>
              <input
                type="file"
                id="thumbInputMobile"
                accept="image/png, image/jpeg, image/webp"
                class="hidden"
              />
            </div>
          </div>
        </div>

        <!-- General Error Box -->
        <div
          id="validationErrorBox"
          class="hidden mt-6 p-3 bg-red-50 border border-red-100 rounded-xl flex items-center gap-2"
        >
          <svg
            class="w-4 h-4 text-red-500 shrink-0 mt-0.5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg
          >
          <p id="validationErrorMsg" class="text-xs font-bold text-red-600"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Section 3: Primary Interaction (Sticky Bottom) -->
  <div
    class="mt-auto pt-4 sticky bottom-0 bg-linear-to-t from-slate-50 to-transparent pb-4 z-20"
  >
    <button
      id="submitBtn"
      disabled
      class="w-full py-4 rounded-xl bg-iruka-blue text-white font-black text-base shadow-xl shadow-blue-500/20 hover:bg-blue-600 hover:translate-y-[-2px] transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none flex items-center justify-center gap-2"
    >
      <span>Đăng bản Build</span>
      <svg
        id="btnSpinner"
        class="hidden w-5 h-5 animate-spin"
        fill="none"
        viewBox="0 0 24 24"
        ><circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"></circle><path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path></svg
      >
    </button>
  </div>

  <!-- Confirmation Modal -->
  <div
    id="confirmModal"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden backdrop-blur-sm"
  >
    <div
      class="bg-white rounded-xl shadow-2xl p-6 w-96 max-w-[90%] transform transition-all scale-100"
    >
      <h3 class="text-lg font-bold text-slate-800 mb-2">
        Chú ý kích thước ảnh
      </h3>
      <p class="text-sm text-slate-600 mb-6">
        Ảnh thumbnail không đúng kích thước chuẩn (Desktop: 308x211, Mobile:
        343x170).<br /><br />
        Việc này có thể ảnh hưởng đến hiển thị trên Store.<br />
        Bạn có chắc chắn muốn tiếp tục?
      </p>
      <div class="flex justify-end gap-3">
        <button
          type="button"
          id="btnModalCancel"
          class="px-4 py-2 rounded-lg bg-slate-100 text-slate-700 font-bold text-xs hover:bg-slate-200 transition-colors"
        >
          Kiểm tra lại
        </button>
        <button
          type="button"
          id="btnModalConfirm"
          class="px-4 py-2 rounded-lg bg-iruka-blue text-white font-bold text-xs hover:bg-blue-600 transition-colors shadow-lg shadow-blue-500/30"
        >
          Vẫn tiếp tục
        </button>
      </div>
    </div>
  </div>

  <!-- Progress Overlay -->
  <div
    id="progressOverlay"
    class="fixed inset-0 z-50 bg-slate-900/60 backdrop-blur-sm items-center justify-center"
    style="display: none;"
  >
    <div
      class="bg-white rounded-[32px] p-8 w-[320px] text-center shadow-2xl animate-fade-in-up"
    >
      <div class="w-20 h-20 mx-auto mb-6 relative">
        <svg class="w-full h-full transform -rotate-90"
          ><circle
            cx="40"
            cy="40"
            r="36"
            stroke="#f1f5f9"
            stroke-width="6"
            fill="none"></circle><circle
            id="progCircle"
            cx="40"
            cy="40"
            r="36"
            stroke="#2b9bf6"
            stroke-width="6"
            fill="none"
            stroke-dasharray="226"
            stroke-dashoffset="226"
            class="transition-all duration-300"></circle></svg
        >
        <div
          class="absolute inset-0 flex items-center justify-center font-black text-xl text-slate-800"
          id="progText"
        >
          0%
        </div>
      </div>
      <h3 class="font-black text-slate-900 mb-1">Đang tải lên</h3>
      <p
        class="text-xs font-bold text-slate-400 uppercase tracking-wider"
        id="progLabel"
      >
        Khởi tạo...
      </p>
    </div>
  </div>
</div>

<script>
  // Type definitions
  interface FileItem {
    file: File;
    path: string;
    size: number;
  }

  interface ManifestData {
    id?: string;
    version?: string;
    title?: string;
    runtime?: string;
    [key: string]: any;
  }

  type UploadMode = "zip" | "folder" | "file";
  type CheckStatus = "pending" | "success" | "error";

  // Elements with proper typing
  const tabs = {
    zip: document.getElementById("tabZip") as HTMLButtonElement | null,
    folder: document.getElementById("tabFolder") as HTMLButtonElement | null,
    file: document.getElementById("tabFile") as HTMLButtonElement | null,
  };

  const inputs = {
    zip: document.getElementById("zipInput") as HTMLInputElement | null,
    folder: document.getElementById("folderInput") as HTMLInputElement | null,
    file: document.getElementById("fileInput") as HTMLInputElement | null,
  };

  const dropZone = document.getElementById("dropZone") as HTMLDivElement | null;
  const dropTitle = document.getElementById(
    "dropTitle"
  ) as HTMLHeadingElement | null;
  const dropHint = document.getElementById(
    "dropHint"
  ) as HTMLParagraphElement | null;
  const triggerBtn = document.getElementById(
    "triggerInputBtn"
  ) as HTMLButtonElement | null;
  const dropIcon = document.getElementById("dropIcon") as SVGElement | null;

  const validationCard = document.getElementById(
    "validationCard"
  ) as HTMLDivElement | null;
  const metaId = document.getElementById("metaId") as HTMLDivElement | null;
  const metaVersion = document.getElementById(
    "metaVersion"
  ) as HTMLDivElement | null;
  const metaTitle = document.getElementById(
    "metaTitle"
  ) as HTMLDivElement | null;
  const fileNameDisplay = document.getElementById(
    "fileNameDisplay"
  ) as HTMLParagraphElement | null;
  const resetBtn = document.getElementById(
    "resetBtn"
  ) as HTMLButtonElement | null;
  const submitBtn = document.getElementById(
    "submitBtn"
  ) as HTMLButtonElement | null;
  const btnSpinner = document.getElementById("btnSpinner") as SVGElement | null;

  const manualEditor = document.getElementById(
    "manualEditor"
  ) as HTMLDivElement | null;
  const toggleEdit = document.getElementById(
    "toggleEdit"
  ) as HTMLButtonElement | null;
  const jsonEditor = document.getElementById(
    "jsonEditor"
  ) as HTMLTextAreaElement | null;
  const saveJson = document.getElementById(
    "saveJson"
  ) as HTMLButtonElement | null;

  // Thumbnail Elements
  const thumbInputDesktop = document.getElementById(
    "thumbInputDesktop"
  ) as HTMLInputElement | null;
  const thumbInputMobile = document.getElementById(
    "thumbInputMobile"
  ) as HTMLInputElement | null;
  const btnSelectThumbDesktop = document.getElementById(
    "btnSelectThumbDesktop"
  ) as HTMLButtonElement | null;
  const btnSelectThumbMobile = document.getElementById(
    "btnSelectThumbMobile"
  ) as HTMLButtonElement | null;
  const thumbDesktopPreview = document.getElementById(
    "thumbDesktopPreview"
  ) as HTMLDivElement | null;
  const thumbMobilePreview = document.getElementById(
    "thumbMobilePreview"
  ) as HTMLDivElement | null;
  const errThumbDesktop = document.getElementById(
    "errTimeDesktop"
  ) as HTMLParagraphElement | null;
  const errThumbMobile = document.getElementById(
    "errThumbMobile"
  ) as HTMLParagraphElement | null;

  const validationErrorBox = document.getElementById(
    "validationErrorBox"
  ) as HTMLDivElement | null;
  const validationErrorMsg = document.getElementById(
    "validationErrorMsg"
  ) as HTMLParagraphElement | null;

  // Modal Elements
  const confirmModal = document.getElementById(
    "confirmModal"
  ) as HTMLDivElement | null;
  const btnModalCancel = document.getElementById(
    "btnModalCancel"
  ) as HTMLButtonElement | null;
  const btnModalConfirm = document.getElementById(
    "btnModalConfirm"
  ) as HTMLButtonElement | null;

  // State with proper typing
  let currentMode: UploadMode = "zip";
  let fileItems: FileItem[] = [];
  let thumbnailDesktopFile: File | null = null;
  let thumbnailMobileFile: File | null = null;
  let isDesktopThumbValidSize = false;
  let isMobileThumbValidSize = false;
  let manifestData: ManifestData | null = null;
  let isUploading = false;

  // -- UI Helpers --
  function setMode(mode: UploadMode): void {
    currentMode = mode;
    // Update Tabs
    Object.keys(tabs).forEach((k) => {
      const tabKey = k as keyof typeof tabs;
      const btn = tabs[tabKey];
      if (btn) {
        if (k === mode) {
          btn.className =
            "px-4 py-1.5 rounded-md text-xs font-bold text-slate-700 shadow-sm bg-white transition-all";
        } else {
          btn.className =
            "px-4 py-1.5 rounded-md text-xs font-bold text-slate-500 hover:text-slate-700 transition-all";
        }
      }
    });

    // Update Dropzone Text
    if (mode === "zip") {
      if (dropTitle) dropTitle.textContent = "Kéo thả file ZIP vào đây";
      if (dropHint) dropHint.textContent = "hoặc click để chọn từ máy tính";
    } else if (mode === "folder") {
      if (dropTitle) dropTitle.textContent = "Kéo thả Thư mục build vào đây";
      if (dropHint) dropHint.textContent = "hoặc click để chọn từ máy tính";
    } else {
      if (dropTitle) dropTitle.textContent = "Kéo thả các file lẻ vào đây";
      if (dropHint) dropHint.textContent = "hoặc click để chọn từ máy tính";
    }

    // Reset state on tab switch
    resetState();
  }

  function resetState(): void {
    fileItems = [];
    manifestData = null;
    if (validationCard) validationCard.classList.add("hidden");

    // Reset Dropzone UI
    if (dropZone) {
      dropZone.classList.remove("hidden");
      // Reset classes
      dropZone.className =
        "relative border-2 border-dashed border-slate-200 rounded-xl bg-slate-50/50 hover:bg-white hover:border-iruka-blue transition-all duration-300 group cursor-pointer flex flex-col items-center justify-center text-center p-8 gap-6";
    }
    // Re-trigger mode set to restore default text/icons
    setMode(currentMode);

    if (submitBtn) submitBtn.disabled = true;
    if (inputs.zip) inputs.zip.value = "";
    if (inputs.folder) inputs.folder.value = "";
    if (inputs.file) inputs.file.value = "";

    // Reset Checks
    setCheckStatus("liveCheckIndex", "pending", "index.html");
    setCheckStatus("liveCheckManifest", "pending", "manifest.json");
    setCheckStatus("liveCheckId", "pending", "Game ID chuẩn");
    setCheckStatus("liveCheckSize", "pending", "Size < 10MB");

    // Reset Thumbnails
    resetThumbnail("desktop");
    resetThumbnail("mobile");
  }

  function resetThumbnail(type: "desktop" | "mobile") {
    if (type === "desktop") {
      thumbnailDesktopFile = null;
      if (thumbInputDesktop) thumbInputDesktop.value = "";
      if (thumbDesktopPreview) {
        thumbDesktopPreview.style.backgroundImage = "none";
        thumbDesktopPreview.innerHTML =
          '<span class="text-[9px] font-bold text-slate-400">308x211</span>';
      }
      if (errThumbDesktop) {
        errThumbDesktop.textContent = "";
        errThumbDesktop.classList.add("hidden");
      }
      isDesktopThumbValidSize = true; // Reset assumption
    } else {
      thumbnailMobileFile = null;
      if (thumbInputMobile) thumbInputMobile.value = "";
      if (thumbMobilePreview) {
        thumbMobilePreview.style.backgroundImage = "none";
        thumbMobilePreview.innerHTML =
          '<span class="text-[9px] font-bold text-slate-400">343x170</span>';
      }
      if (errThumbMobile) {
        errThumbMobile.textContent = "";
        errThumbMobile.classList.add("hidden");
      }
      isMobileThumbValidSize = true; // Reset assumption
    }
  }

  function setCheckStatus(
    id: string,
    status: CheckStatus,
    text?: string
  ): void {
    // We target the new "liveCheck" IDs
    // Map old IDs to new IDs if necessary, or assume code passes correct new ID
    // Actually, let's just make the caller pass the correct ID ("liveCheckIndex" etc)
    const row = document.getElementById(id);
    if (!row) return;

    // Structure: div > svg + span
    const icon = row.querySelector("svg");
    const label = row.querySelector("span");

    if (status === "success") {
      if (icon) {
        icon.innerHTML =
          '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>';
        icon.classList.remove("text-slate-400", "text-red-500");
        icon.classList.add("text-emerald-500");
      }
      row.classList.remove("text-slate-400", "text-red-500");
      row.classList.add("text-emerald-600");
      if (text && label) label.textContent = text;
    } else if (status === "error") {
      if (icon) {
        icon.innerHTML =
          '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>';
        icon.classList.remove("text-slate-400", "text-emerald-500");
        icon.classList.add("text-red-500");
      }
      row.classList.remove("text-slate-400", "text-emerald-600");
      row.classList.add("text-red-500");
      if (text && label) label.textContent = text;
    } else {
      // Pending / Reset
      if (icon) {
        icon.innerHTML =
          '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'; // Default check circle
        icon.classList.remove("text-emerald-500", "text-red-500");
        icon.classList.add("text-slate-400");
      }
      row.classList.remove("text-emerald-600", "text-red-500");
      row.classList.add("text-slate-400");
      if (text && label) label.textContent = text;
    }
  }

  // Set webkitdirectory attribute for folder input
  if (inputs.folder) {
    (inputs.folder as any).webkitdirectory = true;
  }

  // -- Interaction Handlers --
  if (tabs.zip) tabs.zip.onclick = () => setMode("zip");
  if (tabs.folder) tabs.folder.onclick = () => setMode("folder");
  if (tabs.file) tabs.file.onclick = () => setMode("file");
  if (triggerBtn)
    triggerBtn.onclick = () => {
      const input = inputs[currentMode];
      if (input) input.click();
    };
  if (resetBtn) resetBtn.onclick = resetState;

  if (toggleEdit) {
    toggleEdit.onclick = () => {
      if (manualEditor) {
        const isHidden = manualEditor.style.display === "none";
        manualEditor.style.display = isHidden ? "block" : "none";
        // Pre-fill
        if (manifestData && jsonEditor && !jsonEditor.value && isHidden) {
          jsonEditor.value = JSON.stringify(manifestData, null, 2);
        }
      }
    };
  }

  if (saveJson) {
    saveJson.onclick = () => {
      if (!jsonEditor) return;
      try {
        const newData: ManifestData = JSON.parse(jsonEditor.value);
        manifestData = newData;
        updateValidationUI();
        if (manualEditor) manualEditor.style.display = "none";
      } catch (e) {
        alert("JSON không hợp lệ");
      }
    };
  }

  // Drag & Drop
  if (dropZone) {
    dropZone.ondragover = (e: DragEvent) => {
      e.preventDefault();
      dropZone.classList.add("border-iruka-blue", "bg-blue-50");
    };
    dropZone.ondragleave = (e: DragEvent) => {
      e.preventDefault();
      dropZone.classList.remove("border-iruka-blue", "bg-blue-50");
    };
    dropZone.ondrop = (e: DragEvent) => {
      e.preventDefault();
      dropZone.classList.remove("border-iruka-blue", "bg-blue-50");
      if (e.dataTransfer) {
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
      }
    };
  }

  // File Inputs
  if (inputs.zip) {
    inputs.zip.onchange = (e: Event) => {
      const target = e.target as HTMLInputElement;
      if (target && target.files) {
        handleFiles(Array.from(target.files));
      }
    };
  }
  if (inputs.folder) {
    inputs.folder.onchange = (e: Event) => {
      const target = e.target as HTMLInputElement;
      if (target && target.files) {
        handleFiles(Array.from(target.files));
      }
    };
  }
  if (inputs.file) {
    inputs.file.onchange = (e: Event) => {
      const target = e.target as HTMLInputElement;
      if (target && target.files) {
        handleFiles(Array.from(target.files));
      }
    };
  }

  // Thumbnail Logic
  function setupThumbnail(
    input: HTMLInputElement | null,
    btn: HTMLButtonElement | null,
    preview: HTMLDivElement | null,
    errDisplay: HTMLParagraphElement | null,
    targetW: number,
    targetH: number,
    type: "desktop" | "mobile"
  ) {
    if (btn && input) {
      btn.onclick = () => input.click();
      preview?.addEventListener("click", () => input.click());
    }

    if (input) {
      input.onchange = (e: Event) => {
        const target = e.target as HTMLInputElement;
        if (target && target.files && target.files[0]) {
          const file = target.files[0];

          if (file.size > 2 * 1024 * 1024) {
            alert("Ảnh quá lớn (Max 2MB)");
            input.value = "";
            if (type === "desktop") {
              thumbnailDesktopFile = null;
              isDesktopThumbValidSize = false;
            }
            if (type === "mobile") {
              thumbnailMobileFile = null;
              isMobileThumbValidSize = false;
            }
            if (preview) {
              preview.style.backgroundImage = "none";
              preview.innerHTML = `<span class="text-[9px] font-bold text-red-400">Quá lớn</span>`;
            }
            if (errDisplay) {
              errDisplay.textContent = "Ảnh quá lớn (>2MB)";
              errDisplay.classList.remove("hidden");
              errDisplay.classList.remove("text-orange-500");
              errDisplay.classList.add("text-red-500");
            }
            updateValidationUI();
            return;
          }

          const img = new Image();
          const objectUrl = URL.createObjectURL(file);
          img.onload = () => {
            let isValid = true;
            if (img.width !== targetW || img.height !== targetH) {
              isValid = false;
              if (errDisplay) {
                errDisplay.textContent = `Chú ý: Cần ${targetW}x${targetH}`;
                errDisplay.classList.remove("hidden");
                errDisplay.classList.remove("text-red-500");
                errDisplay.classList.add("text-orange-500");
              }
              // Non-blocking warning
              if (preview) {
                preview.style.backgroundImage = `url('${objectUrl}')`;
                preview.innerHTML = `<span class="absolute bottom-0 left-0 right-0 bg-orange-500 text-white text-[9px] font-bold text-center">Sai kích thước</span>`;
              }
            } else {
              if (errDisplay) errDisplay.classList.add("hidden");
              if (preview) {
                preview.style.backgroundImage = `url('${objectUrl}')`;
                preview.innerHTML = "";
              }
            }

            if (type === "desktop") {
              thumbnailDesktopFile = file;
              isDesktopThumbValidSize = isValid;
            } else {
              thumbnailMobileFile = file;
              isMobileThumbValidSize = isValid;
            }

            URL.revokeObjectURL(objectUrl);
            updateValidationUI();
          };
          img.src = objectUrl;
        }
      };
    }
  }

  // Init Thumbnails
  setupThumbnail(
    thumbInputDesktop,
    btnSelectThumbDesktop,
    thumbDesktopPreview,
    errThumbDesktop,
    308,
    211,
    "desktop"
  );
  setupThumbnail(
    thumbInputMobile,
    btnSelectThumbMobile,
    thumbMobilePreview,
    errThumbMobile,
    343,
    170,
    "mobile"
  );

  async function handleFiles(files: File[]): Promise<void> {
    if (!files.length) return;

    // Logic switching based on mode
    if (currentMode === "zip") {
      if (files.length > 1 || !files[0].name.toLowerCase().endsWith(".zip")) {
        alert("Vui lòng chỉ chọn 1 file ZIP");
        return;
      }
      fileItems = [
        { file: files[0], path: files[0].name, size: files[0].size },
      ];
    } else {
      // Folder/File logic
      fileItems = files.map((f: File) => ({
        file: f,
        path: (f as any).webkitRelativePath || f.name,
        size: f.size,
      }));
    }

    // UPDATE Dropzone UI (Don't Hide)
    if (dropZone) {
      // Make it look "Active/Compact" or just indicate file presence
      dropZone.className =
        "relative border-2 border-slate-200 rounded-xl bg-emerald-50/30 transition-all duration-300 flex flex-col items-center justify-center text-center p-4 gap-4";

      if (dropTitle)
        dropTitle.textContent =
          currentMode === "zip"
            ? files[0].name
            : `${files.length} files selected`;
      if (dropHint) dropHint.textContent = "Checking...";
      if (dropIcon)
        dropIcon.innerHTML =
          '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>';
    }

    // Build summary info
    const totalSize = fileItems.reduce(
      (acc: number, f: FileItem) => acc + f.size,
      0
    );
    const sizeMB = (totalSize / (1024 * 1024)).toFixed(1);

    // Check Size
    if (totalSize < 10 * 1024 * 1024) {
      setCheckStatus("liveCheckSize", "success", `Size: ${sizeMB} MB`);
    } else {
      setCheckStatus("liveCheckSize", "error", `Size: ${sizeMB} MB (>10MB)`);
    }

    // Check Index & Manifest
    let hasIndex = false;
    let manifestFile: FileItem | undefined = undefined;

    if (currentMode === "zip") {
      // Mock check for zip
      setCheckStatus("liveCheckIndex", "pending", "Check server (ZIP)");
      setCheckStatus("liveCheckManifest", "pending", "Check server (ZIP)");

      // Allow user to manually input manifest to enable button
      if (metaId) metaId.textContent = "---";
      if (metaVersion) metaVersion.textContent = "---";
      if (metaTitle) metaTitle.textContent = "---";
      if (manualEditor) manualEditor.style.display = "block";
      if (jsonEditor) {
        jsonEditor.value =
          '{\n  "id": "com.iruka.game-name",\n  "version": "1.0.0",\n  "title": "My Game",\n  "runtime": "iframe-html"\n}';
      }
    } else {
      // Folder/File logic
      hasIndex = fileItems.some((f: FileItem) => f.path.endsWith("index.html"));
      manifestFile = fileItems.find((f: FileItem) =>
        f.path.endsWith("manifest.json")
      );

      if (hasIndex) setCheckStatus("liveCheckIndex", "success", "index.html");
      else setCheckStatus("liveCheckIndex", "error", "Missing index.html");

      if (manifestFile) {
        try {
          const text = await manifestFile.file.text();
          manifestData = JSON.parse(text);
          setCheckStatus("liveCheckManifest", "success", "manifest.json");
          updateValidationUI();
        } catch (e) {
          setCheckStatus("liveCheckManifest", "error", "JSON Error");
        }
      } else {
        setCheckStatus("liveCheckManifest", "error", "Missing manifest");
        if (manualEditor) manualEditor.style.display = "block";
        if (jsonEditor) {
          jsonEditor.value =
            '{\n  "id": "com.iruka.game-name",\n  "version": "1.0.0",\n  "title": "My Game",\n  "runtime": "iframe-html"\n}';
        }
      }
    }

    // Show Validation Card (Phase 2)
    if (validationCard) validationCard.classList.remove("hidden");

    updateValidationUI();
  }

  function updateValidationUI(): void {
    if (manifestData) {
      if (metaId) metaId.textContent = manifestData.id || "Missing";
      if (metaVersion)
        metaVersion.textContent = manifestData.version || "Missing";
      if (metaTitle) metaTitle.textContent = manifestData.title || "Missing";

      // Validate Data
      let errors: string[] = [];
      const validId = manifestData.id?.startsWith("com.iruka.");
      if (!validId) {
        errors.push("ID sai format");
        setCheckStatus("liveCheckId", "error", "ID sai format");
      } else {
        setCheckStatus("liveCheckId", "success", "ID Hợp lệ");
      }

      if (!manifestData.version) errors.push("Thiếu version");

      if (errors.length > 0) {
        if (validationErrorBox) validationErrorBox.classList.remove("hidden");
        if (validationErrorMsg)
          validationErrorMsg.textContent = errors.join(", ");
        if (submitBtn) submitBtn.disabled = true;
      } else {
        // Manifest OK
        // Now Check Thumbnails
        let thumbErrors = [];
        if (!thumbnailDesktopFile) thumbErrors.push("Desktop");
        if (!thumbnailMobileFile) thumbErrors.push("Mobile");

        if (thumbErrors.length > 0) {
          if (validationErrorBox) validationErrorBox.classList.remove("hidden");
          if (validationErrorMsg)
            validationErrorMsg.textContent =
              "Thiếu ảnh: " + thumbErrors.join(", ");
          if (submitBtn) submitBtn.disabled = true;
        } else {
          if (validationErrorBox) validationErrorBox.classList.add("hidden");
          if (submitBtn) submitBtn.disabled = false;
        }
      }
    } else {
      // No Manifest Data yet
      if (submitBtn) submitBtn.disabled = true;
      setCheckStatus("liveCheckId", "pending", "Chờ manifest...");
    }
  }

  // Modal Logic
  let pendingSubmission = false;
  if (btnModalCancel) {
    btnModalCancel.onclick = () => {
      if (confirmModal) confirmModal.classList.add("hidden");
      pendingSubmission = false;
    };
  }
  if (btnModalConfirm) {
    btnModalConfirm.onclick = () => {
      if (confirmModal) confirmModal.classList.add("hidden");
      submitData(); // Really submit
    };
  }

  if (submitBtn) {
    submitBtn.onclick = async () => {
      if (submitBtn.disabled) return;
      // Check thumbnails existence (Blocking)
      if (!thumbnailDesktopFile || !thumbnailMobileFile) {
        alert("Vui lòng chọn đủ 2 ảnh thumbnail!");
        return;
      }

      // Check thumbnails dimensions (Warning)
      if (!isDesktopThumbValidSize || !isMobileThumbValidSize) {
        if (confirmModal) confirmModal.classList.remove("hidden");
        return;
      }

      await submitData();
    };
  }

  async function submitData() {
    if (isUploading) return;
    isUploading = true;

    // UI Loading
    const progressOverlay = document.getElementById(
      "progressOverlay"
    ) as HTMLDivElement | null;
    const progCircle = document.getElementById(
      "progCircle"
    ) as SVGCircleElement | null;
    const progText = document.getElementById(
      "progText"
    ) as HTMLDivElement | null;
    const progLabel = document.getElementById(
      "progLabel"
    ) as HTMLParagraphElement | null;

    if (progressOverlay) progressOverlay.style.display = "flex";

    const formData = new FormData();
    // If manual manifest provided, override
    if (manifestData) {
      formData.append("manifest", JSON.stringify(manifestData));
    }

    if (currentMode === "zip") {
      formData.append("zipFile", fileItems[0].file);
    } else {
      fileItems.forEach((f: FileItem) => formData.append("files", f.file));
    }

    // Append Thumbnails
    if (thumbnailDesktopFile)
      formData.append("thumbnailDesktop", thumbnailDesktopFile);
    if (thumbnailMobileFile)
      formData.append("thumbnailMobile", thumbnailMobileFile);

    try {
      // Simulate Progress
      let p = 0;
      const intv = setInterval(() => {
        p += 5;
        if (p > 90) clearInterval(intv);
        const offset = 226 - (226 * p) / 100;
        if (progCircle) progCircle.style.strokeDashoffset = offset.toString();
        if (progText) progText.textContent = p + "%";
        if (p > 50 && progLabel) progLabel.textContent = "Đang xác thực...";
      }, 100);

      const endpoint =
        currentMode === "zip" ? "/api/upload-zip" : "/api/upload";
      const res = await fetch(endpoint, { method: "POST", body: formData });

      clearInterval(intv);

      if (res.ok) {
        if (progCircle) progCircle.style.strokeDashoffset = "0";
        if (progText) progText.textContent = "100%";
        if (progLabel) progLabel.textContent = "Thành công!";
        setTimeout(() => {
          window.location.href = "/";
        }, 800);
      } else {
        throw new Error("Upload failed");
      }
    } catch (e) {
      alert("Có lỗi xảy ra, vui lòng thử lại");
      if (progressOverlay) progressOverlay.style.display = "none";
      isUploading = false;
    }
  }
</script>

<style>
  .animate-fade-in-up {
    animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
