---
interface Props {
  gameId: string;
  gameTitle: string;
  currentVersion: string;
  manifest: any;
}

const { gameId, gameTitle, currentVersion, manifest } = Astro.props;
const bucketName = import.meta.env.GCLOUD_BUCKET_NAME || 'iruka-edu-mini-game';
---

<div class="card overflow-hidden animate-fade-in">
  <div class="p-8">
    <div class="flex items-center gap-4 mb-6">
      <div class="w-14 h-14 rounded-lg bg-emerald-100 flex items-center justify-center">
        <svg class="w-7 h-7 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
        </svg>
      </div>
      <div class="flex-1">
        <h2 class="text-xl font-bold text-slate-900">C·∫≠p nh·∫≠t phi√™n b·∫£n m·ªõi</h2>
        <p class="text-slate-500 text-sm">T·∫£i l√™n phi√™n b·∫£n m·ªõi cho game: <span class="font-medium">{gameTitle}</span></p>
        <p class="text-slate-400 text-xs font-mono mt-1">{gameId}</p>
      </div>
    </div>

    <!-- Current Version Info -->
    <div class="mb-6 p-4 rounded-lg bg-slate-50 border border-slate-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-slate-700">Phi√™n b·∫£n hi·ªán t·∫°i</p>
          <p class="font-mono text-lg text-slate-900">v{currentVersion}</p>
        </div>
        <div class="text-right">
          <p class="text-xs text-slate-500">Phi√™n b·∫£n m·ªõi ph·∫£i l·ªõn h∆°n phi√™n b·∫£n hi·ªán t·∫°i</p>
          <p class="text-xs text-amber-600" id="nextVersionExample">V√≠ d·ª•: v{currentVersion.split('.').map((part, i) => i === 2 ? (parseInt(part) + 1).toString() : part).join('.')}</p>
        </div>
      </div>
    </div>

    <!-- Version Input -->
    <div class="mb-6">
      <label class="block text-sm font-medium text-slate-700 mb-2">Phi√™n b·∫£n m·ªõi *</label>
      <input
        type="text"
        id="newVersion"
        class="w-full bg-white border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent font-mono"
        placeholder={currentVersion.split('.').map((part, i) => i === 2 ? (parseInt(part) + 1).toString() : part).join('.')}
      />
      <p class="text-xs text-slate-500 mt-1">Theo chu·∫©n Semantic Versioning (x.y.z)</p>
    </div>
    <!-- File Upload Section -->
    <div class="mb-6">
      <label class="block text-sm font-medium text-slate-700 mb-3">Ch·ªçn ph∆∞∆°ng th·ª©c t·∫£i l√™n</label>
      
      <div class="grid grid-cols-3 gap-3 mb-4">
        <button type="button" id="selectFilesBtn" class="py-3 px-4 rounded-lg bg-white hover:bg-slate-50 border border-slate-200 hover:border-emerald-300 transition-all flex items-center justify-center gap-2">
          <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <span class="text-slate-700 text-sm font-medium">+ File</span>
        </button>
        <button type="button" id="selectFolderBtn" class="py-3 px-4 rounded-lg bg-white hover:bg-slate-50 border border-slate-200 hover:border-emerald-300 transition-all flex items-center justify-center gap-2">
          <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
          </svg>
          <span class="text-slate-700 text-sm font-medium">+ Th∆∞ m·ª•c</span>
        </button>
        <button type="button" id="selectZipBtn" class="relative py-3 px-4 rounded-lg bg-emerald-50 hover:bg-emerald-100 border border-emerald-200 hover:border-emerald-300 transition-all flex items-center justify-center gap-2">
          <span class="absolute -top-2 -right-2 px-2 py-0.5 rounded-full text-xs font-semibold bg-emerald-600 text-white">Khuy√™n d√πng</span>
          <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 12l2 2 4-4"></path>
          </svg>
          <span class="text-emerald-700 text-sm font-medium">üì¶ ZIP</span>
        </button>
      </div>

      <!-- Hidden file inputs -->
      <input type="file" id="fileInput" multiple class="hidden" />
      <input type="file" id="folderInput" multiple class="hidden" />
      <input type="file" id="zipInput" accept=".zip" class="hidden" />

      <!-- Drop Zone -->
      <div id="dropZone" class="relative border-2 border-dashed border-slate-300 rounded-lg p-8 text-center cursor-pointer hover:border-emerald-400 hover:bg-slate-50 transition-all">
        <svg class="w-12 h-12 text-slate-400 mb-3 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
        </svg>
        <p id="dropZoneText" class="text-slate-600 font-medium">K√©o th·∫£ file build m·ªõi v√†o ƒë√¢y</p>
        <p id="dropZoneHint" class="text-slate-400 text-sm mt-1">Ho·∫∑c s·ª≠ d·ª•ng c√°c n√∫t ph√≠a tr√™n</p>
      </div>
    </div>
    <!-- File List -->
    <div id="fileListContainer" class="hidden mb-6">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <span id="fileCountLabel">0 file ƒë√£ ch·ªçn</span>
        </h3>
        <button type="button" id="clearFilesBtn" class="text-xs text-red-600 hover:text-red-700 px-2 py-1 rounded hover:bg-red-50 transition-colors font-medium">
          X√≥a t·∫•t c·∫£
        </button>
      </div>
      <div id="fileList" class="max-h-64 overflow-y-auto space-y-2 pr-2"></div>
    </div>

    <!-- Status Message -->
    <div id="statusMessage" class="hidden mb-6 p-4 rounded-lg text-sm font-medium"></div>

    <!-- Progress Bar -->
    <div id="progressContainer" class="hidden mb-6">
      <div class="flex justify-between text-sm text-slate-500 mb-2">
        <span id="progressLabel">ƒêang t·∫£i l√™n...</span>
        <span id="progressPercent">0%</span>
      </div>
      <div class="h-2 bg-slate-200 rounded-full overflow-hidden mb-3">
        <div id="progressBar" class="h-full bg-emerald-600 rounded-full transition-all duration-300" style="width: 0%"></div>
      </div>
    </div>

    <!-- Submit Button -->
    <button id="uploadBtn" type="button" disabled class="w-full py-3.5 rounded-lg font-semibold text-white text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-emerald-600 hover:bg-emerald-700 shadow-sm hover:shadow-md">
      <span id="uploadBtnText">Nh·∫≠p phi√™n b·∫£n v√† ch·ªçn file</span>
    </button>
  </div>
</div>
<script define:vars={{ gameId, gameTitle, currentVersion, manifest, bucketName }}>
  // Helper function to get next version
  function getNextVersion(version) {
    const parts = version.split('.');
    const patch = parseInt(parts[2] || '0') + 1;
    return `${parts[0]}.${parts[1]}.${patch}`;
  }

  // State
  let fileItems = [];
  let isZipMode = false;
  let zipFile = null;

  // DOM Elements
  const fileInput = document.getElementById("fileInput");
  const folderInput = document.getElementById("folderInput");
  const zipInput = document.getElementById("zipInput");
  const selectFilesBtn = document.getElementById("selectFilesBtn");
  const selectFolderBtn = document.getElementById("selectFolderBtn");
  const selectZipBtn = document.getElementById("selectZipBtn");
  const dropZone = document.getElementById("dropZone");
  const fileListContainer = document.getElementById("fileListContainer");
  const fileList = document.getElementById("fileList");
  const fileCountLabel = document.getElementById("fileCountLabel");
  const clearFilesBtn = document.getElementById("clearFilesBtn");
  const uploadBtn = document.getElementById("uploadBtn");
  const uploadBtnText = document.getElementById("uploadBtnText");
  const statusMessage = document.getElementById("statusMessage");
  const progressContainer = document.getElementById("progressContainer");
  const progressBar = document.getElementById("progressBar");
  const progressPercent = document.getElementById("progressPercent");
  const progressLabel = document.getElementById("progressLabel");
  const newVersionInput = document.getElementById("newVersion");

  // Utility functions
  function formatFileSize(bytes) {
    if (bytes === 0) return "0 B";
    const k = 1024;
    const sizes = ["B", "KB", "MB", "GB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
  }

  function getFileIcon(fileName) {
    const ext = fileName.split(".").pop()?.toLowerCase();
    if (["html", "htm"].includes(ext || "")) return "üìÑ";
    if (["js", "mjs", "ts"].includes(ext || "")) return "üìú";
    if (["css", "scss", "less"].includes(ext || "")) return "üé®";
    if (["json"].includes(ext || "")) return "üìã";
    if (["png", "jpg", "jpeg", "gif", "svg", "webp"].includes(ext || "")) return "üñºÔ∏è";
    if (["mp3", "wav", "ogg"].includes(ext || "")) return "üîä";
    if (["zip"].includes(ext || "")) return "üì¶";
    return "üìÅ";
  }
  function showStatus(message, type) {
    statusMessage.classList.remove("hidden");
    statusMessage.className = `mb-6 p-4 rounded-lg text-sm font-medium ${
      type === "error"
        ? "bg-red-50 text-red-700 border border-red-200"
        : type === "success"
          ? "bg-emerald-50 text-emerald-700 border border-emerald-200"
          : type === "warning"
            ? "bg-amber-50 text-amber-700 border border-amber-200"
            : "bg-blue-50 text-blue-700 border border-blue-200"
    }`;
    statusMessage.textContent = message;
  }

  function hideStatus() {
    statusMessage.classList.add("hidden");
  }

  function validateVersion() {
    const newVersion = newVersionInput.value.trim();
    if (!newVersion) {
      showStatus("Vui l√≤ng nh·∫≠p phi√™n b·∫£n m·ªõi", "error");
      return false;
    }

    if (!/^\d+\.\d+\.\d+$/.test(newVersion)) {
      showStatus("Phi√™n b·∫£n ph·∫£i theo format x.y.z (v√≠ d·ª•: 1.0.0)", "error");
      return false;
    }

    // Simple version comparison
    const currentParts = currentVersion.split('.').map(Number);
    const newParts = newVersion.split('.').map(Number);
    
    for (let i = 0; i < 3; i++) {
      if (newParts[i] > currentParts[i]) {
        return true;
      } else if (newParts[i] < currentParts[i]) {
        showStatus(`Phi√™n b·∫£n m·ªõi (${newVersion}) ph·∫£i l·ªõn h∆°n phi√™n b·∫£n hi·ªán t·∫°i (${currentVersion})`, "error");
        return false;
      }
    }
    
    showStatus(`Phi√™n b·∫£n m·ªõi (${newVersion}) ph·∫£i l·ªõn h∆°n phi√™n b·∫£n hi·ªán t·∫°i (${currentVersion})`, "error");
    return false;
  }

  function updateUI() {
    const hasFiles = fileItems.length > 0;
    const hasVersion = newVersionInput.value.trim() !== '';
    
    if (hasFiles && hasVersion && validateVersion()) {
      uploadBtn.disabled = false;
      uploadBtnText.textContent = `T·∫£i l√™n phi√™n b·∫£n v${newVersionInput.value.trim()}`;
    } else {
      uploadBtn.disabled = true;
      if (!hasVersion) {
        uploadBtnText.textContent = "Nh·∫≠p phi√™n b·∫£n v√† ch·ªçn file";
      } else if (!hasFiles) {
        uploadBtnText.textContent = "Ch·ªçn file build";
      } else {
        uploadBtnText.textContent = "Ki·ªÉm tra phi√™n b·∫£n";
      }
    }
  }
  function renderFileList() {
    if (fileItems.length === 0) {
      fileListContainer.classList.add("hidden");
      return;
    }

    fileListContainer.classList.remove("hidden");
    
    if (isZipMode) {
      fileCountLabel.textContent = `File ZIP: ${zipFile?.name || 'Unknown'}`;
    } else {
      fileCountLabel.textContent = `${fileItems.length} file ƒë√£ ch·ªçn`;
    }

    fileList.innerHTML = fileItems
      .map((item, index) => `
        <div class="flex items-center justify-between py-2.5 px-4 rounded-lg bg-slate-50 hover:bg-slate-100 transition-colors group" data-index="${index}">
          <div class="flex items-center gap-3 min-w-0 flex-1">
            <span class="text-lg">${getFileIcon(item.name)}</span>
            <div class="min-w-0 flex-1">
              <p class="text-sm text-slate-900 truncate" title="${item.path || item.name}">${item.name}</p>
              <p class="text-xs text-slate-500">${formatFileSize(item.size)}${isZipMode ? ' ‚Ä¢ S·∫Ω ƒë∆∞·ª£c gi·∫£i n√©n' : (item.path ? ` ‚Ä¢ ${item.path}` : "")}</p>
            </div>
          </div>
        </div>
      `)
      .join("");
  }

  async function processFiles(files) {
    // Check total file size before processing
    const totalSize = files.reduce((sum, file) => sum + file.size, 0);
    const totalSizeMB = totalSize / (1024 * 1024);
    
    if (totalSizeMB > 10) {
      showStatus(
        `‚ùå T·ªïng dung l∆∞·ª£ng file qu√° l·ªõn: ${totalSizeMB.toFixed(1)} MB. Gi·ªõi h·∫°n t·ªëi ƒëa l√† 10 MB.`,
        'error'
      );
      return;
    }

    const newItems = files.map((file) => {
      const relativePath = file.webkitRelativePath || "";
      const pathParts = relativePath.split('/');
      
      let folder = "root";
      if (pathParts.length > 1) {
        const cleanPath = pathParts.slice(1).join('/');
        if (cleanPath.includes('/')) {
          folder = cleanPath.split('/').slice(0, -1).join('/');
        }
      }

      return {
        file,
        name: file.name,
        path: relativePath,
        folder,
        type: "file",
        size: file.size,
        status: "pending",
      };
    });

    fileItems = [...fileItems, ...newItems];
    
    // Show size warning if needed
    const currentTotalSize = fileItems.reduce((sum, item) => sum + item.size, 0);
    const currentTotalSizeMB = currentTotalSize / (1024 * 1024);
    
    if (currentTotalSizeMB > 3) {
      showStatus(
        `‚ö†Ô∏è T·ªïng dung l∆∞·ª£ng file: ${currentTotalSizeMB.toFixed(1)} MB (khuy·∫øn ngh·ªã < 3 MB). Game c√≥ th·ªÉ t·∫£i ch·∫≠m tr√™n m·∫°ng y·∫øu.`,
        'warning'
      );
    }
    
    renderFileList();
    updateUI();
  }

  async function processZipFile(file) {
    if (!file.name.toLowerCase().endsWith('.zip')) {
      showStatus('Vui l√≤ng ch·ªçn file ZIP h·ª£p l·ªá', 'error');
      return;
    }

    fileItems = [];
    isZipMode = true;
    zipFile = file;

    const zipItem = {
      file,
      name: file.name,
      path: file.name,
      folder: "root",
      type: "file",
      size: file.size,
      status: "pending",
    };

    fileItems = [zipItem];
    renderFileList();

    const sizeMB = file.size / (1024 * 1024);
    if (sizeMB > 10) {
      showStatus(
        `‚ùå File ZIP qu√° l·ªõn: ${sizeMB.toFixed(1)} MB. Gi·ªõi h·∫°n t·ªëi ƒëa l√† 10 MB.`,
        'error'
      );
      // Clear the file selection
      fileItems = [];
      isZipMode = false;
      zipFile = null;
      renderFileList();
      return;
    } else if (sizeMB > 3) {
      showStatus(
        `‚ö†Ô∏è File ZIP c√≥ dung l∆∞·ª£ng ${sizeMB.toFixed(1)} MB (khuy·∫øn ngh·ªã < 3 MB). Game c√≥ th·ªÉ t·∫£i ch·∫≠m tr√™n m·∫°ng y·∫øu.`,
        'warning'
      );
    } else {
      showStatus(`ƒê√£ ch·ªçn file ZIP: ${file.name} (${formatFileSize(file.size)})`, 'info');
    }

    updateUI();
  }
  // Event Listeners
  selectFilesBtn.addEventListener("click", () => fileInput.click());
  selectFolderBtn.addEventListener("click", () => {
    folderInput.webkitdirectory = true;
    folderInput.click();
  });
  selectZipBtn.addEventListener("click", () => zipInput.click());

  fileInput.addEventListener("change", async (e) => {
    const files = Array.from(e.target.files || []);
    if (files.length > 0) {
      try {
        await processFiles(files);
      } catch (error) {
        console.error('Error processing files:', error);
        showStatus('L·ªói khi x·ª≠ l√Ω file. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
      }
      e.target.value = "";
    }
  });

  folderInput.addEventListener("change", async (e) => {
    const files = Array.from(e.target.files || []);
    if (files.length > 0) {
      try {
        await processFiles(files);
      } catch (error) {
        console.error('Error processing folder:', error);
        showStatus('L·ªói khi x·ª≠ l√Ω th∆∞ m·ª•c. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
      }
      e.target.value = "";
    }
  });

  zipInput.addEventListener("change", async (e) => {
    const files = Array.from(e.target.files || []);
    if (files.length > 0 && files[0]) {
      try {
        await processZipFile(files[0]);
      } catch (error) {
        console.error('Error processing ZIP file:', error);
        showStatus('L·ªói khi x·ª≠ l√Ω file ZIP. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
      }
      e.target.value = "";
    }
  });

  clearFilesBtn.addEventListener("click", () => {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√°c file ƒë√£ ch·ªçn kh√¥ng?')) {
      fileItems = [];
      isZipMode = false;
      zipFile = null;
      renderFileList();
      updateUI();
      hideStatus();
    }
  });

  // Drag and drop
  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("border-emerald-400", "bg-emerald-50");
  });

  dropZone.addEventListener("dragleave", (e) => {
    e.preventDefault();
    dropZone.classList.remove("border-emerald-400", "bg-emerald-50");
  });

  dropZone.addEventListener("drop", async (e) => {
    e.preventDefault();
    dropZone.classList.remove("border-emerald-400", "bg-emerald-50");

    const files = Array.from(e.dataTransfer?.files || []);
    try {
      if (files.length === 1 && files[0].name.toLowerCase().endsWith('.zip')) {
        await processZipFile(files[0]);
      } else if (files.length > 0) {
        await processFiles(files);
      }
    } catch (error) {
      console.error('Error processing dropped files:', error);
      showStatus('L·ªói khi x·ª≠ l√Ω file ƒë∆∞·ª£c k√©o th·∫£. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
    }
  });

  // Version input handler
  newVersionInput.addEventListener("input", updateUI);
  newVersionInput.addEventListener("change", updateUI);
  // Upload handler
  uploadBtn.addEventListener("click", async () => {
    if (fileItems.length === 0 || !validateVersion()) return;

    const newVersion = newVersionInput.value.trim();
    
    uploadBtn.disabled = true;
    uploadBtnText.textContent = "ƒêang t·∫£i l√™n...";
    progressContainer.classList.remove("hidden");

    fileItems.forEach((item) => (item.status = "pending"));
    renderFileList();

    try {
      let res, data;

      // Create updated manifest
      const updatedManifest = {
        ...manifest,
        version: newVersion,
        entryUrl: `https://storage.googleapis.com/${bucketName}/games/${gameId}/${newVersion}/index.html`
      };

      if (isZipMode && zipFile) {
        // ZIP upload mode
        progressLabel.textContent = "ƒêang gi·∫£i n√©n v√† t·∫£i l√™n file ZIP...";
        
        const formData = new FormData();
        formData.append("zipFile", zipFile);
        formData.append("manifest", JSON.stringify(updatedManifest, null, 2));

        let progress = 0;
        const progressInterval = setInterval(() => {
          progress = Math.min(progress + Math.random() * 10, 85);
          progressBar.style.width = `${progress}%`;
          progressPercent.textContent = `${Math.round(progress)}%`;
          
          if (progress < 30) {
            progressLabel.textContent = "ƒêang gi·∫£i n√©n file ZIP...";
          } else if (progress < 70) {
            progressLabel.textContent = "ƒêang t·∫£i l√™n c√°c file...";
            fileItems[0].status = "uploading";
            renderFileList();
          }
        }, 200);

        res = await fetch("/api/upload-zip", {
          method: "POST",
          body: formData,
        });

        clearInterval(progressInterval);
        data = await res.json();

      } else {
        // Regular file upload mode
        const formData = new FormData();
        const manifestBlob = new Blob([JSON.stringify(updatedManifest, null, 2)], { type: "application/json" });
        const manifestFile = new File([manifestBlob], "manifest.json", { type: "application/json" });
        formData.append("files", manifestFile);

        fileItems.forEach((item) => {
          if (item.name !== "manifest.json" && !item.path?.endsWith("/manifest.json")) {
            formData.append("files", item.file);
          }
        });

        let progress = 0;
        const progressInterval = setInterval(() => {
          progress = Math.min(progress + Math.random() * 15, 90);
          progressBar.style.width = `${progress}%`;
          progressPercent.textContent = `${Math.round(progress)}%`;
          progressLabel.textContent = `ƒêang t·∫£i l√™n ${Math.round(progress)}%...`;
        }, 200);

        res = await fetch("/api/upload", {
          method: "POST",
          body: formData,
        });

        clearInterval(progressInterval);
        data = await res.json();
      }

      if (res.ok) {
        fileItems.forEach((item) => (item.status = "success"));
        
        progressBar.style.width = "100%";
        progressPercent.textContent = "100%";
        progressLabel.textContent = "Ho√†n t·∫•t!";
        
        renderFileList();

        showStatus(`‚úÖ ƒê√£ t·∫£i l√™n th√†nh c√¥ng phi√™n b·∫£n v${newVersion} cho game ${gameTitle}!`, "success");
        uploadBtnText.textContent = "Th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...";

        setTimeout(() => {
          window.location.href = `/games/${gameId}/versions`;
        }, 2000);
      } else {
        throw new Error(data.error || "T·∫£i l√™n th·∫•t b·∫°i");
      }
    } catch (err) {
      fileItems.forEach((item) => {
        if (item.status === "uploading" || item.status === "pending") {
          item.status = "error";
          item.errorMessage = err.message;
        }
      });
      renderFileList();

      showStatus(err.message || "T·∫£i l√™n th·∫•t b·∫°i", "error");
      uploadBtn.disabled = false;
      uploadBtnText.textContent = "Th·ª≠ l·∫°i";
      progressContainer.classList.add("hidden");
    }
  });

  // Initialize
  updateUI();
</script>