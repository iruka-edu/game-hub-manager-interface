---
// Quick game version debugger component
// Can be embedded in any admin page for quick debugging
---

<div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
  <h3 class="text-sm font-medium text-slate-900 mb-3">ðŸ”§ Quick Game Version Debug</h3>
  
  <div class="flex gap-2">
    <input 
      type="text" 
      id="quickGameId" 
      placeholder="Game ID (e.g., 6942e6c54f2eae03b502b565)"
      class="flex-1 px-3 py-2 text-sm border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
    >
    <button 
      id="quickDebugBtn" 
      class="px-4 py-2 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700 transition-colors"
    >
      Debug
    </button>
    <button 
      id="quickFixBtn" 
      class="px-4 py-2 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition-colors"
    >
      Fix
    </button>
  </div>

  <div id="quickResults" class="mt-3 hidden">
    <div class="bg-white border border-slate-200 rounded p-3">
      <pre id="quickOutput" class="text-xs text-slate-600 whitespace-pre-wrap"></pre>
    </div>
  </div>
</div>

<script>
  const quickGameIdInput = document.getElementById('quickGameId') as HTMLInputElement;
  const quickDebugBtn = document.getElementById('quickDebugBtn') as HTMLButtonElement;
  const quickFixBtn = document.getElementById('quickFixBtn') as HTMLButtonElement;
  const quickResults = document.getElementById('quickResults') as HTMLDivElement;
  const quickOutput = document.getElementById('quickOutput') as HTMLPreElement;

  async function quickDebug() {
    const gameId = quickGameIdInput.value.trim();
    if (!gameId) {
      alert('Please enter a Game ID');
      return;
    }

    quickDebugBtn.disabled = true;
    quickOutput.textContent = 'Loading...';
    quickResults.classList.remove('hidden');

    try {
      const response = await fetch(`/api/games/${gameId}/debug-versions`);
      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Debug failed');
      }

      // Format the output nicely
      let output = `ðŸŽ® Game: ${data.game.title} (${data.game.gameId})\n`;
      output += `ðŸ“Š Versions: ${data.versions.total} total, ${data.versions.active} active\n`;
      output += `ðŸ”— Latest Ref: ${data.game.latestVersionId || 'null'}\n`;
      output += `ðŸ”— Live Ref: ${data.game.liveVersionId || 'null'}\n\n`;

      if (data.versions.list.length === 0) {
        output += 'âŒ No versions found - need to create version first\n';
        output += `ðŸ’¡ Use: POST /api/games/${gameId}/upload-version`;
      } else {
        output += 'ðŸ“‹ Versions:\n';
        data.versions.list.forEach((v: any, i: number) => {
          const marker = i === 0 ? 'ðŸ“Œ' : '  ';
          const status = v.isDeleted ? 'ðŸ—‘ï¸ DELETED' : `âœ… ${v.status}`;
          output += `${marker} ${v.version} (${status})\n`;
        });

        if (data.versions.active > 0 && !data.game.latestVersionId) {
          output += '\nâš ï¸  Issue: Has versions but latestVersionId is null';
          output += '\nðŸ”§ Can be fixed with Fix button';
        }
      }

      quickOutput.textContent = output;

    } catch (error: any) {
      quickOutput.textContent = `âŒ Error: ${error.message}`;
    } finally {
      quickDebugBtn.disabled = false;
    }
  }

  async function quickFix() {
    const gameId = quickGameIdInput.value.trim();
    if (!gameId) {
      alert('Please enter a Game ID');
      return;
    }

    if (!confirm('Fix version references for this game?')) {
      return;
    }

    quickFixBtn.disabled = true;
    quickOutput.textContent = 'Fixing...';
    quickResults.classList.remove('hidden');

    try {
      const response = await fetch('/api/admin/fix-game-versions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ gameId, dryRun: false })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Fix failed');
      }

      const result = data.results[0];
      let output = `ðŸŽ® Game: ${result.title} (${result.gameSlug})\n`;
      output += `ðŸ“Š Versions found: ${result.versionsFound}\n`;
      output += `ðŸ”§ Action: ${result.action}\n`;

      if (result.updated) {
        output += `âœ… Success: Updated latestVersionId to ${result.newLatestVersion}\n`;
        output += `ðŸŽ¯ Now you can submit for QC!`;
      } else if (result.action === 'none') {
        output += `â„¹ï¸  No fix needed - references are already correct`;
      } else {
        output += `âŒ Failed to update`;
      }

      quickOutput.textContent = output;

    } catch (error: any) {
      quickOutput.textContent = `âŒ Error: ${error.message}`;
    } finally {
      quickFixBtn.disabled = false;
    }
  }

  quickDebugBtn.addEventListener('click', quickDebug);
  quickFixBtn.addEventListener('click', quickFix);

  // Allow Enter key to trigger debug
  quickGameIdInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      quickDebug();
    }
  });
</script>