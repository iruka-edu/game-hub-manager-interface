---
// Device information component for testing reports
interface Props {
  showInProduction?: boolean;
}

const { showInProduction = false } = Astro.props;
const isDev = import.meta.env.DEV;
const shouldShow = isDev || showInProduction;
---

{shouldShow && (
  <div id="device-info" class="hidden">
    <div id="device-data"></div>
  </div>
)}

<script define:vars={{ shouldShow }}>
  if (shouldShow) {
    class DeviceDetector {
      private info: any = {};
      
      constructor() {
        this.detectAll();
        this.setupReporting();
      }
      
      detectAll() {
        this.detectDevice();
        this.detectBrowser();
        this.detectScreen();
        this.detectNetwork();
        this.detectCapabilities();
      }
      
      detectDevice() {
        const ua = navigator.userAgent;
        
        // Device type and model
        if (/iPhone/.test(ua)) {
          this.info.deviceType = 'iPhone';
          this.info.deviceModel = this.extractiPhoneModel(ua);
        } else if (/iPad/.test(ua)) {
          this.info.deviceType = 'iPad';
          this.info.deviceModel = 'iPad';
        } else if (/Android/.test(ua)) {
          this.info.deviceType = ua.includes('Mobile') ? 'Android Phone' : 'Android Tablet';
          this.info.deviceModel = this.extractAndroidModel(ua);
        } else if (/Windows/.test(ua)) {
          this.info.deviceType = 'Windows PC';
          this.info.deviceModel = 'Desktop/Laptop';
        } else if (/Mac/.test(ua)) {
          this.info.deviceType = 'Mac';
          this.info.deviceModel = 'Desktop/Laptop';
        } else {
          this.info.deviceType = 'Unknown';
          this.info.deviceModel = 'Unknown';
        }
        
        // OS Version
        this.info.osVersion = this.extractOSVersion(ua);
        
        // Touch capability
        this.info.touchSupport = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      }
      
      detectBrowser() {
        const ua = navigator.userAgent;
        
        if (ua.includes('Chrome') && !ua.includes('Edge')) {
          this.info.browser = 'Chrome';
          this.info.browserVersion = this.extractVersion(ua, /Chrome\/([0-9.]+)/);
        } else if (ua.includes('Safari') && !ua.includes('Chrome')) {
          this.info.browser = 'Safari';
          this.info.browserVersion = this.extractVersion(ua, /Version\/([0-9.]+)/);
        } else if (ua.includes('Edge')) {
          this.info.browser = 'Edge';
          this.info.browserVersion = this.extractVersion(ua, /Edge\/([0-9.]+)/);
        } else if (ua.includes('Firefox')) {
          this.info.browser = 'Firefox';
          this.info.browserVersion = this.extractVersion(ua, /Firefox\/([0-9.]+)/);
        } else if (ua.includes('SamsungBrowser')) {
          this.info.browser = 'Samsung Internet';
          this.info.browserVersion = this.extractVersion(ua, /SamsungBrowser\/([0-9.]+)/);
        } else {
          this.info.browser = 'Unknown';
          this.info.browserVersion = 'Unknown';
        }
      }
      
      detectScreen() {
        this.info.screenResolution = `${screen.width}×${screen.height}`;
        this.info.viewportSize = `${window.innerWidth}×${window.innerHeight}`;
        this.info.devicePixelRatio = window.devicePixelRatio || 1;
        this.info.colorDepth = screen.colorDepth;
        
        // Determine breakpoint category
        const width = window.innerWidth;
        if (width < 768) {
          this.info.breakpointCategory = 'Mobile';
        } else if (width < 1024) {
          this.info.breakpointCategory = 'Tablet';
        } else {
          this.info.breakpointCategory = 'Desktop';
        }
        
        // Orientation
        this.info.orientation = window.innerWidth > window.innerHeight ? 'Landscape' : 'Portrait';
      }
      
      detectNetwork() {
        if ('connection' in navigator) {
          const connection = (navigator as any).connection;
          this.info.networkType = connection.effectiveType || 'Unknown';
          this.info.networkDownlink = connection.downlink || 'Unknown';
        } else {
          this.info.networkType = 'Unknown';
          this.info.networkDownlink = 'Unknown';
        }
      }
      
      detectCapabilities() {
        this.info.webGL = this.checkWebGL();
        this.info.localStorage = this.checkLocalStorage();
        this.info.serviceWorker = 'serviceWorker' in navigator;
        this.info.webAssembly = 'WebAssembly' in window;
        this.info.intersectionObserver = 'IntersectionObserver' in window;
        this.info.performanceObserver = 'PerformanceObserver' in window;
      }
      
      extractiPhoneModel(ua: string): string {
        if (ua.includes('iPhone')) {
          // This is simplified - real detection would need more complex logic
          return 'iPhone';
        }
        return 'Unknown iPhone';
      }
      
      extractAndroidModel(ua: string): string {
        const match = ua.match(/Android[^;]*;[^)]*\)([^)]*)/);
        if (match) {
          return match[1].trim() || 'Android Device';
        }
        return 'Android Device';
      }
      
      extractOSVersion(ua: string): string {
        let match;
        
        if ((match = ua.match(/iPhone OS ([0-9_]+)/))) {
          return 'iOS ' + match[1].replace(/_/g, '.');
        } else if ((match = ua.match(/Android ([0-9.]+)/))) {
          return 'Android ' + match[1];
        } else if ((match = ua.match(/Windows NT ([0-9.]+)/))) {
          return 'Windows ' + match[1];
        } else if ((match = ua.match(/Mac OS X ([0-9_]+)/))) {
          return 'macOS ' + match[1].replace(/_/g, '.');
        }
        
        return 'Unknown';
      }
      
      extractVersion(ua: string, regex: RegExp): string {
        const match = ua.match(regex);
        return match ? match[1] : 'Unknown';
      }
      
      checkWebGL(): boolean {
        try {
          const canvas = document.createElement('canvas');
          return !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
        } catch (e) {
          return false;
        }
      }
      
      checkLocalStorage(): boolean {
        try {
          localStorage.setItem('test', 'test');
          localStorage.removeItem('test');
          return true;
        } catch (e) {
          return false;
        }
      }
      
      setupReporting() {
        // Update device data container
        const container = document.getElementById('device-data');
        if (container) {
          container.textContent = JSON.stringify(this.info, null, 2);
        }
        
        // Add to window for easy access
        (window as any).deviceInfo = this.info;
        
        // Log for easy copying
        console.log('Device Information:', this.info);
      }
      
      // Generate testing report
      generateTestingReport(): string {
        return `
**Device Testing Report**
Generated: ${new Date().toISOString()}
URL: ${window.location.href}

**Device Information:**
- Type: ${this.info.deviceType}
- Model: ${this.info.deviceModel}
- OS: ${this.info.osVersion}
- Touch Support: ${this.info.touchSupport ? 'Yes' : 'No'}

**Browser Information:**
- Browser: ${this.info.browser}
- Version: ${this.info.browserVersion}

**Screen Information:**
- Resolution: ${this.info.screenResolution}
- Viewport: ${this.info.viewportSize}
- Pixel Ratio: ${this.info.devicePixelRatio}
- Category: ${this.info.breakpointCategory}
- Orientation: ${this.info.orientation}

**Network:**
- Type: ${this.info.networkType}
- Downlink: ${this.info.networkDownlink}

**Capabilities:**
- WebGL: ${this.info.webGL ? 'Supported' : 'Not Supported'}
- Local Storage: ${this.info.localStorage ? 'Supported' : 'Not Supported'}
- Service Worker: ${this.info.serviceWorker ? 'Supported' : 'Not Supported'}
- WebAssembly: ${this.info.webAssembly ? 'Supported' : 'Not Supported'}
        `.trim();
      }
      
      // Copy report to clipboard
      async copyReport(): Promise<boolean> {
        try {
          await navigator.clipboard.writeText(this.generateTestingReport());
          return true;
        } catch (e) {
          console.error('Failed to copy report:', e);
          return false;
        }
      }
    }
    
    // Initialize device detector
    const deviceDetector = new DeviceDetector();
    
    // Make it globally available
    (window as any).deviceDetector = deviceDetector;
    
    // Add keyboard shortcut to copy device info (Ctrl+Shift+D)
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        e.preventDefault();
        deviceDetector.copyReport().then(success => {
          if (success) {
            console.log('Device report copied to clipboard!');
          }
        });
      }
    });
  }
</script>