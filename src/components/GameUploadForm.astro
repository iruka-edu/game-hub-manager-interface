---
// Server-side component - all logic happens on client
---

<div class="flex flex-col h-full animate-fade-in gap-6">
  <!-- Section 1: Upload Card (Tabs + Dropzone) -->
  <div
    class="bg-white rounded-[24px] border border-slate-200 shadow-sm overflow-hidden shrink-0"
  >
    <!-- Tabs Header -->
    <div class="flex border-b border-slate-100">
      <button
        id="tabZip"
        class="flex-1 py-4 text-center text-sm font-black text-iruka-blue border-b-2 border-iruka-blue bg-blue-50/50 transition-all hover:bg-blue-50 flex items-center justify-center gap-2 group"
      >
        <svg
          class="w-5 h-5 text-iruka-blue"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 12l2 2 4-4"
          ></path></svg
        >
        FILE ZIP <span
          class="hidden sm:inline-block px-1.5 py-0.5 rounded text-[10px] bg-emerald-100 text-emerald-700 ml-1"
          >KHUYÊN DÙNG</span
        >
      </button>
      <button
        id="tabFolder"
        class="flex-1 py-4 text-center text-sm font-bold text-slate-500 border-b-2 border-transparent hover:text-slate-700 hover:bg-slate-50 transition-all flex items-center justify-center gap-2"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
          ></path></svg
        >
        THƯ MỤC
      </button>
      <button
        id="tabFile"
        class="flex-1 py-4 text-center text-sm font-bold text-slate-500 border-b-2 border-transparent hover:text-slate-700 hover:bg-slate-50 transition-all flex items-center justify-center gap-2"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          ></path></svg
        >
        FILE LẺ
      </button>
    </div>

    <!-- Dropzone Area -->
    <div class="p-8">
      <div
        id="dropZone"
        class="relative border-4 border-dashed border-blue-100 rounded-[20px] bg-sky-50/20 hover:bg-sky-50/50 hover:border-iruka-blue transition-all duration-300 group cursor-pointer h-[320px] flex flex-col items-center justify-center text-center"
      >
        <div
          class="mb-5 p-4 rounded-full bg-white shadow-sm ring-4 ring-blue-50 group-hover:scale-110 transition-transform duration-300"
        >
          <!-- Illustration Icon changes based on Tab -->
          <svg
            id="dropIcon"
            class="w-10 h-10 text-iruka-blue"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
            ></path></svg
          >
        </div>

        <h3 id="dropTitle" class="text-xl font-black text-slate-900 mb-2">
          Kéo thả file ZIP vào đây
        </h3>
        <p
          id="dropHint"
          class="text-slate-400 font-bold text-sm mb-6 max-w-xs mx-auto leading-relaxed"
        >
          Hệ thống sẽ tự động giải nén và phân tích gói build của bạn
        </p>

        <button
          type="button"
          id="triggerInputBtn"
          class="px-6 py-3 rounded-xl bg-white border-2 border-slate-200 text-slate-700 font-black text-sm hover:border-iruka-blue hover:text-iruka-blue hover:shadow-lg hover:shadow-blue-500/10 transition-all active:scale-95"
        >
          Chọn file ZIP từ máy
        </button>

        <!-- Hidden Inputs -->
        <input type="file" id="zipInput" accept=".zip" class="hidden" />
        <input
          type="file"
          id="folderInput"
          multiple
          class="hidden"
        />
        <input type="file" id="fileInput" multiple class="hidden" />
      </div>
    </div>
  </div>

  <!-- Section 2: Validation Summary (Auto Check) - Initially Hidden -->
  <div
    id="validationCard"
    class="hidden bg-white rounded-[24px] border border-slate-200 shadow-sm overflow-hidden animate-fade-in-up"
  >
    <!-- Header -->
    <div
      class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex items-center justify-between"
    >
      <div class="flex items-center gap-3">
        <div
          class="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center"
        >
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2.5"
              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg
          >
        </div>
        <div>
          <h4 class="text-sm font-black text-slate-900 uppercase">
            Kết quả kiểm tra
          </h4>
          <p
            id="fileNameDisplay"
            class="text-xs font-bold text-slate-500 truncate max-w-[200px]"
          >
            Checking...
          </p>
        </div>
      </div>
      <button
        id="resetBtn"
        class="text-xs font-bold text-red-500 hover:bg-red-50 px-3 py-1.5 rounded-lg transition-colors"
      >
        Hủy bỏ
      </button>
    </div>

    <!-- Content -->
    <div class="p-6 grid gap-6">
      <!-- Metadata Grid -->
      <div class="grid grid-cols-2 gap-4">
        <div class="p-3 rounded-xl bg-slate-50 border border-slate-100">
          <label
            class="block text-[10px] font-black text-slate-400 uppercase mb-1"
            >Game ID</label
          >
          <div id="metaId" class="text-sm font-bold text-slate-800 break-all">
            Checking...
          </div>
        </div>
        <div class="p-3 rounded-xl bg-slate-50 border border-slate-100">
          <label
            class="block text-[10px] font-black text-slate-400 uppercase mb-1"
            >Version</label
          >
          <div id="metaVersion" class="text-sm font-bold text-slate-800">
            Checking...
          </div>
        </div>
        <div
          class="p-3 rounded-xl bg-slate-50 border border-slate-100 col-span-2"
        >
          <label
            class="block text-[10px] font-black text-slate-400 uppercase mb-1"
            >Tên hiển thị</label
          >
          <div id="metaTitle" class="text-sm font-bold text-slate-800">
            Checking...
          </div>
        </div>
      </div>

      <!-- Checklist Status -->
      <div class="space-y-3 pt-4 border-t border-slate-50">
        <div
          id="checkIndex"
          class="flex items-center gap-3 text-sm font-bold text-slate-400"
        >
          <div
            class="w-5 h-5 rounded-full border-2 border-slate-200 flex items-center justify-center shrink-0"
          >
          </div>
          <span>File index.html</span>
        </div>
        <div
          id="checkManifest"
          class="flex items-center gap-3 text-sm font-bold text-slate-400"
        >
          <div
            class="w-5 h-5 rounded-full border-2 border-slate-200 flex items-center justify-center shrink-0"
          >
          </div>
          <span>File manifest.json</span>
        </div>
        <div
          id="checkSize"
          class="flex items-center gap-3 text-sm font-bold text-slate-400"
        >
          <div
            class="w-5 h-5 rounded-full border-2 border-slate-200 flex items-center justify-center shrink-0"
          >
          </div>
          <span>Dung lượng tối ưu</span>
        </div>
      </div>

      <!-- Error Box -->
      <div
        id="validationErrorBox"
        class="hidden p-4 bg-red-50 border border-red-100 rounded-xl"
      >
        <p id="validationErrorMsg" class="text-xs font-bold text-red-600"></p>
      </div>

      <!-- Manual Edit Toggle -->
      <button
        id="toggleEdit"
        class="w-full py-2 text-xs font-bold text-indigo-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors uppercase tracking-wider"
      >
        + Chỉnh sửa thông tin Manifest
      </button>

      <!-- Hidden Editor -->
      <div
        id="manualEditor"
        class="space-y-4 pt-4 border-t border-slate-100"
        style="display: none;"
      >
        <div class="space-y-2">
          <label class="text-xs font-bold text-slate-500">Manifest JSON</label>
          <textarea
            id="jsonEditor"
            class="w-full h-32 text-xs font-mono bg-slate-800 text-green-400 p-3 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500"
            spellcheck="false"></textarea>
          <button
            id="saveJson"
            class="text-xs font-bold bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-lg hover:bg-indigo-200"
            >Áp dụng thay đổi</button
          >
        </div>
      </div>
    </div>
  </div>

  <!-- Section 3: Primary Interaction (Sticky Bottom) -->
  <div
    class="mt-auto pt-4 sticky bottom-0 bg-linear-to-t from-slate-50 to-transparent pb-4 z-20"
  >
    <button
      id="submitBtn"
      disabled
      class="w-full py-4 rounded-xl bg-iruka-blue text-white font-black text-base shadow-xl shadow-blue-500/20 hover:bg-blue-600 hover:translate-y-[-2px] transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none flex items-center justify-center gap-2"
    >
      <span>Đăng bản Build</span>
      <svg
        id="btnSpinner"
        class="hidden w-5 h-5 animate-spin"
        fill="none"
        viewBox="0 0 24 24"
        ><circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"></circle><path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path></svg
      >
    </button>
  </div>

  <!-- Progress Overlay -->
  <div
    id="progressOverlay"
    class="fixed inset-0 z-50 bg-slate-900/60 backdrop-blur-sm items-center justify-center"
    style="display: none;"
  >
    <div
      class="bg-white rounded-[32px] p-8 w-[320px] text-center shadow-2xl animate-fade-in-up"
    >
      <div class="w-20 h-20 mx-auto mb-6 relative">
        <svg class="w-full h-full transform -rotate-90"
          ><circle
            cx="40"
            cy="40"
            r="36"
            stroke="#f1f5f9"
            stroke-width="6"
            fill="none"></circle><circle
            id="progCircle"
            cx="40"
            cy="40"
            r="36"
            stroke="#2b9bf6"
            stroke-width="6"
            fill="none"
            stroke-dasharray="226"
            stroke-dashoffset="226"
            class="transition-all duration-300"></circle></svg
        >
        <div
          class="absolute inset-0 flex items-center justify-center font-black text-xl text-slate-800"
          id="progText"
        >
          0%
        </div>
      </div>
      <h3 class="font-black text-slate-900 mb-1">Đang tải lên</h3>
      <p
        class="text-xs font-bold text-slate-400 uppercase tracking-wider"
        id="progLabel"
      >
        Khởi tạo...
      </p>
    </div>
  </div>
</div>

<script>
  // Type definitions
  interface FileItem {
    file: File;
    path: string;
    size: number;
  }

  interface ManifestData {
    id?: string;
    version?: string;
    title?: string;
    runtime?: string;
    [key: string]: any;
  }

  type UploadMode = "zip" | "folder" | "file";
  type CheckStatus = "pending" | "success" | "error";

  // Elements with proper typing
  const tabs = {
    zip: document.getElementById("tabZip") as HTMLButtonElement | null,
    folder: document.getElementById("tabFolder") as HTMLButtonElement | null,
    file: document.getElementById("tabFile") as HTMLButtonElement | null,
  };
  
  const inputs = {
    zip: document.getElementById("zipInput") as HTMLInputElement | null,
    folder: document.getElementById("folderInput") as HTMLInputElement | null,
    file: document.getElementById("fileInput") as HTMLInputElement | null,
  };
  
  const dropZone = document.getElementById("dropZone") as HTMLDivElement | null;
  const dropTitle = document.getElementById("dropTitle") as HTMLHeadingElement | null;
  const dropHint = document.getElementById("dropHint") as HTMLParagraphElement | null;
  const triggerBtn = document.getElementById("triggerInputBtn") as HTMLButtonElement | null;
  const dropIcon = document.getElementById("dropIcon") as SVGElement | null;

  const validationCard = document.getElementById("validationCard") as HTMLDivElement | null;
  const metaId = document.getElementById("metaId") as HTMLDivElement | null;
  const metaVersion = document.getElementById("metaVersion") as HTMLDivElement | null;
  const metaTitle = document.getElementById("metaTitle") as HTMLDivElement | null;
  const fileNameDisplay = document.getElementById("fileNameDisplay") as HTMLParagraphElement | null;
  const resetBtn = document.getElementById("resetBtn") as HTMLButtonElement | null;
  const submitBtn = document.getElementById("submitBtn") as HTMLButtonElement | null;
  const btnSpinner = document.getElementById("btnSpinner") as SVGElement | null;

  const manualEditor = document.getElementById("manualEditor") as HTMLDivElement | null;
  const toggleEdit = document.getElementById("toggleEdit") as HTMLButtonElement | null;
  const jsonEditor = document.getElementById("jsonEditor") as HTMLTextAreaElement | null;
  const saveJson = document.getElementById("saveJson") as HTMLButtonElement | null;

  const validationErrorBox = document.getElementById("validationErrorBox") as HTMLDivElement | null;
  const validationErrorMsg = document.getElementById("validationErrorMsg") as HTMLParagraphElement | null;

  // State with proper typing
  let currentMode: UploadMode = "zip";
  let fileItems: FileItem[] = [];
  let manifestData: ManifestData | null = null;
  let isUploading = false;

  // -- UI Helpers --
  function setMode(mode: UploadMode): void {
    currentMode = mode;
    // Update Tabs
    Object.keys(tabs).forEach((k) => {
      const tabKey = k as keyof typeof tabs;
      const btn = tabs[tabKey];
      if (btn) {
        if (k === mode) {
          btn.className =
            "flex-1 py-4 text-center text-sm font-black text-iruka-blue border-b-2 border-iruka-blue bg-blue-50/50 transition-all flex items-center justify-center gap-2";
        } else {
          btn.className =
            "flex-1 py-4 text-center text-sm font-bold text-slate-500 border-b-2 border-transparent hover:text-slate-700 hover:bg-slate-50 transition-all flex items-center justify-center gap-2";
        }
      }
    });

    // Update Dropzone Text
    if (mode === "zip") {
      if (dropTitle) dropTitle.textContent = "Kéo thả file ZIP vào đây";
      if (dropHint) dropHint.textContent =
        "Hệ thống sẽ tự động giải nén và phân tích gói build của bạn";
      if (triggerBtn) triggerBtn.textContent = "Chọn file ZIP từ máy";
      if (dropIcon) dropIcon.innerHTML =
        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>';
    } else if (mode === "folder") {
      if (dropTitle) dropTitle.textContent = "Kéo thả Thư mục build vào đây";
      if (dropHint) dropHint.textContent = "Đảm bảo thư mục chứa index.html và manifest.json";
      if (triggerBtn) triggerBtn.textContent = "Chọn thư mục";
      if (dropIcon) dropIcon.innerHTML =
        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>';
    } else {
      if (dropTitle) dropTitle.textContent = "Kéo thả các file lẻ vào đây";
      if (dropHint) dropHint.textContent =
        "Chọn tất cả các file cần thiết (HTML, JS, CSS, Assets)";
      if (triggerBtn) triggerBtn.textContent = "Chọn file lẻ";
      if (dropIcon) dropIcon.innerHTML =
        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>';
    }

    // Reset state on tab switch
    resetState();
  }

  function resetState(): void {
    fileItems = [];
    manifestData = null;
    if (validationCard) validationCard.classList.add("hidden");
    if (dropZone) dropZone.classList.remove("hidden");
    if (submitBtn) submitBtn.disabled = true;
    if (inputs.zip) inputs.zip.value = "";
    if (inputs.folder) inputs.folder.value = "";
    if (inputs.file) inputs.file.value = "";
  }

  function setCheckStatus(id: string, status: CheckStatus, text?: string): void {
    const row = document.getElementById(id);
    if (!row) return;
    
    const icon = row.querySelector("div");
    const label = row.querySelector("span");

    if (status === "success") {
      if (icon) {
        icon.className =
          "w-5 h-5 rounded-full bg-emerald-500 text-white flex items-center justify-center shrink-0";
        icon.innerHTML =
          '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>';
      }
      row.className =
        "flex items-center gap-3 text-sm font-bold text-slate-800";
      if (text && label) label.textContent = text;
    } else if (status === "error") {
      if (icon) {
        icon.className =
          "w-5 h-5 rounded-full bg-red-500 text-white flex items-center justify-center shrink-0";
        icon.innerHTML =
          '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg>';
      }
      row.className = "flex items-center gap-3 text-sm font-bold text-red-600";
      if (text && label) label.textContent = text;
    } else {
      if (icon) {
        icon.className =
          "w-5 h-5 rounded-full border-2 border-slate-200 flex items-center justify-center shrink-0";
        icon.innerHTML = "";
      }
      row.className =
        "flex items-center gap-3 text-sm font-bold text-slate-400";
    }
  }

  // Set webkitdirectory attribute for folder input
  if (inputs.folder) {
    (inputs.folder as any).webkitdirectory = true;
  }

  // -- Interaction Handlers --
  if (tabs.zip) tabs.zip.onclick = () => setMode("zip");
  if (tabs.folder) tabs.folder.onclick = () => setMode("folder");
  if (tabs.file) tabs.file.onclick = () => setMode("file");
  if (triggerBtn) triggerBtn.onclick = () => {
    const input = inputs[currentMode];
    if (input) input.click();
  };
  if (resetBtn) resetBtn.onclick = resetState;

  if (toggleEdit) {
    toggleEdit.onclick = () => {
      if (manualEditor) {
        const isHidden = manualEditor.style.display === "none";
        manualEditor.style.display = isHidden ? "block" : "none";
        // Pre-fill
        if (manifestData && jsonEditor && !jsonEditor.value && isHidden) {
          jsonEditor.value = JSON.stringify(manifestData, null, 2);
        }
      }
    };
  }

  if (saveJson) {
    saveJson.onclick = () => {
      if (!jsonEditor) return;
      try {
        const newData: ManifestData = JSON.parse(jsonEditor.value);
        manifestData = newData;
        updateValidationUI();
        if (manualEditor) manualEditor.style.display = "none";
      } catch (e) {
        alert("JSON không hợp lệ");
      }
    };
  }

  // Drag & Drop
  if (dropZone) {
    dropZone.ondragover = (e: DragEvent) => {
      e.preventDefault();
      dropZone.classList.add("border-iruka-blue", "bg-blue-50");
    };
    dropZone.ondragleave = (e: DragEvent) => {
      e.preventDefault();
      dropZone.classList.remove("border-iruka-blue", "bg-blue-50");
    };
    dropZone.ondrop = (e: DragEvent) => {
      e.preventDefault();
      dropZone.classList.remove("border-iruka-blue", "bg-blue-50");
      if (e.dataTransfer) {
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
      }
    };
  }

  // File Inputs
  if (inputs.zip) {
    inputs.zip.onchange = (e: Event) => {
      const target = e.target as HTMLInputElement;
      if (target && target.files) {
        handleFiles(Array.from(target.files));
      }
    };
  }
  if (inputs.folder) {
    inputs.folder.onchange = (e: Event) => {
      const target = e.target as HTMLInputElement;
      if (target && target.files) {
        handleFiles(Array.from(target.files));
      }
    };
  }
  if (inputs.file) {
    inputs.file.onchange = (e: Event) => {
      const target = e.target as HTMLInputElement;
      if (target && target.files) {
        handleFiles(Array.from(target.files));
      }
    };
  }

  async function handleFiles(files: File[]): Promise<void> {
    if (!files.length) return;

    // Logic switching based on mode
    if (currentMode === "zip") {
      if (files.length > 1 || !files[0].name.toLowerCase().endsWith(".zip")) {
        alert("Vui lòng chỉ chọn 1 file ZIP");
        return;
      }
      fileItems = [
        { file: files[0], path: files[0].name, size: files[0].size },
      ];
    } else {
      // Folder/File logic
      fileItems = files.map((f: File) => ({
        file: f,
        path: (f as any).webkitRelativePath || f.name,
        size: f.size,
      }));
    }

    // Show Validation Card
    if (dropZone) dropZone.classList.add("hidden");
    if (validationCard) validationCard.classList.remove("hidden");

    // Build summary info
    const totalSize = fileItems.reduce((acc: number, f: FileItem) => acc + f.size, 0);
    const sizeMB = (totalSize / (1024 * 1024)).toFixed(1);
    const mainFile = fileItems[0].path;
    if (fileNameDisplay) {
      fileNameDisplay.textContent =
        currentMode === "zip" ? mainFile : `${fileItems.length} files`;
    }

    // Check Size
    if (totalSize < 10 * 1024 * 1024) {
      setCheckStatus(
        "checkSize",
        "success",
        `Dung lượng: ${sizeMB} MB (Hợp lệ)`
      );
    } else {
      setCheckStatus(
        "checkSize",
        "error",
        `Dung lượng: ${sizeMB} MB (Quá lớn > 10MB)`
      );
    }

    // Check Index & Manifest
    let hasIndex = false;
    let manifestFile: FileItem | undefined = undefined;

    if (currentMode === "zip") {
      // Mock check for zip (cannot read inside client-side easily without lib, assume backend will check)
      setCheckStatus("checkIndex", "pending", "Sẽ kiểm tra trên server (ZIP)");
      setCheckStatus(
        "checkManifest",
        "pending",
        "Sẽ kiểm tra trên server (ZIP)"
      );

      // Allow user to manually input manifest to enable button
      if (metaId) metaId.textContent = "---";
      if (metaVersion) metaVersion.textContent = "---";
      if (metaTitle) metaTitle.textContent = "---";
      if (manualEditor) manualEditor.style.display = "block"; // Force open editor for ZIP if no reader
      if (jsonEditor) {
        jsonEditor.value =
          '{\n  "id": "com.iruka.game-name",\n  "version": "1.0.0",\n  "title": "My Game",\n  "runtime": "iframe-html"\n}';
      }
    } else {
      // File/Folder mode: we can resize
      hasIndex = fileItems.some((f: FileItem) => f.path.endsWith("index.html"));
      manifestFile = fileItems.find((f: FileItem) => f.path.endsWith("manifest.json"));

      if (hasIndex)
        setCheckStatus("checkIndex", "success", "Tìm thấy index.html");
      else setCheckStatus("checkIndex", "error", "Thiếu index.html");

      if (manifestFile) {
        try {
          const text = await manifestFile.file.text();
          manifestData = JSON.parse(text);
          setCheckStatus("checkManifest", "success", "Manifest hợp lệ");
          updateValidationUI();
        } catch (e) {
          setCheckStatus("checkManifest", "error", "Manifest lỗi JSON");
        }
      } else {
        setCheckStatus("checkManifest", "error", "Thiếu manifest.json");
        if (manualEditor) manualEditor.style.display = "block"; // Ask to create one
        if (jsonEditor) {
          jsonEditor.value =
            '{\n  "id": "com.iruka.game-name",\n  "version": "1.0.0",\n  "title": "My Game",\n  "runtime": "iframe-html"\n}';
        }
      }
    }
  }

  function updateValidationUI(): void {
    if (manifestData) {
      if (metaId) metaId.textContent = manifestData.id || "Missing";
      if (metaVersion) metaVersion.textContent = manifestData.version || "Missing";
      if (metaTitle) metaTitle.textContent = manifestData.title || "Missing";

      // Validate Data
      let errors: string[] = [];
      if (!manifestData.id?.startsWith("com.iruka."))
        errors.push("ID phải bắt đầu bằng com.iruka.");
      if (!manifestData.version) errors.push("Thiếu version");

      if (errors.length > 0) {
        if (validationErrorBox) validationErrorBox.classList.remove("hidden");
        if (validationErrorMsg) validationErrorMsg.textContent = errors.join(", ");
        if (submitBtn) submitBtn.disabled = true;
      } else {
        if (validationErrorBox) validationErrorBox.classList.add("hidden");
        if (submitBtn) submitBtn.disabled = false;
      }
    }
  }

  if (submitBtn) {
    submitBtn.onclick = async () => {
      if (isUploading) return;
      isUploading = true;

      // UI Loading
      const progressOverlay = document.getElementById("progressOverlay") as HTMLDivElement | null;
      const progCircle = document.getElementById("progCircle") as SVGCircleElement | null;
      const progText = document.getElementById("progText") as HTMLDivElement | null;
      const progLabel = document.getElementById("progLabel") as HTMLParagraphElement | null;

      if (progressOverlay) progressOverlay.style.display = "flex";

      const formData = new FormData();
      // If manual manifest provided, override
      if (manifestData) {
        formData.append("manifest", JSON.stringify(manifestData));
      }

      if (currentMode === "zip") {
        formData.append("zipFile", fileItems[0].file);
      } else {
        fileItems.forEach((f: FileItem) => formData.append("files", f.file));
      }

      try {
        // Simulate Progress
        let p = 0;
        const intv = setInterval(() => {
          p += 5;
          if (p > 90) clearInterval(intv);
          const offset = 226 - (226 * p) / 100;
          if (progCircle) progCircle.style.strokeDashoffset = offset.toString();
          if (progText) progText.textContent = p + "%";
          if (p > 50 && progLabel) progLabel.textContent = "Đang xác thực...";
        }, 100);

        const endpoint =
          currentMode === "zip" ? "/api/upload-zip" : "/api/upload";
        const res = await fetch(endpoint, { method: "POST", body: formData });

        clearInterval(intv);

        if (res.ok) {
          if (progCircle) progCircle.style.strokeDashoffset = "0";
          if (progText) progText.textContent = "100%";
          if (progLabel) progLabel.textContent = "Thành công!";
          setTimeout(() => {
            window.location.href = "/";
          }, 800);
        } else {
          throw new Error("Upload failed");
        }
      } catch (e) {
        alert("Có lỗi xảy ra, vui lòng thử lại");
        if (progressOverlay) progressOverlay.style.display = "none";
        isUploading = false;
      }
    };
  }
</script>

<style>
  .animate-fade-in-up {
    animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
