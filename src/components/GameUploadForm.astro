---
// Server-side component - all logic happens on client
---

<div class="card overflow-hidden animate-fade-in">
  <div class="p-8">
    <div class="flex items-center gap-4 mb-6">
      <div
        class="w-14 h-14 rounded-lg bg-indigo-100 flex items-center justify-center"
      >
        <svg
          class="w-7 h-7 text-indigo-600"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
          ></path>
        </svg>
      </div>
      <div class="flex-1">
        <h2 class="text-xl font-bold text-slate-900">T·∫£i Game M·ªõi</h2>
        <p class="text-slate-500 text-sm">Ch·ªçn file, th∆∞ m·ª•c ho·∫∑c file ZIP ƒë·ªÉ t·∫£i l√™n</p>
      </div>
    </div>

    <!-- 3-Step Flow -->
    <div class="mb-6 p-4 rounded-lg bg-blue-50 border border-blue-200">
      <div class="flex items-start gap-3 text-sm text-blue-800">
        <svg class="w-5 h-5 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div>
          <p class="font-semibold mb-1">Quy tr√¨nh t·∫£i l√™n:</p>
          <ol class="space-y-1 text-blue-700">
            <li><span class="font-medium">1.</span> Ch·ªçn ki·ªÉu t·∫£i l√™n (File / Th∆∞ m·ª•c / ZIP - khuy√™n d√πng)</li>
            <li><span class="font-medium">2.</span> Ch·ªçn g√≥i build (k√©o th·∫£ ho·∫∑c b·∫•m n√∫t ch·ªçn)</li>
            <li><span class="font-medium">3.</span> H·ªá th·ªëng ki·ªÉm tra & x√°c nh·∫≠n ‚Üí ƒêƒÉng b·∫£n build</li>
          </ol>
        </div>
      </div>
    </div>

    <!-- File Input Options -->
    <div class="mb-6">
      <label class="block text-sm font-medium text-slate-700 mb-3">
        Ch·ªçn ph∆∞∆°ng th·ª©c t·∫£i l√™n
      </label>

      <div class="grid grid-cols-3 gap-3 mb-4">
        <button
          type="button"
          id="selectFilesBtn"
          class="py-3 px-4 rounded-lg bg-white hover:bg-slate-50 border border-slate-200 hover:border-indigo-300 transition-all flex items-center justify-center gap-2"
        >
          <svg
            class="w-5 h-5 text-slate-500"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
            ></path>
          </svg>
          <span class="text-slate-700 text-sm font-medium">+ File</span>
        </button>
        <button
          type="button"
          id="selectFolderBtn"
          class="py-3 px-4 rounded-lg bg-white hover:bg-slate-50 border border-slate-200 hover:border-indigo-300 transition-all flex items-center justify-center gap-2"
        >
          <svg
            class="w-5 h-5 text-slate-500"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
            ></path>
          </svg>
          <span class="text-slate-700 text-sm font-medium">+ Th∆∞ m·ª•c</span>
        </button>
        <button
          type="button"
          id="selectZipBtn"
          class="relative py-3 px-4 rounded-lg bg-emerald-50 hover:bg-emerald-100 border border-emerald-200 hover:border-emerald-300 transition-all flex items-center justify-center gap-2"
        >
          <span class="absolute -top-2 -right-2 px-2 py-0.5 rounded-full text-xs font-semibold bg-emerald-600 text-white">Khuy√™n d√πng</span>
          <svg
            class="w-5 h-5 text-emerald-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 12l2 2 4-4"
            ></path>
          </svg>
          <span class="text-emerald-700 text-sm font-medium">üì¶ ZIP</span>
        </button>
      </div>

      <!-- Hidden file inputs -->
      <input type="file" id="fileInput" multiple class="hidden" />
      <input type="file" id="folderInput" multiple class="hidden" />
      <input type="file" id="zipInput" accept=".zip" class="hidden" />

      <!-- Drop Zone -->
      <div
        id="dropZone"
        class="relative border-2 border-dashed border-slate-300 rounded-lg p-8 text-center cursor-pointer
               hover:border-indigo-400 hover:bg-slate-50 transition-all"
      >
        <svg
          class="w-12 h-12 text-slate-400 mb-3 mx-auto"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="1.5"
            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
          ></path>
        </svg>
        <p id="dropZoneText" class="text-slate-600 font-medium">
          K√©o th·∫£ file, th∆∞ m·ª•c ho·∫∑c ZIP v√†o ƒë√¢y
        </p>
        <p id="dropZoneHint" class="text-slate-400 text-sm mt-1">
          Ho·∫∑c s·ª≠ d·ª•ng c√°c n√∫t ph√≠a tr√™n
        </p>
      </div>
    </div>

    <!-- File List -->
    <div id="fileListContainer" class="hidden mb-6">
      <div class="flex items-center justify-between mb-3">
        <h3
          class="text-sm font-semibold text-slate-700 flex items-center gap-2"
        >
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
            ></path>
          </svg>
          <span id="fileCountLabel">0 file ƒë√£ ch·ªçn</span>
        </h3>
        <button
          type="button"
          id="clearFilesBtn"
          class="text-xs text-red-600 hover:text-red-700 px-2 py-1 rounded hover:bg-red-50 transition-colors font-medium"
        >
          X√≥a t·∫•t c·∫£
        </button>
      </div>

      <div id="fileList" class="max-h-64 overflow-y-auto space-y-2 pr-2">
        <!-- File items will be rendered here -->
      </div>
    </div>

    <!-- Manifest Editor -->
    <div id="manifestEditor" class="hidden mb-6">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h3
            class="text-sm font-semibold text-indigo-700 flex items-center gap-2"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              ></path>
            </svg>
            C·∫•u h√¨nh Manifest
          </h3>
          <p id="manifestSource" class="text-xs text-slate-500 mt-1"></p>
        </div>
        <div class="flex items-center gap-2">
          <button
            type="button"
            id="toggleManifestView"
            class="text-xs text-slate-500 hover:text-slate-700 px-2 py-1 rounded hover:bg-slate-200 transition-colors font-medium"
          >
            Xem JSON
          </button>
        </div>
      </div>

      <!-- Manifest Form Fields -->
      <div
        id="manifestFields"
        class="p-5 rounded-lg bg-slate-50 border border-slate-200 space-y-5"
      >
        <!-- Th√¥ng tin c∆° b·∫£n -->
        <div>
          <h4 class="text-xs font-semibold text-slate-700 mb-3 uppercase tracking-wide">Th√¥ng tin c∆° b·∫£n</h4>
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-medium text-slate-600 mb-1.5"
                  >Game ID *</label
                >
                <input
                  type="text"
                  id="manifestId"
                  class="w-full bg-white border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  placeholder="com.iruka.my-awesome-game"
                />
                <p class="text-xs text-slate-500 mt-1">Format: com.iruka.&lt;slug&gt; v·ªõi kebab-case</p>
                <p id="gameIdWarning" class="hidden text-xs text-amber-600 mt-1 flex items-center gap-1">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-.834-1.964-.834-2.732 0L3.732 16c-.77 1.333.192 3 1.732 3z"></path>
                  </svg>
                  <span>V·ªõi game ƒë√£ t·ªìn t·∫°i, kh√¥ng n√™n ƒë·ªïi Game ID</span>
                </p>
              </div>
              <div>
                <label class="block text-xs font-medium text-slate-600 mb-1.5"
                  >Phi√™n b·∫£n *</label
                >
                <input
                  type="text"
                  id="manifestVersion"
                  class="w-full bg-white border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  placeholder="1.0.0"
                />
                <p class="text-xs text-slate-500 mt-1">M·ªói l·∫ßn ƒëƒÉng b·∫£n build m·ªõi, b·∫Øt bu·ªôc tƒÉng version (SemVer: x.y.z)</p>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-medium text-slate-600 mb-1.5"
                  >T√™n game *</label
                >
                <input
                  type="text"
                  id="manifestTitle"
                  class="w-full bg-white border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  placeholder="My Awesome Game"
                />
                <p class="text-xs text-slate-500 mt-1">T√™n n√†y s·∫Ω hi·ªÉn th·ªã tr√™n Game Hub v√† cho ph·ª• huynh/h·ªçc sinh</p>
              </div>
              <div>
                <label class="block text-xs font-medium text-slate-600 mb-1.5"
                  >Runtime *</label
                >
                <select
                  id="manifestRuntime"
                  class="w-full bg-white border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                >
                  <option value="iframe-html">iframe-html - Game web th√¥ng th∆∞·ªùng</option>
                  <option value="esm-module">esm-module - Module JavaScript</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- T√≠nh nƒÉng & t√≠ch h·ª£p -->
        <div class="pt-4 border-t border-slate-200">
          <h4 class="text-xs font-semibold text-slate-700 mb-3 uppercase tracking-wide">T√≠nh nƒÉng & t√≠ch h·ª£p</h4>
          <div>
            <label class="block text-xs font-medium text-slate-600 mb-2"
              >Kh·∫£ nƒÉng (Capabilities)</label
            >
            <div id="capabilitiesSelector" class="flex flex-wrap gap-2 mb-2">
              <!-- Capability tags will be rendered here -->
            </div>
            <input
              type="hidden"
              id="manifestCapabilities"
            />
            <p class="text-xs text-slate-500">Ch·ªçn c√°c kh·∫£ nƒÉng game s·ª≠ d·ª•ng (c√≥ th·ªÉ ch·ªçn nhi·ªÅu)</p>
          </div>
        </div>
      </div>

      <!-- Raw JSON View (hidden by default) -->
      <div id="manifestJsonView" class="hidden">
        <textarea
          id="manifestJsonText"
          class="w-full h-48 bg-white border border-slate-200 rounded-lg p-4 text-sm text-slate-700 font-mono resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500"
          placeholder='{"id": "...", "version": "..."}'></textarea>
      </div>
    </div>

    <!-- Status Message -->
    <div
      id="statusMessage"
      class="hidden mb-6 p-4 rounded-lg text-sm font-medium"
    >
    </div>

    <!-- Validation Details -->
    <div id="validationDetails" class="hidden mb-6">
      <!-- Errors -->
      <div id="validationErrors" class="hidden mb-4 p-4 rounded-lg bg-red-50 border border-red-200">
        <h4 class="text-sm font-semibold text-red-800 mb-2 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          L·ªói c·∫ßn s·ª≠a
        </h4>
        <ul id="errorsList" class="text-sm text-red-700 space-y-1"></ul>
      </div>

      <!-- Warnings -->
      <div id="validationWarnings" class="hidden mb-4 p-4 rounded-lg bg-amber-50 border border-amber-200">
        <h4 class="text-sm font-semibold text-amber-800 mb-2 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
          C·∫£nh b√°o
        </h4>
        <ul id="warningsList" class="text-sm text-amber-700 space-y-1"></ul>
      </div>

      <!-- Suggestions -->
      <div id="validationSuggestions" class="hidden mb-4 p-4 rounded-lg bg-blue-50 border border-blue-200">
        <h4 class="text-sm font-semibold text-blue-800 mb-2 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
          </svg>
          G·ª£i √Ω c·∫£i thi·ªán
        </h4>
        <ul id="suggestionsList" class="text-sm text-blue-700 space-y-1"></ul>
      </div>
    </div>

    <!-- Progress Bar -->
    <div id="progressContainer" class="hidden mb-6">
      <div class="flex justify-between text-sm text-slate-500 mb-2">
        <span id="progressLabel">ƒêang t·∫£i l√™n...</span>
        <span id="progressPercent">0%</span>
      </div>
      <div class="h-2 bg-slate-200 rounded-full overflow-hidden mb-3">
        <div
          id="progressBar"
          class="h-full bg-indigo-600 rounded-full transition-all duration-300"
          style="width: 0%"
        >
        </div>
      </div>
      
      <!-- Folder Progress Details -->
      <div id="folderProgress" class="space-y-2 text-xs">
        <!-- Folder progress items will be inserted here -->
      </div>
    </div>

    <!-- Submit Button -->
    <button
      id="uploadBtn"
      type="button"
      disabled
      class="w-full py-3.5 rounded-lg font-semibold text-white text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed
             bg-indigo-600 hover:bg-indigo-700 shadow-sm hover:shadow-md"
    >
      <span id="uploadBtnText">Ch·ªçn file tr∆∞·ªõc</span>
    </button>
  </div>

  <!-- Instructions -->
  <div class="px-8 pb-8">
    <div class="p-5 rounded-lg bg-slate-50 border border-slate-200">
      <h3
        class="text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2"
      >
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path>
        </svg>
        Y√™u c·∫ßu t·∫£i l√™n
      </h3>
      <ul id="requirementsList" class="space-y-2 text-sm text-slate-600">
        <li class="flex items-start gap-2" data-check="index-html">
          <span class="check-icon text-slate-400 mt-0.5">‚óã</span>
          <span
            >Ph·∫£i ch·ª©a file <code
              class="bg-slate-200 px-1.5 py-0.5 rounded text-xs"
              >index.html</code
            > l√†m ƒëi·ªÉm v√†o</span
          >
        </li>
        <li class="flex items-start gap-2" data-check="manifest-json">
          <span class="check-icon text-slate-400 mt-0.5">‚óã</span>
          <span
            >Ph·∫£i c√≥ <code
              class="bg-slate-200 px-1.5 py-0.5 rounded text-xs"
              >manifest.json</code
            > ·ªü th∆∞ m·ª•c g·ªëc, ch·ª©a ƒë·ªß: id, title, version, runtime</span
          >
        </li>
        <li class="flex items-start gap-2" data-check="game-id">
          <span class="check-icon text-slate-400 mt-0.5">‚óã</span>
          <span
            >Game ID theo format <code
              class="bg-slate-200 px-1.5 py-0.5 rounded text-xs"
              >com.iruka.&lt;slug&gt;</code
            > v·ªõi kebab-case</span
          >
        </li>
        <li class="flex items-start gap-2" data-check="game-title">
          <span class="check-icon text-slate-400 mt-0.5">‚óã</span>
          <span
            >T√™n game 3-40 k√Ω t·ª±, Title Case, kh√¥ng emoji</span
          >
        </li>
        <li class="flex items-start gap-2" data-check="version">
          <span class="check-icon text-slate-400 mt-0.5">‚óã</span>
          <span
            >Version theo SemVer (v√≠ d·ª•: <code
              class="bg-slate-200 px-1.5 py-0.5 rounded text-xs">1.0.0</code
            >), khuy·∫øn ngh·ªã stable cho production</span
          >
        </li>
        <li class="flex items-start gap-2" data-check="file-size">
          <span class="check-icon text-slate-400 mt-0.5">‚óã</span>
          <span
            >Dung l∆∞·ª£ng ZIP: khuy·∫øn ngh·ªã &lt; 3 MB ƒë·ªÉ t·∫£i nhanh cho v√πng m·∫°ng y·∫øu</span
          >
        </li>
        <li class="flex items-start gap-2">
          <span class="text-blue-600 mt-0.5">üì¶</span>
          <span
            >File ZIP ƒë∆∞·ª£c t·ª± ƒë·ªông gi·∫£i n√©n & validate theo chu·∫©n Iruka</span
          >
        </li>
        <li class="flex items-start gap-2">
          <span class="text-purple-600 mt-0.5">üõ†Ô∏è</span>
          <span
            >D√†nh cho dev: d√πng <code
              class="bg-slate-200 px-1.5 py-0.5 rounded text-xs"
              >pnpm iruka-game:validate &lt;folder&gt;</code
            > ƒë·ªÉ ki·ªÉm tra tr∆∞·ªõc khi upload</span
          >
        </li>
      </ul>
      <div id="requirementsSummary" class="hidden mt-3 pt-3 border-t border-slate-200 text-sm font-medium">
        <!-- Summary will be inserted here -->
      </div>
    </div>
  </div>
</div>

<script>
  interface FileItem {
    file: File;
    name: string;
    path: string;
    folder: string;
    type: "file" | "folder";
    size: number;
    status: "pending" | "uploading" | "success" | "error";
    errorMessage?: string;
  }

  // DOM Elements
  const fileInput = document.getElementById("fileInput") as HTMLInputElement;
  const folderInput = document.getElementById("folderInput") as HTMLInputElement;
  const zipInput = document.getElementById("zipInput") as HTMLInputElement;
  const selectFilesBtn = document.getElementById("selectFilesBtn") as HTMLButtonElement;
  const selectFolderBtn = document.getElementById("selectFolderBtn") as HTMLButtonElement;
  const selectZipBtn = document.getElementById("selectZipBtn") as HTMLButtonElement;
  const dropZone = document.getElementById("dropZone") as HTMLDivElement;
  const fileListContainer = document.getElementById("fileListContainer") as HTMLDivElement;
  const fileList = document.getElementById("fileList") as HTMLDivElement;
  const fileCountLabel = document.getElementById("fileCountLabel") as HTMLSpanElement;
  const clearFilesBtn = document.getElementById("clearFilesBtn") as HTMLButtonElement;
  const manifestEditor = document.getElementById("manifestEditor") as HTMLDivElement;
  const manifestFields = document.getElementById("manifestFields") as HTMLDivElement;
  const manifestJsonView = document.getElementById("manifestJsonView") as HTMLDivElement;
  const manifestJsonText = document.getElementById("manifestJsonText") as HTMLTextAreaElement;
  const toggleManifestView = document.getElementById("toggleManifestView") as HTMLButtonElement;
  const uploadBtn = document.getElementById("uploadBtn") as HTMLButtonElement;
  const uploadBtnText = document.getElementById("uploadBtnText") as HTMLSpanElement;
  const statusMessage = document.getElementById("statusMessage") as HTMLDivElement;
  const progressContainer = document.getElementById("progressContainer") as HTMLDivElement;
  const progressBar = document.getElementById("progressBar") as HTMLDivElement;
  const progressPercent = document.getElementById("progressPercent") as HTMLSpanElement;
  const progressLabel = document.getElementById("progressLabel") as HTMLSpanElement;

  // State
  let fileItems: FileItem[] = [];
  let manifestData: any = null;
  let isJsonView = false;
  let isZipMode = false;
  let zipFile: File | null = null;
  let selectedCapabilities: string[] = [];
  let manifestFromFile = false;

  // Available capabilities
  const AVAILABLE_CAPABILITIES = [
    { id: 'score', label: 'Score', icon: 'üéØ' },
    { id: 'save-progress', label: 'Save Progress', icon: 'üíæ' },
    { id: 'levels', label: 'Levels', icon: 'üéÆ' },
    { id: 'hints', label: 'Hints', icon: 'üí°' },
    { id: 'audio', label: 'Audio', icon: 'üîä' },
    { id: 'telemetry', label: 'Telemetry', icon: 'üìä' },
    { id: 'leaderboard', label: 'Leaderboard', icon: 'üèÜ' }
  ];

  // Utility functions
  function formatFileSize(bytes: number): string {
    if (bytes === 0) return "0 B";
    const k = 1024;
    const sizes = ["B", "KB", "MB", "GB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
  }

  function getFileIcon(fileName: string): string {
    const ext = fileName.split(".").pop()?.toLowerCase();
    if (["html", "htm"].includes(ext || "")) return "üìÑ";
    if (["js", "mjs", "ts"].includes(ext || "")) return "üìú";
    if (["css", "scss", "less"].includes(ext || "")) return "üé®";
    if (["json"].includes(ext || "")) return "üìã";
    if (["png", "jpg", "jpeg", "gif", "svg", "webp"].includes(ext || "")) return "üñºÔ∏è";
    if (["mp3", "wav", "ogg"].includes(ext || "")) return "üîä";
    if (["mp4", "webm"].includes(ext || "")) return "üé¨";
    if (["woff", "woff2", "ttf", "otf"].includes(ext || "")) return "üî§";
    if (["zip"].includes(ext || "")) return "üì¶";
    return "üìÅ";
  }

  function getStatusBadge(status: FileItem["status"], isValidating: boolean = false): string {
    if (isValidating && status === "pending") {
      return '<span class="px-2 py-0.5 rounded text-xs bg-blue-50 text-blue-700 font-medium flex items-center gap-1"><svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>ƒêang ki·ªÉm tra...</span>';
    }
    switch (status) {
      case "pending":
        return '<span class="px-2 py-0.5 rounded text-xs bg-slate-200 text-slate-600 font-medium">Ch·ªù x·ª≠ l√Ω</span>';
      case "uploading":
        return '<span class="px-2 py-0.5 rounded text-xs bg-blue-50 text-blue-700 font-medium animate-pulse">ƒêang t·∫£i...</span>';
      case "success":
        return '<span class="px-2 py-0.5 rounded text-xs bg-emerald-50 text-emerald-700 font-medium">‚úÖ H·ª£p l·ªá</span>';
      case "error":
        return '<span class="px-2 py-0.5 rounded text-xs bg-red-50 text-red-700 font-medium">‚ùå L·ªói</span>';
      default:
        return "";
    }
  }

  function renderCapabilitiesSelector() {
    const container = document.getElementById('capabilitiesSelector');
    if (!container) return;

    container.innerHTML = AVAILABLE_CAPABILITIES.map(cap => {
      const isSelected = selectedCapabilities.includes(cap.id);
      return `
        <button
          type="button"
          class="capability-tag px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
            isSelected
              ? 'bg-indigo-100 text-indigo-700 border-2 border-indigo-300'
              : 'bg-white text-slate-600 border border-slate-300 hover:border-indigo-300 hover:bg-slate-50'
          }"
          data-capability="${cap.id}"
        >
          <span class="mr-1">${cap.icon}</span>
          ${cap.label}
        </button>
      `;
    }).join('');

    // Attach click handlers
    container.querySelectorAll('.capability-tag').forEach(btn => {
      btn.addEventListener('click', () => {
        const capId = (btn as HTMLElement).dataset.capability!;
        toggleCapability(capId);
      });
    });
  }

  function toggleCapability(capId: string) {
    const index = selectedCapabilities.indexOf(capId);
    if (index > -1) {
      selectedCapabilities.splice(index, 1);
    } else {
      selectedCapabilities.push(capId);
    }
    renderCapabilitiesSelector();
    updateManifestFromFields();
  }

  function updateRequirementsChecklist() {
    const checks = {
      'index-html': false,
      'manifest-json': false,
      'game-id': false,
      'game-title': false,
      'version': false,
      'file-size': false
    };

    // Check index.html
    if (fileItems.some(f => f.name === 'index.html' || f.path?.endsWith('/index.html'))) {
      checks['index-html'] = true;
    }

    // Check manifest data
    if (manifestData) {
      if (manifestData.id && manifestData.id.startsWith('com.iruka.')) {
        checks['game-id'] = true;
      }
      if (manifestData.title && manifestData.title.length >= 3 && manifestData.title.length <= 40) {
        checks['game-title'] = true;
      }
      if (manifestData.version && /^\d+\.\d+\.\d+/.test(manifestData.version)) {
        checks['version'] = true;
      }
      checks['manifest-json'] = true;
    }

    // Check file size
    const totalSize = fileItems.reduce((sum, item) => sum + item.size, 0);
    let fileSizeCheck: boolean | string = false;
    if (totalSize > 0 && totalSize < 3 * 1024 * 1024) {
      fileSizeCheck = true;
    } else if (totalSize > 0) {
      // Show warning but don't fail
      fileSizeCheck = 'warning';
    }
    checks['file-size'] = fileSizeCheck as any;

    // Update UI
    Object.entries(checks).forEach(([checkId, passed]) => {
      const li = document.querySelector(`[data-check="${checkId}"]`);
      if (!li) return;

      const icon = li.querySelector('.check-icon');
      if (!icon) return;

      if (passed === true) {
        icon.textContent = '‚úÖ';
        icon.className = 'check-icon text-emerald-600 mt-0.5';
      } else if (typeof passed === 'string' && passed === 'warning') {
        icon.textContent = '‚ö†Ô∏è';
        icon.className = 'check-icon text-amber-600 mt-0.5';
      } else if (fileItems.length > 0 || manifestData) {
        icon.textContent = '‚ùå';
        icon.className = 'check-icon text-red-600 mt-0.5';
      } else {
        icon.textContent = '‚óã';
        icon.className = 'check-icon text-slate-400 mt-0.5';
      }
    });

    // Update summary
    const summary = document.getElementById('requirementsSummary');
    if (summary && (fileItems.length > 0 || manifestData)) {
      const passedCount = Object.values(checks).filter(v => v === true).length;
      const totalCount = Object.keys(checks).length;
      const hasErrors = Object.values(checks).some(v => v === false && (fileItems.length > 0 || manifestData));

      summary.classList.remove('hidden');
      if (hasErrors) {
        summary.className = 'mt-3 pt-3 border-t border-slate-200 text-sm font-medium text-red-700';
        summary.innerHTML = `K·∫øt qu·∫£ ki·ªÉm tra: ${passedCount}/${totalCount} y√™u c·∫ßu ƒë·∫°t ‚Äì Vui l√≤ng s·ª≠a c√°c l·ªói ·ªü tr√™n`;
      } else {
        summary.className = 'mt-3 pt-3 border-t border-slate-200 text-sm font-medium text-emerald-700';
        summary.innerHTML = `‚úÖ K·∫øt qu·∫£ ki·ªÉm tra: ${passedCount}/${totalCount} y√™u c·∫ßu ƒë·∫°t`;
      }
    } else if (summary) {
      summary.classList.add('hidden');
    }
  }

  function showStatus(message: string, type: "error" | "success" | "info" | "warning") {
    statusMessage.classList.remove("hidden");
    statusMessage.className = `mb-6 p-4 rounded-lg text-sm font-medium ${
      type === "error"
        ? "bg-red-50 text-red-700 border border-red-200"
        : type === "success"
          ? "bg-emerald-50 text-emerald-700 border border-emerald-200"
          : type === "warning"
            ? "bg-amber-50 text-amber-700 border border-amber-200"
            : "bg-blue-50 text-blue-700 border border-blue-200"
    }`;
    statusMessage.textContent = message;
  }

  function hideStatus() {
    statusMessage.classList.add("hidden");
  }

  function renderFileList() {
    if (fileItems.length === 0) {
      fileListContainer.classList.add("hidden");
      return;
    }

    fileListContainer.classList.remove("hidden");
    
    if (isZipMode) {
      fileCountLabel.textContent = `File ZIP: ${zipFile?.name || 'Unknown'}`;
    } else {
      fileCountLabel.textContent = `${fileItems.length} file ƒë√£ ch·ªçn`;
    }

    fileList.innerHTML = fileItems
      .map((item, index) => `
        <div class="flex items-center justify-between py-2.5 px-4 rounded-lg bg-slate-50 hover:bg-slate-200 transition-colors group" data-index="${index}">
          <div class="flex items-center gap-3 min-w-0 flex-1">
            <span class="text-lg">${getFileIcon(item.name)}</span>
            <div class="min-w-0 flex-1">
              <p class="text-sm text-slate-900 truncate" title="${item.path || item.name}">${item.name}</p>
              <p class="text-xs text-slate-500">${formatFileSize(item.size)}${isZipMode ? ' ‚Ä¢ S·∫Ω ƒë∆∞·ª£c gi·∫£i n√©n' : (item.path ? ` ‚Ä¢ ${item.path}` : "")}</p>
            </div>
          </div>
          <div class="flex items-center gap-2 shrink-0">
            ${getStatusBadge(item.status)}
            ${!isZipMode ? `
              <button 
                class="remove-file-btn opacity-0 group-hover:opacity-100 p-1.5 rounded-md text-red-500 hover:text-red-600 hover:bg-red-50 transition-all"
                data-index="${index}"
                title="X√≥a file"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            ` : ''}
          </div>
        </div>
      `)
      .join("");

    // Attach remove handlers for non-ZIP mode
    if (!isZipMode) {
      fileList.querySelectorAll(".remove-file-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const index = parseInt((e.currentTarget as HTMLElement).dataset.index || "0");
          removeFile(index);
        });
      });
    }
  }

  function removeFile(index: number) {
    fileItems.splice(index, 1);
    renderFileList();
    validateAndUpdateUI();
  }

  function clearAllFiles() {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a g√≥i upload hi·ªán t·∫°i kh√¥ng?')) {
      return;
    }
    
    fileItems = [];
    manifestData = null;
    isZipMode = false;
    zipFile = null;
    manifestFromFile = false;
    selectedCapabilities = [];
    renderFileList();
    renderCapabilitiesSelector();
    manifestEditor.classList.add("hidden");
    uploadBtn.disabled = true;
    uploadBtnText.textContent = "Ch·ªçn file tr∆∞·ªõc";
    hideStatus();
    updateRequirementsChecklist();
  }

  async function processFiles(files: File[]) {
    const newItems: FileItem[] = files.map((file) => {
      const relativePath = (file as any).webkitRelativePath || "";
      const pathParts = relativePath.split('/');
      
      // Determine folder: remove top-level folder (e.g., 'dist') and get folder structure
      let folder = "root";
      if (pathParts.length > 1) {
        const cleanPath = pathParts.slice(1).join('/');
        if (cleanPath.includes('/')) {
          folder = cleanPath.split('/').slice(0, -1).join('/');
        }
      }

      return {
        file,
        name: file.name,
        path: relativePath,
        folder,
        type: "file" as const,
        size: file.size,
        status: "pending" as const,
      };
    });

    fileItems = [...fileItems, ...newItems];
    renderFileList();
    await validateAndUpdateUI();
  }

  async function processZipFile(file: File) {
    if (!file.name.toLowerCase().endsWith('.zip')) {
      showStatus('Vui l√≤ng ch·ªçn file ZIP h·ª£p l·ªá', 'error');
      return;
    }

    // Clear existing files and switch to ZIP mode
    fileItems = [];
    isZipMode = true;
    zipFile = file;
    manifestFromFile = false;

    // Create a virtual file item for the ZIP
    const zipItem: FileItem = {
      file,
      name: file.name,
      path: file.name,
      folder: "root",
      type: "file" as const,
      size: file.size,
      status: "pending" as const,
    };

    fileItems = [zipItem];
    renderFileList();

    // Check file size
    const sizeMB = file.size / (1024 * 1024);
    if (sizeMB > 3) {
      showStatus(
        `‚ö†Ô∏è File ZIP c√≥ dung l∆∞·ª£ng ${sizeMB.toFixed(1)} MB (khuy·∫øn ngh·ªã < 3 MB). Game c√≥ th·ªÉ t·∫£i ch·∫≠m tr√™n m·∫°ng y·∫øu.`,
        'warning'
      );
    } else {
      showStatus(
        `ƒê√£ ch·ªçn file ZIP: ${file.name} (${formatFileSize(file.size)}). ƒêang ki·ªÉm tra...`,
        'info'
      );
    }

    // Show manifest editor for ZIP mode
    manifestEditor.classList.remove("hidden");
    manifestData = null;
    selectedCapabilities = [];
    renderCapabilitiesSelector();
    updateManifestSourceIndicator();
    updateManifestFromFields();
    updateRequirementsChecklist();
  }

  async function validateAndUpdateUI() {
    hideStatus();
    hideValidationDetails();
    updateRequirementsChecklist();

    if (fileItems.length === 0) {
      manifestEditor.classList.add("hidden");
      uploadBtn.disabled = true;
      uploadBtnText.textContent = "Ch·ªçn file tr∆∞·ªõc";
      return;
    }

    if (isZipMode) {
      // ZIP mode - always show manifest editor
      manifestEditor.classList.remove("hidden");
      updateManifestSourceIndicator();
      
      if (manifestData && manifestData.id && manifestData.version) {
        // Validate manifest data for ZIP mode
        const manifestContent = JSON.stringify(manifestData);
        await validateManifestContent(manifestContent);
        
        uploadBtn.disabled = false;
        uploadBtnText.textContent = `T·∫£i l√™n ZIP: ${manifestData.title || manifestData.id} v${manifestData.version}`;
      } else {
        uploadBtn.disabled = true;
        uploadBtnText.textContent = "Ho√†n th√†nh manifest tr∆∞·ªõc";
      }
      return;
    }

    const hasIndex = fileItems.some(
      (f) => f.name === "index.html" || f.path?.endsWith("/index.html")
    );
    const manifestFile = fileItems.find(
      (f) => f.name === "manifest.json" || f.path?.endsWith("/manifest.json")
    );

    if (!hasIndex) {
      showStatus("‚ùå Thi·∫øu file 'index.html'. ƒê√¢y l√† ƒëi·ªÉm v√†o b·∫Øt bu·ªôc.", "warning");
      manifestEditor.classList.add("hidden");
      uploadBtn.disabled = true;
      uploadBtnText.textContent = "Thi·∫øu index.html";
      return;
    }

    if (!manifestFile) {
      showStatus("Kh√¥ng t√¨m th·∫•y manifest.json. Vui l√≤ng ƒëi·ªÅn th√¥ng tin b√™n d∆∞·ªõi.", "info");
      manifestEditor.classList.remove("hidden");
      manifestFromFile = false;
      manifestData = null;
      selectedCapabilities = [];
      renderCapabilitiesSelector();
      updateManifestSourceIndicator();
      updateManifestFromFields();
      return;
    }

    try {
      manifestFromFile = true;
      const content = await manifestFile.file.text();
      await validateManifestContent(content);
      updateManifestSourceIndicator();
    } catch (err) {
      showStatus("Kh√¥ng th·ªÉ ƒë·ªçc file manifest.json", "error");
      manifestEditor.classList.remove("hidden");
      uploadBtn.disabled = true;
      uploadBtnText.textContent = "S·ª≠a manifest";
    }
  }

  async function validateManifestContent(content: string) {
    try {
      // Import enhanced validator dynamically (since it's not available in browser)
      // For now, use basic validation and enhance later
      const manifest = JSON.parse(content);
      manifestData = manifest;

      manifestEditor.classList.remove("hidden");
      populateManifestFields(manifest);
      updateManifestJson();
      updateRequirementsChecklist();

      // Enhanced validation
      const validation = await performEnhancedValidation(content);
      
      if (validation.errors.length > 0) {
        showValidationDetails(validation);
        uploadBtn.disabled = true;
        uploadBtnText.textContent = "S·ª≠a l·ªói manifest";
        return;
      }

      if (validation.warnings.length > 0 || validation.suggestions.length > 0) {
        showValidationDetails(validation);
      }

      if (!manifest.id || !manifest.version) {
        showStatus("Manifest thi·∫øu c√°c tr∆∞·ªùng b·∫Øt bu·ªôc. Vui l√≤ng ho√†n th√†nh form.", "warning");
        uploadBtn.disabled = true;
        uploadBtnText.textContent = "Ho√†n th√†nh manifest tr∆∞·ªõc";
        return;
      }

      showStatus(`‚úÖ S·∫µn s√†ng t·∫£i l√™n ${isZipMode ? 'file ZIP' : `${fileItems.length} file`}`, "info");
      uploadBtn.disabled = false;
      uploadBtnText.textContent = `T·∫£i l√™n ${manifest.title || manifest.id} v${manifest.version}`;
    } catch (err) {
      showStatus("JSON trong manifest.json kh√¥ng h·ª£p l·ªá. Vui l√≤ng s·ª≠a ho·∫∑c ch·ªânh s·ª≠a b√™n d∆∞·ªõi.", "error");
      manifestEditor.classList.remove("hidden");
      uploadBtn.disabled = true;
      uploadBtnText.textContent = "S·ª≠a manifest";
    }
  }

  async function performEnhancedValidation(content: string) {
    // Basic client-side validation (enhanced validation will be done on server)
    const errors: string[] = [];
    const warnings: string[] = [];
    const suggestions: string[] = [];

    try {
      const manifest = JSON.parse(content);

      // ID validation
      if (!manifest.id) {
        errors.push("Thi·∫øu tr∆∞·ªùng b·∫Øt bu·ªôc: id");
      } else if (!manifest.id.startsWith('com.iruka.')) {
        errors.push("ID ph·∫£i b·∫Øt ƒë·∫ßu v·ªõi 'com.iruka.'");
        suggestions.push("V√≠ d·ª•: com.iruka.my-awesome-game");
      } else {
        const slug = manifest.id.replace('com.iruka.', '');
        if (slug.includes('--')) {
          errors.push("ID kh√¥ng ƒë∆∞·ª£c c√≥ hai d·∫•u g·∫°ch ngang li·ªÅn nhau");
        }
        if (slug.includes('_')) {
          errors.push("ID kh√¥ng ƒë∆∞·ª£c c√≥ d·∫•u g·∫°ch d∆∞·ªõi, s·ª≠ d·ª•ng d·∫•u g·∫°ch ngang");
        }
        if (!/^[a-z0-9-]+$/.test(slug)) {
          errors.push("Slug ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ th∆∞·ªùng, s·ªë v√† d·∫•u g·∫°ch ngang");
        }
      }

      // Title validation
      if (!manifest.title) {
        errors.push("Thi·∫øu tr∆∞·ªùng b·∫Øt bu·ªôc: title");
      } else {
        if (manifest.title.length < 3 || manifest.title.length > 40) {
          errors.push("T√™n game ph·∫£i c√≥ ƒë·ªô d√†i 3-40 k√Ω t·ª±");
        }
        if (manifest.title !== manifest.title.trim()) {
          errors.push("T√™n game kh√¥ng ƒë∆∞·ª£c c√≥ kho·∫£ng tr·∫Øng ·ªü ƒë·∫ßu ho·∫∑c cu·ªëi");
        }
        if (manifest.title === manifest.title.toUpperCase() && manifest.title.length > 1) {
          errors.push("T√™n game kh√¥ng ƒë∆∞·ª£c vi·∫øt to√†n ch·ªØ HOA");
          suggestions.push(`G·ª£i √Ω: "${toTitleCase(manifest.title)}"`);
        }
        // Check for emojis (basic)
        if (/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]/gu.test(manifest.title)) {
          errors.push("T√™n game kh√¥ng ƒë∆∞·ª£c ch·ª©a emoji");
        }
      }

      // Version validation
      if (!manifest.version) {
        errors.push("Thi·∫øu tr∆∞·ªùng b·∫Øt bu·ªôc: version");
      } else if (!/^\d+\.\d+\.\d+/.test(manifest.version)) {
        errors.push("Version ph·∫£i theo chu·∫©n Semantic Versioning (x.y.z)");
        suggestions.push("V√≠ d·ª•: 1.0.0");
      } else {
        if (manifest.version.includes('-') || manifest.version.includes('+')) {
          warnings.push("Version c√≥ prerelease/build metadata. Khuy·∫øn ngh·ªã s·ª≠ d·ª•ng stable cho production");
        }
        if (manifest.version.startsWith('0.')) {
          warnings.push("Version 0.x.x cho th·∫•y game ƒëang ph√°t tri·ªÉn. C√¢n nh·∫Øc 1.0.0+ cho production");
        }
      }

      // Runtime validation
      if (!manifest.runtime) {
        errors.push("Thi·∫øu tr∆∞·ªùng b·∫Øt bu·ªôc: runtime");
      } else if (!['iframe-html', 'esm-module'].includes(manifest.runtime)) {
        errors.push("Runtime ph·∫£i l√† 'iframe-html' ho·∫∑c 'esm-module'");
      }

      // Capabilities validation
      if (manifest.capabilities && Array.isArray(manifest.capabilities)) {
        const validCaps = ['score', 'save-progress', 'levels', 'hints', 'audio', 'telemetry', 'leaderboard'];
        const invalid = manifest.capabilities.filter((cap: string) => !validCaps.includes(cap));
        if (invalid.length > 0) {
          errors.push(`Capabilities kh√¥ng h·ª£p l·ªá: ${invalid.join(', ')}`);
          suggestions.push(`Ch·ªâ s·ª≠ d·ª•ng: ${validCaps.join(', ')}`);
        }
      }

    } catch (e) {
      errors.push("JSON kh√¥ng h·ª£p l·ªá");
    }

    return { errors, warnings, suggestions };
  }

  function toTitleCase(str: string): string {
    return str.replace(/\w\S*/g, (txt) => 
      txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
    );
  }

  function showValidationDetails(validation: {errors: string[], warnings: string[], suggestions: string[]}) {
    const validationDetails = document.getElementById('validationDetails');
    const errorsDiv = document.getElementById('validationErrors');
    const warningsDiv = document.getElementById('validationWarnings');
    const suggestionsDiv = document.getElementById('validationSuggestions');
    const errorsList = document.getElementById('errorsList');
    const warningsList = document.getElementById('warningsList');
    const suggestionsList = document.getElementById('suggestionsList');

    if (!validationDetails) return;

    validationDetails.classList.remove('hidden');

    // Show errors
    if (validation.errors.length > 0 && errorsDiv && errorsList) {
      errorsDiv.classList.remove('hidden');
      errorsList.innerHTML = validation.errors.map(error => `<li>‚Ä¢ ${error}</li>`).join('');
    } else if (errorsDiv) {
      errorsDiv.classList.add('hidden');
    }

    // Show warnings
    if (validation.warnings.length > 0 && warningsDiv && warningsList) {
      warningsDiv.classList.remove('hidden');
      warningsList.innerHTML = validation.warnings.map(warning => `<li>‚Ä¢ ${warning}</li>`).join('');
    } else if (warningsDiv) {
      warningsDiv.classList.add('hidden');
    }

    // Show suggestions
    if (validation.suggestions.length > 0 && suggestionsDiv && suggestionsList) {
      suggestionsDiv.classList.remove('hidden');
      suggestionsList.innerHTML = validation.suggestions.map(suggestion => `<li>‚Ä¢ ${suggestion}</li>`).join('');
    } else if (suggestionsDiv) {
      suggestionsDiv.classList.add('hidden');
    }
  }

  function hideValidationDetails() {
    const validationDetails = document.getElementById('validationDetails');
    if (validationDetails) {
      validationDetails.classList.add('hidden');
    }
  }

  function populateManifestFields(manifest: any) {
    (document.getElementById("manifestId") as HTMLInputElement).value = manifest.id || "";
    (document.getElementById("manifestVersion") as HTMLInputElement).value = manifest.version || "";
    (document.getElementById("manifestTitle") as HTMLInputElement).value = manifest.title || "";
    (document.getElementById("manifestRuntime") as HTMLSelectElement).value = manifest.runtime || "iframe-html";
    
    // Set capabilities
    selectedCapabilities = Array.isArray(manifest.capabilities) ? manifest.capabilities : [];
    renderCapabilitiesSelector();
  }

  function getManifestFromFields(): any {
    const id = (document.getElementById("manifestId") as HTMLInputElement).value.trim();
    const version = (document.getElementById("manifestVersion") as HTMLInputElement).value.trim();
    const title = (document.getElementById("manifestTitle") as HTMLInputElement).value.trim();
    const runtime = (document.getElementById("manifestRuntime") as HTMLSelectElement).value;

    return { 
      id, 
      version, 
      title, 
      runtime, 
      capabilities: selectedCapabilities.length > 0 ? selectedCapabilities : undefined 
    };
  }

  function updateManifestFromFields() {
    manifestData = getManifestFromFields();
    updateManifestJson();
    updateRequirementsChecklist();

    if (manifestData.id && manifestData.version) {
      uploadBtn.disabled = false;
      const buttonText = isZipMode 
        ? `T·∫£i l√™n ZIP: ${manifestData.title || manifestData.id} v${manifestData.version}`
        : `T·∫£i l√™n ${manifestData.title || manifestData.id} v${manifestData.version}`;
      uploadBtnText.textContent = buttonText;
      showStatus(`S·∫µn s√†ng t·∫£i l√™n ${isZipMode ? 'file ZIP' : `${fileItems.length} file`}`, "info");
    } else {
      uploadBtn.disabled = true;
      uploadBtnText.textContent = "Ho√†n th√†nh manifest tr∆∞·ªõc";
    }
  }

  function updateManifestSourceIndicator() {
    const sourceEl = document.getElementById('manifestSource');
    if (!sourceEl) return;

    if (manifestFromFile) {
      sourceEl.innerHTML = '‚úÖ ƒê√£ ƒë·ªçc t·ª± ƒë·ªông t·ª´ manifest.json trong file ZIP';
      sourceEl.className = 'text-xs text-emerald-600 mt-1';
    } else if (isZipMode) {
      sourceEl.innerHTML = '‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y manifest.json. Vui l√≤ng nh·∫≠p c·∫•u h√¨nh m·ªõi cho game.';
      sourceEl.className = 'text-xs text-amber-600 mt-1';
    } else {
      sourceEl.innerHTML = 'Vui l√≤ng ƒëi·ªÅn th√¥ng tin manifest cho game';
      sourceEl.className = 'text-xs text-slate-500 mt-1';
    }
  }

  function updateManifestJson() {
    manifestJsonText.value = JSON.stringify(manifestData, null, 2);
  }

  function updateManifestFromJson() {
    try {
      manifestData = JSON.parse(manifestJsonText.value);
      populateManifestFields(manifestData);

      if (manifestData.id && manifestData.version) {
        uploadBtn.disabled = false;
        const buttonText = isZipMode 
          ? `T·∫£i l√™n ZIP: ${manifestData.title || manifestData.id} v${manifestData.version}`
          : `T·∫£i l√™n ${manifestData.title || manifestData.id} v${manifestData.version}`;
        uploadBtnText.textContent = buttonText;
        showStatus(`S·∫µn s√†ng t·∫£i l√™n ${isZipMode ? 'file ZIP' : `${fileItems.length} file`}`, "info");
      } else {
        uploadBtn.disabled = true;
        uploadBtnText.textContent = "Ho√†n th√†nh manifest tr∆∞·ªõc";
      }
    } catch (err) {
      showStatus("ƒê·ªãnh d·∫°ng JSON kh√¥ng h·ª£p l·ªá", "error");
      uploadBtn.disabled = true;
    }
  }

  // Event Listeners
  selectFilesBtn.addEventListener("click", () => fileInput.click());
  selectFolderBtn.addEventListener("click", () => {
    (folderInput as any).webkitdirectory = true;
    folderInput.click();
  });
  selectZipBtn.addEventListener("click", () => zipInput.click());

  fileInput.addEventListener("change", (e) => {
    const files = Array.from((e.target as HTMLInputElement).files || []);
    if (files.length > 0) {
      processFiles(files);
      (e.target as HTMLInputElement).value = "";
    }
  });

  folderInput.addEventListener("change", (e) => {
    const files = Array.from((e.target as HTMLInputElement).files || []);
    if (files.length > 0) {
      processFiles(files);
      (e.target as HTMLInputElement).value = "";
    }
  });

  zipInput.addEventListener("change", (e) => {
    const files = Array.from((e.target as HTMLInputElement).files || []);
    if (files.length > 0 && files[0]) {
      processZipFile(files[0]);
      (e.target as HTMLInputElement).value = "";
    }
  });

  clearFilesBtn.addEventListener("click", clearAllFiles);

  // Drag and drop
  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("border-indigo-400", "bg-indigo-50");
  });

  dropZone.addEventListener("dragleave", (e) => {
    e.preventDefault();
    dropZone.classList.remove("border-indigo-400", "bg-indigo-50");
  });

  dropZone.addEventListener("drop", async (e) => {
    e.preventDefault();
    dropZone.classList.remove("border-indigo-400", "bg-indigo-50");

    const files = Array.from(e.dataTransfer?.files || []);
    if (files.length === 1 && files[0].name.toLowerCase().endsWith('.zip')) {
      processZipFile(files[0]);
    } else if (files.length > 0) {
      processFiles(files);
    }
  });

  // Manifest editor toggle
  toggleManifestView.addEventListener("click", () => {
    isJsonView = !isJsonView;
    if (isJsonView) {
      manifestFields.classList.add("hidden");
      manifestJsonView.classList.remove("hidden");
      toggleManifestView.textContent = "Xem Form";
      updateManifestJson();
    } else {
      manifestFields.classList.remove("hidden");
      manifestJsonView.classList.add("hidden");
      toggleManifestView.textContent = "Xem JSON";
    }
  });

  // Manifest field change handlers
  ["manifestId", "manifestVersion", "manifestTitle", "manifestRuntime", "manifestCapabilities"].forEach((id) => {
    document.getElementById(id)?.addEventListener("input", updateManifestFromFields);
    document.getElementById(id)?.addEventListener("change", updateManifestFromFields);
  });

  manifestJsonText.addEventListener("input", updateManifestFromJson);

  // Initialize capabilities selector
  renderCapabilitiesSelector();

  // Upload handler
  uploadBtn.addEventListener("click", async () => {
    if (fileItems.length === 0 || !manifestData || !manifestData.id || !manifestData.version) return;

    uploadBtn.disabled = true;
    uploadBtnText.textContent = "ƒêang t·∫£i l√™n...";
    progressContainer.classList.remove("hidden");

    fileItems.forEach((item) => (item.status = "pending"));
    renderFileList();

    try {
      let res: Response;
      let data: any;

      if (isZipMode && zipFile) {
        // ZIP upload mode
        progressLabel.textContent = "ƒêang gi·∫£i n√©n v√† t·∫£i l√™n file ZIP...";
        
        const formData = new FormData();
        formData.append("zipFile", zipFile);
        formData.append("manifest", JSON.stringify(manifestData, null, 2));

        // Simulate ZIP extraction progress
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress = Math.min(progress + Math.random() * 10, 85);
          progressBar.style.width = `${progress}%`;
          progressPercent.textContent = `${Math.round(progress)}%`;
          
          if (progress < 30) {
            progressLabel.textContent = "ƒêang gi·∫£i n√©n file ZIP...";
          } else if (progress < 70) {
            progressLabel.textContent = "ƒêang t·∫£i l√™n c√°c file...";
            fileItems[0].status = "uploading";
            renderFileList();
          }
        }, 200);

        res = await fetch("/api/upload-zip", {
          method: "POST",
          body: formData,
        });

        clearInterval(progressInterval);
        data = await res.json();

      } else {
        // Regular file upload mode
        const formData = new FormData();
        const manifestBlob = new Blob([JSON.stringify(manifestData, null, 2)], { type: "application/json" });
        const manifestFile = new File([manifestBlob], "manifest.json", { type: "application/json" });
        formData.append("files", manifestFile);

        fileItems.forEach((item) => {
          if (item.name !== "manifest.json" && !item.path?.endsWith("/manifest.json")) {
            formData.append("files", item.file);
          }
        });

        // Simulate upload progress
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress = Math.min(progress + Math.random() * 15, 90);
          progressBar.style.width = `${progress}%`;
          progressPercent.textContent = `${Math.round(progress)}%`;
          progressLabel.textContent = `ƒêang t·∫£i l√™n ${Math.round(progress)}%...`;
        }, 200);

        res = await fetch("/api/upload", {
          method: "POST",
          body: formData,
        });

        clearInterval(progressInterval);
        data = await res.json();
      }

      if (res.ok) {
        fileItems.forEach((item) => (item.status = "success"));
        
        progressBar.style.width = "100%";
        progressPercent.textContent = "100%";
        progressLabel.textContent = "Ho√†n t·∫•t!";
        
        renderFileList();

        const summary = data.summary;
        let successMessage = data.message;
        if (summary) {
          if (isZipMode) {
            successMessage += ` (${summary.totalFiles} file ƒë∆∞·ª£c gi·∫£i n√©n t·ª´ ${summary.zipFile})`;
          } else {
            successMessage += ` (${summary.totalFiles} file trong ${summary.folders} th∆∞ m·ª•c)`;
          }
        }

        showStatus(successMessage, "success");
        uploadBtnText.textContent = "Th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...";

        setTimeout(() => {
          window.location.href = "/";
        }, 2000);
      } else {
        throw new Error(data.error || "T·∫£i l√™n th·∫•t b·∫°i");
      }
    } catch (err: any) {
      fileItems.forEach((item) => {
        if (item.status === "uploading" || item.status === "pending") {
          item.status = "error";
          item.errorMessage = err.message;
        }
      });
      renderFileList();

      showStatus(err.message || "T·∫£i l√™n th·∫•t b·∫°i", "error");
      uploadBtn.disabled = false;
      uploadBtnText.textContent = "Th·ª≠ l·∫°i";
      progressContainer.classList.add("hidden");
    }
  });
</script>