---
// Server-side component - all logic happens on client
---

<div class="space-y-6 animate-fade-in">
  <!-- Section 1: Build Upload -->
  <div
    class="bg-white rounded-[32px] border border-slate-200 overflow-hidden shadow-sm"
  >
    <div class="p-8 pb-10">
      <div class="flex items-center gap-4 mb-8">
        <div
          class="w-12 h-12 rounded-2xl bg-blue-50 flex items-center justify-center text-iruka-blue"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2.5"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
            ></path>
          </svg>
        </div>
        <div>
          <h2 class="text-xl font-black text-slate-900 tracking-tight">
            T·∫£i l√™n b·∫£n Build
          </h2>
          <p class="text-slate-500 text-sm font-medium">
            H·ªá th·ªëng h·ªó tr·ª£ th∆∞ m·ª•c zip, folder ho·∫∑c file l·∫ª.
          </p>
        </div>
      </div>

      <!-- Main Drop Zone -->
      <div
        id="dropZone"
        class="relative border-4 border-dashed border-blue-100 rounded-[32px] p-12 text-center cursor-pointer
               bg-blue-50/30 hover:bg-blue-50 hover:border-blue-300 transition-all duration-300 group"
      >
        <!-- Illustration -->
        <div
          class="mb-6 transform group-hover:scale-110 transition-transform duration-500"
        >
          <svg
            class="w-24 h-24 mx-auto text-blue-400 opacity-60"
            viewBox="0 0 100 100"
            fill="currentColor"
          >
            <path
              d="M95,50c0-11.1-4.7-21.1-12.3-28.1c-1.1-1-2.2-1.9-3.4-2.8c-0.1-0.1-0.2-0.1-0.3-0.2c-0.2-0.1-0.3-0.2-0.5-0.3 c-0.6-0.4-1.2-0.8-1.8-1.2c-0.1,0-0.1-0.1-0.2-0.1c-1-0.6-2-1.1-3.1-1.6c-11-4.5-23.4-4.5-34.4,0c-1.1,0.5-2.1,1-3.1,1.6 c-0.1,0-0.1,0.1-0.2,0.1c-0.6,0.4-1.2,0.8-1.8,1.2c-0.2,0.1-0.3,0.2-0.5,0.3c-0.1,0.1-0.2,0.1-0.3,0.2c-1.2,0.9-2.3,1.8-3.4,2.8 C21,28.9,16.3,38.9,16.3,50c0,10.6,4.3,20.2,11.3,27.1c0.1,0.1,0.3,0.3,0.4,0.4c0.2,0.2,0.5,0.4,0.7,0.7c0.2,0.2,0.5,0.4,0.7,0.6 c0.4,0.3,0.8,0.6,1.2,0.9c0.1,0.1,0.1,0.1,0.2,0.2c0.8,0.5,1.5,1,2.3,1.4c0.1,0,0.3,0.2,0.4,0.2c0.7,0.4,1.4,0.7,2.2,1.1 C41.6,85,48.2,86.3,55,86.3c15.2,0,28.7-8.1,36.4-20.3C93.7,60.8,95,55.5,95,50z M55,75.3c-14,0-25.3-11.3-25.3-25.3 S41,24.7,55,24.7s25.3,11.3,25.3,25.3S69,75.3,55,75.3z"
            ></path>
            <path
              d="M55,34.7c-8.5,0-15.3,6.9-15.3,15.3S46.5,65.3,55,65.3s15.3-6.9,15.3-15.3S63.5,34.7,55,34.7z M55,55.3 c-2.9,0-5.3-2.4-5.3-5.3S52.1,44.7,55,44.7s5.3,2.4,5.3,5.3S57.9,55.3,55,55.3z"
            ></path>
          </svg>
        </div>

        <p
          id="dropZoneText"
          class="text-xl font-black text-slate-900 tracking-tight"
        >
          K√©o th·∫£ file Game v√†o ƒë√¢y
        </p>
        <p id="dropZoneHint" class="text-slate-400 text-sm mt-2 font-medium">
          Ho·∫∑c b·∫°n c√≥ th·ªÉ ch·ªçn th·ªß c√¥ng t·ª´ng lo·∫°i b·∫£n build
        </p>

        <!-- Selection Buttons Inside Zone -->
        <div class="mt-10 flex flex-wrap items-center justify-center gap-4">
          <button
            type="button"
            id="selectZipBtn"
            class="relative py-3 px-6 rounded-2xl bg-white border border-slate-200 hover:border-blue-400 hover:shadow-xl hover:shadow-blue-500/10 transition-all flex items-center gap-3 active:scale-95 group/btn"
          >
            <span
              class="absolute -top-3 -right-2 px-3 py-1 rounded-full text-[10px] font-black bg-emerald-500 text-white shadow-lg shadow-emerald-500/20 uppercase tracking-widest"
              >Khuy√™n d√πng</span
            >
            <div
              class="w-8 h-8 rounded-xl bg-emerald-50 flex items-center justify-center text-emerald-600 transition-colors group-hover/btn:bg-emerald-500 group-hover/btn:text-white"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2.5"
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 12l2 2 4-4"
                ></path></svg
              >
            </div>
            <span class="text-slate-800 text-sm font-bold">G√≥i ZIP</span>
          </button>

          <button
            type="button"
            id="selectFolderBtn"
            class="py-3 px-6 rounded-2xl bg-white border border-slate-200 hover:border-blue-400 hover:shadow-xl hover:shadow-blue-500/10 transition-all flex items-center gap-3 active:scale-95 group/btn"
          >
            <div
              class="w-8 h-8 rounded-xl bg-amber-50 flex items-center justify-center text-amber-600 transition-colors group-hover/btn:bg-amber-500 group-hover/btn:text-white"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2.5"
                  d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                ></path></svg
              >
            </div>
            <span class="text-slate-800 text-sm font-bold">Th∆∞ m·ª•c</span>
          </button>

          <button
            type="button"
            id="selectFilesBtn"
            class="py-3 px-6 rounded-2xl bg-white border border-slate-200 hover:border-blue-400 hover:shadow-xl hover:shadow-blue-500/10 transition-all flex items-center gap-3 active:scale-95 group/btn"
          >
            <div
              class="w-8 h-8 rounded-xl bg-blue-50 flex items-center justify-center text-blue-600 transition-colors group-hover/btn:bg-blue-500 group-hover/btn:text-white"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2.5"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                ></path></svg
              >
            </div>
            <span class="text-slate-800 text-sm font-bold">File l·∫ª</span>
          </button>
        </div>
      </div>

      <!-- Hidden file inputs -->
      <input type="file" id="fileInput" multiple class="hidden" />
      <input type="file" id="folderInput" multiple class="hidden" />
      <input type="file" id="zipInput" accept=".zip" class="hidden" />
    </div>

    <!-- Status Message -->
    <div
      id="statusMessage"
      class="hidden mx-8 mb-6 p-4 rounded-2xl text-sm font-bold transition-all"
    >
    </div>
  </div>

  <!-- Section 2: File List -->
  <div
    id="fileListContainer"
    class="hidden bg-white rounded-[32px] border border-slate-200 p-8 shadow-sm"
  >
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div
          class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center text-slate-400"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2.5"
              d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
            ></path></svg
          >
        </div>
        <div>
          <h3
            id="fileCountLabel"
            class="text-lg font-black text-slate-900 tracking-tight"
          >
            0 file ƒë√£ ch·ªçn
          </h3>
          <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">
            Danh s√°ch t√†i nguy√™n t·∫£i l√™n
          </p>
        </div>
      </div>
      <button
        type="button"
        id="clearFilesBtn"
        class="px-4 py-2 rounded-xl text-xs font-black text-red-500 hover:bg-red-50 transition-all uppercase tracking-widest border border-transparent hover:border-red-100"
      >
        L√†m m·ªõi t·∫•t c·∫£
      </button>
    </div>

    <div
      id="fileList"
      class="max-h-80 overflow-y-auto space-y-3 pr-4 custom-scrollbar"
    >
      <!-- File items will be rendered here -->
    </div>
  </div>

  <!-- Section 3: Manifest Editor & Validation -->
  <div id="manifestEditor" class="hidden space-y-6">
    <!-- Validation Panel -->
    <div id="validationDetails" class="hidden space-y-4">
      <div
        id="validationErrors"
        class="hidden p-5 bg-red-50 border border-red-100 rounded-[24px]"
      >
        <div class="flex items-center gap-3 text-red-700 mb-3">
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2.5"
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg
          >
          <span class="font-black text-sm uppercase tracking-widest"
            >L·ªói c·∫•u h√¨nh C·∫ßn s·ª≠a</span
          >
        </div>
        <ul
          id="errorsList"
          class="text-sm text-red-600/80 font-bold space-y-1 ml-8 list-disc"
        >
        </ul>
      </div>

      <div
        id="validationWarnings"
        class="hidden p-5 bg-amber-50 border border-amber-100 rounded-[24px]"
      >
        <div class="flex items-center gap-3 text-amber-700 mb-3">
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2.5"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"
            ></path></svg
          >
          <span class="font-black text-sm uppercase tracking-widest"
            >C·∫£nh b√°o k·ªπ thu·∫≠t</span
          >
        </div>
        <ul
          id="warningsList"
          class="text-sm text-amber-600/80 font-bold space-y-1 ml-8 list-disc"
        >
        </ul>
      </div>
    </div>

    <!-- Main Config Card -->
    <div
      class="bg-white rounded-[32px] border border-slate-200 overflow-hidden shadow-sm"
    >
      <div class="p-8">
        <div class="flex items-center justify-between mb-8">
          <div class="flex items-center gap-4">
            <div
              class="w-12 h-12 rounded-2xl bg-indigo-50 flex items-center justify-center text-indigo-600 shadow-inner"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2.5"
                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                ></path></svg
              >
            </div>
            <div>
              <h3 class="text-xl font-black text-slate-900 tracking-tight">
                C·∫•u h√¨nh h·ªá th·ªëng
              </h3>
              <p
                id="manifestSource"
                class="text-xs font-bold mt-0.5 uppercase tracking-widest"
              >
              </p>
            </div>
          </div>
          <button
            type="button"
            id="toggleManifestView"
            class="px-4 py-2 rounded-xl text-xs font-black text-slate-400 hover:text-slate-600 hover:bg-slate-50 transition-all uppercase tracking-[0.2em]"
          >
            Ch·∫ø ƒë·ªô JSON
          </button>
        </div>

        <!-- Form Editor -->
        <div id="manifestFields" class="space-y-8">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="space-y-2">
              <label
                class="text-xs font-black text-slate-400 uppercase tracking-widest px-1"
                >Game Identity ID</label
              >
              <input
                type="text"
                id="manifestId"
                class="w-full px-5 py-4 bg-slate-50/50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-blue-100 focus:border-blue-400 focus:bg-white outline-none transition-all font-bold text-slate-900"
                placeholder="com.iruka.my-game"
              />
              <p class="text-[10px] text-slate-400 font-bold px-1 italic">
                D·∫°ng: com.iruka.&lt;t√™n-game&gt;
              </p>
            </div>
            <div class="space-y-2">
              <label
                class="text-xs font-black text-slate-400 uppercase tracking-widest px-1"
                >Phi√™n b·∫£n (SemVer)</label
              >
              <input
                type="text"
                id="manifestVersion"
                class="w-full px-5 py-4 bg-slate-50/50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-blue-100 focus:border-blue-400 focus:bg-white outline-none transition-all font-bold text-slate-900"
                placeholder="1.0.0"
              />
              <p class="text-[10px] text-slate-400 font-bold px-1 italic">
                S·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng x.y.z
              </p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="space-y-2">
              <label
                class="text-xs font-black text-slate-400 uppercase tracking-widest px-1"
                >T√™n game hi·ªÉn th·ªã</label
              >
              <input
                type="text"
                id="manifestTitle"
                class="w-full px-5 py-4 bg-slate-50/50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-blue-100 focus:border-blue-400 focus:bg-white outline-none transition-all font-bold text-slate-900"
                placeholder="T√™n game c·ªßa b·∫°n"
              />
            </div>
            <div class="space-y-2">
              <label
                class="text-xs font-black text-slate-400 uppercase tracking-widest px-1"
                >C∆° ch·∫ø v·∫≠n h√†nh (Runtime)</label
              >
              <select
                id="manifestRuntime"
                class="w-full px-5 py-4 bg-slate-50/50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-blue-100 focus:border-blue-400 focus:bg-white outline-none transition-all font-bold text-slate-900 appearance-none bg-no-repeat bg-[right_20px_center]"
                style="background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2394a3b8%22%20stroke-width%3D%222.5%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpolyline%20points%3D%226%209%2012%2015%2018%209%22%3E%3C/polyline%3E%3C/svg%3E')"
              >
                <option value="iframe-html">Web Iframe (Ph·ªï bi·∫øn nh·∫•t)</option>
                <option value="esm-module">ES Module (N√¢ng cao)</option>
              </select>
            </div>
          </div>

          <div class="space-y-3 pt-6 border-t border-slate-50">
            <label
              class="text-xs font-black text-slate-400 uppercase tracking-widest px-1"
              >T√≠nh nƒÉng t√≠ch h·ª£p (Capabilities)</label
            >
            <div id="capabilitiesSelector" class="flex flex-wrap gap-3">
              <!-- Capability tags -->
            </div>
          </div>
        </div>

        <!-- Raw JSON View (hidden by default) -->
        <div id="manifestJsonView" class="hidden">
          <textarea
            id="manifestJsonText"
            class="w-full h-64 bg-slate-900 text-blue-400 rounded-2xl p-6 text-sm font-mono focus:ring-4 focus:ring-blue-100 outline-none scrollbar-thin scrollbar-thumb-slate-700"
            placeholder='{ "id": "com.iruka.game", ... }'></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Bar Overlay (for uploading) -->
  <div
    id="progressContainer"
    class="hidden fixed inset-0 z-[100] bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-6"
  >
    <div
      class="bg-white rounded-[40px] p-10 max-w-lg w-full shadow-2xl animate-modal text-center"
    >
      <div class="relative w-32 h-32 mx-auto mb-8">
        <svg class="w-full h-full transform -rotate-90">
          <circle
            cx="64"
            cy="64"
            r="58"
            stroke="currentColor"
            stroke-width="8"
            fill="transparent"
            class="text-slate-100"></circle>
          <circle
            id="progressCircle"
            cx="64"
            cy="64"
            r="58"
            stroke="currentColor"
            stroke-width="8"
            fill="transparent"
            stroke-dasharray="364.4"
            stroke-dashoffset="364.4"
            class="text-iruka-blue transition-all duration-300"></circle>
        </svg>
        <div class="absolute inset-0 flex items-center justify-center">
          <span id="progressPercent" class="text-3xl font-black text-slate-900"
            >0%</span
          >
        </div>
      </div>
      <h3 class="text-2xl font-black text-slate-900 mb-2">
        ƒêang t·∫£i l√™n H·ªá th·ªëng
      </h3>
      <p
        id="progressLabel"
        class="text-slate-500 font-bold uppercase tracking-widest text-xs"
      >
        Ph√¢n t√≠ch build...
      </p>

      <div
        id="progressBar"
        class="hidden h-1.5 bg-slate-100 rounded-full mt-8 overflow-hidden"
      >
        <div
          id="progressBarFill"
          class="h-full bg-iruka-blue transition-all duration-300 w-0"
        >
        </div>
      </div>
    </div>
  </div>

  <!-- Action Button -->
  <div class="pt-4">
    <button
      id="uploadBtn"
      type="button"
      disabled
      class="w-full py-5 rounded-[24px] font-black text-white text-lg tracking-tight transition-all disabled:opacity-50 disabled:cursor-not-allowed
             bg-iruka-blue hover:bg-blue-600 shadow-xl shadow-blue-500/20 active:scale-[0.98]"
    >
      <span id="uploadBtnText">T·∫£i l√™n b·∫£n Build</span>
    </button>
  </div>
</div>

<script>
  // Script logic goes here - integrating your existing logic with my new selectors
  interface FileItem {
    file: File;
    name: string;
    path: string;
    folder: string;
    type: "file" | "folder";
    size: number;
    status: "pending" | "uploading" | "success" | "error";
    errorMessage?: string;
  }

  // DOM Elements
  const fileInput = document.getElementById("fileInput") as HTMLInputElement;
  const folderInput = document.getElementById(
    "folderInput"
  ) as HTMLInputElement;
  const zipInput = document.getElementById("zipInput") as HTMLInputElement;
  const selectFilesBtn = document.getElementById(
    "selectFilesBtn"
  ) as HTMLButtonElement;
  const selectFolderBtn = document.getElementById(
    "selectFolderBtn"
  ) as HTMLButtonElement;
  const selectZipBtn = document.getElementById(
    "selectZipBtn"
  ) as HTMLButtonElement;
  const dropZone = document.getElementById("dropZone") as HTMLDivElement;
  const fileListContainer = document.getElementById(
    "fileListContainer"
  ) as HTMLDivElement;
  const fileList = document.getElementById("fileList") as HTMLDivElement;
  const fileCountLabel = document.getElementById(
    "fileCountLabel"
  ) as HTMLSpanElement;
  const clearFilesBtn = document.getElementById(
    "clearFilesBtn"
  ) as HTMLButtonElement;
  const manifestEditor = document.getElementById(
    "manifestEditor"
  ) as HTMLDivElement;
  const manifestFields = document.getElementById(
    "manifestFields"
  ) as HTMLDivElement;
  const manifestJsonView = document.getElementById(
    "manifestJsonView"
  ) as HTMLDivElement;
  const manifestJsonText = document.getElementById(
    "manifestJsonText"
  ) as HTMLTextAreaElement;
  const toggleManifestView = document.getElementById(
    "toggleManifestView"
  ) as HTMLButtonElement;
  const uploadBtn = document.getElementById("uploadBtn") as HTMLButtonElement;
  const uploadBtnText = document.getElementById(
    "uploadBtnText"
  ) as HTMLSpanElement;
  const statusMessage = document.getElementById(
    "statusMessage"
  ) as HTMLDivElement;
  const progressContainer = document.getElementById(
    "progressContainer"
  ) as HTMLDivElement;
  const progressBarFill = document.getElementById(
    "progressBarFill"
  ) as HTMLDivElement;
  const progressPercent = document.getElementById(
    "progressPercent"
  ) as HTMLSpanElement;
  const progressLabel = document.getElementById(
    "progressLabel"
  ) as HTMLSpanElement;
  const progressCircle = document.getElementById("progressCircle") as any;

  // State
  let fileItems: FileItem[] = [];
  let manifestData: any = null;
  let isJsonView = false;
  let isZipMode = false;
  let zipFile: File | null = null;
  let selectedCapabilities: string[] = [];
  let manifestFromFile = false;

  // Capabilities
  const AVAILABLE_CAPABILITIES = [
    { id: "score", label: "T√≠nh ƒëi·ªÉm", icon: "üéØ" },
    { id: "save-progress", label: "L∆∞u ti·∫øn tr√¨nh", icon: "üíæ" },
    { id: "levels", label: "T∆∞ duy Level", icon: "üéÆ" },
    { id: "hints", label: "G·ª£i √Ω th√¥ng minh", icon: "üí°" },
    { id: "audio", label: "√Çm thanh", icon: "üîä" },
    { id: "leaderboard", label: "BXH", icon: "üèÜ" },
  ];

  function formatFileSize(bytes: number): string {
    if (bytes === 0) return "0 B";
    const k = 1024;
    const sizes = ["B", "KB", "MB", "GB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
  }

  function getFileIcon(fileName: string): string {
    const ext = fileName.split(".").pop()?.toLowerCase();
    if (["html", "htm"].includes(ext || "")) return "üåê";
    if (["js", "mjs", "ts"].includes(ext || "")) return "üìú";
    if (["css", "scss", "less"].includes(ext || "")) return "üé®";
    if (["zip"].includes(ext || "")) return "üì¶";
    return "üìÑ";
  }

  function getStatusBadge(status: FileItem["status"]): string {
    switch (status) {
      case "success":
        return '<span class="text-[10px] font-black uppercase text-emerald-500 bg-emerald-50 px-2 py-0.5 rounded-lg border border-emerald-100">ƒê·∫°t</span>';
      case "error":
        return '<span class="text-[10px] font-black uppercase text-red-500 bg-red-50 px-2 py-0.5 rounded-lg border border-red-100">L·ªói</span>';
      default:
        return '<span class="text-[10px] font-black uppercase text-slate-400 bg-slate-50 px-2 py-0.5 rounded-lg border border-slate-200">Ch·ªù</span>';
    }
  }

  function renderCapabilitiesSelector() {
    const container = document.getElementById("capabilitiesSelector");
    if (!container) return;
    container.innerHTML = AVAILABLE_CAPABILITIES.map((cap) => {
      const isSelected = selectedCapabilities.includes(cap.id);
      return `
        <button type="button" class="capability-tag px-4 py-2 rounded-xl text-sm font-bold transition-all ${
          isSelected
            ? "bg-blue-500 text-white shadow-lg shadow-blue-500/20"
            : "bg-slate-50 text-slate-500 hover:bg-slate-100 border border-slate-100"
        }" data-capability="${cap.id}">
          <span class="mr-2">${cap.icon}</span>${cap.label}
        </button>
      `;
    }).join("");
    container.querySelectorAll(".capability-tag").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = (btn as any).dataset.capability;
        const idx = selectedCapabilities.indexOf(id);
        if (idx > -1) selectedCapabilities.splice(idx, 1);
        else selectedCapabilities.push(id);
        renderCapabilitiesSelector();
        updateManifestFromFields();
      });
    });
  }

  function updateRequirementsChecklist() {
    const checks = {
      "index-html": fileItems.some(
        (f) => f.name === "index.html" || f.path?.endsWith("/index.html")
      ),
      "manifest-json": !!manifestData,
      "game-id": manifestData?.id?.startsWith("com.iruka."),
      "file-size": fileItems.reduce((s, i) => s + i.size, 0) < 10 * 1024 * 1024,
    };

    Object.entries(checks).forEach(([id, passed]) => {
      const li = document.querySelector(`[data-req="${id}"]`);
      if (li) {
        const box = li.querySelector(".check-box");
        const icon = box?.querySelector("svg");
        if (passed) {
          box?.classList.add("bg-white/20", "border-transparent");
          box?.classList.remove("border-white/30");
          icon?.classList.remove("hidden");
        } else {
          box?.classList.remove("bg-white/20", "border-transparent");
          box?.classList.add("border-white/30");
          icon?.classList.add("hidden");
        }
      }
    });
  }

  function showStatus(message: string, type: string) {
    statusMessage.classList.remove("hidden");
    statusMessage.className = `mx-8 mb-6 p-4 rounded-2xl text-sm font-bold border ${
      type === "error"
        ? "bg-red-50 text-red-700 border-red-100"
        : type === "success"
          ? "bg-emerald-50 text-emerald-700 border-emerald-100"
          : "bg-blue-50 text-blue-700 border-blue-100"
    }`;
    statusMessage.textContent = message;
  }

  function renderFileList() {
    if (fileItems.length === 0) {
      fileListContainer.classList.add("hidden");
      return;
    }
    fileListContainer.classList.remove("hidden");
    fileCountLabel.textContent = isZipMode
      ? `File ZIP n√©n: v${manifestData?.version || "?"}`
      : `${fileItems.length} file ƒë√£ ch·ªçn`;

    fileList.innerHTML = fileItems
      .map(
        (item, idx) => `
      <div class="flex items-center justify-between py-3.5 px-5 rounded-2xl bg-slate-50/50 border border-slate-100 hover:bg-white hover:shadow-md transition-all group">
        <div class="flex items-center gap-4 min-w-0">
          <div class="w-10 h-10 bg-white rounded-xl shadow-sm flex items-center justify-center text-lg">${getFileIcon(item.name)}</div>
          <div class="truncate">
            <p class="text-sm font-bold text-slate-800 truncate">${item.path || item.name}</p>
            <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mt-0.5">${formatFileSize(item.size)}</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          ${getStatusBadge(item.status)}
          <button onclick="removeFile(${idx})" class="p-1.5 opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-all"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        </div>
      </div>
    `
      )
      .join("");
  }

  window.removeFile = (idx: number) => {
    fileItems.splice(idx, 1);
    if (fileItems.length === 0) clearAllFiles();
    else {
      renderFileList();
      validateAndUpdateUI();
    }
  };

  function clearAllFiles() {
    fileItems = [];
    manifestData = null;
    isZipMode = false;
    zipFile = null;
    manifestFromFile = false;
    selectedCapabilities = [];
    renderFileList();
    renderCapabilitiesSelector();
    manifestEditor.classList.add("hidden");
    uploadBtn.disabled = true;
    uploadBtnText.textContent = "T·∫£i l√™n b·∫£n Build";
    statusMessage.classList.add("hidden");
    updateRequirementsChecklist();
  }

  function updateProgressUI(percent: number, label: string) {
    percent = Math.round(percent);
    progressPercent.textContent = `${percent}%`;
    progressLabel.textContent = label;
    if (progressCircle) {
      const offset = 364.4 - (364.4 * percent) / 100;
      progressCircle.style.strokeDashoffset = offset;
    }
  }

  async function processFiles(files: File[]) {
    const totalSize = files.reduce((s, f) => s + f.size, 0);
    if (totalSize > 10 * 1024 * 1024)
      return showStatus("‚ùå T·ªïng dung l∆∞·ª£ng v∆∞·ª£t qu√° 10MB!", "error");

    fileItems = files.map((f) => ({
      file: f,
      name: f.name,
      path: (f as any).webkitRelativePath || f.name,
      folder: "root",
      type: "file",
      size: f.size,
      status: "pending",
    }));

    renderFileList();
    await validateAndUpdateUI();
  }

  async function processZipFile(file: File) {
    if (file.size > 10 * 1024 * 1024)
      return showStatus("‚ùå File ZIP v∆∞·ª£t qu√° 10MB!", "error");
    isZipMode = true;
    zipFile = file;
    fileItems = [
      {
        file,
        name: file.name,
        path: file.name,
        folder: "root",
        type: "file",
        size: file.size,
        status: "pending",
      },
    ];
    renderFileList();
    manifestEditor.classList.remove("hidden");
    updateManifestSourceIndicator();
    updateManifestFromFields();
  }

  async function validateAndUpdateUI() {
    updateRequirementsChecklist();
    if (fileItems.length === 0) return clearAllFiles();

    // Auto-detect index.html and manifest.json
    const hasIndex = fileItems.some(
      (f) => f.name === "index.html" || f.path?.endsWith("/index.html")
    );
    const manifestFile = fileItems.find(
      (f) => f.name === "manifest.json" || f.path?.endsWith("/manifest.json")
    );

    if (isZipMode) {
      manifestEditor.classList.remove("hidden");
      uploadBtn.disabled = !manifestData?.id;
      return;
    }

    if (!hasIndex) {
      showStatus("‚ö†Ô∏è Thi·∫øu file index.html kh·ªüi ƒë·∫ßu!", "error");
      uploadBtn.disabled = true;
      return;
    }

    manifestEditor.classList.remove("hidden");
    if (manifestFile && !manifestFromFile) {
      try {
        const content = await manifestFile.file.text();
        manifestData = JSON.parse(content);
        manifestFromFile = true;
        populateManifestFields(manifestData);
        updateManifestSourceIndicator();
      } catch (e) {
        showStatus("‚ùå L·ªói ƒë·ªãnh d·∫°ng manifest.json", "error");
      }
    }
    updateManifestFromFields();
  }

  function populateManifestFields(m: any) {
    (document.getElementById("manifestId") as any).value = m.id || "";
    (document.getElementById("manifestVersion") as any).value = m.version || "";
    (document.getElementById("manifestTitle") as any).value = m.title || "";
    (document.getElementById("manifestRuntime") as any).value =
      m.runtime || "iframe-html";
    selectedCapabilities = Array.isArray(m.capabilities) ? m.capabilities : [];
    renderCapabilitiesSelector();
  }

  function updateManifestFromFields() {
    manifestData = {
      id: (document.getElementById("manifestId") as any).value.trim(),
      version: (document.getElementById("manifestVersion") as any).value.trim(),
      title: (document.getElementById("manifestTitle") as any).value.trim(),
      runtime: (document.getElementById("manifestRuntime") as any).value,
      capabilities: selectedCapabilities,
    };
    manifestJsonText.value = JSON.stringify(manifestData, null, 2);
    updateRequirementsChecklist();

    if (manifestData.id && manifestData.version) {
      uploadBtn.disabled = false;
      uploadBtnText.textContent = `T·∫£i l√™n ${manifestData.title || manifestData.id} v${manifestData.version}`;
    }
  }

  function updateManifestSourceIndicator() {
    const el = document.getElementById("manifestSource");
    if (!el) return;
    if (manifestFromFile) {
      el.textContent = "‚úì T·ª± ƒë·ªông tr√≠ch xu·∫•t t·ª´ Build";
      el.className =
        "text-[10px] font-black mt-0.5 uppercase tracking-widest text-emerald-500";
    } else {
      el.textContent = "‚úè ƒêang ch·ªânh s·ª≠a th·ªß c√¥ng";
      el.className =
        "text-[10px] font-black mt-0.5 uppercase tracking-widest text-blue-500";
    }
  }

  // Event Listeners
  selectFilesBtn.addEventListener("click", () => fileInput.click());
  selectFolderBtn.addEventListener("click", () => {
    (folderInput as any).webkitdirectory = true;
    folderInput.click();
  });
  selectZipBtn.addEventListener("click", () => zipInput.click());
  fileInput.addEventListener("change", (e) =>
    processFiles(Array.from((e.target as any).files))
  );
  folderInput.addEventListener("change", (e) =>
    processFiles(Array.from((e.target as any).files))
  );
  zipInput.addEventListener("change", (e) => {
    if ((e.target as any).files[0]) processZipFile((e.target as any).files[0]);
  });
  clearFilesBtn.addEventListener("click", clearAllFiles);

  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("bg-blue-50", "border-blue-300");
  });
  dropZone.addEventListener("dragleave", (e) => {
    e.preventDefault();
    dropZone.classList.remove("bg-blue-50", "border-blue-300");
  });
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("bg-blue-50", "border-blue-300");
    const files = Array.from(e.dataTransfer?.files || []);
    if (files.length === 1 && files[0].name.toLowerCase().endsWith(".zip"))
      processZipFile(files[0]);
    else processFiles(files);
  });

  toggleManifestView.addEventListener("click", () => {
    isJsonView = !isJsonView;
    manifestFields.classList.toggle("hidden", isJsonView);
    manifestJsonView.classList.toggle("hidden", !isJsonView);
    toggleManifestView.textContent = isJsonView ? "Ch·∫ø ƒë·ªô Form" : "Ch·∫ø ƒë·ªô JSON";
  });

  ["manifestId", "manifestVersion", "manifestTitle", "manifestRuntime"].forEach(
    (id) => {
      document
        .getElementById(id)
        ?.addEventListener("input", updateManifestFromFields);
    }
  );

  uploadBtn.addEventListener("click", async () => {
    uploadBtn.disabled = true;
    progressContainer.classList.remove("hidden");
    updateProgressUI(10, "ƒêang kh·ªüi t·∫°o...");

    const formData = new FormData();
    if (isZipMode) {
      formData.append("zipFile", zipFile!);
      formData.append("manifest", JSON.stringify(manifestData));
    } else {
      fileItems.forEach((i) => formData.append("files", i.file));
      formData.append(
        "files",
        new File([JSON.stringify(manifestData)], "manifest.json")
      );
    }

    try {
      updateProgressUI(40, "ƒêang t·∫£i d·ªØ li·ªáu...");
      const res = await fetch(isZipMode ? "/api/upload-zip" : "/api/upload", {
        method: "POST",
        body: formData,
      });
      if (!res.ok) throw new Error("L·ªói t·∫£i l√™n");
      updateProgressUI(100, "Ho√†n t·∫•t!");
      showStatus("‚úÖ Th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...", "success");
      setTimeout(() => (window.location.href = "/"), 1500);
    } catch (e) {
      showStatus("‚ùå L·ªói trong qu√° tr√¨nh upload", "error");
      progressContainer.classList.add("hidden");
      uploadBtn.disabled = false;
    }
  });

  renderCapabilitiesSelector();
</script>

<style is:inline>
  .custom-scrollbar::-webkit-scrollbar {
    width: 5px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #e2e8f0;
    border-radius: 10px;
  }
  .animate-modal {
    animation: modalIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  @keyframes modalIn {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }
</style>
