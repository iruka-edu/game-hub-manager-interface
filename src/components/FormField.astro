---
interface Props {
  label: string;
  name: string;
  type?: 'text' | 'email' | 'password' | 'textarea' | 'select' | 'checkbox' | 'file';
  placeholder?: string;
  value?: string;
  required?: boolean;
  disabled?: boolean;
  options?: { value: string; label: string }[];
  rows?: number;
  accept?: string;
  multiple?: boolean;
  helpText?: string;
  errorMessage?: string;
  validateOnBlur?: boolean;
  validateOnInput?: boolean;
}

const { 
  label, 
  name, 
  type = 'text', 
  placeholder, 
  value = '', 
  required = false,
  disabled = false,
  options = [],
  rows = 3,
  accept,
  multiple = false,
  helpText,
  errorMessage,
  validateOnBlur = true,
  validateOnInput = false
} = Astro.props;

const fieldId = `field-${name}`;
const errorId = `error-${name}`;
const helpId = `help-${name}`;

const baseInputClasses = "w-full px-3 py-2.5 border border-slate-200 rounded-lg text-sm text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors min-h-[40px]";
const errorInputClasses = "border-red-300 focus:ring-red-500 focus:border-red-500";
const disabledInputClasses = "bg-slate-50 text-slate-500 cursor-not-allowed";
---

<div class="form-field">
  <!-- Label -->
  <label 
    for={fieldId} 
    class={`block text-sm font-medium text-slate-700 mb-2 ${required ? "after:content-['*'] after:text-red-500 after:ml-1" : ""}`}
  >
    {label}
  </label>

  <!-- Input Field -->
  {type === 'textarea' ? (
    <textarea
      id={fieldId}
      name={name}
      placeholder={placeholder}
      required={required}
      disabled={disabled}
      rows={rows}
      class={`${baseInputClasses} ${errorMessage ? errorInputClasses : ''} ${disabled ? disabledInputClasses : ''}`}
      aria-describedby={`${helpText ? helpId : ''} ${errorMessage ? errorId : ''}`.trim()}
      data-validate-on-blur={validateOnBlur}
      data-validate-on-input={validateOnInput}
    >{value}</textarea>
  ) : type === 'select' ? (
    <select
      id={fieldId}
      name={name}
      required={required}
      disabled={disabled}
      class={`${baseInputClasses} ${errorMessage ? errorInputClasses : ''} ${disabled ? disabledInputClasses : ''}`}
      aria-describedby={`${helpText ? helpId : ''} ${errorMessage ? errorId : ''}`.trim()}
      data-validate-on-blur={validateOnBlur}
      data-validate-on-input={validateOnInput}
    >
      {placeholder && <option value="">{placeholder}</option>}
      {options.map(option => (
        <option value={option.value} selected={option.value === value}>
          {option.label}
        </option>
      ))}
    </select>
  ) : type === 'checkbox' ? (
    <div class="flex items-center gap-3">
      <input
        type="checkbox"
        id={fieldId}
        name={name}
        value={value}
        required={required}
        disabled={disabled}
        class="w-4 h-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500 focus:ring-2"
        aria-describedby={`${helpText ? helpId : ''} ${errorMessage ? errorId : ''}`.trim()}
        data-validate-on-blur={validateOnBlur}
        data-validate-on-input={validateOnInput}
      />
      <span class="text-sm text-slate-700">{placeholder}</span>
    </div>
  ) : (
    <input
      type={type}
      id={fieldId}
      name={name}
      placeholder={placeholder}
      value={value}
      required={required}
      disabled={disabled}
      accept={accept}
      multiple={multiple}
      class={`${baseInputClasses} ${errorMessage ? errorInputClasses : ''} ${disabled ? disabledInputClasses : ''}`}
      aria-describedby={`${helpText ? helpId : ''} ${errorMessage ? errorId : ''}`.trim()}
      data-validate-on-blur={validateOnBlur}
      data-validate-on-input={validateOnInput}
    />
  )}

  <!-- Help Text -->
  {helpText && (
    <p id={helpId} class="mt-2 text-sm text-slate-500">
      {helpText}
    </p>
  )}

  <!-- Error Message -->
  <div id={errorId} class={`field-error mt-2 text-sm text-red-600 ${errorMessage ? 'block' : 'hidden'}`} role="alert">
    {errorMessage || ''}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const formFields = document.querySelectorAll('.form-field');
    
    formFields.forEach(field => {
      const input = field.querySelector('input, textarea, select');
      const errorDiv = field.querySelector('.field-error');
      
      if (!input || !errorDiv) return;
      
      const validateOnBlur = input.dataset.validateOnBlur === 'true';
      const validateOnInput = input.dataset.validateOnInput === 'true';
      
      // Validation function
      function validateField() {
        const value = input.value.trim();
        const isRequired = input.hasAttribute('required');
        const type = input.type;
        
        // Clear previous error
        clearError();
        
        // Required validation
        if (isRequired && !value) {
          showError('Trường này là bắt buộc');
          return false;
        }
        
        // Email validation
        if (type === 'email' && value) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(value)) {
            showError('Vui lòng nhập email hợp lệ');
            return false;
          }
        }
        
        // Password validation
        if (type === 'password' && value) {
          if (value.length < 6) {
            showError('Mật khẩu phải có ít nhất 6 ký tự');
            return false;
          }
        }
        
        // File validation
        if (type === 'file' && input.files && input.files.length > 0) {
          const file = input.files[0];
          const maxSize = 10 * 1024 * 1024; // 10MB
          
          if (file.size > maxSize) {
            showError('File không được vượt quá 10MB');
            return false;
          }
        }
        
        return true;
      }
      
      function showError(message) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
        errorDiv.classList.add('block');
        input.classList.add('border-red-300', 'focus:ring-red-500', 'focus:border-red-500');
        input.classList.remove('border-slate-200', 'focus:ring-indigo-500', 'focus:border-indigo-500');
      }
      
      function clearError() {
        errorDiv.textContent = '';
        errorDiv.classList.add('hidden');
        errorDiv.classList.remove('block');
        input.classList.remove('border-red-300', 'focus:ring-red-500', 'focus:border-red-500');
        input.classList.add('border-slate-200', 'focus:ring-indigo-500', 'focus:border-indigo-500');
      }
      
      // Event listeners
      if (validateOnBlur) {
        input.addEventListener('blur', validateField);
      }
      
      if (validateOnInput) {
        input.addEventListener('input', validateField);
      }
      
      // Expose validation function
      input.validateField = validateField;
      input.clearError = clearError;
    });
  });
</script>